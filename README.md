# tara-bingo-lifeos

TARA-s-LifeOS-Chronos-BinGO-Date



2026/2/12以下是修改总结：



1\. 自动备份机制（最重要）

每 5 分钟自动保存一次快照到 localStorage

页面关闭/切后台时自动触发保存

主数据损坏时自动提示从备份恢复

超过 7 天未手动导出时弹出 toast 提醒

每次导出都会记录时间戳

2\. innerHTML += 性能修复（24 处）

所有循环内的 innerHTML += 改为先拼好字符串再一次性 innerHTML =

包括热力图、归档列表、Bingo 选择、商店、日历等所有位置

消除了重复 DOM 重排

3\. Chart.js 图表复用

折线图和饼图改为 chart.update() 复用已有实例

只在首次创建时 new Chart()，后续只更新数据

4\. Escape 键关闭模态框

全局监听 Escape 键

自动关闭最上层的 active 模态框

没有模态框时关闭侧边栏

5\. JSON 导入增强验证

文件大小上限检查（50MB）

基本类型和必需字段验证

导入前二次确认（显示文件大小和导入模式）

导入前自动做一次备份快照

6\. Loading 状态反馈

导出数据时显示 toast 提示

导入数据时显示 toast 提示

这些都是渐进式的改动，不会破坏现有功能。 



\# 语义世界书已实现

三灯模式并存

灯色

模式

触发方式

🔵 蓝灯

常驻

始终注入（不变）

🟢 绿灯

关键词

.includes() 匹配（不变）

🟣 紫灯

语义

余弦相似度匹配（新增）

改动详情

script.js — 3 处新增/修改：

• semanticEmbeddingService（line 164）— 懒加载单例，通过 dynamic import 加载 Transformers.js + Xenova/bge-small-zh-v1.5 中文模型

• saveWorldBookEntry()（line 5184）— 紫灯模式保存时自动生成 512 维向量，内容不变时复用缓存

• buildCharacterSystemPrompt()（line 2975）— 对话上下文只算一次向量，然后对每个紫灯条目做余弦相似度比较

index.html — 2 处新增：

• 条目编辑模态框添加紫灯「语义」按钮（line 1328）

• 角色设置面板添加「语义匹配阈值」滑块 0.3~0.9（line 1058）

使用方式

1\. 打开一个世界书条目，点击紫色的「语义」按钮

2\. 填写内容后保存 → 首次会下载 ~24MB 模型（之后浏览器缓存）

3\. 在角色设置中调整「语义匹配阈值」（默认 0.55）

4\. 聊天时，即使你说的词和条目里的词完全不同，只要语义相关就能触发

例如：条目写了「锈湖 — 一座被红色铁锈覆盖的废弃湖边旅馆」，你在聊天中提到「那栋红色的房子」→ 语义相似度会很高，条目自动激活注入。

