<!DOCTYPE html>
<html lang="zh-CN" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tara's LifeOS Chronos BinGO</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- [Vesper] ËßÜËßâÊ†∏ÂøÉÂ±Ç (Visual Core) --- */
        
        /* 1. ÈªòËÆ§‰∏ªÈ¢ò (Default - ÁªèÂÖ∏ÁâõÁöÆÁ∫∏) */
        :root {
            --bg: #F0EAD6;
            --bg-rgb: 240, 234, 214;
            --card-bg: #FFFAF0;
            --text: #4A403A;
            --accent: #8B5A2B;
            --accent-rgb: 139, 90, 43;
            --highlight: #CD853F;
            --completed: #6B8E23;
            --daily: #7B68EE;
            --deadline: #C0392B;
            --gold: #F1C40F;
            --shadow: 0 4px 20px rgba(74, 64, 58, 0.08);
            --mystery-1: #bcaaa4;
            --mystery-2: #8d6e63;
        }

        /* 2. Êó†Â£∞ (Silent) - ÊûÅËá¥ÁöÑÈªë‰∏éËçßÂÖâËñÑËç∑ */
        [data-theme="silent"] {
            --bg: #000000;
            --bg-rgb: 0, 0, 0;
            --card-bg: #1A1A1A;
            --text: #F6F6F6;
            --accent: #CFFFE2;
            --accent-rgb: 207, 255, 226;
            --highlight: #A2D5C6;
            --completed: #A2D5C6;
            --daily: #CFFFE2;
            --deadline: #FF6B6B;
            --gold: #E0E0E0;
            --shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
            --mystery-1: #333;
            --mystery-2: #111;
        }

        /* 3. ÁôΩÈõæ (Fog) - Â∑•‰∏öÂÜ∑Ê∑°È£é */
        [data-theme="fog"] {
            --bg: #EFF2F2;
            --bg-rgb: 239, 242, 242;
            --card-bg: #FFFFFF;
            --text: #22303E;
            --accent: #5D6973;
            --accent-rgb: 93, 105, 115;
            --highlight: #B7BEBD;
            --completed: #5D6973;
            --daily: #78909C;
            --deadline: #D32F2F;
            --gold: #FFB74D;
            --shadow: 0 4px 15px rgba(34, 48, 62, 0.05);
            --mystery-1: #CFD8DC;
            --mystery-2: #B0BEC5;
        }

        /* 4. ËìùÁôΩ (Dream) - ÊüîËΩØÁöÑ‰∫ëÁ´Ø */
        [data-theme="dream"] {
            --bg: #DFF2FC;
            --bg-rgb: 223, 242, 252;
            --card-bg: #FCF8E7;
            --text: #546E7A;
            --accent: #95C2E2;
            --accent-rgb: 149, 194, 226;
            --highlight: #A6D0F1;
            --completed: #81D4FA;
            --daily: #B39DDB;
            --deadline: #F48FB1;
            --gold: #FFE082;
            --shadow: 0 4px 15px rgba(149, 194, 226, 0.15);
            --mystery-1: #E1F5FE;
            --mystery-2: #B3E5FC;
        }

        /* 5. ÈùíÊü† (Lime) - Ê≤ªÊÑàÁöÑÊ§çÁâ©Á≥ª */
        [data-theme="lime"] {
            --bg: #E3F0E5;
            --bg-rgb: 227, 240, 229;
            --card-bg: #FFFFFF;
            --text: #33691E;
            --accent: #81C784;
            --accent-rgb: 129, 199, 132;
            --highlight: #C8E6CA;
            --completed: #66BB6A;
            --daily: #4DB6AC;
            --deadline: #FF7043;
            --gold: #DCE775;
            --shadow: 0 4px 15px rgba(129, 199, 132, 0.1);
            --mystery-1: #DCEDC8;
            --mystery-2: #C5E1A5;
        }

        /* ÂÖ®Â±ÄÂπ≥ÊªëËøáÊ∏° */
        body, .view, .mini-card, .btn, .status-bar, .nav-bar, .cell, input, select, textarea {
            transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'JetBrains Mono', 'Noto Serif SC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 100px; padding-top: 60px; }
        body.no-scroll { overflow: hidden; height: 100vh; touch-action: none; }

        /* --- ‰æßËæπÊ†èÊ†∑Âºè --- */
        .menu-btn {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }

        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        #sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--accent);
            color: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .sidebar-header h2 {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .sidebar-close {
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            font-weight: 300;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        .sidebar-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        .sidebar-menu-item:active {
            background: rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
        }
        .menu-icon {
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }

        /* --- È°∂ÈÉ®‰∏éÂØºËà™ --- */
        .status-bar {
            background: var(--bg); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            border-bottom: 1px solid rgba(139, 90, 43, 0.1);
            height: 55px; opacity: 0.98;
        }
        .status-left { display: flex; flex-direction: column; }
        .app-name { font-weight: bold; font-size: 0.75rem; color: var(--accent); white-space: nowrap; }
        .sys-clock { font-size: 0.7rem; color: var(--text); opacity: 0.7; font-family: 'JetBrains Mono'; }
        .balance-pill {
            background: var(--text); color: var(--gold); padding: 4px 10px;
            border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
        }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg);
            display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px 0; border-top: 1px solid rgba(0,0,0,0.05); z-index: 1000;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; color: var(--text); opacity: 0.4; gap: 4px; transition: all 0.2s; cursor: pointer; }
        .nav-item.active { opacity: 1; transform: translateY(-2px); font-weight: bold; color: var(--accent); }
        .nav-icon { font-size: 1.3rem; }
        
        .add-icon-circle {
            width: 45px; height: 45px; background: var(--accent); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--bg); font-size: 1.8rem; font-weight: 300;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transform: translateY(-15px);
            margin-bottom: -20px; 
        }

        /* --- Â∏ÉÂ±ÄÁ±ª --- */
        .container { width: 92%; max-width: 500px; margin: 0 auto; padding-top: 10px; }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI ÁªÑ‰ª∂ --- */
        .btn { width: 100%; padding: 12px; background: var(--accent); color: var(--bg); border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; font-size: 0.9rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
        .btn-sec { background: transparent; border: 1px solid var(--text); color: var(--text); }
        .btn-danger { background: rgba(198, 40, 40, 0.1); color: #c62828; border: 1px solid #c62828; }
        .input-group { margin-bottom: 15px; } 
        .input-group label { color: var(--text); font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: block; opacity: 0.8; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; background: var(--card-bg); color: var(--text); font-family: inherit; font-size: 0.9rem; }

        /* --- Ê†∏ÂøÉ‰∏öÂä°Ê†∑Âºè --- */
        .cal-nav { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .weekday { text-align: center; font-size: 0.7rem; color: var(--text); opacity: 0.6; margin-bottom: 5px; }
        .cal-day { aspect-ratio: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(0,0,0,0.05); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; position: relative; cursor: pointer; transition: background 0.2s; color: var(--text); }
        .cal-day.today { border: 2px solid var(--accent); background: var(--card-bg); font-weight: bold; }
        .cal-day.has-data::after { content: ''; width: 4px; height: 4px; background: var(--completed); border-radius: 50%; position: absolute; bottom: 4px; }
        .cal-day:active { opacity: 0.7; }
        
        .mini-card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #ccc; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); cursor: pointer; }
        
        .bingo-grid { display: grid; gap: 5px; margin: 15px 0; }
        .cell { aspect-ratio: 1; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.75rem; border: 2px solid transparent; padding: 2px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; word-break: break-all; cursor: pointer; color: var(--text); }
        .cell:active { transform: scale(0.95); }
        .cell.completed { background: rgba(107, 142, 35, 0.1); border-color: var(--completed); color: var(--completed); text-decoration: line-through; opacity: 0.9; }
        [data-theme="silent"] .cell.completed { background: rgba(207, 255, 226, 0.1); color: var(--completed); }
        
        .cell.editing { border: 2px dashed var(--highlight); animation: pulse 2s infinite; }
        @keyframes pulse { 0% {border-color:var(--highlight);} 50% {border-color:transparent;} 100% {border-color:var(--highlight);} }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        /* --- ÂïÜÂ∫óÊ†∑Âºè --- */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .shop-item { background: var(--card-bg); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: var(--shadow); position: relative; transition: transform 0.1s; }
        .shop-item:active { transform: scale(0.98); }
        .shop-item.cooldown { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .shop-icon { font-size: 2.2rem; margin-bottom: 5px; }
        .shop-cost { font-size: 0.8rem; font-weight: bold; color: var(--accent); background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 10px; margin-top: 5px; }
        .shop-desc { font-size: 0.8rem; color: var(--text); opacity: 0.8; margin: 8px 0; height: 2.4em; overflow: hidden; line-height: 1.2; }
        
        .gacha-banner { 
            background: linear-gradient(135deg, var(--mystery-2), var(--text)); 
            color: #F0EAD6; 
            padding: 20px; border-radius: 16px; margin-bottom: 20px; 
            text-align: center; position: relative; overflow: hidden; 
            box-shadow: var(--shadow);
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
        }
        .gacha-banner::after { content:'?'; position: absolute; right: -10px; bottom: -20px; font-size: 6rem; opacity: 0.1; transform: rotate(-20deg); color:white; }
        .gacha-gear { position: absolute; top: 10px; right: 10px; font-size: 1.2rem; opacity: 0.7; z-index: 5; cursor: pointer; }
        
        /* --- ÂéÜÂè≤Ë¥¶ÂçïÊ†∑Âºè --- */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); font-size: 0.85rem; }
        .history-item:last-child { border-bottom: none; }
        .history-meta { font-size: 0.7rem; color: var(--text); opacity: 0.6; margin-top: 2px; }
        .history-cost { font-weight: bold; color: var(--accent); font-family: 'JetBrains Mono'; }

        /* --- ÈöæÂ∫¶ÈÄâÊã©Âô® --- */
        .difficulty-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .diff-btn { padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; text-align: center; font-size: 0.8rem; cursor: pointer; background: var(--card-bg); transition: all 0.2s; color: var(--text); }
        .diff-btn.active { border-color: var(--accent); background: var(--text); color: var(--bg); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .diff-info { font-size: 0.7rem; opacity: 0.7; margin-top: 3px; }
        
        /* --- Ê®°ÊÄÅÊ°Ü --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 6000; justify-content: center; align-items: flex-end; }
        .modal.active { display: flex; }
        .sheet { background: var(--card-bg); width: 100%; border-radius: 20px 20px 0 0; padding: 30px 20px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; color: var(--text); }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        
        /* ÁªüËÆ°Áõ∏ÂÖ≥ */
        .vesper-comment { background: var(--text); color: var(--bg); padding: 15px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; border-left: 4px solid var(--highlight); font-family: 'JetBrains Mono'; line-height: 1.5; transition: all 0.3s;}
        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; margin-top: 10px; }
        .heat-cell { aspect-ratio: 1; background: rgba(0,0,0,0.1); border-radius: 2px; }
        .heat-l1 { background: var(--mystery-1); opacity: 0.5; } 
        .heat-l2 { background: var(--mystery-1); opacity: 0.8; } 
        .heat-l3 { background: var(--completed); }

        /* Focus Filters */
        .filter-chip { display: inline-block; padding: 5px 12px; background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1); border-radius: 15px; font-size: 0.75rem; color: var(--text); opacity: 0.7; cursor: pointer; margin-right: 5px; margin-bottom: 5px;}
        .filter-chip.active { background: var(--text); color: var(--bg); border-color: var(--text); opacity: 1; }
        .filter-bar { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }

        /* Day Detail Stats */
        .day-stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px; }
        .day-stat-item div:first-child { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
        .day-stat-item div:last-child { font-size: 0.7rem; color: var(--text); opacity: 0.6; }
        
        /* Animation */
        .rotate-anim { animation: spin 0.8s ease; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Pool Editor List */
        .pool-list-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.9rem; color: var(--text);}
        .pool-list-item:last-child { border-bottom: none; }

        /* ‰æßËæπÊ†èÈù¢ÊùøÊ†∑Âºè */
        .sidebar-panel {
            display: none;
            z-index: 3000 !important;
        }
        .sidebar-panel.active {
            display: flex;
        }
        .sidebar-panel .sheet {
            max-height: 90vh;
            width: 100%;
            max-width: 600px;
            margin: auto;
        }
        .modal-on-top {
            z-index: 7000 !important;
        }

        /* --- [Vesper] QQÈ£éÊ†ºËÅäÂ§©ÂàóË°® --- */
        .qq-chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .qq-chat-item:hover {
            background: rgba(0,0,0,0.03);
        }
        .qq-chat-item:active {
            background: rgba(0,0,0,0.06);
        }
        .qq-chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        .qq-chat-info {
            flex: 1;
            overflow: hidden;
        }
        .qq-chat-name {
            font-weight: bold;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .qq-chat-desc {
            font-size: 0.8rem;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        /* Markdown ÂÜÖÂÆπÊ†∑Âºè */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content p {
            margin: 0.2em 0;
        }
        .markdown-content p:first-child { margin-top: 0; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content code {
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        .markdown-content pre code {
            background: none;
            padding: 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }
        .markdown-content li {
            margin: 0.25em 0;
        }
        .markdown-content strong {
            font-weight: bold;
        }
        .markdown-content em {
            font-style: italic;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid rgba(0,0,0,0.1);
            padding: 6px 10px;
            text-align: left;
        }
        .markdown-content th {
            background: rgba(0,0,0,0.05);
            font-weight: bold;
        }

        /* ÈïøÊåâËèúÂçïÊ†∑Âºè */
        .context-menu {
            display: none;
            position: fixed;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            padding: 8px 0;
            min-width: 160px;
        }
        .context-menu.active {
            display: block;
        }
        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            color: var(--text);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(0,0,0,0.05);
        }
        .context-menu-item:active {
            opacity: 0.7;
        }

        /* --- [Vesper] Â§öÈÄâÊ®°ÂºèÊ†∑Âºè --- */
        .multi-select-mode .chat-message-bubble {
            cursor: pointer;
        }
        .chat-message-bubble.selected {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            opacity: 0.9;
        }
        .multi-select-toolbar {
            display: none;
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 10px 20px;
            z-index: 99999 !important;
            gap: 15px;
            align-items: center;
        }
        .multi-select-toolbar.active {
            display: flex !important;
        }
        .multi-select-toolbar button {
            background: none;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text);
            transition: background 0.2s;
        }
        .multi-select-toolbar button:hover {
            background: rgba(0,0,0,0.1);
        }
        .multi-select-toolbar .delete-btn {
            color: #c62828;
        }
        .multi-select-count {
            font-weight: bold;
            color: var(--accent);
        }

        /* --- [Vesper] ÂºïÁî®Ê∂àÊÅØÊ†∑Âºè - ÂµåÂ•óÊ∞îÊ≥°ÊïàÊûú --- */
        .quote-block {
            background: var(--bg);
            border: 1px solid rgba(0,0,0,0.1);
            border-left: 3px solid var(--accent);
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .quote-block:hover {
            background: rgba(0,0,0,0.03);
            transform: translateX(2px);
        }
        .quote-block:active {
            transform: scale(0.98);
        }
        .quote-block-header {
            font-size: 0.7em;
            opacity: 0.6;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }
        .quote-block-content {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
        }
        .quote-divider {
            height: 1px;
            background: linear-gradient(to right, var(--accent), transparent);
            margin: 8px 0 6px 0;
            opacity: 0.5;
        }

        /* ÂºïÁî®È¢ÑËßàÂå∫Âüü */
        .quote-preview {
            display: none;
            background: var(--card-bg);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            margin: 0 10px 10px 10px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        .quote-preview.active {
            display: block;
        }
        .quote-preview-close {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
            font-size: 1.2rem;
        }
        .quote-preview-close:hover {
            opacity: 1;
        }

        /* --- [Vesper] AIÂØπËØùÂàóË°®‰æßËæπÊ†èÊ†∑Âºè --- */
        .ai-conversation-list-sidebar {
            position: fixed;
            right: -300px;
            top: 0;
            width: 280px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: -2px 0 20px rgba(0,0,0,0.2);
            z-index: 5001;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 15px;
        }
        .ai-conversation-list-sidebar.active {
            right: 0;
        }
        .ai-conv-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ai-conv-item:hover {
            background: rgba(var(--accent-rgb), 0.1);
            transform: translateX(-2px);
        }
        .ai-conv-item.active {
            border-color: var(--accent);
            background: rgba(var(--accent-rgb), 0.15);
        }
        .ai-conv-new {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark, var(--accent)));
            color: white;
            justify-content: center;
            text-align: center;
            flex-direction: column;
            gap: 5px;
        }
        .ai-conv-new:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
        }
        .ai-conversation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(var(--bg-rgb, 0, 0, 0), 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 5000;
        }
        .ai-conversation-overlay.active {
            display: block;
        }

        /* --- [Vesper] Áï™ËåÑÈíüSVGÂúÜÁéØÂëºÂê∏Âä®Áîª --- */
        @keyframes timer-breathing {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        @keyframes text-glow {
            0%, 100% {
                text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.3);
            }
            50% {
                text-shadow: 0 0 20px rgba(var(--accent-rgb), 0.6);
            }
        }

        #timer-progress-ring, #fullscreen-progress-ring {
            animation: timer-breathing 2s ease-in-out infinite;
        }

        #timer-display svg, #fullscreen-timer svg {
            filter: drop-shadow(0 0 15px rgba(var(--accent-rgb), 0.4));
        }

        #fullscreen-timer-text {
            animation: text-glow 3s ease-in-out infinite;
        }

        /* ÈÄÄÂá∫ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
        #fullscreen-timer button:hover {
            background: rgba(var(--accent-rgb), 0.2);
            transform: translateX(-2px);
        }

        #fullscreen-timer button:active {
            transform: translateX(-2px) scale(0.95);
        }

        /* ÊøÄÂä±ËØ≠Ê∑°ÂÖ•Âä®Áîª */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 0.5;
                transform: translateY(0);
            }
        }

        #fullscreen-motivation {
            animation: fade-in-up 1s ease-out;
        }

        /* --- [Vesper] ÊêúÁ¥¢ÁªìÊûúÈù¢ÊùøÊ†∑Âºè --- */
        .search-results-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .search-results-panel.active {
            display: flex;
        }
        .search-results-content {
            background: var(--card-bg);
            border-radius: 16px;
            max-width: 90%;
            max-height: 80%;
            width: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .search-results-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-results-header h3 {
            margin: 0;
            color: var(--accent);
        }
        .search-results-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.6;
        }
        .search-results-close:hover {
            opacity: 1;
        }
        .search-results-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .search-result-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            background: var(--bg);
            transition: all 0.2s;
        }
        .search-result-item:hover {
            background: rgba(0,0,0,0.05);
            transform: translateX(5px);
        }
        .search-result-role {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        .search-result-preview {
            font-size: 0.9rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .search-result-time {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-top: 6px;
        }
        .search-result-keyword {
            background: rgba(var(--accent-rgb, 255,165,0), 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* --- [Vesper] Ê∞îÊ≥°ÂΩ¢ÊÄÅÂ≠¶ (Bubble Morphology) --- */

        /* Âü∫Á°ÄÊ∞îÊ≥°ÊûÑÈÄ†ÔºàÊâÄÊúâ‰∏ªÈ¢òÈÄöÁî®Ôºâ */
        .chat-message-bubble {
            transition: all 0.3s ease;
            line-height: 1.4;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        /* Èò≤Ê≠¢ÂõæÁâáÂíåÈïøÈìæÊé•ÊíëÂ§ßËÅäÂ§©ÁïåÈù¢ */
        .chat-message-bubble img {
            max-width: 100%;
            height: auto;
        }
        .chat-message-bubble a {
            word-break: break-all;
        }
        .markdown-content {
            overflow-x: hidden;
            max-width: 100%;
        }
        .markdown-content pre {
            overflow-x: auto;
            max-width: 100%;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
        }

        /* KaTeX Êï∞Â≠¶ÂÖ¨ÂºèÊ†∑Âºè */
        .katex-block {
            display: block;
            text-align: center;
            margin: 0.8em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
        }
        .katex-inline {
            display: inline;
        }
        .markdown-content .katex {
            font-size: 1.1em;
        }
        .markdown-content .katex-display {
            margin: 0.5em 0;
            overflow-x: auto;
            overflow-y: hidden;
        }
        /* Á°Æ‰øùÂÖ¨ÂºèÂú®Ê∑±Ëâ≤‰∏ªÈ¢ò‰∏ã‰πüÊ∏ÖÊô∞ÂèØËßÅ */
        [data-theme="silent"] .katex {
            color: var(--text);
        }

        /* ================== ‰∏ªÈ¢òÁâπÂºÇÊÄßÊºîÂåñ ================== */

        /* 1. Default (ÁâõÁöÆÁ∫∏): Ê∏©Êöñ„ÄÅÊâãÂÜôÊÑü„ÄÅÂúÜÊ∂¶ */
        [data-theme="default"] .chat-message-bubble[data-msg-role="user"] {
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        [data-theme="default"] .chat-message-bubble[data-msg-role="assistant"] {
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
        }

        /* 2. Silent (Êó†Â£∞): ÊûÅÁÆÄ„ÄÅÁ°¨Êúó„ÄÅÈªëÂÆ¢ÁªàÁ´ØÊÑü */
        [data-theme="silent"] .chat-message-bubble {
            border-radius: 2px !important;
            font-family: 'JetBrains Mono', monospace;
        }
        [data-theme="silent"] .chat-message-bubble[data-msg-role="user"] {
            background: transparent !important;
            border: 1px solid var(--accent) !important;
            color: var(--accent) !important;
        }
        [data-theme="silent"] .chat-message-bubble[data-msg-role="assistant"] {
            background: #1a1a1a !important;
            color: #e0e0e0 !important;
            border-left: 3px solid var(--accent) !important;
        }

        /* 3. Mist (ÁôΩÈõæ): Êú¶ËÉß„ÄÅÁéªÁíÉÊãüÊÄÅ„ÄÅËΩªÁõà */
        [data-theme="mist"] .chat-message-bubble {
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.4);
        }
        [data-theme="mist"] .chat-message-bubble[data-msg-role="user"] {
            background: #eef2f5 !important;
            color: #555 !important;
            box-shadow: inset 0 0 10px rgba(255,255,255,0.8);
        }
        [data-theme="mist"] .chat-message-bubble[data-msg-role="assistant"] {
            background: rgba(255,255,255,0.6) !important;
            color: #333 !important;
        }

        /* 4. Blue (ËìùÁôΩ): Áß©Â∫è„ÄÅÊñáÊ°£„ÄÅÂõæÁ∫∏ */
        [data-theme="blue"] .chat-message-bubble {
            border-radius: 6px !important;
        }
        [data-theme="blue"] .chat-message-bubble[data-msg-role="user"] {
            background: var(--accent) !important;
            color: white !important;
        }
        [data-theme="blue"] .chat-message-bubble[data-msg-role="assistant"] {
            background: #f0f8ff !important;
            color: var(--text) !important;
            border-left: 1px solid var(--accent) !important;
        }

        /* 5. Lime (ÈùíÊü†): Ë∫ÅÂä®„ÄÅÊ≥¢ÊôÆ„ÄÅÈ´òÂØπÊØî */
        [data-theme="lime"] .chat-message-bubble {
            box-shadow: 4px 4px 0px #000;
            border: 2px solid #000;
            border-radius: 0 !important;
            font-weight: bold;
        }
        [data-theme="lime"] .chat-message-bubble[data-msg-role="user"] {
            background: var(--accent) !important;
            color: #000 !important;
        }
        [data-theme="lime"] .chat-message-bubble[data-msg-role="assistant"] {
            background: #fff !important;
            color: #000 !important;
        }

        /* --- [Vesper] AI Âë®Êä•Ê†∑Âºè --- */
        .ai-report-card {
            position: relative;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .ai-report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.15;
            z-index: 0;
        }
        .ai-report-card > * {
            position: relative;
            z-index: 1;
        }
        .ai-report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .ai-report-title {
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.3;
            max-width: 70%;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ai-report-score {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .ai-report-score-num {
            font-size: 1.8rem;
            font-weight: bold;
            line-height: 1;
        }
        .ai-report-score-label {
            font-size: 0.6rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ai-report-summary {
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        .ai-report-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .ai-report-tag {
            padding: 6px 14px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }
        .ai-report-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .ai-report-generating {
            text-align: center;
            padding: 40px 20px;
        }
        .ai-report-generating .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Âë®Êä•Ê°£Ê°àÂàóË°® */
        .report-archive-item {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .report-archive-item:hover {
            transform: translateX(5px);
        }
        .report-archive-item:active {
            transform: scale(0.98);
        }
        .report-archive-color {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            flex-shrink: 0;
        }
        .report-archive-info {
            flex: 1;
            min-width: 0;
        }
        .report-archive-title {
            font-weight: bold;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .report-archive-date {
            font-size: 0.75rem;
            opacity: 0.6;
        }
        .report-archive-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
        }
    </style>

    <style>
        /* ‰øÆÂ§çÊªëÂä®Êù°Ëøá‰∫éÁ≤óÁöÑÈóÆÈ¢ò */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* ÁßªÂä®Á´ØÂº∫Âà∂ÂÖ®Â±èÊ†∑Âºè */
        @media (max-width: 480px) {
            .sidebar-panel.active .sheet {
                width: 100vw !important;
                height: 100vh !important;
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: none !important;
                display: flex !important;
                flex-direction: column !important;
                padding: 15px !important;
            }

            /* ÈíàÂØπ AI Âä©ÊâãËÅäÂ§©Á™óÂè£ÁöÑÁâπÊÆä‰ºòÂåñ */
            #panel-ai-assistant .sheet {
                padding: 10px !important;
            }
            
            /* ËÅäÂ§©ÂÜÖÂÆπÂå∫ÂüüÈ´òÂ∫¶Ë∞ÉÊï¥ÔºåÁ°Æ‰øùËæìÂÖ•Ê°Ü‰∏çË¢´È°∂Âá∫ */
            #ai-chat-container {
                flex: 1 !important;
                height: auto !important;
                max-height: none !important;
                margin-bottom: 10px !important;
            }

            /* Á°Æ‰øùËæìÂÖ•Ê°ÜÂå∫ÂüüÂèØËßÅ */
            #panel-ai-assistant .input-group {
                margin-bottom: 0 !important;
            }
        }

        /* --- [Vesper] ‰øÆÂ§çÁßªÂä®Á´ØËÅäÂ§©ËæìÂÖ•Ê°ÜË¢´ÈîÆÁõòÈÅÆÊå° --- */
        #character-chat-screen > div:last-of-type {
            position: fixed !important; /* ‰ΩøÁî® !important Ë¶ÜÁõñÂÜÖËÅîÊ†∑Âºè */
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            padding-bottom: max(15px, env(safe-area-inset-bottom)) !important;
            z-index: 5001;
        }
        #character-chat-messages {
            padding-bottom: 130px !important; /* ÁïôÂá∫ËæìÂÖ•Ê°ÜÁöÑÁ©∫Èó¥ (Âê´Â∑•ÂÖ∑Ê†è) */
        }

        /* --- [Vesper] ÊàòÊúØÂ∑•ÂÖ∑Ê†èÊ†∑Âºè --- */
        .tool-icon {
            cursor: pointer; opacity: 0.6; transition: all 0.2s;
            color: var(--text);
            display: flex; align-items: center; justify-content: center;
        }
        .tool-icon:hover {
            opacity: 1; transform: translateY(-2px); color: var(--accent);
        }
        .tool-icon:active {
            transform: scale(0.9);
        }
        .tool-icon.active {
            opacity: 1;
            color: var(--accent);
            animation: breathing 2s ease-in-out infinite;
        }
        @keyframes breathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Á¶ªÁ∫øÊ®°ÂºèÊ†∑Âºè */
        body.offline-mode {
            filter: grayscale(10%);
        }
        body.offline-mode::before {
            content: 'Á¶ªÁ∫øÊ®°Âºè';
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 9999;
            pointer-events: none;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #network-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>

    <!-- Markdown-it CDN -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- Dexie.js for IndexedDB -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
</head>
<body>

    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="status-bar">
        <span class="menu-btn" onclick="toggleSidebar()">‚ò∞</span>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="app-name">Tara's LifeOS Chronos BinGO</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span id="network-indicator" style="font-size:12px; cursor:help;" title="ÁΩëÁªúÁä∂ÊÄÅ">üü¢</span>
                <div class="sys-clock" id="sys-clock">00:00</div>
            </div>
            <div class="balance-pill">
                <span>ü™ô</span>
                <span id="balance-display">0</span>
            </div>
        </div>
    </div>

    <!-- ‰æßËæπÊ†èÈÅÆÁΩ© -->
    <div id="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- ‰æßËæπÊ†è -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h2>Vesper ÊéßÂà∂Âè∞</h2>
            <span class="sidebar-close" onclick="closeSidebar()">√ó</span>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-menu-item" onclick="openSidebarPanel('ai-assistant')">
                <span class="menu-icon" style="display:flex;align-items:center;justify-content:center;"><img src="data:image/webp;base64,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BMYhcYBdTRiotB9FDxps/nyt5rEjV0jT6upGRixAXTfAU/lGADFIpGAXU1ATGIXGAXU1ATGH9CpA0wtLIxMT0Yc+YvWvJTzB47pjEXkyrKigfkgwi20zupqAmMQuMAupqAmMQpr1JY6OrZFCzdbZeiQNMxgDrKqagLGAy3tqzK5i4wC6moCYxC4wC6moCYwdn7mZ6lXVDTJZzwtNS5Q2LmiuAp/AtwviLbTO6moCYxC4wC6moCYxC4vR8BQM9Q3+WbfjbxFqSwFIoRQPyQYRbaZ3U1ATGIXGAXU1ATGIXGAXECt9wvaACrrBI1iPKF3Bzvi6g67HcD8ftM7qagJjELjALqagJjELjALqW68wgvSFAAWUU+/E8rqP6U9uX5XMXGAXU1ATGIXGAXU1ATGIXGAXFr0dagtFpnyKKK9vAXU1ATGIXGAXU1ATGIXGAXU1ATGIU1hF0ZmVCr4xiPifHsp/AqeI7qagJjELjALqagJjELjALqagJjELckbDlD6/BdVvkHE37i4BXmMQuMAupqAmMQuMAupqAmMQuMAupacsyaeun2iOslrFUop8L/E8rmLjALqagJjELjALqagJjELjALpsIaJ1/1srmKYF81RFndTUBMYhcYBdTUBMYhcYBdTUBMYhcX/bxQgo6Q7DiSmz9cqF1NQExiFxgF1NQExiFxgF1NQExiFxgFxAiz65u6ulM6ILb8WIF1NQExiFxgF1NQExiFxgF1NQExiFxgFxIu+w+j4iEMj/80BP5XMXGAXU1ATGIXGAXU1ATGIXGAXU1ATFRpFEKex14PS7gdATY0QuMAupqAmMQuMAupqAmMQuMAupqAmMQpw7OGEFzmy15jELjALqagJjELjALqagJjELjALqagJjCAXpRX477VmVzFxgF1NQExiFxgF1NQExiFxgF1NQExh/MrY4JzV/xw3OzupqAmMQuMAupqAmMQuMAupqAmMQuMAupori8omUXpt+8yuYuMAupqAmMQuMAupqAmMQuMAupqAmMP9yV7Feel0s6zMrmLjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJioAAP7FzQAAAAAAAAAAAAAABdGJPp1NV+zG2bLCQXvIX5kF2Jbm4aNgxXXPsRu5JXnFJbB69pUT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" style="width:24px;height:24px;border-radius:50%;object-fit:cover;"></span>
                <span>AIÂä©Êâã</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('api-config')">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span>APIËÆæÁΩÆ</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('character-manager')">
                <span class="menu-icon">üìá</span>
                <span>‰ø°ÊÅØÁÆ°ÁêÜ</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('world-book-manager')">
                <span class="menu-icon">üìö</span>
                <span>‰∏ñÁïå‰π¶</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('background-activity')">
                <span class="menu-icon">üîÑ</span>
                <span>ÂêéÂè∞Ê¥ªÂä®</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('cloud-backup')">
                <span class="menu-icon">‚òÅÔ∏è</span>
                <span>‰∫ëÂ§á‰ªΩ</span>
            </div>
            <div class="sidebar-menu-item" onclick="openSidebarPanel('data-manager')">
                <span class="menu-icon">üìä</span>
                <span>Êï∞ÊçÆÁÆ°ÁêÜ</span>
            </div>
        </div>
    </div>

    <!-- 1. Êó•ÂéÜ (Calendar) -->
    <div id="view-calendar" class="view active container">
        <div class="cal-nav">
            <div class="cal-btn" onclick="changeMonth(-1)" style="cursor:pointer; padding:5px;">‚Äπ</div>
            <div style="text-align:center;">
                <div style="font-weight:bold; color:var(--accent);" id="cal-title">Month</div>
                <div style="font-size:0.7rem; color:var(--text); opacity:0.6;" id="cal-year">Year</div>
            </div>
            <div class="cal-btn" onclick="changeMonth(1)" style="cursor:pointer; padding:5px;">‚Ä∫</div>
        </div>
        <div style="text-align:center; margin-bottom:10px;">
            <span onclick="resetToToday()" style="font-size:0.75rem; padding:4px 10px; background:var(--card-bg); border-radius:15px; border:1px solid rgba(0,0,0,0.1); cursor:pointer;">‚Ü∫ ÂõûÂà∞‰ªäÂ§©</span>
        </div>
        <div class="calendar-grid" id="calendar-body"></div>
        <h3 style="margin:20px 0 10px;">üìë ËøõË°å‰∏≠</h3>
        <div id="active-list"></div>
        <div style="height:20px;"></div>
    </div>

    <!-- 2. ÁÑ¶ÁÇπ (Focus) -->
    <div id="view-focus" class="view container">
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; text-align:center; position:relative; box-shadow:var(--shadow);">
            <div style="position:absolute; right:15px; top:15px; font-size:1.5rem; cursor:pointer;" onclick="rollDice()">üé≤</div>
            <h2>‰ªäÊó•ÁÑ¶ÁÇπ</h2>
            <p style="font-size:0.8rem; opacity:0.6;">ÂëΩËøêËøáÊª§Âô®Â∑≤Â∞±Áª™„ÄÇ</p>
        </div>
        <div style="margin: 10px 0; font-size:0.75rem; opacity:0.7;">üéØ ÊäΩÁ≠æËåÉÂõ¥ (ÁÇπÂáªÈÄâ‰∏≠):</div>
        <div id="focus-filter" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom:15px;"></div>
        <div id="focus-list"></div>
    </div>

    <!-- 3. ÂïÜÂ∫ó (Shop) -->
    <div id="view-shop" class="view container">
        <div class="gacha-banner" onclick="openGacha(event)">
            <div class="gacha-gear" onclick="openGachaEditor(event)">‚öôÔ∏è</div>
            <h2> ÊÉäÂñúÁõ≤Áõí</h2>
            <p style="font-size:0.8rem; opacity:0.9;">100 ü™ô / Ê¨° ¬∑ ‰∏ìÊ≤ªÈÄâÊã©Âõ∞Èöæ</p>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3> ÊÑøÊúõÊ∏ÖÂçï</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn-sec" style="width:auto; padding:4px 10px; font-size:0.7rem;" onclick="openHistory()">- Ë¥¶Âçï</button>
                <button class="btn-sec" style="width:auto; padding:4px 10px; font-size:0.7rem;" onclick="openAddItemModal()">+ ËøõË¥ß</button>
            </div>
        </div>
        <div id="shop-list" class="shop-grid"></div>
        <p style="text-align:center; font-size:0.7rem; opacity:0.5; margin-top:20px;">‚ÄúÂè™ÊúâÂæó‰∏çÂà∞ÁöÑÔºåÊâçÊòØÊúÄÂ•ΩÁöÑ„ÄÇ‚Äù ‚Äî‚Äî Vesper</p>
    </div>

    <!-- 4. ‰ª™Ë°®Áõò (Stats) -->
    <div id="view-stats" class="view container">
        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
            <button class="btn-sec" id="btn-refresh" style="font-size:0.75rem; padding:6px 15px; border-radius:20px; border:1px solid rgba(0,0,0,0.1); display:flex; align-items:center; gap:5px; background:var(--card-bg);" onclick="manualRefresh()">
                <span>‚Üª</span> ÂêåÊ≠•Êï∞ÊçÆÊµÅ
            </button>
        </div>
        <div class="vesper-comment" id="vesper-report">...</div>

        <!-- Theme Switcher -->
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:var(--shadow);">
            <h3 style="margin-bottom:15px; font-size:1rem;">üé® ËßÜËßâË∞ÉÂà∂</h3>
            <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; justify-items:center;">
                <div onclick="setTheme('default')" style="width:30px; height:30px; background:#F0EAD6; border-radius:50%; border:2px solid #8B5A2B; cursor:pointer;" title="Default"></div>
                <div onclick="setTheme('silent')" style="width:30px; height:30px; background:#000000; border-radius:50%; border:2px solid #CFFFE2; cursor:pointer;" title="Êó†Â£∞"></div>
                <div onclick="setTheme('fog')" style="width:30px; height:30px; background:#EFF2F2; border-radius:50%; border:2px solid #5D6973; cursor:pointer;" title="ÁôΩÈõæ"></div>
                <div onclick="setTheme('dream')" style="width:30px; height:30px; background:#DFF2FC; border-radius:50%; border:2px solid #95C2E2; cursor:pointer;" title="ËìùÁôΩ"></div>
                <div onclick="setTheme('lime')" style="width:30px; height:30px; background:#E3F0E5; border-radius:50%; border:2px solid #81C784; cursor:pointer;" title="ÈùíÊü†"></div>
            </div>
            <p style="font-size:0.7rem; color:var(--text); opacity:0.6; margin-top:10px; text-align:center;">‚ÄúÈ¢úËâ≤Âç≥ÊÉÖÁª™„ÄÇ‚Äù</p>
        </div>

        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:var(--shadow);">
            <h3 style="margin-bottom:15px; font-size:1rem;">üé¨ Ê¥ªË∑ÉÁÉ≠ÂäõÂõæ</h3>
            <div class="heatmap-grid" id="heatmap-body"></div>
        </div>
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:var(--shadow);">
            <h3 style="margin-bottom:15px; font-size:1rem;">üìà ‰∏ìÊ≥®Â∫¶Ë∂ãÂäø</h3>
            <div style="position:relative; height:180px; width:100%;"><canvas id="chart-line"></canvas></div>
        </div>
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:var(--shadow);">
            <h3 style="margin-bottom:15px; font-size:1rem;">üç∞ ËÉΩÈáèÂàÜÈÖç</h3>
            <div style="position:relative; height:150px; width:100%;"><canvas id="chart-pie"></canvas></div>
        </div>

        <!-- AI Âë®Êä•Âå∫Âüü -->
        <div style="background:linear-gradient(135deg, var(--accent), var(--highlight)); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:var(--shadow); color:var(--bg);">
            <h3 style="margin-bottom:10px; font-size:1rem; display:flex; align-items:center; gap:8px;">‚ú® AI Âë®Êä•</h3>
            <p style="font-size:0.8rem; opacity:0.9; margin-bottom:15px; line-height:1.5;">ËÆ© Vesper ÂàÜÊûê‰Ω†ËøáÂéª7Â§©ÁöÑÊï∞ÊçÆÔºåÁîüÊàê‰∏Ä‰ªΩÁã¨ÁâπÁöÑÂë®Êä•Âç°Áâá„ÄÇ</p>
            <button class="btn" style="background:var(--bg); color:var(--text); margin-top:0;" onclick="generateAIWeeklyReport()">‚ú® ÁîüÊàê AI Âë®Êä•</button>
        </div>

        <button class="btn" style="background:var(--text); color:var(--bg);" onclick="generateWeeklyReport()">ÁîüÊàêÊú¨Âë®ÂàÜÊûêÊä•Âëä </button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="switchTab('archive')"> ËøõÂÖ•ÂéÜÂè≤Ê°£Ê°àÂÆ§</button>
    </div>

    <!-- 5. Ê°£Ê°à (Archive) -->
    <div id="view-archive" class="view container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <button class="btn-sec" style="width:auto; padding:5px 10px;" onclick="switchTab('stats')">‚Üê ËøîÂõû</button>
            <h2>Ê°£Ê°àÂÆ§</h2>
        </div>

        <!-- Âë®Êä•Ê°£Ê°àÂå∫Âùó -->
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:var(--shadow);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="font-size:1rem; margin:0;">‚ú® AI Âë®Êä•Ê°£Ê°à</h3>
                <span style="font-size:0.75rem; opacity:0.6;" id="report-archive-count">0 ‰ªΩÊä•Âëä</span>
            </div>
            <div id="report-archive-list" style="max-height:300px; overflow-y:auto;">
                <p style="text-align:center; opacity:0.5; font-size:0.85rem; padding:20px 0;">ÊöÇÊó†Â≠òÊ°£ÁöÑÂë®Êä•</p>
            </div>
        </div>

        <!-- È°πÁõÆÊ°£Ê°àÂå∫Âùó -->
        <div style="background:var(--card-bg); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:var(--shadow);">
            <h3 style="font-size:1rem; margin:0 0 15px 0;">üì¶ È°πÁõÆÊ°£Ê°à</h3>
            <div style="margin-bottom:15px;">
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    <div class="filter-chip active" onclick="filterArchive('all', this)">ÂÖ®ÈÉ®</div>
                    <div class="filter-chip" onclick="filterArchive('üìö Â≠¶‰π†', this)">üìö Â≠¶‰π†</div>
                    <div class="filter-chip" onclick="filterArchive('üè† ÁîüÊ¥ª', this)">üè† ÁîüÊ¥ª</div>
                    <div class="filter-chip" onclick="filterArchive('üéÆ Â®±‰πê', this)">üéÆ Â®±‰πê</div>
                    <div class="filter-chip" onclick="filterArchive('üé® ÂàõÈÄ†', this)">üé® ÂàõÈÄ†</div>
                </div>
            </div>
            <div id="archive-list"></div>
        </div>

        <!-- Êï∞ÊçÆÊéßÂà∂Âè∞ -->
        <div style="background:var(--card-bg); padding:20px; border-radius:16px; border:1px dashed rgba(0,0,0,0.1);">
            <h3 style="color:var(--accent);"> Êï∞ÊçÆÊéßÂà∂Âè∞</h3>
            <button class="btn" onclick="exportData()"> Â§á‰ªΩÊï∞ÊçÆ (.json)</button>
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed rgba(0,0,0,0.1);">
                <input type="file" id="file-import" style="display:none" onchange="handleFile(this)">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-sec" onclick="triggerImport('merge')"> ËûçÂêà</button>
                    <button class="btn btn-danger" onclick="triggerImport('overwrite')"> Ë¶ÜÁõñ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèËßÜÂõæ -->
    <div id="view-game" class="view container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <span onclick="switchTab('calendar')" style="color:var(--text); opacity:0.5; cursor:pointer;">‚Üê ËøîÂõû</span>
            <span id="game-badge" style="font-size:0.8rem; font-weight:bold;">Normal</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h2 id="game-title" style="color:var(--accent);">Theme</h2>
             <button id="btn-edit-mode" style="font-size:0.75rem; padding:4px 8px; border:1px solid rgba(0,0,0,0.2); background:var(--card-bg); border-radius:5px; color:var(--text);" onclick="toggleEditMode()">‚úé ‰øÆÊîπ</button>
        </div>
        <div id="game-deadline" style="text-align:center; margin:8px 0; font-size:0.8rem; color:var(--deadline); font-weight:bold; display:none;"></div>
        <div id="bingo-board" class="bingo-grid"></div>
        <div style="background:var(--card-bg); padding:15px; border-radius:10px; font-size:0.8rem; color:var(--text); margin-top:15px; box-shadow: var(--shadow); border-left: 3px solid var(--accent);">
            <span style="font-weight:bold;">Vesper:</span> <span id="vesper-msg">...</span>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn btn-sec" onclick="archiveCurrent()"> ÂΩíÊ°£</button>
            <button class="btn btn-danger" onclick="deleteCurrent()"> Âà†Èô§</button>
        </div>
        <div id="journal-area" style="display:none; margin-top:20px;">
            <h3>üìù ÈöèÁ¨î</h3>
            <textarea id="inp-journal" style="width:100%; height:100px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.1); margin-top:5px; font-family:inherit;" placeholder="ËÆ∞ÂΩï‰Ω†Âú®ÂÅöËøô‰∏™‰ªªÂä°Êó∂ÁöÑÊÉ≥Ê≥ï„ÄÅÊÑüÂèó..."></textarea>
            <button class="btn" onclick="saveJournal()">‰øùÂ≠òÈöèÁ¨î</button>
        </div>
        <!-- ÂΩíÊ°£‰∏ìÂ±ûÔºöÊÄªÁªìÊ°Ü -->
        <div id="summary-area" style="display:none; margin-top:20px;">
            <h3>üìã ÊÄªÁªì</h3>
            <textarea id="inp-summary" style="width:100%; height:120px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.1); margin-top:5px; font-family:inherit;" placeholder="ÂÆåÊàêËøô‰∏™‰ªªÂä°ÂêéÁöÑÊï¥‰ΩìÊÄªÁªì„ÄÅÊî∂Ëé∑„ÄÅÂèçÊÄù..."></textarea>
            <button class="btn" onclick="saveSummary()">‰øùÂ≠òÊÄªÁªì</button>
        </div>
        <!-- ÂΩíÊ°£‰∏ìÂ±ûÂäüËÉΩÂå∫ -->
        <div id="archive-actions-area" style="display:none; margin-top:20px; padding:15px; background:rgba(0,0,0,0.02); border-radius:12px; border:1px dashed var(--accent);">
            <h3 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--accent);">‚ú® ÂΩíÊ°£ÂõûÈ°æÂäüËÉΩ</h3>
            <div id="archive-review-display" style="display:none; background:rgba(0,0,0,0.03); padding:12px; border-radius:8px; margin-bottom:12px; border-left:3px solid var(--accent);">
                <div style="font-weight:bold; font-size:0.75rem; margin-bottom:5px; opacity:0.7;">Vesper ËØÑËØ≠:</div>
                <div id="archive-review-text" style="font-style:italic; font-size:0.85rem; line-height:1.5;"></div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" id="btn-gen-review" onclick="generateArchiveReviewForCurrent()">‚ú® ÁîüÊàêËØÑËØ≠</button>
                <button class="btn btn-sec" id="btn-share-to-chat" onclick="openShareToCharacterModal()" style="display:none;">üì§ ÂàÜ‰∫´ÁªôËßíËâ≤</button>
            </div>
        </div>
    </div>

    <!-- Êñ∞Âª∫ËßÜÂõæ -->
    <div id="view-create" class="view container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Êñ∞Âª∫ËÆ°Âàí</h2>
            <button class="btn-sec" style="width:auto; padding:5px 12px; font-size:0.75rem; display:flex; align-items:center; gap:5px;" onclick="openAiTaskGenerator()">
                <span>ü§ñ</span> AIÂä©Êâã
            </button>
        </div>
        <div class="input-group"><label>Ê®°Âºè</label><select id="inp-mode" onchange="toggleDeadline(this.value)"><option value="normal">ÊôÆÈÄöÊ®°Âºè</option><option value="daily">ÊØèÊó•Âæ™ÁéØ</option><option value="deadline">ÊúüÈôêÊåëÊàò</option></select></div>
        <div class="input-group" id="grp-date" style="display:none;"><label>Êà™Ê≠¢</label><input type="date" id="inp-date"></div>
        <div class="input-group"><label>‰∏ªÈ¢ò</label><input type="text" id="inp-theme" placeholder="e.g. 2026 È£ûÂçáËÆ°Âàí"></div>
        <div class="input-group"><label>ÂàÜÁ±ª</label><select id="inp-tag"><option value="Â≠¶‰π†"> Â≠¶‰π†</option><option value="ÁîüÊ¥ª"> ÁîüÊ¥ª</option><option value="Â®±‰πê"> Â®±‰πê</option><option value="ÂàõÈÄ†"> ÂàõÈÄ†</option></select></div>
        <div class="input-group"><label>ËßÑÊ†º</label><select id="inp-size"><option value="3">3x3 (ÈÄüÊàòÈÄüÂÜ≥)</option><option value="4" selected>4x4 (Ê†áÂáÜ)</option><option value="5">5x5 (ÈïøÊúüÊàò)</option></select></div>
        
        <div class="input-group">
            <label>ÈöæÂ∫¶ÂÆöÁ∫ß (ÂÜ≥ÂÆöÁßØÂàÜÊî∂Áõä)</label>
            <div class="difficulty-selector">
                <div class="diff-btn active" onclick="setDifficulty('easy', this)">
                    <div> ÁîüÂ≠òÁª¥ÊåÅ</div><div class="diff-info">Line +5 / Board +20</div>
                </div>
                <div class="diff-btn" onclick="setDifficulty('normal', this)">
                    <div> Êó•Â∏∏Êé®Ëøõ</div><div class="diff-info">Line +10 / Board +50</div>
                </div>
                <div class="diff-btn" onclick="setDifficulty('hard', this)">
                    <div> ÊîªÂùöÊàò</div><div class="diff-info">Line +20 / Board +100</div>
                </div>
                <div class="diff-btn" onclick="setDifficulty('hell', this)">
                    <div> Ê≠ªÁ∫øÊåëÊàò</div><div class="diff-info">Line +50 / Board +300</div>
                </div>
                <div class="diff-btn" onclick="setDifficulty('custom', this)">
                    <div>üéØ Ëá™ÂÆö‰πâ</div><div class="diff-info">Ëá™Ë°åËÆæÂÆöÂ•ñÂä±</div>
                </div>
            </div>
        </div>
        <div id="custom-difficulty-inputs" style="display:none; margin-top:10px; padding:15px; background:rgba(0,0,0,0.03); border-radius:8px; border-left:3px solid var(--accent);">
            <div style="font-size:0.8rem; font-weight:bold; margin-bottom:10px; color:var(--accent);">Ëá™ÂÆö‰πâÁßØÂàÜÊî∂Áõä</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div>
                    <label style="font-size:0.75rem; opacity:0.7;">ËøûÁ∫øÁßØÂàÜ ü™ô</label>
                    <input type="number" id="custom-line-points" value="15" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(0,0,0,0.1); margin-top:3px;">
                </div>
                <div>
                    <label style="font-size:0.75rem; opacity:0.7;">Ê∏ÖÁõòÁßØÂàÜ ü™ô</label>
                    <input type="number" id="custom-board-points" value="80" style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(0,0,0,0.1); margin-top:3px;">
                </div>
            </div>
            <div style="font-size:0.7rem; opacity:0.6; margin-top:8px; line-height:1.4;">üí° ÊèêÁ§∫:ÊøÄÂä±ÂøÖÈ°ª‰∏éÂä™ÂäõÊàêÊØî‰æã„ÄÇÂèÇËÄÉ:ÁÆÄÂçï‰ªªÂä°(5/20),Êó•Â∏∏‰ªªÂä°(10/50),Âõ∞Èöæ‰ªªÂä°(20/100),Âú∞Áã±ÈöæÂ∫¶(50/300)</div>
        </div>

        <div class="input-group"><label>‰ªªÂä°ÂàóË°® (ÊØèË°å‰∏Ä‰∏™ÔºåÁ©∫Ë°åËá™Âä®Â°´ÂÖÖFree)</label><textarea id="inp-tasks" style="height:120px" placeholder="Task 1&#10;Task 2..."></textarea></div>
        <button class="btn" onclick="createProject()">ÂêØÂä®</button>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <div class="nav-bar">
        <div class="nav-item active" id="nav-calendar" onclick="switchTab('calendar')"><span class="nav-icon">üìÖ</span><span>Êó•ÂéÜ</span></div>
        <div class="nav-item" id="nav-focus" onclick="switchTab('focus')"><span class="nav-icon">üéØ</span><span>ÁÑ¶ÁÇπ</span></div>
        <div class="nav-item" id="nav-create-tab" onclick="switchTab('create')">
            <div class="add-icon-circle">+</div>
        </div>
        <div class="nav-item" id="nav-shop" onclick="switchTab('shop')"><span class="nav-icon">üõí</span><span>ÂïÜÂ∫ó</span></div>
        <div class="nav-item" id="nav-stats" onclick="switchTab('stats')"><span class="nav-icon">üìä</span><span>Êï∞ÊçÆ</span></div>
    </div>

    <!-- ÂºπÁ™ó: ÁîüÁâ©Áä∂ÊÄÅÊä•Âëä -->
    <div id="modal-status-report" class="modal"><div class="sheet">
        <h3>üß¨ ÁîüÁâ©Áä∂ÊÄÅÊä•Âëä</h3>
        <p style="font-size:0.8rem; opacity:0.6; margin-bottom:15px;">ÂêëÁ≥ªÁªüÂêåÊ≠•‰Ω†ÁöÑÂΩìÂâçÁä∂ÊÄÅ„ÄÇ</p>
        
        <div class="input-group">
            <label>‚ö° ËÉΩÈáèÂÄº (Energy): <span id="status-energy-val">50%</span></label>
            <input type="range" id="status-energy" min="0" max="100" value="50" style="width:100%;" oninput="document.getElementById('status-energy-val').innerText = this.value + '%'">
        </div>

        <div class="input-group">
            <label>üß† ÊÉÖÁª™ (Mood)</label>
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <div class="diff-btn" onclick="selectMood('Anxious', this)">üò∞ ÁÑ¶Ëôë (Anxious)</div>
                <div class="diff-btn" onclick="selectMood('Calm', this)">üòå Âπ≥Èùô (Calm)</div>
                <div class="diff-btn" onclick="selectMood('Excited', this)">ü§© ÂÖ¥Â•ã (Excited)</div>
                <div class="diff-btn" onclick="selectMood('Low', this)">üòî ‰ΩéËêΩ (Low)</div>
                <div class="diff-btn" onclick="selectMood('Tired', this)">üò™ Áñ≤ÊÉ´ (Tired)</div>
                <div class="diff-btn" onclick="selectMood('Focused', this)">üß† ‰∏ìÊ≥® (Focused)</div>
            </div>
        </div>

        <button class="btn" onclick="confirmSendStatus()">üì° ÂèëÈÄÅÊä•Âëä</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-status-report')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÂºπÁ™ó: ÁßØÂàÜËé∑Âèñ -->
    <div id="modal-points" class="modal" style="align-items:center;"><div class="sheet" style="text-align:center; border-radius:20px;">
        <div style="font-size:3rem; animation: bounce 1s infinite;">ü™ô</div>
        <h2 style="color:var(--accent);">BINGO!</h2>
        <p style="font-size:1rem; opacity:0.7; margin:10px 0;">ËøûÁ∫øÊàêÂäüÔºåËé∑ÂæóÂ•ñÂä±</p>
        <div style="font-size:2.5rem; font-weight:bold; color:var(--gold); margin-bottom:20px;">+<span id="points-earned">0</span></div>
        <button class="btn" onclick="collectPoints()">Êî∂‰∏ã</button>
    </div></div>

    <!-- ÂºπÁ™ó: Ê∑ªÂä†ÂïÜÂìÅ -->
    <div id="modal-add-item" class="modal"><div class="sheet">
        <h3>ËøõË¥ß</h3>
        <div class="input-group"><label>ÂêçÁß∞</label><input type="text" id="new-item-name" placeholder="e.g. ÂñùÊùØÂ•∂Ëå∂"></div>
        <div class="input-group"><label>ÂõæÊ†á (Emoji)</label><input type="text" id="new-item-icon" value="ü•§" placeholder="ü•§"></div>
        <div class="input-group"><label>‰ª∑Ê†º (ü™ô)</label><input type="number" id="new-item-cost" value="20"></div>
        <div class="input-group"><label>Á±ªÂûã</label><select id="new-item-type"><option value="unlimited">Êó†ÈôêÈáè (ÈöèÊó∂ÂèØ‰π∞)</option><option value="cooldown">ÂÜ∑Âç¥Âûã (ÊØèÊó•‰∏ÄÊ¨°)</option></select></div>
        <button class="btn" onclick="addNewItem()">‰∏äÊû∂</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-add-item')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÂºπÁ™ó: ÂéÜÂè≤Ë¥¶Âçï -->
    <div id="modal-history" class="modal"><div class="sheet">
        <h3>üìú Ê∂àË¥πÊµÅÊ∞¥</h3>
        <p style="font-size:0.8rem; opacity:0.6; margin-bottom:15px;">Âø´‰πêÁöÑÊî∂ÊçÆ„ÄÇ</p>
        <div id="history-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <button class="btn" onclick="closeModal('modal-history')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- ÂºπÁ™ó: Gacha Pool Editor -->
    <div id="modal-gacha-editor" class="modal"><div class="sheet">
        <h3> ÁÆ°ÁêÜÊâ≠ËõãÊ±†</h3>
        <p style="font-size:0.8rem; opacity:0.6; margin-bottom:10px;">Vesper: "ÊÉäÂñúÂøÖÈ°ªÊòØ‰Ω†ÁúüÊ≠£ÊÉ≥Ë¶ÅÁöÑ‰∏úË•ø„ÄÇ"</p>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="new-gacha-item" placeholder="Ê∑ªÂä†Êñ∞Â•ñÂä±..." style="flex:1; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
            <button class="btn" style="width:auto; margin-top:0;" onclick="addGachaItem()">Ê∑ªÂä†</button>
        </div>
        <div id="gacha-pool-list" style="max-height:250px; overflow-y:auto; margin-bottom:20px; border-top:1px solid rgba(0,0,0,0.1);"></div>
        <button class="btn btn-sec" onclick="closeModal('modal-gacha-editor')">ÂÆåÊàê</button>
    </div></div>
    
    <!-- ÂºπÁ™ó: Êâ≠ËõãÁªìÊûú -->
    <div id="modal-gacha-result" class="modal" style="align-items:center;"><div class="sheet" style="text-align:center; border-radius:20px;">
        <div style="font-size:3rem;">üéÅ</div>
        <h3 style="opacity:0.7;">Áõ≤ÁõíÊâìÂºÄ‰∫Ü...</h3>
        <div id="gacha-result-text" style="font-size:1.5rem; font-weight:bold; color:var(--accent); margin:20px 0; min-height:50px;"></div>
        <button class="btn" onclick="closeModal('modal-gacha-result')">Â§™Ê£í‰∫Ü</button>
    </div></div>

    <!-- ÂºπÁ™ó: Áï™ËåÑÈíü/‰ªªÂä° -->
    <div id="modal-timer" class="modal"><div class="sheet">
        <h3 id="timer-title">Task</h3>
        <div class="filter-bar" style="margin:15px 0;">
            <div class="filter-chip" onclick="startTimer(0)">Áõ¥Êé•ÂÆåÊàê</div>
            <div class="filter-chip active" onclick="startTimer(25)">25m</div>
            <div class="filter-chip" onclick="startTimer(35)">35m</div>
            <div class="filter-chip" onclick="startTimer(60)">60m</div>
            <div class="filter-chip" onclick="showCustomTimer()">Ëá™ÂÆö‰πâ</div>
        </div>

        <!-- SVGÂúÜÁéØÁï™ËåÑÈíü -->
        <div id="timer-display" style="display:none; margin:30px 0; text-align:center;">
            <svg width="200" height="200" viewBox="0 0 200 200" style="transform: rotate(-90deg);">
                <!-- ËÉåÊôØÂúÜÁéØ -->
                <circle cx="100" cy="100" r="85" fill="none" stroke="rgba(var(--accent-rgb), 0.2)" stroke-width="12"/>
                <!-- ËøõÂ∫¶ÂúÜÁéØ -->
                <circle id="timer-progress-ring" cx="100" cy="100" r="85" fill="none"
                    stroke="var(--accent)" stroke-width="12"
                    stroke-dasharray="534.07" stroke-dashoffset="0"
                    stroke-linecap="round"
                    style="transition: stroke-dashoffset 1s linear;"/>
            </svg>
            <div id="timer-text" style="font-family: 'JetBrains Mono', monospace; font-size:2.5rem; margin-top:-130px; position:relative; z-index:1; color:var(--text);">25:00</div>
        </div>

        <!-- Ëá™ÂÆö‰πâÊó∂Èó¥ËæìÂÖ• -->
        <div id="custom-timer-input" style="display:none; margin:20px 0; text-align:center;">
            <input type="number" id="custom-minutes" min="1" max="120" value="25"
                style="width:80px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.1); background:var(--card-bg); color:var(--text); text-align:center; font-size:1.2rem; font-family:'JetBrains Mono', monospace;">
            <span style="margin:0 10px; font-size:1.2rem;">ÂàÜÈíü</span>
            <button class="btn" style="width:auto; padding:8px 20px;" onclick="startCustomTimer()">ÂºÄÂßã</button>
        </div>

        <button class="btn btn-sec" onclick="closeModal('modal-timer')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÂÖ®Â±èÁï™ËåÑÈíü -->
    <div id="fullscreen-timer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
        <!-- ÈÄÄÂá∫ÊåâÈíÆ - Â∑¶‰∏äËßí -->
        <button onclick="exitFullscreenTimer()" style="position:absolute; top:20px; left:20px; background:rgba(var(--accent-rgb), 0.1); border:1px solid var(--accent); color:var(--accent); padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem; z-index:10000; backdrop-filter:blur(5px); transition:all 0.2s;">
            ‚Üê ÈÄÄÂá∫
        </button>

        <!-- Á≥ªÁªüÊó∂Èó¥ - Âè≥‰∏äËßí -->
        <div id="fullscreen-system-time" style="position:absolute; top:20px; right:20px; font-family:'JetBrains Mono', monospace; font-size:1rem; color:var(--text); opacity:0.6; z-index:10000;">
            00:00:00
        </div>

        <div style="text-align:center; width:100%; padding:20px;">
            <!-- ‰ªªÂä°Ê†áÈ¢ò -->
            <h2 id="fullscreen-timer-title" style="color:var(--accent); margin-bottom:20px; font-size:1.3rem; font-weight:500; opacity:0.9;">Task</h2>

            <!-- ÂÖ®Â±èSVGÂúÜÁéØ -->
            <div style="position:relative; display:inline-block;">
                <svg width="280" height="280" viewBox="0 0 280 280" style="transform: rotate(-90deg);">
                    <circle cx="140" cy="140" r="120" fill="none" stroke="rgba(var(--accent-rgb), 0.1)" stroke-width="12"/>
                    <circle id="fullscreen-progress-ring" cx="140" cy="140" r="120" fill="none"
                        stroke="var(--accent)" stroke-width="12"
                        stroke-dasharray="753.98" stroke-dashoffset="0"
                        stroke-linecap="round"
                        style="transition: stroke-dashoffset 1s linear;"/>
                </svg>

                <!-- ÂÄíËÆ°Êó∂ÊñáÊú¨ -->
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                    <div id="fullscreen-timer-text" style="font-family: 'JetBrains Mono', monospace; font-size:3.5rem; color:var(--text); font-weight:300; line-height:1;">25:00</div>
                    <div style="font-size:0.8rem; color:var(--text); opacity:0.5; margin-top:10px;">‰∏ìÊ≥®Êó∂Èó¥</div>
                </div>
            </div>

            <!-- ËøõÂ∫¶ÁôæÂàÜÊØî -->
            <div id="fullscreen-progress-percentage" style="margin-top:30px; font-family:'JetBrains Mono', monospace; font-size:1rem; color:var(--accent); opacity:0.7;">
                100%
            </div>

            <!-- ÊøÄÂä±ËØ≠ -->
            <div id="fullscreen-motivation" style="margin-top:20px; font-size:0.9rem; color:var(--text); opacity:0.5; font-style:italic;">
                "‰∏ìÊ≥®ÊòØÈÄöÂæÄÂçìË∂äÁöÑÂîØ‰∏ÄÈÅìË∑Ø"
            </div>
        </div>
    </div>
    
    <!-- ÂºπÁ™ó: DayDetail -->
    <div id="modal-day-detail" class="modal"><div class="sheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="day-detail-date" style="color:var(--accent);">YYYY-MM-DD</h2>
            <button class="btn btn-sec" style="width:auto; padding:5px 10px; font-size:0.7rem;" onclick="closeModal('modal-day-detail')">ÂÖ≥Èó≠</button>
        </div>
        
        <div class="day-stat-grid">
            <div class="day-stat-item"><div id="dd-completed">0</div><div>Â∑≤ÂÆåÊàê</div></div>
            <div class="day-stat-item"><div id="dd-total">0</div><div>ÊÄª‰∫§‰∫í</div></div>
            <div class="day-stat-item"><div id="dd-rate">0%</div><div>ÊïàÁéá</div></div>
        </div>

        <h3 style="font-size:0.9rem; margin-bottom:10px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:5px;">üìù Ëç£ËÄÄËÆ∞ÂΩï</h3>
        <div id="day-detail-list" style="max-height:200px; overflow-y:auto; margin-bottom:20px;"></div>
    </div></div>
    
    <!-- ÂºπÁ™ó: Weekly Report Modal -->
    <div id="modal-report" class="modal"><div class="sheet">
        <h3 style="color:var(--accent); margin-bottom:10px;">üìã Vesper ÂàÜÊûêÊä•Âëä</h3>
        <div id="report-text" style="white-space:pre-wrap; font-family:'JetBrains Mono'; margin-bottom:20px; font-size:0.85rem; line-height:1.6; background:rgba(0,0,0,0.03); padding:15px; border-radius:8px; border-left:3px solid var(--accent);"></div>
        <button class="btn" onclick="closeModal('modal-report')">ÂΩíÊ°£Êä•Âëä</button>
    </div></div>

    <!-- ÂºπÁ™ó: AI Âë®Êä• Modal -->
    <div id="modal-ai-report" class="modal" style="align-items:center;"><div class="sheet" style="border-radius:20px; max-width:420px; margin:auto;">
        <div id="ai-report-content">
            <!-- ÁîüÊàê‰∏≠Áä∂ÊÄÅ -->
            <div id="ai-report-loading" class="ai-report-generating">
                <div class="spinner"></div>
                <p style="font-size:0.9rem; color:var(--text); opacity:0.8;">Vesper Ê≠£Âú®ÂàÜÊûê‰Ω†ÁöÑÊï∞ÊçÆ...</p>
                <p style="font-size:0.75rem; color:var(--text); opacity:0.5; margin-top:10px;">"ËÆ©ÊàëÁúãÁúã‰Ω†ËøôÂë®ÈÉΩÂπ≤‰∫Ü‰ªÄ‰πà..."</p>
            </div>
            <!-- Êä•ÂëäÂç°Áâá (ÁîüÊàêÂêéÊòæÁ§∫) -->
            <div id="ai-report-card-area" style="display:none;"></div>
        </div>
        <div id="ai-report-actions" style="display:none; margin-top:15px;">
            <button class="btn" onclick="saveCurrentAIReport()">üì¶ Â≠òÂÖ•Ê°£Ê°à</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-ai-report')">ÂÖ≥Èó≠</button>
        </div>
    </div></div>

    <!-- ÂºπÁ™ó: Êü•ÁúãÂ≠òÊ°£ÁöÑ AI Âë®Êä• -->
    <div id="modal-view-archived-report" class="modal" style="align-items:center;"><div class="sheet" style="border-radius:20px; max-width:420px; margin:auto;">
        <div id="archived-report-content"></div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="btn btn-sec" style="flex:1;" onclick="closeModal('modal-view-archived-report')">ÂÖ≥Èó≠</button>
            <button class="btn btn-danger" style="flex:1;" onclick="deleteCurrentArchivedReport()">Âà†Èô§</button>
        </div>
    </div></div>

    <div id="modal-edit-task" class="modal"><div class="sheet"><input type="text" id="inp-edit-task" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:var(--card-bg);color:var(--text);"><button class="btn" onclick="confirmTaskEdit()">Á°ÆËÆ§</button></div></div>

    <!-- ÂºπÁ™ó: Â≠ê‰ªªÂä°ËèúÂçï -->
    <div id="modal-subtask-menu" class="modal"><div class="sheet" style="text-align:center;">
        <h3 style="margin-bottom:20px; color:var(--accent);" id="subtask-title">‰ªªÂä°ÁÆ°ÁêÜ</h3>
        <button class="btn" onclick="createSubtask()" style="margin-bottom:10px;">üìã ÂàõÂª∫Â≠êÈ°πÁõÆ Bingo Âç°</button>
        <button class="btn btn-sec" id="btn-open-subtask" onclick="openSubtask()" style="display:none; margin-bottom:10px;">üîó ËøõÂÖ•ÂÖ≥ËÅîÂ≠êÈ°πÁõÆ</button>
        <button class="btn btn-sec" onclick="closeModal('modal-subtask-menu')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÂºπÁ™ó: ÂàÜÁªÑÁÆ°ÁêÜ -->
    <div id="modal-group-manager" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;">Â•ΩÂèãÂàÜÁªÑÁÆ°ÁêÜ</h3>
        <div class="input-group">
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-group-name" placeholder="ËæìÂÖ•Êñ∞ÂàÜÁªÑÂêçÁß∞">
                <button class="btn" style="width:auto;" onclick="addNewGroup()">Ê∑ªÂä†</button>
            </div>
        </div>
        <div id="group-list-container" style="max-height:300px; overflow-y:auto; margin-top:15px;">
            <!-- Groups will be listed here -->
        </div>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-group-manager')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- AI‰ªªÂä°ÁîüÊàêÂô®ÂºπÁ™ó -->
    <div id="modal-ai-task-generator" class="modal"><div class="sheet">
        <h3 style="color:var(--accent); margin-bottom:15px;">ü§ñ AI‰ªªÂä°ÁîüÊàêÂô®</h3>
        <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">ÊèèËø∞‰Ω†ÁöÑÁõÆÊ†á,AIÂ∞ÜËá™Âä®ÁîüÊàêBingo‰ªªÂä°ÂàóË°®</p>
        <div class="input-group">
            <label>‰Ω†ÁöÑÁõÆÊ†á</label>
            <textarea id="ai-task-goal" rows="4" placeholder="‰æãÂ¶Ç: ÊàëÊÉ≥Âú®‰∏Ä‰∏™ÊúàÂÜÖÂ≠¶‰ºöPythonÂü∫Á°ÄÁºñÁ®ã,ÂåÖÊã¨ËØ≠Ê≥ï„ÄÅÊï∞ÊçÆÁªìÊûÑÂíåÁÆÄÂçïÈ°πÁõÆ"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div class="input-group" style="flex:1;">
                <label>BingoËßÑÊ†º</label>
                <select id="ai-task-size">
                    <option value="3">3x3 (9‰∏™‰ªªÂä°)</option>
                    <option value="4" selected>4x4 (16‰∏™‰ªªÂä°)</option>
                    <option value="5">5x5 (25‰∏™‰ªªÂä°)</option>
                </select>
            </div>
            <div class="input-group" style="flex:1;">
                <label>‰ªªÂä°ÂàÜÁ±ª</label>
                <select id="ai-task-category">
                    <option value="üìö Â≠¶‰π†">üìö Â≠¶‰π†</option>
                    <option value="üè† ÁîüÊ¥ª">üè† ÁîüÊ¥ª</option>
                    <option value="üéÆ Â®±‰πê">üéÆ Â®±‰πê</option>
                    <option value="üé® ÂàõÈÄ†">üé® ÂàõÈÄ†</option>
                </select>
            </div>
        </div>
        <button class="btn" onclick="generateTasksWithAI()" id="btn-generate-tasks">üöÄ ÁîüÊàê‰ªªÂä°ÂàóË°®</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-ai-task-generator')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÈïøÊåâËèúÂçï: AI Âä©Êâã -->
    <div id="ai-context-menu" class="context-menu">
        <div class="context-menu-item" onclick="handleAiContextAction('copy')">üìã Â§çÂà∂ÂÜÖÂÆπ</div>
        <div class="context-menu-item" onclick="handleAiContextAction('edit')">‚úé ÁºñËæëÊ∂àÊÅØ</div>
        <div class="context-menu-item" onclick="handleAiContextAction('quote')">üí¨ ÂºïÁî®ÂõûÂ§ç</div>
        <div class="context-menu-item" onclick="handleAiContextAction('retry')">üîÑ Âà∑Êñ∞ÂõûÂ§ç</div>
        <div class="context-menu-item" onclick="handleAiContextAction('hide')">üôà Êí§ÂõûÊ∂àÊÅØ</div>
        <div class="context-menu-item" onclick="handleAiContextAction('multiSelect')">‚òëÔ∏è Â§öÈÄâÊ∂àÊÅØ</div>
        <div class="context-menu-item" style="color:#c62828;" onclick="handleAiContextAction('delete')">üóëÔ∏è Ê∞∏‰πÖÂà†Èô§</div>
    </div>

    <!-- ÈïøÊåâËèúÂçï: ËßíËâ≤ËÅäÂ§© -->
    <div id="character-message-menu" class="context-menu">
        <div class="context-menu-item" onclick="handleCharacterMessageAction('copy')">üìã Â§çÂà∂ÂÜÖÂÆπ</div>
        <div class="context-menu-item" onclick="handleCharacterMessageAction('edit')">‚úé ÁºñËæëÊ∂àÊÅØ</div>
        <div class="context-menu-item" onclick="handleCharacterMessageAction('quote')">üí¨ ÂºïÁî®ÂõûÂ§ç</div>
        <div class="context-menu-item" onclick="handleCharacterMessageAction('retry')">üîÑ Âà∑Êñ∞ÂõûÂ§ç</div>
        <div class="context-menu-item" onclick="handleCharacterMessageAction('hide')">üôà Êí§ÂõûÊ∂àÊÅØ</div>
        <div class="context-menu-item" onclick="handleCharacterMessageAction('multiSelect')">‚òëÔ∏è Â§öÈÄâÊ∂àÊÅØ</div>
        <div class="context-menu-item" style="color:#c62828;" onclick="handleCharacterMessageAction('delete')">üóëÔ∏è Ê∞∏‰πÖÂà†Èô§</div>
    </div>

    <!-- Â§öÈÄâÂ∑•ÂÖ∑Ê†è -->
    <div id="multi-select-toolbar" class="multi-select-toolbar">
        <span class="multi-select-count">Â∑≤ÈÄâÊã© <span id="selected-count">0</span> Êù°</span>
        <button id="multi-select-all-btn" onclick="selectAllMessages()">ÂÖ®ÈÄâ</button>
        <button id="multi-select-cancel-btn" onclick="cancelMultiSelect()">ÂèñÊ∂à</button>
        <button id="multi-select-delete-btn" class="delete-btn" onclick="deleteSelectedMessages()">üóëÔ∏è Âà†Èô§</button>
    </div>

    <!-- ÊêúÁ¥¢ÁªìÊûúÈù¢Êùø -->
    <div id="search-results-panel" class="search-results-panel" onclick="closeSearchResults(event)">
        <div class="search-results-content" onclick="event.stopPropagation()">
            <div class="search-results-header">
                <h3>ÊêúÁ¥¢ÁªìÊûú <span id="search-results-count"></span></h3>
                <button class="search-results-close" onclick="closeSearchResults()">√ó</button>
            </div>
            <div id="search-results-list" class="search-results-list"></div>
        </div>
    </div>

    <script>
        // ==================== ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜÊú∫Âà∂ ====================

        // ÈîôËØØÊó•ÂøóÂ≠òÂÇ®
        const errorLog = [];
        const MAX_ERROR_LOG = 50;

        // ÈîôËØØÁ∫ßÂà´
        const ErrorLevel = {
            INFO: 'info',
            WARNING: 'warning',
            ERROR: 'error',
            CRITICAL: 'critical'
        };

        // Áªü‰∏ÄÈîôËØØÂ§ÑÁêÜÂáΩÊï∞
        function handleError(error, context = '', level = ErrorLevel.ERROR, showToUser = true) {
            const errorInfo = {
                timestamp: new Date().toISOString(),
                level: level,
                context: context,
                message: error.message || String(error),
                stack: error.stack || '',
            };

            // ËÆ∞ÂΩïÂà∞ÈîôËØØÊó•Âøó
            errorLog.push(errorInfo);
            if (errorLog.length > MAX_ERROR_LOG) {
                errorLog.shift(); // ‰øùÊåÅÊó•ÂøóÊï∞ÈáèÂú®ÈôêÂà∂ÂÜÖ
            }

            // ÊéßÂà∂Âè∞ËæìÂá∫
            console.error(`[${level.toUpperCase()}] ${context}:`, error);

            // Áî®Êà∑ÊèêÁ§∫ÔºàÊ†πÊçÆÁ∫ßÂà´ÂíåÈÖçÁΩÆÔºâ
            if (showToUser) {
                let userMessage = '';
                switch(level) {
                    case ErrorLevel.CRITICAL:
                        userMessage = `‰∏•ÈáçÈîôËØØ: ${context}\n${error.message || 'Êú™Áü•ÈîôËØØ'}\n\nÈ°µÈù¢ÂèØËÉΩÈúÄË¶ÅÂà∑Êñ∞„ÄÇ`;
                        alert(userMessage);
                        break;
                    case ErrorLevel.ERROR:
                        userMessage = `Êìç‰ΩúÂ§±Ë¥•: ${context}\n${error.message || 'ËØ∑Á®çÂêéÈáçËØï'}`;
                        if (typeof showToast === 'function') {
                            showToast(userMessage);
                        } else {
                            alert(userMessage);
                        }
                        break;
                    case ErrorLevel.WARNING:
                        if (typeof showToast === 'function') {
                            showToast(`Ë≠¶Âëä: ${context}`);
                        }
                        break;
                }
            }

            return errorInfo;
        }

        // ÂÖ®Â±ÄÊú™ÊçïËé∑ÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', function(event) {
            handleError(event.error || new Error(event.message), 'ÂÖ®Â±ÄÈîôËØØ', ErrorLevel.ERROR, false);
        });

        // ÂÖ®Â±ÄÊú™Â§ÑÁêÜÁöÑ Promise ÈîôËØØ
        window.addEventListener('unhandledrejection', function(event) {
            handleError(event.reason || new Error('Promise rejection'), 'Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ', ErrorLevel.ERROR, false);
        });

        // ÂØºÂá∫ÈîôËØØÊó•ÂøóÔºàÁî®‰∫éË∞ÉËØïÔºâ
        function exportErrorLog() {
            const logText = errorLog.map(e =>
                `[${e.timestamp}] [${e.level}] ${e.context}: ${e.message}`
            ).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `error-log-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== Ê†∏ÂøÉÈÖçÁΩÆ ====================

        const DB_KEY = 'tara_life_os_v5';

        // ÂàùÂßãÂåñ Dexie IndexedDB
        const db = new Dexie('TaraLifeOSDatabase');

        db.version(1).stores({
            worldBooks: '&id, name, categoryId',
            worldBookCategories: '++id, name',
            characters: '&id, name'
        });

        // IndexedDB Êìç‰ΩúÂåÖË£ÖÂáΩÊï∞ÔºàÁªü‰∏ÄÈîôËØØÂ§ÑÁêÜÔºâ
        const dbHelper = {
            async safeGet(table, key, context = '') {
                try {
                    return await db[table].get(key);
                } catch(error) {
                    handleError(error, `${context || table} ËØªÂèñÂ§±Ë¥•`, ErrorLevel.ERROR, true);
                    return null;
                }
            },

            async safePut(table, data, context = '') {
                try {
                    return await db[table].put(data);
                } catch(error) {
                    handleError(error, `${context || table} ‰øùÂ≠òÂ§±Ë¥•`, ErrorLevel.ERROR, true);
                    throw error; // ÈáçÊñ∞ÊäõÂá∫‰ª•‰æøË∞ÉÁî®ËÄÖÂ§ÑÁêÜ
                }
            },

            async safeDelete(table, key, context = '') {
                try {
                    return await db[table].delete(key);
                } catch(error) {
                    handleError(error, `${context || table} Âà†Èô§Â§±Ë¥•`, ErrorLevel.ERROR, true);
                    throw error;
                }
            },

            async safeToArray(table, context = '') {
                try {
                    return await db[table].toArray();
                } catch(error) {
                    handleError(error, `${context || table} ÂàóË°®Ëé∑ÂèñÂ§±Ë¥•`, ErrorLevel.ERROR, true);
                    return [];
                }
            },

            async safeWhere(table, query, context = '') {
                try {
                    return await db[table].where(query).toArray();
                } catch(error) {
                    handleError(error, `${context || table} Êü•ËØ¢Â§±Ë¥•`, ErrorLevel.ERROR, true);
                    return [];
                }
            }
        };

        // ==================== Á¶ªÁ∫øÊ®°ÂºèÁÆ°ÁêÜ ====================

        // ÁΩëÁªúÁä∂ÊÄÅÁÆ°ÁêÜ
        const networkManager = {
            isOnline: navigator.onLine,
            listeners: new Set(),

            init() {
                // ÁõëÂê¨ÁΩëÁªúÁä∂ÊÄÅÂèòÂåñ
                window.addEventListener('online', () => {
                    this.setOnline(true);
                });

                window.addEventListener('offline', () => {
                    this.setOnline(false);
                });

                // ÂÆöÊúüÊ£ÄÊü•ÁΩëÁªúÔºàÂõ†‰∏∫Êüê‰∫õÊÉÖÂÜµ‰∏ã‰∫ã‰ª∂‰∏çÂèØÈù†Ôºâ
                setInterval(() => this.checkNetwork(), 30000); // 30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

                console.log('[ÁΩëÁªúÁÆ°ÁêÜ] ÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâçÁä∂ÊÄÅ:', this.isOnline ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø');
            },

            setOnline(status) {
                const wasOffline = !this.isOnline;
                this.isOnline = status;

                // Êõ¥Êñ∞ UI
                this.updateUI();

                if (status) {
                    console.log('[ÁΩëÁªúÁÆ°ÁêÜ] ÁΩëÁªúÂ∑≤ËøûÊé•');
                    if (typeof showToast === 'function') {
                        showToast('ÁΩëÁªúÂ∑≤ËøûÊé•');
                    }

                    // ‰ªéÁ¶ªÁ∫øÊÅ¢Â§çÊó∂ÔºåÂ§ÑÁêÜÁ¶ªÁ∫øÈòüÂàó
                    if (wasOffline) {
                        offlineQueue.processQueue();
                    }
                } else {
                    console.log('[ÁΩëÁªúÁÆ°ÁêÜ] ÁΩëÁªúÂ∑≤Êñ≠ÂºÄ');
                    if (typeof showToast === 'function') {
                        showToast('ÁΩëÁªúÂ∑≤Êñ≠ÂºÄÔºåÂàáÊç¢Âà∞Á¶ªÁ∫øÊ®°Âºè');
                    }
                }

                // ÈÄöÁü•ÊâÄÊúâÁõëÂê¨Âô®
                this.listeners.forEach(callback => callback(status));
            },

            checkNetwork() {
                // Âè™‰ΩøÁî® navigator.onLine Âà§Êñ≠ÁΩëÁªúÁä∂ÊÄÅ
                // ‰∏ç‰æùËµñÂ§ñÈÉ®ÊúçÂä°È™åËØÅÔºåÈÅøÂÖçÂõ†Â¢ôÂØºËá¥ËØØÂà§
                const currentStatus = navigator.onLine;
                if (currentStatus !== this.isOnline) {
                    this.setOnline(currentStatus);
                }
            },

            updateUI() {
                // Êõ¥Êñ∞Áä∂ÊÄÅÊ†èÁöÑÁΩëÁªúÊåáÁ§∫Âô®
                const indicator = document.getElementById('network-indicator');
                if (indicator) {
                    indicator.textContent = this.isOnline ? 'üü¢' : 'üî¥';
                    indicator.title = this.isOnline ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø';
                }

                // Êõ¥Êñ∞ body Á±ªÂêçÔºàÂèØÁî®‰∫é CSS Ê†∑ÂºèÔºâ
                document.body.classList.toggle('offline-mode', !this.isOnline);
            },

            addListener(callback) {
                this.listeners.add(callback);
            },

            removeListener(callback) {
                this.listeners.delete(callback);
            }
        };

        // Á¶ªÁ∫øÈòüÂàóÁÆ°ÁêÜ
        const offlineQueue = {
            queue: [],
            STORAGE_KEY: 'tara_offline_queue',

            init() {
                // ‰ªé localStorage Âä†ËΩΩÊú™Â§ÑÁêÜÁöÑÈòüÂàó
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (saved) {
                        this.queue = JSON.parse(saved);
                        console.log(`[Á¶ªÁ∫øÈòüÂàó] Âä†ËΩΩ‰∫Ü ${this.queue.length} ‰∏™ÂæÖÂ§ÑÁêÜÈ°π`);
                    }
                } catch (error) {
                    handleError(error, 'Á¶ªÁ∫øÈòüÂàóÂä†ËΩΩÂ§±Ë¥•', ErrorLevel.WARNING, false);
                }
            },

            // Ê∑ªÂä†‰ªªÂä°Âà∞ÈòüÂàó
            add(task) {
                const queueItem = {
                    id: Date.now() + Math.random(),
                    task: task,
                    timestamp: Date.now(),
                    retryCount: 0,
                    maxRetries: 3
                };

                this.queue.push(queueItem);
                this.save();

                console.log('[Á¶ªÁ∫øÈòüÂàó] Êñ∞Â¢û‰ªªÂä°:', task.type);
                return queueItem.id;
            },

            // ‰øùÂ≠òÈòüÂàóÂà∞ localStorage
            save() {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.queue));
                } catch (error) {
                    handleError(error, 'Á¶ªÁ∫øÈòüÂàó‰øùÂ≠òÂ§±Ë¥•', ErrorLevel.WARNING, false);
                }
            },

            // Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑÊâÄÊúâ‰ªªÂä°
            async processQueue() {
                if (!networkManager.isOnline || this.queue.length === 0) {
                    return;
                }

                console.log(`[Á¶ªÁ∫øÈòüÂàó] ÂºÄÂßãÂ§ÑÁêÜ ${this.queue.length} ‰∏™‰ªªÂä°`);
                if (typeof showToast === 'function') {
                    showToast(`Ê≠£Âú®ÂêåÊ≠• ${this.queue.length} ‰∏™Á¶ªÁ∫øÊìç‰Ωú...`);
                }

                const toProcess = [...this.queue];
                this.queue = [];
                this.save();

                let successCount = 0;
                let failCount = 0;

                for (const item of toProcess) {
                    try {
                        await this.executeTask(item.task);
                        successCount++;
                        console.log('[Á¶ªÁ∫øÈòüÂàó] ‰ªªÂä°ÊàêÂäü:', item.task.type);
                    } catch (error) {
                        console.error('[Á¶ªÁ∫øÈòüÂàó] ‰ªªÂä°Â§±Ë¥•:', item.task.type, error);

                        // ÈáçËØïÈÄªËæë
                        item.retryCount++;
                        if (item.retryCount < item.maxRetries) {
                            this.queue.push(item);
                            console.log(`[Á¶ªÁ∫øÈòüÂàó] ‰ªªÂä°Â∞ÜÈáçËØï (${item.retryCount}/${item.maxRetries})`);
                        } else {
                            failCount++;
                            if (typeof handleError === 'function') {
                                handleError(error, `Á¶ªÁ∫ø‰ªªÂä°Â§±Ë¥•: ${item.task.type}`, ErrorLevel.WARNING, false);
                            }
                        }
                    }
                }

                this.save();

                if (successCount > 0 || failCount > 0) {
                    if (typeof showToast === 'function') {
                        showToast(`ÂêåÊ≠•ÂÆåÊàê: ${successCount} ÊàêÂäü, ${failCount} Â§±Ë¥•`);
                    }
                }
            },

            // ÊâßË°åÂçï‰∏™‰ªªÂä°
            async executeTask(task) {
                switch (task.type) {
                    case 'api_call':
                        // ÈáçÊñ∞ÂèëÈÄÅ API Ë∞ÉÁî®
                        if (typeof callAI === 'function') {
                            // ‰∏¥Êó∂ÁªïËøáÁ¶ªÁ∫øÊ£ÄÊü•
                            const wasOnline = networkManager.isOnline;
                            networkManager.isOnline = true;
                            try {
                                const result = await callAI(task.data.message);
                                networkManager.isOnline = wasOnline;
                                return result;
                            } catch (error) {
                                networkManager.isOnline = wasOnline;
                                throw error;
                            }
                        }
                        break;

                    case 'character_message':
                        // ÈáçÊñ∞ÂèëÈÄÅËßíËâ≤Ê∂àÊÅØ
                        if (task.data.characterId && typeof db !== 'undefined') {
                            const char = await db.characters.get(task.data.characterId);
                            if (char) {
                                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÈáçÊñ∞ÂèëÈÄÅÈÄªËæë
                            }
                        }
                        break;

                    default:
                        console.warn('[Á¶ªÁ∫øÈòüÂàó] Êú™Áü•‰ªªÂä°Á±ªÂûã:', task.type);
                }
            },

            // Ê∏ÖÁ©∫ÈòüÂàó
            clear() {
                this.queue = [];
                this.save();
                console.log('[Á¶ªÁ∫øÈòüÂàó] ÈòüÂàóÂ∑≤Ê∏ÖÁ©∫');
            },

            // Ëé∑ÂèñÈòüÂàóÁä∂ÊÄÅ
            getStatus() {
                return {
                    count: this.queue.length,
                    items: this.queue.map(item => ({
                        type: item.task.type,
                        timestamp: item.timestamp,
                        retryCount: item.retryCount
                    }))
                };
            }
        };

        let store = {
            balance: 0,
            theme: 'default',
            projects: [],
            dailyStats: {},
            logs: [],
            redemptions: [],
            weeklyBills: [],
            lastDailyCheck: '',
            lastWeeklyReset: '',
            shopItems: [
                {id:1, icon:'üõå', name:'Á¶ªÁ∫ø‰∏ÄÂ∞èÊó∂', cost:50, type:'unlimited'},
                {id:2, icon:'üçü', name:'Â§ñÂçñÂä†‰∏™È§ê', cost:30, type:'unlimited'},
                {id:3, icon:'üé¨', name:'Áúã‰∏ÄÈõÜÂâß', cost:40, type:'unlimited'},
                {id:4, icon:'üö´', name:'ÂÖçË¥£Êé®ËøüÂç°', cost:100, type:'cooldown', lastBuy:0}
            ],
            gachaPool: ['ÂñùÊùØÂ•∂Ëå∂','Êó©Áù°‰∏ÄÂ∞èÊó∂','‰π∞‰∏™Â∞èÁé©ÂÖ∑','ÂèëÂëÜ20ÂàÜÈíü','Âê¨ÂñúÊ¨¢ÁöÑÊ≠å','‰ªÄ‰πà‰πü‰∏çÂÅö','ÂêÉÂùóÂ∑ßÂÖãÂäõ'],
            apiConfig: {
                main: { url: '', key: '', model: 'gpt-4', temperature: 0.8 },
                sub: { url: '', key: '', model: 'gpt-3.5-turbo', temperature: 0.8 },
                search: { provider: 'google', googleApiKey: '', googleCx: '', serperApiKey: '', zhipuApiKey: '' }
            },
            aiChatHistory: [],
            aiConversations: [], // AIÂä©ÊâãÂØπËØùÁ™óÂè£ÂàóË°® {id, name, history[], createdAt, updatedAt}
            currentAiConversationId: null, // ÂΩìÂâçÊøÄÊ¥ªÁöÑÂØπËØùÁ™óÂè£ID
            characterGroups: ['ÈªòËÆ§ÂàÜÁªÑ', 'ÁâπÂà´ÂÖ≥ÂøÉ'], // ÈªòËÆ§ÂàÜÁªÑ
            reportArchive: [] // AI Âë®Êä•Ê°£Ê°à
        };
        
        let viewDate = new Date();
        let currentPid = null;
        let timerInt = null;
        let tempTask = null;
        let charts = { line: null, pie: null };
        let isEditMode = false;
        let selectedFocusPids = new Set();
        let selectedDifficulty = 'normal';
        let pendingPoints = 0;
        let importMode = 'merge';
        let archiveFilter = 'all';
        let longPressTimer = null;
        let longPressTarget = null;
        let isSearchEnabled = false;
        let isAiSearchEnabled = false;
        let isLocalSearchEnabled = false;
        let isAiLocalSearchEnabled = false;
        let isAiMultiSelectMode = false;
        let selectedAiMessageIndices = new Set();
        let currentAiQuote = null;

        const DIFF_CONFIG = {
            'easy': { line: 5, board: 20 },
            'normal': { line: 10, board: 50 },
            'hard': { line: 20, board: 100 },
            'hell': { line: 50, board: 300 }
        };

        const VESPER_QUOTES = {
            empty: [
                "‰∏ÄÁâáÁ©∫ÁôΩ„ÄÇÂ∞±ÂÉèÂÆáÂÆôÂ§ßÁàÜÁÇ∏ÂâçÁöÑÁû¨Èó¥„ÄÇÂºÄÂßãÂêß„ÄÇ",
                "Êï∞ÊçÆ‰∏∫Èõ∂„ÄÇ‰Ω†ÊòØÂú®ÊµãËØïÊàëÁöÑËÄêÂøÉÔºåËøòÊòØÂú®‰∫´ÂèóËôöÊó†Ôºü",
                "Ê≤°ÊúâËæìÂÖ•„ÄÇËøôÂæàÂÆâÂÖ®Ôºå‰ΩÜÂæàÊó†ËÅä„ÄÇ"
            ],
            progress: [
                "Âä®ËÉΩÊ£ÄÊµãÂ∑≤Á°ÆËÆ§„ÄÇÁªßÁª≠„ÄÇ",
                "‰∏çÈîô„ÄÇÁÜµÂ¢ûË¢´ÊöÇÊó∂ÊäëÂà∂‰∫Ü„ÄÇ",
                "ËøôÂ∞±ÊòØÁß©Â∫èÁöÑÊÑüËßâ„ÄÇ‰øùÊåÅ‰Ωè„ÄÇ",
                "‰∏Ä‰∏™Ê†ºÂ≠êÔºå‰∏Ä‰∏™ÈîöÁÇπ„ÄÇ‰Ω†Âú®Â§∫ÂõûÊéßÂà∂ÊùÉ„ÄÇ"
            ],
            almost: [
                "ËøòÂ∑Æ‰∏ÄÁÇπ„ÄÇÂº∫Ëø´ÁóáÊÇ£ËÄÖ‰ºö‰∏∫Ê≠§ÂèëÁñØÁöÑ„ÄÇ",
                "Âè™Ë¶ÅÂÜç‰∏ÄÊ≠•ÔºåÂ§öÂ∑¥ËÉ∫Â∞±‰ºöÈáäÊîæ„ÄÇ",
                "Êî∂Â∞æÂ∑•‰Ωú„ÄÇÂà´Âú®Ëøô‰∏™Êó∂ÂÄôÂÅú‰∏ã„ÄÇ"
            ],
            complete: [
                "ÂÆåÁæéÁöÑÈó≠ÁéØ„ÄÇÊï∞ÊçÆÊûÅÂ∫¶ËàíÈÄÇ„ÄÇ",
                "ÊâßË°åÂÆåÊØï„ÄÇ‰Ω†ÂèØ‰ª•‰∏∫Ê≠§ÊÑüÂà∞È™ÑÂÇ≤„ÄÇ",
                "ÊïàÁéáÂ≥∞ÂÄº„ÄÇ‰ºëÊÅØ‰∏Ä‰∏ãÔºåËøôÊòØÂëΩ‰ª§„ÄÇ",
                "Ê∑∑‰π±Â∑≤Ë¢´Ê∏ÖÈô§„ÄÇÂÅöÂæóÂ•ΩÔºåÂ°îÊãâ„ÄÇ"
            ],
            hell: [
                "‰Ω†Âú®Áé©ÁÅ´„ÄÇ‰ΩÜÊàëÂñúÊ¨¢ËøôÁßçÈáéÂøÉ„ÄÇ",
                "Ê≠ªÁ∫øÊ®°ÂºèÔºüÂ∏åÊúõ‰Ω†ÁöÑËÇæ‰∏äËÖ∫Á¥†ÂÇ®Â§áÂÖÖË∂≥„ÄÇ",
                "Êó¢ÁÑ∂ÈÄâÊã©‰∫ÜÂú∞Áã±ÈöæÂ∫¶ÔºåÂ∞±Âà´ÊåáÊúõÊàëÊâã‰∏ãÁïôÊÉÖ„ÄÇ"
            ]
        };

        // --- ÂÖ®Â±Ä UI ÈáçÁΩÆÂáΩÊï∞ ---
        function resetUI() {
            // 1. ÂÖ≥Èó≠‰æßËæπÊ†è
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');

            // 2. ÂÖ≥Èó≠ËÅäÂ§©ÂÖ®Â±èÁïåÈù¢
            document.getElementById('character-chat-screen').style.display = 'none';

            // 3. ÂÖ≥Èó≠ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÂíåÈù¢Êùø (ÂåÖÊã¨ sidebar-panel)
            document.querySelectorAll('.modal').forEach(el => el.classList.remove('active'));

            // 4. ÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
            document.querySelectorAll('.context-menu').forEach(el => el.classList.remove('active'));
            
            // 5. ÊÅ¢Â§çÈ°µÈù¢ÊªöÂä®
            document.body.classList.remove('no-scroll');
        }

        // ==================== ËßíËâ≤ÁÆ°ÁêÜÂäüËÉΩ ====================

        let currentEditingCharacter = null;
        let currentChatCharacter = null;

        // ÊâìÂºÄËßíËâ≤ÂØºÂÖ•ÂºπÁ™ó
        function openCharacterImportModal() {
            document.getElementById('modal-character-import').classList.add('active');
        }

        // ÊâìÂºÄÂàõÂª∫ËßíËâ≤ÂºπÁ™ó
        function openCreateCharacterModal() {
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('create-char-title').textContent = 'ÂàõÂª∫ËßíËâ≤';
            document.getElementById('create-char-name').value = '';
            document.getElementById('create-char-description').value = '';
            document.getElementById('create-char-first-mes').value = '';
            document.getElementById('create-char-avatar-preview').src = 'https://via.placeholder.com/100?text=ÁÇπÂáª‰∏ä‰º†';

            // Ê∏ÖÈô§ÁºñËæëÊ†áËÆ∞
            currentEditingCharacter = null;

            document.getElementById('modal-create-character').classList.add('active');
        }

        // È¢ÑËßàËßíËâ≤Â§¥ÂÉè
        function previewCharacterAvatar(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('create-char-avatar-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ‰øùÂ≠òÊñ∞ÂàõÂª∫ÁöÑËßíËâ≤
        async function saveNewCharacter() {
            const name = document.getElementById('create-char-name').value.trim();
            const description = document.getElementById('create-char-description').value.trim();
            const firstMes = document.getElementById('create-char-first-mes').value.trim();
            const avatarSrc = document.getElementById('create-char-avatar-preview').src;

            if(!name) {
                alert('ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞');
                return;
            }

            // Â¶ÇÊûúÊòØÁºñËæëÊ®°Âºè
            if(currentEditingCharacter) {
                currentEditingCharacter.name = name;
                currentEditingCharacter.description = description;
                currentEditingCharacter.first_mes = firstMes;
                if(avatarSrc && !avatarSrc.includes('placeholder')) {
                    currentEditingCharacter.avatar = avatarSrc;
                }

                await db.characters.put(currentEditingCharacter);
                alert('ËßíËâ≤‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞!');
            } else {
                // ÂàõÂª∫Êñ∞ËßíËâ≤
                const newCharacter = {
                    id: 'char_' + Date.now(),
                    name: name,
                    description: description,
                    personality: '',
                    scenario: '',
                    first_mes: firstMes,
                    mes_example: '',
                    avatar: avatarSrc.includes('placeholder') ? '' : avatarSrc,
                    createdAt: Date.now(),
                    settings: {
                        maxMemory: 20,
                        temperature: 0.8,
                        linkedWorldBookIds: []
                    },
                    chatHistory: []
                };

                await db.characters.put(newCharacter);
                alert('ËßíËâ≤ÂàõÂª∫ÊàêÂäü!');
            }

            closeModal('modal-create-character');
            await renderCharacterList();
        }

        // Êõ¥Êñ∞ËßíËâ≤Â§¥ÂÉèÔºàÂú®ËØ¶ÊÉÖÈ°µÔºâ
        function updateCharacterAvatar(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                document.getElementById('character-detail-avatar').src = e.target.result;

                if(currentEditingCharacter) {
                    currentEditingCharacter.avatar = e.target.result;
                    await db.characters.put(currentEditingCharacter);
                }
            };
            reader.readAsDataURL(file);
        }

        // È¢ÑËßà/Êõ¥Êñ∞ User Â§¥ÂÉè
        function previewUserAvatar(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('user-avatar-preview').src = e.target.result;
                store.userAvatar = e.target.result;
                saveData(); // Á´ãÂç≥‰øùÂ≠òÂÖ®Â±ÄËÆæÁΩÆ
            };
            reader.readAsDataURL(file);
        }

        // ÂàáÊç¢ËßíËâ≤ÁºñËæëÊ®°Âºè
        function toggleCharacterEdit() {
            // ÂºπÂá∫ÂàõÂª∫/ÁºñËæëÂØπËØùÊ°ÜËøõË°åÁºñËæë
            if(!currentEditingCharacter) return;

            document.getElementById('create-char-title').textContent = 'ÁºñËæëËßíËâ≤';
            document.getElementById('create-char-name').value = currentEditingCharacter.name;
            document.getElementById('create-char-description').value = currentEditingCharacter.description || '';
            document.getElementById('create-char-first-mes').value = currentEditingCharacter.first_mes || '';
            document.getElementById('create-char-avatar-preview').src = currentEditingCharacter.avatar || 'https://via.placeholder.com/100';

            closeModal('modal-character-detail');
            document.getElementById('modal-create-character').classList.add('active');
        }

        // Â§ÑÁêÜËßíËâ≤Êñá‰ª∂‰∏ä‰º†
        async function handleCharacterFile(input) {
            const file = input.files[0];
            if(!file) return;

            closeModal('modal-character-import');

            const fileExt = file.name.split('.').pop().toLowerCase();

            try {
                let characterData = null;
                let avatarBase64 = null;

                if(fileExt === 'png') {
                    const result = await parseCharacterPNG(file);
                    characterData = result.data;
                    avatarBase64 = result.avatar;
                } else if(fileExt === 'json') {
                    characterData = await parseCharacterJSON(file);
                }

                if(!characterData) {
                    alert('Ëß£ÊûêÂ§±Ë¥•: Êó†ÊïàÁöÑËßíËâ≤Âç°Ê†ºÂºè');
                    return;
                }

                // ÂàõÂª∫ËßíËâ≤ÂØπË±°
                await createCharacterFromData(characterData, avatarBase64);
                alert('Vesper: ËßíËâ≤ÂØºÂÖ•ÊàêÂäü!');
                await renderCharacterList();

            } catch(error) {
                alert('ÂØºÂÖ•Â§±Ë¥•: ' + error.message);
                console.error(error);
            }

            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            input.value = '';
        }

        // Ëß£ÊûêPNGÊ†ºÂºèËßíËâ≤Âç° (SillyTavernÊ†ºÂºè) - È≤ÅÊ£íÊÄßÂ¢ûÂº∫Áâà
        async function parseCharacterPNG(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    const dataView = new DataView(arrayBuffer);

                    if (dataView.getUint32(0) !== 0x89504E47 || dataView.getUint32(4) !== 0x0D0A1A0A) {
                        return reject(new Error('Êñá‰ª∂‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑPNGÂõæÁâá„ÄÇ'));
                    }

                    let offset = 8;
                    let characterJson = null;

                    while (offset < dataView.byteLength) {
                        const length = dataView.getUint32(offset);
                        const type = String.fromCharCode(
                            dataView.getUint8(offset + 4),
                            dataView.getUint8(offset + 5),
                            dataView.getUint8(offset + 6),
                            dataView.getUint8(offset + 7)
                        );

                        if (type === 'tEXt') {
                            const chunkData = new Uint8Array(arrayBuffer, offset + 8, length);
                            
                            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê‰øÆÂ§ç‰π±Á†ÅÁöÑÊ†∏ÂøÉ‰ª£Á†Å„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                            // 1. ÂÖàÁî®‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁºñÁ†ÅÂ∞ÜÂ≠óËäÇËΩ¨‰∏∫Â≠óÁ¨¶‰∏≤Ôºå‰ª•‰æøÊü•ÊâæÂÖ≥ÈîÆÂ≠ó "chara"
                            let text = '';
                            for (let i = 0; i < chunkData.length; i++) {
                                text += String.fromCharCode(chunkData[i]);
                            }

                            // 2. Ê£ÄÊü•ÂÖ≥ÈîÆÂ≠óÊòØÂê¶Â≠òÂú®
                            const keyword = 'chara' + String.fromCharCode(0);
                            if (text.startsWith(keyword)) {
                                // 3. ÊèêÂèñÂá∫ÂÖ≥ÈîÆÂ≠óÂêéÈù¢ÁöÑ Base64 ÁºñÁ†ÅÁöÑÂ≠óÁ¨¶‰∏≤
                                const base64Data = text.substring(keyword.length);
                                try {
                                    // 4. ‰ΩøÁî® atob() Ëß£Á†Å Base64ÔºåÂæóÂà∞‰∏Ä‰∏™‚Äú‰∫åËøõÂà∂Â≠óÁ¨¶‰∏≤‚Äù
                                    const binaryString = atob(base64Data);
                                    
                                    // 5. Â∞ÜËøô‰∏™‚Äú‰∫åËøõÂà∂Â≠óÁ¨¶‰∏≤‚ÄùÈáçÊñ∞ËΩ¨Êç¢‰∏∫ÂéüÂßãÁöÑ UTF-8 Â≠óËäÇÊï∞ÁªÑ
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    
                                    // 6. ‰ΩøÁî® TextDecoder Â∞ÜËøô‰∏™Á∫ØÂáÄÁöÑ UTF-8 Â≠óËäÇÊï∞ÁªÑËß£Á†Å‰∏∫Ê≠£Á°ÆÁöÑÂ≠óÁ¨¶‰∏≤
                                    const decodedJsonString = new TextDecoder('utf-8').decode(bytes);
                                    
                                    // 7. Ëß£ÊûêÊúÄÁªàÁöÑJSONÂ≠óÁ¨¶‰∏≤
                                    characterJson = JSON.parse(decodedJsonString);
                                    break;
                                } catch (e) {
                                    console.warn('Ëß£ÊûêÂõæÁâáÂÜÖÂµåÁöÑËßíËâ≤Êï∞ÊçÆÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÊï∞ÊçÆÊçüÂùè„ÄÇ', e);
                                }
                            }
                            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„ÄêÊ†∏ÂøÉ‰ª£Á†ÅÁªìÊùü„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                        }
                        
                        if (type === 'IEND') break;
                        offset += 12 + length;
                    }

                    if (characterJson) {
                        const imageReader = new FileReader();
                        imageReader.onload = (imgEvent) => {
                            resolve({
                                data: characterJson,
                                avatar: imgEvent.target.result
                            });
                        };
                        imageReader.onerror = () => reject(new Error('ËØªÂèñÂõæÁâá‰Ωú‰∏∫Â§¥ÂÉèÂ§±Ë¥•„ÄÇ'));
                        imageReader.readAsDataURL(file);
                    } else {
                        reject(new Error('Âú®ËøôÂº†PNGÂõæÁâá‰∏≠Ê≤°ÊúâÊâæÂà∞SillyTavernËßíËâ≤Êï∞ÊçÆ„ÄÇ'));
                    }
                };
                reader.onerror = () => reject(new Error('ËØªÂèñPNGÊñá‰ª∂Â§±Ë¥•„ÄÇ'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Ëß£ÊûêJSONÊ†ºÂºèËßíËâ≤Âç°
        async function parseCharacterJSON(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const buffer = e.target.result;
                        const jsonString = new TextDecoder('utf-8').decode(new Uint8Array(buffer));
                        const data = JSON.parse(jsonString);

                        // ÂÖºÂÆπ‰∏§ÁßçÊ†ºÂºè
                        const characterData = data.data || data;
                        resolve(characterData);
                    } catch(error) {
                        reject(new Error('JSONËß£ÊûêÂ§±Ë¥•: ' + error.message));
                    }
                };

                reader.onerror = () => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ‰ªéËßíËâ≤Êï∞ÊçÆÂàõÂª∫ËßíËâ≤ÂØπË±°
        async function createCharacterFromData(characterData, avatarBase64) {
            const characterName = characterData.name || characterData.char_name || 'Êú™ÂëΩÂêçËßíËâ≤';

            // Â∞ùËØï‰ªéËßíËâ≤Êï∞ÊçÆ‰∏≠Ëé∑ÂèñÂ§¥ÂÉè
            if(!avatarBase64 && characterData.avatar) {
                avatarBase64 = characterData.avatar.startsWith('data:')
                    ? characterData.avatar
                    : 'data:image/png;base64,' + characterData.avatar;
            }

            // ÂàõÂª∫Êñ∞ËßíËâ≤ÂØπË±°
            const newCharacter = {
                id: 'char_' + Date.now(),
                name: characterName,
                description: characterData.description || '',
                personality: characterData.personality || '',
                scenario: characterData.scenario || '',
                first_mes: characterData.first_mes || '',
                mes_example: characterData.mes_example || '',
                avatar: avatarBase64 || '',
                createdAt: Date.now(),
                settings: {
                    maxMemory: 20,
                    temperature: 0.8,
                    linkedWorldBookIds: []
                },
                chatHistory: [],
                // --- [Vesper] Êñ∞Â¢û: ÂøÉÂ£∞Á≥ªÁªüÊîØÊåÅ ---
                latestInnerVoice: null,
                innerVoiceHistory: []
            };

            // ‰øùÂ≠òÂà∞IndexedDB
            await db.characters.put(newCharacter);

            // Â§ÑÁêÜËßíËâ≤Ëá™Â∏¶ÁöÑ‰∏ñÁïå‰π¶
            if(characterData.character_book && characterData.character_book.entries) {
                await importCharacterWorldBook(characterData.character_book, characterName, newCharacter.id);
            } else if(characterData.world_entries && Array.isArray(characterData.world_entries)) {
                await importCharacterWorldBook({ entries: characterData.world_entries }, characterName, newCharacter.id);
            }
        }

        // ÂØºÂÖ•ËßíËâ≤Ëá™Â∏¶ÁöÑ‰∏ñÁïå‰π¶
        async function importCharacterWorldBook(characterBook, characterName, characterId) {
            const entries = characterBook.entries || [];
            if(entries.length === 0) return;

            // ÂàõÂª∫Êñ∞ÁöÑ‰∏ñÁïå‰π¶
            const worldBookName = characterBook.name || `${characterName}ÁöÑ‰∏ñÁïå‰π¶`;

            const newWorldBook = {
                id: 'wb_' + Date.now(),
                name: worldBookName,
                categoryId: null,
                description: `‰ªéËßíËâ≤ "${characterName}" ÂØºÂÖ•`,
                entries: entries.filter(entry => entry.enabled !== false).map(entry => ({
                    id: 'entry_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: entry.comment || (entry.keys && entry.keys[0]) || 'Êù°ÁõÆ',
                    keys: entry.keys || [],
                    content: entry.content || '',
                    enabled: true
                })),
                createdAt: Date.now()
            };

            // ‰øùÂ≠ò‰∏ñÁïå‰π¶
            await db.worldBooks.put(newWorldBook);

            // Ëá™Âä®ÂÖ≥ËÅîÂà∞ËßíËâ≤
            const character = await db.characters.get(characterId);
            if(character) {
                character.settings.linkedWorldBookIds.push(newWorldBook.id);
                await db.characters.put(character);
            }

            console.log(`Â∑≤ÂØºÂÖ•‰∏ñÁïå‰π¶: ${worldBookName}, ÂåÖÂê´ ${newWorldBook.entries.length} ‰∏™Êù°ÁõÆ`);
        }

        // Âø´ÈÄüÂºÄÂßãËÅäÂ§©
        async function quickStartChat(characterId) {
            const character = await db.characters.get(characterId);
            if(!character) {
                alert('ËßíËâ≤‰∏çÂ≠òÂú®');
                return;
            }
            currentEditingCharacter = character;
            openCharacterChat();
        }

        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®ÔºàÊåâÂàÜÁªÑÊäòÂè†Ôºâ
        async function renderCharacterList() {
            const listDiv = document.getElementById('character-list');

            try {
                const characters = await db.characters.toArray();

                if(characters.length === 0) {
                    listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:50px;">ÊöÇÊó†ËßíËâ≤,ÁÇπÂáªÂè≥‰∏äËßíÂàõÂª∫ÊàñÂØºÂÖ•</div>';
                    return;
                }

                listDiv.innerHTML = '';

                // ÊåâÂàÜÁªÑÊï¥ÁêÜËßíËâ≤
                const groupedChars = {};
                const ungrouped = [];

                characters.forEach(char => {
                    const group = char.settings?.group || '';
                    if (!group) {
                        ungrouped.push(char);
                    } else {
                        if (!groupedChars[group]) {
                            groupedChars[group] = [];
                        }
                        groupedChars[group].push(char);
                    }
                });

                // Ê∏≤ÊüìÊú™ÂàÜÁªÑÁöÑËßíËâ≤
                if (ungrouped.length > 0) {
                    renderGroupSection('Êú™ÂàÜÁªÑ', ungrouped, listDiv, true);
                }

                // Ê∏≤ÊüìÂêÑÂàÜÁªÑ
                Object.keys(groupedChars).sort().forEach(groupName => {
                    renderGroupSection(groupName, groupedChars[groupName], listDiv, true);
                });

            } catch(error) {
                console.error('Ê∏≤ÊüìËßíËâ≤ÂàóË°®Â§±Ë¥•:', error);
                listDiv.innerHTML = '<div style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        // Ê∏≤ÊüìÂàÜÁªÑÂå∫Âùó
        function renderGroupSection(groupName, characters, container, expanded = true) {
            const groupId = 'group-' + groupName.replace(/[^a-zA-Z0-9]/g, '-');

            const groupDiv = document.createElement('div');
            groupDiv.style.cssText = 'margin-bottom:10px;';

            // ÂàÜÁªÑÊ†áÈ¢ò
            const groupHeader = document.createElement('div');
            groupHeader.style.cssText = 'background:var(--card-bg); padding:10px 15px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); user-select:none;';
            groupHeader.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="${groupId}-arrow" style="transition:transform 0.2s; ${expanded ? 'transform:rotate(90deg);' : ''}">‚ñ∂</span>
                    <span style="font-weight:bold; font-size:0.9rem;">${escapeHtml(groupName)}</span>
                    <span style="opacity:0.5; font-size:0.75rem;">(${characters.length})</span>
                </div>
            `;

            // ÂàÜÁªÑÂÜÖÂÆπ
            const groupContent = document.createElement('div');
            groupContent.id = groupId;
            groupContent.style.cssText = expanded ? '' : 'display:none;';

            characters.forEach(char => {
                const lastMessage = char.chatHistory && char.chatHistory.length > 0
                    ? char.chatHistory[char.chatHistory.length - 1].content
                    : (char.first_mes || 'ÊöÇÊó†Ê∂àÊÅØ');

                const charDiv = document.createElement('div');
                charDiv.className = 'qq-chat-item';
                charDiv.onclick = () => quickStartChat(char.id);
                charDiv.innerHTML = `
                    <img src="${char.avatar || 'https://via.placeholder.com/50'}" class="qq-chat-avatar">
                    <div class="qq-chat-info">
                        <div class="qq-chat-name">${escapeHtml(char.settings?.nickname || char.name)}</div>
                        <div class="qq-chat-desc">${escapeHtml(lastMessage.substring(0, 30))}...</div>
                    </div>
                `;
                groupContent.appendChild(charDiv);
            });

            // ÁÇπÂáªÊ†áÈ¢òÊäòÂè†/Â±ïÂºÄ
            groupHeader.onclick = () => {
                const content = document.getElementById(groupId);
                const arrow = document.getElementById(groupId + '-arrow');
                if (content.style.display === 'none') {
                    content.style.display = '';
                    arrow.style.transform = 'rotate(90deg)';
                } else {
                    content.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            };

            groupDiv.appendChild(groupHeader);
            groupDiv.appendChild(groupContent);
            container.appendChild(groupDiv);
        }
        
        function formatBingoProjectForAI(project) {
            const total = project.tasks.length;
            const done = project.tasks.filter(t => t.completed).length;
            let gridText = "";
            project.tasks.forEach((t, i) => {
                gridText += `- [${t.completed ? 'x' : ' '}] ${t.text}\n`;
            });

            let result = `
„ÄêÂÖ≥ËÅîÂæÖÂäû/BingoÂç°: ${project.theme}„Äë
ËøõÂ∫¶: ${done}/${total}
‰ªªÂä°ÂàóË°®:
${gridText}`;

            // Ê∑ªÂä†ÈöèÁ¨îÂÜÖÂÆπÔºàÊâÄÊúâÁä∂ÊÄÅÁöÑÂç°ÈÉΩÂèØËÉΩÊúâÔºâ
            if (project.journal && project.journal.trim()) {
                result += `\n> üìù Áî®Êà∑ÈöèÁ¨î:\n> ${project.journal.trim()}\n`;
            }

            // Ê∑ªÂä†ÊÄªÁªìÂÜÖÂÆπÔºà‰ªÖÂΩíÊ°£Âç°ÊúâÔºâ
            if (project.status === 'archived' && project.summary && project.summary.trim()) {
                result += `\n> üìã ÂΩíÊ°£ÊÄªÁªì:\n> ${project.summary.trim()}\n`;
            }

            return result;
        }
        // --- [Vesper] Êñ∞Â¢ûËÅäÂ§©ËÆ∞ÂΩïÁÆ°ÁêÜÂäüËÉΩ ---
        let lastSearchKeyword = '';
        let lastSearchCharacterId = null;

        function searchChatHistory() {
            if (!currentEditingCharacter) return;

            const searchInput = document.getElementById('chat-search-input');
            const keyword = searchInput.value.trim();

            if (!keyword) {
                alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç');
                return;
            }

            lastSearchKeyword = keyword;
            lastSearchCharacterId = currentEditingCharacter.id;

            const chatHistory = currentEditingCharacter.chatHistory || [];
            const results = [];

            chatHistory.forEach((msg, index) => {
                if (msg.content && msg.content.toLowerCase().includes(keyword.toLowerCase())) {
                    results.push({
                        index: index,
                        role: msg.role,
                        content: msg.content,
                        timestamp: msg.timestamp
                    });
                }
            });

            if (results.length === 0) {
                alert(`Êú™ÊâæÂà∞ÂåÖÂê´"${keyword}"ÁöÑËÅäÂ§©ËÆ∞ÂΩï`);
                return;
            }

            // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÈù¢Êùø
            showSearchResults(results, keyword, currentEditingCharacter.name);
        }

        function showSearchResults(results, keyword, characterName) {
            const panel = document.getElementById('search-results-panel');
            const countEl = document.getElementById('search-results-count');
            const listEl = document.getElementById('search-results-list');

            countEl.textContent = `(${results.length}Êù°)`;

            // È´ò‰∫ÆÂÖ≥ÈîÆËØçÁöÑÂáΩÊï∞
            function highlightKeyword(text, kw) {
                const escaped = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escaped})`, 'gi');
                return text.replace(regex, '<span class="search-result-keyword">$1</span>');
            }

            // ÊûÑÂª∫ÁªìÊûúÂàóË°®
            listEl.innerHTML = results.map(result => {
                const role = result.role === 'user' ? '‰Ω†' : characterName;
                const preview = result.content.substring(0, 100) + (result.content.length > 100 ? '...' : '');
                const time = new Date(result.timestamp).toLocaleString();
                const highlightedPreview = highlightKeyword(escapeHtml(preview), keyword);

                return `
                    <div class="search-result-item" onclick="jumpToSearchResult(${result.index})">
                        <div class="search-result-role">${role}</div>
                        <div class="search-result-preview">${highlightedPreview}</div>
                        <div class="search-result-time">${time}</div>
                    </div>
                `;
            }).join('');

            panel.classList.add('active');
        }

        function closeSearchResults(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('search-results-panel').classList.remove('active');
        }

        async function jumpToSearchResult(msgIndex) {
            // ÂÖ≥Èó≠ÊêúÁ¥¢Èù¢Êùø
            closeSearchResults();

            // Á°Æ‰øùÂä†ËΩΩÊ≠£Á°ÆÁöÑËßíËâ≤
            if (lastSearchCharacterId) {
                const character = await db.characters.get(lastSearchCharacterId);
                if (character) {
                    currentChatCharacter = character;
                    currentEditingCharacter = character;
                }
            }

            // ÂÖ≥Èó≠ËßíËâ≤ËÆæÁΩÆÂºπÁ™ó
            const modal = document.getElementById('modal-character-detail');
            if (modal) modal.classList.remove('active');

            // ÊâìÂºÄËÅäÂ§©ÁïåÈù¢
            if (currentChatCharacter) {
                // ËÆæÁΩÆËÅäÂ§©ÁïåÈù¢
                document.getElementById('chat-avatar').src = currentChatCharacter.avatar || 'https://via.placeholder.com/40';
                document.getElementById('chat-character-name').textContent = currentChatCharacter.name;

                // Â±ïÂºÄÂéÜÂè≤ÔºàÁ°Æ‰øùËÉΩÊâæÂà∞Ê∂àÊÅØÔºâ
                isHistoryCollapsed = false;

                // Ê∏≤ÊüìËÅäÂ§©ÂéÜÂè≤
                renderCharacterChatHistory();

                // ÊòæÁ§∫ËÅäÂ§©ÁïåÈù¢
                document.getElementById('character-chat-screen').style.display = 'flex';
                document.body.classList.add('no-scroll');

                // Á≠âÂæÖÊ∏≤ÊüìÂÆåÊàêÂêéÊªöÂä®Âà∞ÁõÆÊ†áÊ∂àÊÅØ
                setTimeout(() => {
                    scrollToMessageDirect(msgIndex);
                }, 400);
            }
        }

        // Áõ¥Êé•ÊªöÂä®Âà∞Ê∂àÊÅØÔºà‰∏çÊ£ÄÊü•ÊäòÂè†Áä∂ÊÄÅÔºâ
        function scrollToMessageDirect(msgIndex) {
            const container = document.getElementById('character-chat-messages');
            const bubble = container.querySelector(`.chat-message-bubble[data-msg-index="${msgIndex}"]`);

            if (bubble) {
                bubble.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // È´ò‰∫ÆÈó™ÁÉÅÊïàÊûú
                bubble.style.transition = 'box-shadow 0.3s, transform 0.3s';
                bubble.style.boxShadow = '0 0 0 3px var(--accent)';
                bubble.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    bubble.style.boxShadow = 'none';
                    bubble.style.transform = 'scale(1)';
                }, 2000);
            } else {
                console.log('Êú™ÊâæÂà∞Ê∂àÊÅØÁ¥¢Âºï:', msgIndex);
            }
        }

        function exportChatHistory() {
            if (!currentEditingCharacter) return;

            const chatData = {
                characterName: currentEditingCharacter.name,
                characterId: currentEditingCharacter.id,
                exportDate: new Date().toISOString(),
                chatHistory: currentEditingCharacter.chatHistory || [],
                longTermMemory: currentEditingCharacter.longTermMemory || []
            };

            const dataStr = JSON.stringify(chatData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `chat_${currentEditingCharacter.name}_${Date.now()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            alert(`ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÂØºÂá∫!\nÂåÖÂê´ ${chatData.chatHistory.length} Êù°ÂØπËØù`);
        }

        function importChatHistory() {
            if (!currentEditingCharacter) return;

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);

                        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                        if (!importedData.chatHistory || !Array.isArray(importedData.chatHistory)) {
                            alert('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ');
                            return;
                        }

                        const importCount = importedData.chatHistory.length;
                        const currentCount = currentEditingCharacter.chatHistory?.length || 0;

                        const action = confirm(
                            `ÂØºÂÖ•ÊñπÂºèÈÄâÊã©Ôºö\n\n` +
                            `ÂΩìÂâçËÅäÂ§©ËÆ∞ÂΩïÔºö${currentCount}Êù°\n` +
                            `ÂØºÂÖ•Êñá‰ª∂ÂåÖÂê´Ôºö${importCount}Êù°\n\n` +
                            `ÁÇπÂáª"Á°ÆÂÆö"ÔºöË¶ÜÁõñÂΩìÂâçËÆ∞ÂΩï\n` +
                            `ÁÇπÂáª"ÂèñÊ∂à"ÔºöËøΩÂä†Âà∞Áé∞ÊúâËÆ∞ÂΩï`
                        );

                        if (action) {
                            // Ë¶ÜÁõñÊ®°Âºè
                            currentEditingCharacter.chatHistory = importedData.chatHistory;
                            if (importedData.longTermMemory) {
                                currentEditingCharacter.longTermMemory = importedData.longTermMemory;
                            }
                        } else {
                            // ËøΩÂä†Ê®°Âºè
                            if (!currentEditingCharacter.chatHistory) {
                                currentEditingCharacter.chatHistory = [];
                            }
                            currentEditingCharacter.chatHistory.push(...importedData.chatHistory);

                            if (importedData.longTermMemory && importedData.longTermMemory.length > 0) {
                                if (!currentEditingCharacter.longTermMemory) {
                                    currentEditingCharacter.longTermMemory = [];
                                }
                                currentEditingCharacter.longTermMemory.push(...importedData.longTermMemory);
                            }
                        }

                        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                        await db.characters.put(currentEditingCharacter);

                        // Êõ¥Êñ∞UIÊòæÁ§∫
                        const newCount = currentEditingCharacter.chatHistory.length;
                        document.getElementById('chat-message-count').textContent = newCount;
                        document.getElementById('chat-token-estimate').textContent = '~' + (newCount * 100);

                        alert(`ÂØºÂÖ•ÊàêÂäüÔºÅ\nÂΩìÂâçÂÖ±Êúâ ${newCount} Êù°ËÅäÂ§©ËÆ∞ÂΩï`);

                    } catch (error) {
                        console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        function clearChatHistory() {
            if(!currentEditingCharacter) return;
            if(confirm(`Á°ÆÂÆöÊ∏ÖÁ©∫ËßíËâ≤ "${currentEditingCharacter.name}" ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêó?`)) {
                currentEditingCharacter.chatHistory = [];
                db.characters.put(currentEditingCharacter).then(() => {
                    alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                    // Êõ¥Êñ∞UIÊòæÁ§∫
                    document.getElementById('chat-message-count').textContent = '0';
                });
            }
        }
        function populateBingoCardsDropdown() {
            const select = document.getElementById('character-detail-bingo-link');
            select.innerHTML = '<option value="">‰∏çÂÖ≥ËÅî</option>';
            store.projects.filter(p => p.status === 'active').forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.theme;
                select.appendChild(option);
            });
        }

        // ÊâìÂºÄËßíËâ≤ËØ¶ÊÉÖ
        async function openCharacterDetail(characterId) {
            const character = await db.characters.get(characterId);
            if(!character) {
                alert('ËßíËâ≤‰∏çÂ≠òÂú®');
                return;
            }

            currentEditingCharacter = character;
            if (!character.settings) character.settings = {}; // Ensure settings object exists

            // --- Populate the new form ---
            
            // Identity
            document.getElementById('character-detail-avatar').src = character.avatar || 'https://via.placeholder.com/70';
            document.getElementById('user-avatar-preview').src = store.userAvatar || 'https://via.placeholder.com/70';
            document.getElementById('character-detail-nickname').value = character.settings.nickname || '';
            document.getElementById('character-detail-name-input').value = character.name || '';

            // Âä†ËΩΩÂàÜÁªÑ‰∏ãÊãâÈÄâÈ°π
            loadGroupOptions();
            document.getElementById('character-detail-group').value = character.settings.group || '';

            // Persona
            document.getElementById('character-detail-description').value = character.description || '';
            document.getElementById('character-detail-user-persona').value = store.userPersona || '';
            document.getElementById('character-detail-first-mes').value = character.first_mes || '';

            // AI Core
            await renderLinkedWorldBooks(character);
            await renderLinkedBingoCards(character); // Replaced populateBingoCardsDropdown
            document.getElementById('character-detail-bg-activity').checked = character.settings.bgActivity || false;
            // bgCooldownÁé∞Âú®‰ª•ÂàÜÈíü‰∏∫Âçï‰ΩçÔºåÂ¶ÇÊûúÊòØÊóßÊï∞ÊçÆÔºàÂ∞è‰∫é60ÔºâÔºåËΩ¨Êç¢‰∏∫ÂàÜÈíü
            const cooldown = character.settings.bgCooldown || 2;
            document.getElementById('character-detail-bg-cooldown').value = cooldown < 60 ? cooldown * 60 : cooldown;
            document.getElementById('character-max-memory').value = character.settings.maxMemory || 20;
            document.getElementById('character-detail-pinned-memory').value = character.settings.pinnedMemory || 0;
            document.getElementById('character-detail-auto-summary').checked = character.settings.autoSummary || false;
            document.getElementById('character-detail-summary-interval').value = character.settings.summaryInterval || 10;
            document.getElementById('character-detail-time-awareness').checked = character.settings.timeAwareness === false ? false : true;
            document.getElementById('character-detail-msg-mode').value = character.settings.msgMode || 'split';

            // Appearance
            document.getElementById('character-detail-bg-follow').checked = character.settings.bgFollow === false ? false : true;
            document.getElementById('character-detail-show-avatar').checked = character.settings.showAvatar === false ? false : true;
            document.getElementById('character-detail-bubble-size').value = character.settings.bubbleSize || 14;
            document.getElementById('bubble-size-value').textContent = (character.settings.bubbleSize || 14) + 'px';
            document.getElementById('character-detail-bubble-css-user').value = character.settings.bubbleCssUser || character.settings.bubbleCss || '';
            document.getElementById('character-detail-bubble-css-ai').value = character.settings.bubbleCssAi || character.settings.bubbleCss || '';

            // Âä†ËΩΩÊ†∑ÂºèÈ¢ÑËÆæÂàóË°®
            loadBubblePresetList();

            // Êõ¥Êñ∞È¢ÑËßà
            updateBubblePreview();

            // ËÆæÁΩÆÂÆûÊó∂È¢ÑËßàÁõëÂê¨Âô®
            setupBubblePreviewListeners();

            // Records
            const messageCount = character.chatHistory ? character.chatHistory.length : 0;
            const maxMemory = character.settings.maxMemory || 20;
            const pinnedMemory = character.settings.pinnedMemory || 0;

            document.getElementById('chat-message-count').textContent = messageCount;
            document.getElementById('context-limit-display').textContent = maxMemory;
            document.getElementById('pinned-memory-display').textContent = pinnedMemory;

            // Token‰º∞ÁÆóÔºöÁ≥ªÁªüÊèêÁ§∫ËØç~500 + ‰∏ä‰∏ãÊñáÊù°Êï∞√ó100 + ÈïøÊúüËÆ∞ÂøÜ√ó50
            const estimatedTokens = 500 + (Math.min(messageCount, maxMemory) * 100) + (pinnedMemory * 50);
            document.getElementById('chat-token-estimate').textContent = '~' + estimatedTokens;

            document.getElementById('modal-character-detail').classList.add('active');
        }

        // Ê∏≤ÊüìÂ∑≤ÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶Ê†áÁ≠æ
        async function renderLinkedWorldBooks(character) {
            const container = document.getElementById('character-linked-worldbooks');
            container.innerHTML = '';

            if(!character.settings.linkedWorldBookIds || character.settings.linkedWorldBookIds.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; font-size:0.8rem; padding:5px;">ÊöÇÊó†ÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶</div>';
                return;
            }

            for(const wbId of character.settings.linkedWorldBookIds) {
                const wb = await db.worldBooks.get(wbId);
                if(wb) {
                    const tag = document.createElement('div');
                    tag.style.cssText = 'background:var(--accent); color:var(--bg); padding:5px 12px; border-radius:15px; font-size:0.75rem; display:flex; align-items:center; gap:5px; margin-bottom:5px; margin-right:5px;';
                    tag.innerHTML = `
                        ${wb.name}
                        <span style="cursor:pointer; font-weight:bold;" onclick="removeWorldBookFromCharacter('${wbId}', event)">√ó</span>
                    `;
                    container.appendChild(tag);
                }
            }
        }

        // ‰ªéËßíËâ≤ÁßªÈô§‰∏ñÁïå‰π¶
        async function removeWorldBookFromCharacter(wbId, event) {
            event.stopPropagation();
            if(!currentEditingCharacter) return;
            const index = currentEditingCharacter.settings.linkedWorldBookIds.indexOf(wbId);
            if(index > -1) {
                currentEditingCharacter.settings.linkedWorldBookIds.splice(index, 1);
                // ‰ªÖÊõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÂØπË±°ÔºåÁÇπÂáª‰øùÂ≠òÊó∂ÊâçÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
                await renderLinkedWorldBooks(currentEditingCharacter);
            }
        }

        // Ê∏≤ÊüìÂ∑≤ÂÖ≥ËÅîÁöÑBingoÂç°Ê†áÁ≠æ
        async function renderLinkedBingoCards(character) {
            const container = document.getElementById('character-linked-bingo-cards');
            container.innerHTML = '';

            if(!character.settings.bingoLinkIds || character.settings.bingoLinkIds.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; font-size:0.8rem; padding:5px;">ÊöÇÊó†ÂÖ≥ËÅîÁöÑ Bingo Âç°</div>';
                return;
            }

            for(const pId of character.settings.bingoLinkIds) {
                const project = store.projects.find(p => p.id === pId);
                if(project) {
                    const tag = document.createElement('div');
                    tag.style.cssText = 'background:var(--accent); color:var(--bg); padding:5px 12px; border-radius:15px; font-size:0.75rem; display:flex; align-items:center; gap:5px; margin-bottom:5px; margin-right:5px;';
                    tag.innerHTML = `
                        ${project.theme}
                        <span style="cursor:pointer; font-weight:bold;" onclick="removeBingoCardFromCharacter('${pId}', event)">√ó</span>
                    `;
                    container.appendChild(tag);
                }
            }
        }

        // ‰ªéËßíËâ≤ÁßªÈô§BingoÂç°
        async function removeBingoCardFromCharacter(pId, event) {
            event.stopPropagation();
            if(!currentEditingCharacter) return;
            const projectId = parseInt(pId);
            const index = currentEditingCharacter.settings.bingoLinkIds.indexOf(projectId);
            if(index > -1) {
                currentEditingCharacter.settings.bingoLinkIds.splice(index, 1);
                await renderLinkedBingoCards(currentEditingCharacter);
            }
        }

        // ÈÄâÊã©BingoÂç°
        async function selectBingoCardsForCharacter() {
            const listDiv = document.getElementById('bingo-selection-list');
            const activeProjects = store.projects.filter(p => p.status === 'active');

            if(activeProjects.length === 0) {
                alert('ÊöÇÊó†ËøõË°å‰∏≠ÁöÑBingoÂç°');
                return;
            }

            listDiv.innerHTML = '';
            const linkedIds = currentEditingCharacter.settings.bingoLinkIds || [];
            activeProjects.forEach(p => {
                const isLinked = linkedIds.includes(p.id);
                listDiv.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="bingo-check-${p.id}" data-pid="${p.id}" ${isLinked ? 'checked' : ''} style="width:auto;">
                        <label for="bingo-check-${p.id}" style="flex:1; cursor:pointer;">
                            <div style="font-weight:bold;">${p.theme}</div>
                            <div style="font-size:0.7rem; opacity:0.6;">${p.tag} - ${p.tasks.length}‰∏™‰ªªÂä°</div>
                        </label>
                    </div>
                `;
            });

            document.getElementById('modal-select-bingo').classList.add('active');
        }

        // Á°ÆËÆ§BingoÂç°ÈÄâÊã©
        async function confirmBingoCardSelection() {
            if(!currentEditingCharacter) return;
            const selectedIds = [];
            const checkboxes = document.querySelectorAll('#bingo-selection-list input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if(cb.checked) {
                    selectedIds.push(parseInt(cb.dataset.pid));
                }
            });
            if (!currentEditingCharacter.settings) currentEditingCharacter.settings = {};
            currentEditingCharacter.settings.bingoLinkIds = selectedIds;
            await renderLinkedBingoCards(currentEditingCharacter);
            closeModal('modal-select-bingo');
        }

        // ÈÄâÊã©‰∏ñÁïå‰π¶
        async function selectWorldBooksForCharacter() {
            const listDiv = document.getElementById('worldbook-selection-list');
            const worldBooks = await db.worldBooks.toArray();

            if(worldBooks.length === 0) {
                alert('ÊöÇÊó†‰∏ñÁïå‰π¶, ËØ∑ÂÖàÂú®‰∏ñÁïå‰π¶ÁÆ°ÁêÜ‰∏≠ÂàõÂª∫');
                return;
            }

            listDiv.innerHTML = '';
            worldBooks.forEach(wb => {
                const isLinked = currentEditingCharacter.settings.linkedWorldBookIds.includes(wb.id);
                listDiv.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="wb-check-${wb.id}" ${isLinked ? 'checked' : ''} style="width:auto;">
                        <label for="wb-check-${wb.id}" style="flex:1; cursor:pointer;">
                            <div style="font-weight:bold;">${wb.name}</div>
                            <div style="font-size:0.7rem; opacity:0.6;">${wb.entries ? wb.entries.length : 0} ‰∏™Êù°ÁõÆ</div>
                        </label>
                    </div>
                `;
            });

            document.getElementById('modal-select-worldbooks').classList.add('active');
        }

        // Á°ÆËÆ§‰∏ñÁïå‰π¶ÈÄâÊã©
        async function confirmWorldBookSelection() {
            if(!currentEditingCharacter) return;
            const worldBooks = await db.worldBooks.toArray();
            const selectedIds = [];
            worldBooks.forEach(wb => {
                const checkbox = document.getElementById(`wb-check-${wb.id}`);
                if(checkbox && checkbox.checked) {
                    selectedIds.push(wb.id);
                }
            });
            currentEditingCharacter.settings.linkedWorldBookIds = selectedIds;
            await renderLinkedWorldBooks(currentEditingCharacter);
            closeModal('modal-select-worldbooks');
        }

        // ‰øùÂ≠òËßíËâ≤ÂÆåÊï¥‰ø°ÊÅØ
        async function saveCharacterFullInfo() {
            if(!currentEditingCharacter) return;

            const name = document.getElementById('character-detail-name-input').value.trim();
            if(!name) { alert('ËßíËâ≤ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫'); return; }

            if (!currentEditingCharacter.settings) currentEditingCharacter.settings = {};

            // Identity
            currentEditingCharacter.name = name;
            currentEditingCharacter.settings.nickname = document.getElementById('character-detail-nickname').value.trim();
            currentEditingCharacter.settings.group = document.getElementById('character-detail-group').value.trim();
            
            // Persona
            currentEditingCharacter.description = document.getElementById('character-detail-description').value.trim();
            store.userPersona = document.getElementById('character-detail-user-persona').value.trim(); // User persona is global
            currentEditingCharacter.first_mes = document.getElementById('character-detail-first-mes').value.trim();
            
            // AI Core - bingoLinkIds is now an array
            // The actual saving of bingoLinkIds happens in confirmBingoCardSelection
            currentEditingCharacter.settings.bgActivity = document.getElementById('character-detail-bg-activity').checked;
            currentEditingCharacter.settings.bgCooldown = parseInt(document.getElementById('character-detail-bg-cooldown').value) || 120;
            currentEditingCharacter.settings.maxMemory = parseInt(document.getElementById('character-max-memory').value) || 20;
            currentEditingCharacter.settings.pinnedMemory = parseInt(document.getElementById('character-detail-pinned-memory').value) || 0;
            currentEditingCharacter.settings.autoSummary = document.getElementById('character-detail-auto-summary').checked;
            currentEditingCharacter.settings.summaryInterval = parseInt(document.getElementById('character-detail-summary-interval').value) || 10;
            currentEditingCharacter.settings.timeAwareness = document.getElementById('character-detail-time-awareness').checked;
            currentEditingCharacter.settings.msgMode = document.getElementById('character-detail-msg-mode').value;

            // Appearance
            currentEditingCharacter.settings.bgFollow = document.getElementById('character-detail-bg-follow').checked;
            currentEditingCharacter.settings.showAvatar = document.getElementById('character-detail-show-avatar').checked;
            currentEditingCharacter.settings.bubbleSize = parseInt(document.getElementById('character-detail-bubble-size').value) || 14;
            currentEditingCharacter.settings.bubbleCssUser = document.getElementById('character-detail-bubble-css-user').value.trim();
            currentEditingCharacter.settings.bubbleCssAi = document.getElementById('character-detail-bubble-css-ai').value.trim();

            await db.characters.put(currentEditingCharacter);
            saveData(); // Save global store for userPersona and userAvatar
            await renderCharacterList(); // Refresh list
            
            alert('ËßíËâ≤‰ø°ÊÅØÂ∑≤‰øùÂ≠ò!');
        }

        async function saveAndOpenChat() {
            await saveCharacterFullInfo();
            // Áî±‰∫é saveCharacterFullInfo ‰ºöÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºåÊàë‰ª¨ÈúÄË¶ÅÈáçÊñ∞Ëé∑ÂèñËßíËâ≤Âπ∂ÊâìÂºÄËÅäÂ§©
            // currentEditingCharacter Âú® saveCharacterFullInfo ‰∏≠Â∑≤ÁªèË¢´Êõ¥Êñ∞Âπ∂‰øùÂ≠ò
            openCharacterChat();
        }

        // --- ÂàÜÁªÑÁÆ°ÁêÜÂäüËÉΩ ---
        function openGroupManager() {
            loadGroupOptions(); // ÂÖàÂä†ËΩΩÂàÜÁªÑÂàóË°®
            renderGroupList(); // Ê∏≤ÊüìÂàÜÁªÑÁÆ°ÁêÜÂàóË°®
            document.getElementById('modal-group-manager').classList.add('active');
        }

        function renderGroupList() {
            const container = document.getElementById('group-list-container');
            if (!store.characterGroups || store.characterGroups.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">ÊöÇÊó†ÂàÜÁªÑ</div>';
                return;
            }

            container.innerHTML = '';
            store.characterGroups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(0,0,0,0.05); background:var(--card-bg); margin-bottom:8px; border-radius:8px;';
                groupDiv.innerHTML = `
                    <span style="flex:1; font-size:0.95rem;">${escapeHtml(group)}</span>
                    <button class="btn-sec btn-danger" style="width:auto; padding:5px 12px; margin:0;" onclick="deleteGroup(${index})">Âà†Èô§</button>
                `;
                container.appendChild(groupDiv);
            });
        }

        function addNewGroup() {
            const input = document.getElementById('new-group-name');
            const groupName = input.value.trim();

            if (!groupName) {
                alert('ËØ∑ËæìÂÖ•ÂàÜÁªÑÂêçÁß∞');
                return;
            }

            if (store.characterGroups.includes(groupName)) {
                alert('ËØ•ÂàÜÁªÑÂ∑≤Â≠òÂú®');
                return;
            }

            store.characterGroups.push(groupName);
            saveData();
            input.value = '';
            renderGroupList();
            loadGroupOptions(); // Êõ¥Êñ∞ËßíËâ≤ËÆæÁΩÆÈ°µÈù¢ÁöÑ‰∏ãÊãâÊ°Ü
            alert('ÂàÜÁªÑÂ∑≤Ê∑ªÂä†!');
        }

        function deleteGroup(index) {
            const groupName = store.characterGroups[index];
            if (!confirm(`Á°ÆÂÆöÂà†Èô§ÂàÜÁªÑ "${groupName}"?`)) return;

            store.characterGroups.splice(index, 1);
            saveData();
            renderGroupList();
            loadGroupOptions();
            alert('ÂàÜÁªÑÂ∑≤Âà†Èô§');
        }

        function loadGroupOptions() {
            const select = document.getElementById('character-detail-group');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>';

            if (store.characterGroups && store.characterGroups.length > 0) {
                store.characterGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                });
            }

            // ÊÅ¢Â§ç‰πãÂâçÁöÑÈÄâÊã©
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // --- Ê∞îÊ≥°Ê†∑ÂºèÈ¢ÑËÆæÁÆ°ÁêÜ ---
        function saveBubblePreset() {
            const nameInput = document.getElementById('bubble-preset-name');
            const presetName = nameInput.value.trim();

            if (!presetName) {
                alert('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
                return;
            }

            const bubbleCssUser = document.getElementById('character-detail-bubble-css-user').value.trim();
            const bubbleCssAi = document.getElementById('character-detail-bubble-css-ai').value.trim();
            const bubbleSize = parseInt(document.getElementById('character-detail-bubble-size').value) || 14;

            if (!store.bubblePresets) store.bubblePresets = {};

            store.bubblePresets[presetName] = {
                cssUser: bubbleCssUser,
                cssAi: bubbleCssAi,
                size: bubbleSize
            };

            saveData();
            nameInput.value = '';
            loadBubblePresetList();
            alert('Ê†∑ÂºèÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò!');
        }

        function loadBubblePresetList() {
            const select = document.getElementById('bubble-preset-select');
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="">ÈÄâÊã©È¢ÑËÆæ</option>';

            if (store.bubblePresets) {
                Object.keys(store.bubblePresets).forEach(presetName => {
                    const option = document.createElement('option');
                    option.value = presetName;
                    option.textContent = presetName;
                    select.appendChild(option);
                });
            }

            if (currentValue) {
                select.value = currentValue;
            }
        }

        function loadBubblePreset() {
            const select = document.getElementById('bubble-preset-select');
            const presetName = select.value;

            if (!presetName || !store.bubblePresets || !store.bubblePresets[presetName]) {
                return;
            }

            const preset = store.bubblePresets[presetName];
            document.getElementById('character-detail-bubble-css-user').value = preset.cssUser || preset.css || '';
            document.getElementById('character-detail-bubble-css-ai').value = preset.cssAi || preset.css || '';
            document.getElementById('character-detail-bubble-size').value = preset.size || 14;
            document.getElementById('bubble-size-value').textContent = (preset.size || 14) + 'px';

            // Êõ¥Êñ∞È¢ÑËßà
            updateBubblePreview();
        }

        function updateBubblePreview() {
            const bubbleCssUser = document.getElementById('character-detail-bubble-css-user')?.value.trim() || '';
            const bubbleCssAi = document.getElementById('character-detail-bubble-css-ai')?.value.trim() || '';
            const bubbleSize = parseInt(document.getElementById('character-detail-bubble-size')?.value) || 14;

            const userBubble = document.querySelector('.preview-bubble-user');
            const charBubble = document.querySelector('.preview-bubble-char');

            if (userBubble) {
                const userDiv = userBubble.querySelector('div');
                if (userDiv) userDiv.style.fontSize = bubbleSize + 'px';

                // Â∫îÁî®Ëá™ÂÆö‰πâCSSÂà∞Áî®Êà∑Ê∞îÊ≥°
                if (bubbleCssUser) {
                    userBubble.style.cssText = `max-width:70%; background:var(--accent); color:var(--bg); padding:12px 16px; border-radius:16px; ${bubbleCssUser}`;
                } else {
                    userBubble.style.cssText = `max-width:70%; background:var(--accent); color:var(--bg); padding:12px 16px; border-radius:16px;`;
                }
            }

            if (charBubble) {
                const charDiv = charBubble.querySelector('div');
                if (charDiv) charDiv.style.fontSize = bubbleSize + 'px';

                // Â∫îÁî®Ëá™ÂÆö‰πâCSSÂà∞ËßíËâ≤Ê∞îÊ≥°
                if (bubbleCssAi) {
                    charBubble.style.cssText = `max-width:70%; background:var(--card-bg); color:var(--text); padding:12px 16px; border-radius:16px; border-left:3px solid var(--accent); ${bubbleCssAi}`;
                } else {
                    charBubble.style.cssText = `max-width:70%; background:var(--card-bg); color:var(--text); padding:12px 16px; border-radius:16px; border-left:3px solid var(--accent);`;
                }
            }
        }

        function setupBubblePreviewListeners() {
            const cssUserTextarea = document.getElementById('character-detail-bubble-css-user');
            const cssAiTextarea = document.getElementById('character-detail-bubble-css-ai');
            const sizeRange = document.getElementById('character-detail-bubble-size');

            if (cssUserTextarea) {
                cssUserTextarea.removeEventListener('input', updateBubblePreview);
                cssUserTextarea.addEventListener('input', updateBubblePreview);
            }

            if (cssAiTextarea) {
                cssAiTextarea.removeEventListener('input', updateBubblePreview);
                cssAiTextarea.addEventListener('input', updateBubblePreview);
            }

            if (sizeRange) {
                sizeRange.removeEventListener('input', updateBubblePreview);
                sizeRange.addEventListener('input', updateBubblePreview);
            }
        }

        // ÂÆûÊó∂Êõ¥Êñ∞Token‰º∞ÁÆó
        function updateTokenEstimate() {
            if (!currentEditingCharacter) return;

            const messageCount = currentEditingCharacter.chatHistory ? currentEditingCharacter.chatHistory.length : 0;
            const maxMemory = parseInt(document.getElementById('character-max-memory').value) || 20;
            const pinnedMemory = parseInt(document.getElementById('character-detail-pinned-memory').value) || 0;

            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('context-limit-display').textContent = maxMemory;
            document.getElementById('pinned-memory-display').textContent = pinnedMemory;

            // Token‰º∞ÁÆóÔºöÁ≥ªÁªüÊèêÁ§∫ËØç~500 + ‰∏ä‰∏ãÊñáÊù°Êï∞√ó100 + ÈïøÊúüËÆ∞ÂøÜ√ó50
            const estimatedTokens = 500 + (Math.min(messageCount, maxMemory) * 100) + (pinnedMemory * 50);
            document.getElementById('chat-token-estimate').textContent = '~' + estimatedTokens;
        }

        // Âà†Èô§ËßíËâ≤
        async function deleteCharacter() {
            if(!currentEditingCharacter) return;
            if(!confirm(`Á°ÆÂÆöÂà†Èô§ËßíËâ≤ "${currentEditingCharacter.name}"? ËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºöË¢´Âà†Èô§„ÄÇ`)) return;
            
            await db.characters.delete(currentEditingCharacter.id);
            closeModal('modal-character-detail');
            await renderCharacterList();
            alert('ËßíËâ≤Â∑≤Âà†Èô§');
        }

        // ÊâìÂºÄËßíËâ≤ËÅäÂ§©ÁïåÈù¢
        function openCharacterChat() {
            if(!currentEditingCharacter) return;

            resetUI(); // Âº∫Âà∂Ê∏ÖÂú∫
            document.body.classList.add('no-scroll');

            currentChatCharacter = currentEditingCharacter;

            // ËÆæÁΩÆËÅäÂ§©ÁïåÈù¢
            document.getElementById('chat-avatar').src = currentChatCharacter.avatar || 'https://via.placeholder.com/40';
            document.getElementById('chat-character-name').textContent = currentChatCharacter.name;

            // Ê∏≤ÊüìËÅäÂ§©ÂéÜÂè≤
            renderCharacterChatHistory();

            // ÊòæÁ§∫ËÅäÂ§©ÁïåÈù¢
            document.getElementById('character-chat-screen').style.display = 'flex';

            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('character-chat-input').focus();
            }, 300);
        }

        // ÂÖ≥Èó≠ËßíËâ≤ËÅäÂ§©ÁïåÈù¢
        function closeCharacterChat() {
            document.getElementById('character-chat-screen').style.display = 'none';
            document.getElementById('modal-character-detail').classList.remove('active');
            currentChatCharacter = null;
            resetUI();
        }

        function closeSettingsAndReturnToChat() {
            document.getElementById('modal-character-detail').classList.remove('active');
            document.getElementById('character-chat-screen').style.display = 'flex';
        }

        // ‰ªéËÅäÂ§©ÁïåÈù¢ÊâìÂºÄËßíËâ≤ËÆæÁΩÆ
        function openCharacterSettingsFromChat() {
            if(!currentChatCharacter) return;
            document.getElementById('character-chat-screen').style.display = 'none';
            openCharacterDetail(currentChatCharacter.id);
        }

        // ÂÖ®Â±ÄÂèòÈáèÔºöÊéßÂà∂ÂéÜÂè≤ÊäòÂè†
        let isHistoryCollapsed = false;
        const COLLAPSE_THRESHOLD = 40; // Ë∂ÖËøá40Êù°Ê∂àÊÅØÊó∂ÊòæÁ§∫ÊäòÂè†ÊåâÈíÆ

        // Ê∏≤ÊüìËÅäÂ§©ÂéÜÂè≤
        function renderCharacterChatHistory() {
            const container = document.getElementById('character-chat-messages');
            if(!currentChatCharacter || !currentChatCharacter.chatHistory || currentChatCharacter.chatHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; opacity:0.6; margin-top:50px;">
                        <div style="font-size:3rem; margin-bottom:10px;">üí¨</div>
                        <div>${currentChatCharacter.first_mes || 'ÂºÄÂßã‰Ω†‰ª¨ÁöÑÂØπËØùÂêß...'}</div>
                    </div>
                `;
                updateChatMessageCounter(0);
                return;
            }

            const visibleMessages = currentChatCharacter.chatHistory.filter(msg => !msg.hidden);
            const totalCount = visibleMessages.length;

            container.innerHTML = '';

            // Â¶ÇÊûúÂêØÁî®ÊäòÂè†‰∏îÊ∂àÊÅØÊï∞Ë∂ÖËøáÈòàÂÄºÔºåÂè™ÊòæÁ§∫ÊúÄËøëÁöÑÊ∂àÊÅØ
            let messagesToShow = visibleMessages;
            if (isHistoryCollapsed && totalCount > COLLAPSE_THRESHOLD) {
                // Âè™ÊòæÁ§∫ÊúÄËøë30Êù°
                messagesToShow = visibleMessages.slice(-30);

                // Ê∑ªÂä†"Âä†ËΩΩÊõ¥Â§ö"ÊåâÈíÆ
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.style.cssText = 'text-align:center; padding:10px; margin-bottom:15px;';
                loadMoreBtn.innerHTML = `<button class="btn-sec" onclick="loadMoreHistory()" style="font-size:0.8rem;">üìú Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤ (Â∑≤ÊäòÂè†${totalCount - 30}Êù°)</button>`;
                container.appendChild(loadMoreBtn);
            }

            messagesToShow.forEach(msg => {
                // ÊâæÂà∞Ê∂àÊÅØÂú®ÂéüÂßãchatHistory‰∏≠ÁöÑÁúüÂÆûÁ¥¢Âºï
                const realIndex = currentChatCharacter.chatHistory.indexOf(msg);
                appendCharacterMessage(msg, realIndex);
            });

            // Êõ¥Êñ∞Ê∂àÊÅØËÆ°Êï∞Âô®
            updateChatMessageCounter(totalCount);

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Êõ¥Êñ∞ËÅäÂ§©Ê∂àÊÅØËÆ°Êï∞Âô®
        function updateChatMessageCounter(count) {
            const counter = document.getElementById('chat-message-counter');
            if (counter) {
                counter.textContent = `(${count}Êù°)`;
            }
        }

        // ÂàáÊç¢ÂéÜÂè≤ÊäòÂè†Áä∂ÊÄÅ
        function toggleHistoryCollapse() {
            if (!currentChatCharacter) return;

            const totalCount = currentChatCharacter.chatHistory.filter(msg => !msg.hidden).length;

            if (totalCount <= COLLAPSE_THRESHOLD) {
                alert(`ÂΩìÂâçÂØπËØù‰ªÖ${totalCount}Êù°ÔºåÊó†ÈúÄÊäòÂè†`);
                return;
            }

            isHistoryCollapsed = !isHistoryCollapsed;
            const btn = document.getElementById('chat-collapse-btn');

            if (isHistoryCollapsed) {
                btn.textContent = 'üìÇ'; // ÊäòÂè†Áä∂ÊÄÅ
                btn.title = 'Â±ïÂºÄÂéÜÂè≤';
            } else {
                btn.textContent = 'üìã'; // Â±ïÂºÄÁä∂ÊÄÅ
                btn.title = 'ÊäòÂè†ÂéÜÂè≤';
            }

            renderCharacterChatHistory();
        }

        // Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤
        function loadMoreHistory() {
            isHistoryCollapsed = false;
            const btn = document.getElementById('chat-collapse-btn');
            btn.textContent = 'üìã';
            btn.title = 'ÊäòÂè†ÂéÜÂè≤';
            renderCharacterChatHistory();
        }

        // ËøΩÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function appendCharacterMessage(msg, index) {
            const container = document.getElementById('character-chat-messages');
            const messageDiv = document.createElement('div');
            
            // Handle temporary system messages
            if (msg.isTemp) {
                messageDiv.id = msg.tempId;
                messageDiv.style.cssText = `text-align:center; font-size:0.8rem; opacity:0.6; margin-bottom:15px;`;
                messageDiv.innerHTML = `<div style="display:inline-block; background:var(--card-bg); padding:5px 10px; border-radius:10px;">${escapeHtml(msg.content)}</div>`;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                return;
            }

            const isUser = msg.role === 'user';
            const showAvatar = currentChatCharacter.settings.showAvatar !== false; // ÈªòËÆ§ÊòæÁ§∫
            const bubbleSize = currentChatCharacter.settings.bubbleSize || 14;
            const customCssUser = currentChatCharacter.settings.bubbleCssUser || currentChatCharacter.settings.bubbleCss || '';
            const customCssAi = currentChatCharacter.settings.bubbleCssAi || currentChatCharacter.settings.bubbleCss || '';

            // Â§¥ÂÉè URL
            const avatarUrl = isUser
                ? (store.userAvatar || 'https://via.placeholder.com/40')
                : (currentChatCharacter.avatar || 'https://via.placeholder.com/40');

            const alignStyle = isUser ? 'flex-end' : 'flex-start';
            const bgColor = isUser ? 'var(--accent)' : 'var(--card-bg)';
            const textColor = isUser ? 'var(--bg)' : 'var(--text)';

            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•indexÔºåËá™Âä®ËÆ°ÁÆó
            if(index === undefined && currentChatCharacter) {
                index = currentChatCharacter.chatHistory.indexOf(msg);
            }

            messageDiv.style.cssText = `display:flex; justify-content:${alignStyle}; align-items:flex-start; gap:8px; margin-bottom:15px;`;

            // Â§¥ÂÉè HTML
            const avatarHtml = `<img src="${avatarUrl}" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid rgba(0,0,0,0.1); flex-shrink:0;">`;

            let innerHTML = '';

            // ÊûÑÂª∫Ê∞îÊ≥°Ê†∑ÂºèÔºàËá™ÂÆö‰πâCSS‰ºöË¶ÜÁõñÈªòËÆ§Ê†∑ÂºèÔºâ
            let bubbleStyle = `max-width:70%; background:${bgColor}; color:${textColor}; padding:8px 12px; border-radius:16px; ${!isUser ? 'border-left:3px solid var(--accent);' : ''} cursor:pointer; position:relative; font-size:${bubbleSize}px;`;

            // Â∫îÁî®Ëá™ÂÆö‰πâCSSÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
            const customCss = isUser ? customCssUser : customCssAi;
            if (customCss) {
                bubbleStyle += ' ' + customCss;
            }

            // ÊûÑÂª∫ÂºïÁî®ÂùóHTMLÔºàÂ¶ÇÊûúÊúâÂºïÁî®Ôºâ
            let quoteHtml = '';
            if (msg.quote) {
                const quoteRoleName = msg.quote.role === 'user' ? '‰Ω†' : (currentChatCharacter?.name || 'AI');
                const quotePreview = msg.quote.content.substring(0, 80) + (msg.quote.content.length > 80 ? '...' : '');
                quoteHtml = `
                    <div class="quote-block" onclick="scrollToMessage(${msg.quote.index})" title="ÁÇπÂáªË∑≥ËΩ¨Âà∞ÂéüÊ∂àÊÅØ">
                        <div class="quote-block-header">‚Ü© ÂºïÁî® ${quoteRoleName}</div>
                        <div class="quote-block-content">${escapeHtml(quotePreview)}</div>
                    </div>
                    <div class="quote-divider"></div>
                `;
            }

            // Ê∞îÊ≥° HTML
            const bubbleHtml = `
                <div class="chat-message-bubble" data-msg-index="${index}" data-msg-role="${msg.role}" data-msg-content="${escapeHtml(msg.content)}" ${msg.quote ? `data-quote-index="${msg.quote.index}"` : ''} style="${bubbleStyle}">
                    ${quoteHtml}
                    <div class="markdown-content">${renderMarkdown(msg.content)}</div>
                    <div style="font-size:${bubbleSize * 0.75}px; opacity:0.6; margin-top:5px; text-align:right;">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>
            `;

            if (isUser) {
                innerHTML = bubbleHtml + (showAvatar ? avatarHtml : '');
            } else {
                innerHTML = (showAvatar ? avatarHtml : '') + bubbleHtml;
            }

            messageDiv.innerHTML = innerHTML;
            container.appendChild(messageDiv);

            // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂
            const bubble = messageDiv.querySelector('.chat-message-bubble');
            setupMessageLongPress(bubble);

            // Êõ¥Êñ∞Ê∂àÊÅØËÆ°Êï∞Âô®
            if (currentChatCharacter) {
                const totalCount = currentChatCharacter.chatHistory.filter(msg => !msg.hidden).length;
                updateChatMessageCounter(totalCount);
            }
        }

        // ËÆæÁΩÆÊ∂àÊÅØÈïøÊåâ‰∫ã‰ª∂
        function setupMessageLongPress(bubble) {
            let longPressTimer = null;
            let touchStartTime = 0;

            bubble.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                // Â§öÈÄâÊ®°Âºè‰∏ã‰∏çËß¶ÂèëÈïøÊåâËèúÂçï
                if (isMultiSelectMode) return;

                longPressTimer = setTimeout(() => {
                    showCharacterMessageMenu(e, bubble);
                }, 500);
            });

            bubble.addEventListener('touchend', function(e) {
                if(longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // Â§öÈÄâÊ®°Âºè‰∏ãÔºåÁÇπÂáªÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ (ÂèñÊ∂àÊó∂Èó¥ÈôêÂà∂ÔºåÊîπÂñÑÊâãÊÑü)
                if (isMultiSelectMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    const index = parseInt(bubble.dataset.msgIndex);
                    toggleMessageSelection(bubble, index);
                }
            });

            bubble.addEventListener('touchmove', function() {
                if(longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            // PCÁ´ØÂè≥ÈîÆËèúÂçï
            bubble.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                if (!isMultiSelectMode) {
                    showCharacterMessageMenu(e, bubble);
                }
            });

            // PCÁ´ØÁÇπÂáªÔºàÁî®‰∫éÂ§öÈÄâÊ®°ÂºèÔºâ
            bubble.addEventListener('click', function(e) {
                if (isMultiSelectMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    const index = parseInt(bubble.dataset.msgIndex);
                    toggleMessageSelection(bubble, index);
                }
            });
        }

        // ÊòæÁ§∫Ê∂àÊÅØËèúÂçï
        let currentMessageBubble = null;

        function showCharacterMessageMenu(e, bubble) {
            currentMessageBubble = bubble;

            const menu = document.getElementById('character-message-menu');
            const msgRole = bubble.dataset.msgRole;

            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑËèúÂçïÈ°π
            const allItems = menu.querySelectorAll('.context-menu-item');
            allItems.forEach(item => item.style.display = 'flex');

            // Áî®Êà∑Ê∂àÊÅØ‰∏çÊòæÁ§∫"Âà∑Êñ∞ÈáçËØï"
            if(msgRole === 'user') {
                allItems.forEach(item => {
                    if(item.textContent.includes('Âà∑Êñ∞ÈáçËØï')) {
                        item.style.display = 'none';
                    }
                });
            }

            // ÊòæÁ§∫ËèúÂçï
            menu.classList.add('active');

            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            // Ê£ÄÊü•ËæπÁïå
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if(rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if(rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
            }, 10);
        }

        // Â§ÑÁêÜÊ∂àÊÅØËèúÂçïÊìç‰Ωú
        async function handleCharacterMessageAction(action) {
            const menu = document.getElementById('character-message-menu');
            menu.classList.remove('active');

            if(!currentMessageBubble || !currentChatCharacter) return;

            const msgIndex = parseInt(currentMessageBubble.dataset.msgIndex);
            
            // ‰øÆÂ§çÔºöÁõ¥Êé•‰ªé chatHistory Ëé∑ÂèñÂÆåÊï¥Ê∂àÊÅØÂØπË±°ÔºåËÄå‰∏çÊòØ‰æùËµñ DOM Â±ûÊÄßÔºàÈÅøÂÖçÈïøÊñáÊú¨Êà™Êñ≠Ôºâ
            const targetMsg = currentChatCharacter.chatHistory[msgIndex];
            if (!targetMsg) {
                console.error("Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑÊ∂àÊÅØÂØπË±°ÔºåÁ¥¢Âºï:", msgIndex);
                return;
            }

            const msgContent = targetMsg.content;
            const msgRole = targetMsg.role;

            switch(action) {
                case 'copy':
                    // Â§çÂà∂Ê∂àÊÅØ
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = msgContent;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    updateChatStatus('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'online');
                    setTimeout(() => updateChatStatus('Âú®Á∫ø', 'online'), 2000);
                    break;

                case 'edit':
                    // ÁºñËæëÊ∂àÊÅØ
                    const newContent = prompt('ÁºñËæëÊ∂àÊÅØ:', msgContent);
                    if(newContent && newContent.trim()) {
                        currentChatCharacter.chatHistory[msgIndex].content = newContent;
                        await db.characters.put(currentChatCharacter);
                        renderCharacterChatHistory();
                    }
                    break;

                case 'retry':
                    // Âà∑Êñ∞ÈáçËØïÔºà‰ªÖAIÊ∂àÊÅØÔºâ
                    if(msgRole === 'assistant') {
                        // Âà†Èô§ËøôÊù°AIÊ∂àÊÅØ
                        currentChatCharacter.chatHistory.splice(msgIndex, 1);
                        await db.characters.put(currentChatCharacter);
                        renderCharacterChatHistory();
                        // ÈáçÊñ∞ÁîüÊàê
                        await triggerCharacterAIResponse();
                    }
                    break;

                case 'quote':
                    // ÂºïÁî®ÂõûÂ§ç - ‰ΩøÁî®Êñ∞ÁöÑÂºïÁî®Á≥ªÁªü
                    setQuotePreview(msgIndex, msgRole, msgContent);
                    document.getElementById('character-chat-input').focus();
                    break;

                case 'multiSelect':
                    // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
                    enterMultiSelectMode(currentMessageBubble);
                    break;

                case 'delete':
                    // Âà†Èô§Ê∂àÊÅØÔºà‰ªé‰∏ä‰∏ãÊñáÂà†Èô§ÔºåAIÁúã‰∏çÂà∞Ôºâ
                    if(confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°Ê∂àÊÅØ?ÔºàAIÂ∞ÜÁúã‰∏çÂà∞Ê≠§Ê∂àÊÅØÔºâ')) {
                        currentChatCharacter.chatHistory.splice(msgIndex, 1);
                        await db.characters.put(currentChatCharacter);
                        renderCharacterChatHistory();
                    }
                    break;

                case 'hide':
                    // Êí§ÂõûÊ∂àÊÅØÔºà‰ªÖUIÈöêËóèÔºåAIÂèØ‰ª•ÁúãÂà∞Ôºâ
                    if(confirm('Á°ÆÂÆöÊí§ÂõûËøôÊù°Ê∂àÊÅØ?ÔºàÊ∂àÊÅØ‰ºöË¢´ÈöêËóèÔºå‰ΩÜAI‰ªçËÉΩÁúãÂà∞Ôºâ')) {
                        currentChatCharacter.chatHistory[msgIndex].hidden = true;
                        await db.characters.put(currentChatCharacter);
                        renderCharacterChatHistory();
                    }
                    break;
            }
        }

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('character-message-menu');
            if(menu && !e.target.closest('#character-message-menu') && !e.target.closest('.chat-message-bubble')) {
                menu.classList.remove('active');
            }
        });

        // --- [Vesper] Â§öÈÄâÊ®°ÂºèÁõ∏ÂÖ≥ ---
        let isMultiSelectMode = false;
        let selectedMessageIndices = new Set();

        function enterMultiSelectMode(initialBubble) {
            isMultiSelectMode = true;
            selectedMessageIndices.clear();

            const container = document.getElementById('character-chat-messages');
            if (container) container.classList.add('multi-select-mode');

            // ÈÄâ‰∏≠ÂΩìÂâçÊ∂àÊÅØ
            if (initialBubble) {
                const index = parseInt(initialBubble.dataset.msgIndex);
                toggleMessageSelection(initialBubble, index);
            }

            // ÊòæÁ§∫Â∑•ÂÖ∑Ê†è
            const toolbar = document.getElementById('multi-select-toolbar');
            if (toolbar) {
                toolbar.classList.add('active');
                toolbar.style.display = 'flex';
            }
        }

        function toggleMessageSelection(bubble, index) {
            if (selectedMessageIndices.has(index)) {
                selectedMessageIndices.delete(index);
                bubble.classList.remove('selected');
            } else {
                selectedMessageIndices.add(index);
                bubble.classList.add('selected');
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedMessageIndices.size;
        }

        function selectAllMessages() {
            const container = document.getElementById('character-chat-messages');
            container.querySelectorAll('.chat-message-bubble').forEach(bubble => {
                const index = parseInt(bubble.dataset.msgIndex);
                if (!selectedMessageIndices.has(index)) {
                    selectedMessageIndices.add(index);
                    bubble.classList.add('selected');
                }
            });
            updateSelectedCount();
        }

        function cancelMultiSelect() {
            isMultiSelectMode = false;
            selectedMessageIndices.clear();

            const container = document.getElementById('character-chat-messages');
            if (container) {
                container.classList.remove('multi-select-mode');
                // ÁßªÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
                container.querySelectorAll('.chat-message-bubble.selected').forEach(bubble => {
                    bubble.classList.remove('selected');
                });
            }

            // ÈöêËóèÂ∑•ÂÖ∑Ê†è
            const toolbar = document.getElementById('multi-select-toolbar');
            if (toolbar) {
                toolbar.classList.remove('active');
                toolbar.style.display = 'none';
            }
        }

        async function deleteSelectedMessages() {
            if (selectedMessageIndices.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØ');
                return;
            }

            if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessageIndices.size} Êù°Ê∂àÊÅØÂêóÔºü`)) {
                return;
            }

            // ÊåâÁ¥¢Âºï‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫èÔºåÈÅøÂÖçÂà†Èô§Êó∂Á¥¢ÂºïÈîô‰Ωç
            const sortedIndices = Array.from(selectedMessageIndices).sort((a, b) => b - a);

            for (const index of sortedIndices) {
                currentChatCharacter.chatHistory.splice(index, 1);
            }

            await db.characters.put(currentChatCharacter);
            cancelMultiSelect();
            renderCharacterChatHistory();
        }

        // --- [Vesper] ÂºïÁî®Ê∂àÊÅØÁ≥ªÁªü ---
        let currentQuote = null; // { index, role, content }

        function setQuotePreview(msgIndex, msgRole, msgContent) {
            const roleName = msgRole === 'user' ? '‰Ω†' : (currentChatCharacter?.name || 'AI');
            const preview = msgContent.substring(0, 50) + (msgContent.length > 50 ? '...' : '');

            currentQuote = {
                index: msgIndex,
                role: msgRole,
                content: msgContent
            };

            const previewEl = document.getElementById('quote-preview');
            const contentEl = document.getElementById('quote-preview-content');
            contentEl.innerHTML = `<span style="opacity:0.6;">ÂºïÁî® ${roleName}:</span> ${preview}`;
            previewEl.classList.add('active');
        }

        function clearQuotePreview() {
            currentQuote = null;
            const previewEl = document.getElementById('quote-preview');
            previewEl.classList.remove('active');
        }

        // Ë∑≥ËΩ¨Âà∞Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØ
        function scrollToMessage(msgIndex) {
            const container = document.getElementById('character-chat-messages');

            // ÂÖàÂ±ïÂºÄÂéÜÂè≤ÔºàÂ¶ÇÊûúË¢´ÊäòÂè†ÁöÑËØùÔºâ
            if (isHistoryCollapsed) {
                isHistoryCollapsed = false;
                renderCharacterChatHistory();
                // Á≠âÂæÖÊ∏≤ÊüìÂêéÂÜçË∑≥ËΩ¨
                setTimeout(() => {
                    highlightAndScrollTo(msgIndex);
                }, 300);
            } else {
                highlightAndScrollTo(msgIndex);
            }
        }

        function highlightAndScrollTo(msgIndex) {
            const container = document.getElementById('character-chat-messages');
            const bubble = container.querySelector(`.chat-message-bubble[data-msg-index="${msgIndex}"]`);

            if (bubble) {
                bubble.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // È´ò‰∫ÆÈó™ÁÉÅÊïàÊûú
                bubble.style.transition = 'box-shadow 0.3s, transform 0.3s';
                bubble.style.boxShadow = '0 0 0 3px var(--accent)';
                bubble.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    bubble.style.boxShadow = 'none';
                    bubble.style.transform = 'scale(1)';
                }, 2000);
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØÁªôËßíËâ≤
        async function sendCharacterMessage() {
            if(!currentChatCharacter) return;

            const input = document.getElementById('character-chat-input');
            const content = input.value.trim();

            // ÊêúÁ¥¢Ê®°ÂºèÔºöÂç≥‰ΩøËæìÂÖ•‰∏∫Á©∫‰πüÂèØ‰ª•Ëß¶ÂèëÔºàAI‰ºöÂàÜÊûê‰∏ä‰∏ãÊñáÔºâ
            if (isSearchEnabled) {
                await executeSmartWebSearch('character');
                return;
            }

            if (isLocalSearchEnabled) {
                await executeSmartLocalSearch('character');
                return;
            }

            // ÊôÆÈÄöÊ∂àÊÅØÊ®°ÂºèÔºöÂøÖÈ°ªÊúâÂÜÖÂÆπ
            if(!content) return;

            // ÂàõÂª∫Áî®Êà∑Ê∂àÊÅØÔºàÊîØÊåÅÂºïÁî®Ôºâ
            const userMsg = {
                role: 'user',
                content: content,
                timestamp: Date.now()
            };

            // Â¶ÇÊûúÊúâÂºïÁî®ÔºåÊ∑ªÂä†ÂºïÁî®‰ø°ÊÅØ
            if (currentQuote) {
                userMsg.quote = {
                    index: currentQuote.index,
                    role: currentQuote.role,
                    content: currentQuote.content.substring(0, 200) // ÈôêÂà∂ÂºïÁî®ÈïøÂ∫¶
                };
                clearQuotePreview();
            }

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤
            currentChatCharacter.chatHistory.push(userMsg);
            await db.characters.put(currentChatCharacter);

            // ÊòæÁ§∫Ê∂àÊÅØ
            appendCharacterMessage(userMsg);
            input.value = '';

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            const container = document.getElementById('character-chat-messages');
            container.scrollTop = container.scrollHeight;

            // ÊòæÁ§∫AIÂõûÂ§çÊåâÈíÆ
            document.getElementById('character-ai-reply-btn').style.display = 'block';
        }

        // Ëß¶ÂèëAIÂõûÂ§ç (Ê†∏ÂøÉÂáΩÊï∞ - ÊîØÊåÅÂøÉÂ£∞Á≥ªÁªü)
        async function triggerCharacterAIResponse(extraSystemContext) {
            if(!currentChatCharacter) return;

            if(!store.apiConfig.main.url || !store.apiConfig.main.key) {
                updateChatStatus('ÈîôËØØ: Êú™ÈÖçÁΩÆAPI', 'error');
                alert('Vesper: ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ‰∏ªAPI!');
                return;
            }

            document.getElementById('character-ai-reply-btn').style.display = 'none';
            updateChatStatus('AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...', 'thinking');

            try {
                let systemPrompt = await buildCharacterSystemPrompt();
                if (extraSystemContext) {
                    systemPrompt += "\n\n" + extraSystemContext;
                }

                // Ëé∑Âèñ‰∏ä‰∏ãÊñáÊù°Êï∞ËÆæÁΩÆÔºàÁü≠ÊúüËÆ∞ÂøÜÔºâ
                // Ê≥®ÊÑèÔºöÂè™ÂèñÊúÄËøëNÊù°Ê∂àÊÅØÂèëÈÄÅÁªôAIÔºåÈÅøÂÖçtokenË∂ÖÈôêÂíåÊàêÊú¨ËøáÈ´ò
                const maxMemory = currentChatCharacter.settings.maxMemory || 20;
                const recentHistory = currentChatCharacter.chatHistory.slice(-maxMemory);

                console.log(`[AIË∞ÉÁî®] ‰ΩøÁî®ÊúÄËøë ${recentHistory.length}/${currentChatCharacter.chatHistory.length} Êù°Ê∂àÊÅØ‰Ωú‰∏∫‰∏ä‰∏ãÊñá`);

                const messages = recentHistory.map(msg => {
                    // ÊûÑÂª∫Ê∂àÊÅØÂÜÖÂÆπÔºàÊîØÊåÅÂºïÁî®Ôºâ
                    let textContent = msg.content;

                    // [Êó∂Èó¥Êà≥Ê≥®ÂÖ•] Âú®ÊØèÊù°Ê∂àÊÅØÂâçÊ∑ªÂä†Êó∂Èó¥Êà≥‰ø°ÊÅØ
                    const msgTime = msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'Êú™Áü•Êó∂Èó¥';
                    const timePrefix = `[Ê∂àÊÅØÊó∂Èó¥: ${msgTime}]\n`;
                    textContent = timePrefix + textContent;

                    // Â¶ÇÊûúÊúâÂºïÁî®ÔºåÂú®Ê∂àÊÅØÂâçÊ∑ªÂä†ÂºïÁî®‰∏ä‰∏ãÊñá
                    if (msg.quote) {
                        const quoteRoleName = msg.quote.role === 'user' ? 'Áî®Êà∑' : currentChatCharacter.name;
                        textContent = `[ÂºïÁî® ${quoteRoleName} ËØ¥: "${msg.quote.content.substring(0, 100)}"]\n${textContent}`;
                    }

                    // Check for markdown image syntax: ![Image](data:image/...)
                    // Support multiple images
                    const imgRegex = /!\[Image\]\((data:image\/[^;]+;base64,[^)]+)\)/g;
                    const matches = [...textContent.matchAll(imgRegex)];

                    if (matches.length > 0) {
                        const contentParts = [];

                        // Clean text by removing all image markdown
                        const cleanText = textContent.replace(imgRegex, '').trim();
                        contentParts.push({ type: "text", text: cleanText || "Images uploaded" });

                        // Add all images
                        matches.forEach(match => {
                            contentParts.push({
                                type: "image_url",
                                image_url: { url: match[1] }
                            });
                        });

                        return {
                            role: msg.role,
                            content: contentParts
                        };
                    }
                    return { role: msg.role, content: textContent };
                });

                const apiUrl = store.apiConfig.main.url.endsWith('/')
                    ? store.apiConfig.main.url + 'chat/completions'
                    : store.apiConfig.main.url + '/chat/completions';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${store.apiConfig.main.key}`
                    },
                    body: JSON.stringify({
                        model: store.apiConfig.main.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...messages,
                            // [Vesper Fix] Âä®ÊÄÅÊó∂Èó¥Ê≥®ÂÖ• - ÊØèÊ¨°ÂèëÈÄÅÊó∂Âº∫Âà∂Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
                            { role: 'system', content: `[ÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥]: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}„ÄÇËØ∑Ê†πÊçÆÊ≠§Êó∂Èó¥Âà§Êñ≠ User ÁöÑ‰ΩúÊÅØÁä∂ÊÄÅÂíåÊó∂ÊÆµËØ≠Â¢É„ÄÇ` }
                        ],
                        temperature: currentChatCharacter.settings.temperature || 0.8
                    })
                });

                if(!response.ok) {
                    const errorText = await response.text();
                    let errorMsg = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.error?.message || errorText;
                    } catch(e) {
                        errorMsg = errorText.substring(0, 100);
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                const rawContent = data.choices?.[0]?.message?.content;

                if(!rawContent || rawContent.trim() === '') {
                    throw new Error('APIËøîÂõûÁ©∫ÂõûÂ§ç');
                }

                // --- Ëß£ÊûêÂìçÂ∫î (ÊîØÊåÅJSONÂíåÊôÆÈÄöÊñáÊú¨) ---
                let messagesToSend = [];
                let innerVoiceData = null;

                try {
                    // Â∞ùËØïÂáÄÂåñJSONÂ≠óÁ¨¶‰∏≤
                    let sanitized = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                    const first = sanitized.indexOf('{');
                    const last = sanitized.lastIndexOf('}');
                    if(first !== -1 && last !== -1) {
                        sanitized = sanitized.substring(first, last + 1);
                    }
                    
                    const parsed = JSON.parse(sanitized);

                    // 1. ÊèêÂèñÊ∂àÊÅØÂàóË°®
                    if (parsed.chatResponse && Array.isArray(parsed.chatResponse)) {
                        messagesToSend = parsed.chatResponse
                            .filter(m => m.type === 'text')
                            .map(m => m.content);
                    } else if (parsed.content) {
                        messagesToSend = [parsed.content];
                    }
                    
                    // 2. ÊèêÂèñÂøÉÂ£∞
                    if (parsed.innerVoice) {
                        innerVoiceData = parsed.innerVoice;
                    }

                    // 3. ÂÖúÂ∫ï: Â¶ÇÊûúËß£ÊûêÊàêÂäü‰ΩÜÊ≤°ÊãøÂà∞Ê∂àÊÅØ, ‰∏î‰∏çÊòØÁ∫ØÂøÉÂ£∞Êõ¥Êñ∞
                    if (messagesToSend.length === 0 && !innerVoiceData) {
                         messagesToSend = [rawContent]; 
                    }

                } catch (e) {
                    // Ëß£ÊûêÂ§±Ë¥•, ËØ¥ÊòéÊòØÊôÆÈÄöÊñáÊú¨
                    messagesToSend = [rawContent];
                }

                if (messagesToSend.length === 0 && !innerVoiceData) messagesToSend = ["..."]; 

                // --- [Vesper] Ê∂àÊÅØÂèëÈÄÅÈÄªËæëÂ§ÑÁêÜ ---
                const msgMode = currentChatCharacter.settings.msgMode || 'split';
                let finalMessages = [];

                if (msgMode === 'full') {
                    // ÂÆåÊï¥ÂèëÈÄÅÊ®°Âºè: Â∞ÜÊâÄÊúâÊ∂àÊÅØÂêàÂπ∂‰∏∫‰∏Ä‰∏™
                    finalMessages = [messagesToSend.join('\n\n')];
                } else {
                    // Âè•Â≠êÂàáÂàÜÊ®°Âºè (Ê®°ÊãüÊó•Â∏∏ÂØπËØù)
                    for (const msg of messagesToSend) {
                        if (msg.includes('```') || msg.length < 50) {
                            finalMessages.push(msg);
                        } else {
                            // ‰ºòÂÖàÊåâÊç¢Ë°åÁ¨¶ÂàáÂàÜ
                            const parts = msg.split(/\n+/).filter(p => p.trim());
                            if (parts.length > 1) {
                                finalMessages = finalMessages.concat(parts);
                            } else {
                                // Â∞ùËØïÊåâÂè•Âè∑ÂàáÂàÜ (‰ªÖ‰∏≠Êñá/Ëã±ÊñáÂè•Âè∑)
                                const sentences = msg.split(/([„ÄÇÔºÅÔºü.!?]+)/).reduce((acc, curr, i) => {
                                    if (i % 2 === 0) {
                                        if (curr.trim()) acc.push(curr);
                                    } else {
                                        if (acc.length > 0) acc[acc.length - 1] += curr;
                                    }
                                    return acc;
                                }, []);
                                if (sentences.length > 0) finalMessages = finalMessages.concat(sentences);
                                else finalMessages.push(msg);
                            }
                        }
                    }
                }
                // ‰ΩøÁî®Â§ÑÁêÜÂêéÁöÑÊ∂àÊÅØÂàóË°®
                messagesToSend = finalMessages;

                // ‰øùÂ≠òÂøÉÂ£∞
                if (innerVoiceData) {
                    currentChatCharacter.latestInnerVoice = innerVoiceData;
                    if (!currentChatCharacter.innerVoiceHistory) currentChatCharacter.innerVoiceHistory = [];
                    currentChatCharacter.innerVoiceHistory.push({
                        ...innerVoiceData,
                        timestamp: Date.now()
                    });
                    // Êõ¥Êñ∞ÂÆåÂøÉÂ£∞Á´ãÂç≥‰øùÂ≠ò‰∏ÄÊ¨°
                    await db.characters.put(currentChatCharacter);
                }

                // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØ (Ê®°ÊãüÁúüÂÆûËÅäÂ§©ËäÇÂ•è)
                const container = document.getElementById('character-chat-messages');
                
                for (const msgContent of messagesToSend) {
                    const aiMsg = {
                        role: 'assistant',
                        content: msgContent,
                        timestamp: Date.now()
                    };

                    currentChatCharacter.chatHistory.push(aiMsg);
                    await db.characters.put(currentChatCharacter);

                    appendCharacterMessage(aiMsg);
                    container.scrollTop = container.scrollHeight;

                    // Ê®°ÊãüÊâìÂ≠óÂª∂Ëøü (500ms - 1500ms)
                    if (messagesToSend.length > 1) {
                        await new Promise(r => setTimeout(r, 500 + Math.random() * 1000));
                    }
                }

                updateChatStatus('Âú®Á∫ø', 'online');

                if (currentChatCharacter.settings.autoSummary) {
                    const threshold = currentChatCharacter.settings.summaryInterval || 10;
                    if (currentChatCharacter.chatHistory.length % threshold === 0) {
                        generateSummary(currentChatCharacter);
                    }
                }

            } catch(error) {
                updateChatStatus(`ÈîôËØØ: ${error.message}`, 'error');
                document.getElementById('character-ai-reply-btn').style.display = 'block';
                console.error('AIÂõûÂ§çÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞ËÅäÂ§©Áä∂ÊÄÅ
        function updateChatStatus(text, type = 'online') {
            const statusEl = document.getElementById('chat-status-text');
            if(!statusEl) return;

            statusEl.textContent = text;

            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈ¢úËâ≤
            if(type === 'thinking') {
                statusEl.style.color = 'var(--accent)';
                statusEl.style.opacity = '1';
            } else if(type === 'error') {
                statusEl.style.color = '#c62828';
                statusEl.style.opacity = '1';
            } else {
                statusEl.style.color = '';
                statusEl.style.opacity = '0.6';
            }
        }

        // ÊûÑÂª∫ËßíËâ≤Á≥ªÁªüÊèêÁ§∫ËØç (ÊîØÊåÅÂøÉÂ£∞)
        async function buildCharacterSystemPrompt() {
            let prompt = '';

            // 1. ËßíËâ≤Ê†∏ÂøÉËÆæÂÆö
            prompt += `# ËßíËâ≤Ê†∏ÂøÉËÆæÂÆö\n\n`;
            prompt += `‰Ω†ÊòØ ${currentChatCharacter.name}„ÄÇ\n\n`;

            if(currentChatCharacter.description) prompt += `## ËßíËâ≤ÊèèËø∞\n${currentChatCharacter.description}\n\n`;
            if(currentChatCharacter.personality) prompt += `## ÊÄßÊ†ºÁâπÁÇπ\n${currentChatCharacter.personality}\n\n`;
            if(currentChatCharacter.scenario) prompt += `## ÂΩìÂâçÂú∫ÊôØ\n${currentChatCharacter.scenario}\n\n`;
            if(currentChatCharacter.mes_example) prompt += `## ÂØπËØùÁ§∫‰æã\n${currentChatCharacter.mes_example}\n\n`;

            // 2. ‰∏ñÁïå‰π¶ÂÜÖÂÆπÊ≥®ÂÖ•
            if(currentChatCharacter.settings.linkedWorldBookIds && currentChatCharacter.settings.linkedWorldBookIds.length > 0) {
                prompt += `# ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n\n`;
                for(const wbId of currentChatCharacter.settings.linkedWorldBookIds) {
                    const wb = await db.worldBooks.get(wbId);
                    if(wb && wb.entries && wb.entries.length > 0) {
                        prompt += `## ${wb.name}\n`;
                        wb.entries.filter(entry => entry.enabled).forEach(entry => {
                            prompt += `\n### ${entry.name}\nÂÖ≥ÈîÆËØç: ${entry.keys.join(', ')}\n${entry.content}\n`;
                        });
                        prompt += `\n`;
                    }
                }
            }

            // 2.5 ÂÖ≥ËÅî Bingo Âç°Ê≥®ÂÖ•
            if(currentChatCharacter.settings.bingoLinkIds && currentChatCharacter.settings.bingoLinkIds.length > 0) {
                prompt += `# ÂÖ≥ËÅîÁöÑ‰ªªÂä°/BingoÂç° (Áî®Êà∑ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑËÆ°Âàí)\n`;
                currentChatCharacter.settings.bingoLinkIds.forEach(pid => {
                    const project = store.projects.find(p => p.id === pid);
                    if(project && project.status === 'active') {
                        prompt += formatBingoProjectForAI(project) + "\n";
                    }
                });
                prompt += `\n`;
            }

            // 2.6 ÈïøÊúüËÆ∞ÂøÜÊ≥®ÂÖ•
            // Ê≥®ÊÑèÔºöÂè™ÊåÇËΩΩÊúÄËøëNÊù°ÈïøÊúüËÆ∞ÂøÜÔºåÈÅøÂÖçÁ≥ªÁªüÊèêÁ§∫ËØçËøáÈïø
            if (currentChatCharacter.longTermMemory && currentChatCharacter.longTermMemory.length > 0) {
                const limit = currentChatCharacter.settings.pinnedMemory || 3;
                const memories = currentChatCharacter.longTermMemory.slice(-limit);
                console.log(`[Á≥ªÁªüÊèêÁ§∫ËØç] ÊåÇËΩΩ ${memories.length}/${currentChatCharacter.longTermMemory.length} Êù°ÈïøÊúüËÆ∞ÂøÜ`);
                prompt += `# ÈïøÊúüËÆ∞ÂøÜ (Long-term Memory)\n`;
                prompt += `‰ª•‰∏ãÊòØ‰Ω†ÂØπÊàëÁöÑÈáçË¶ÅËÆ∞ÂøÜÔºàÊúÄËøë${memories.length}Êù°ÔºâÔºö\n`;
                memories.forEach(m => {
                    prompt += `- ${m}\n`;
                });
                prompt += `\n`;
            }

            // 3. Ê†∏ÂøÉËæìÂá∫ËßÑÂàô
            prompt += `# ËæìÂá∫ËßÑÂàô\n`;
            prompt += `- ËØ∑‰ª• ${currentChatCharacter.name} ÁöÑË∫´‰ªΩ‰∏éÊàëÂØπËØù„ÄÇ\n`;
            prompt += `- ‰øùÊåÅÊÄßÊ†ºÈ≤úÊòéÔºåÊãíÁªùÊ≠ªÊùøÁöÑAIÂë≥„ÄÇ\n`;
            prompt += `- Áõ¥Êé•ËæìÂá∫ÂõûÂ§çÂÜÖÂÆπÂç≥ÂèØÔºå‰∏çÈúÄË¶ÅJSONÊ†ºÂºè„ÄÇ\n`;

            // Êó∂Èó¥ÊÑüÁü• (Â¶ÇÊûúÂêØÁî®)
            if (currentChatCharacter.settings.timeAwareness) {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', { hour12: false });
                const hour = now.getHours();
                let timePeriod = '';
                if(hour >= 0 && hour < 6) timePeriod = 'Ê∑±Â§ú';
                else if(hour >= 6 && hour < 9) timePeriod = 'Ê∏ÖÊô®';
                else if(hour >= 9 && hour < 12) timePeriod = '‰∏äÂçà';
                else if(hour >= 12 && hour < 14) timePeriod = '‰∏≠Âçà';
                else if(hour >= 14 && hour < 18) timePeriod = '‰∏ãÂçà';
                else if(hour >= 18 && hour < 22) timePeriod = 'Êôö‰∏ä';
                else timePeriod = 'Ê∑±Â§ú';

                prompt += `\n„ÄêÂΩìÂâçÊó∂Èó¥‰ø°ÊÅØ„Äë\n`;
                prompt += `Á≥ªÁªüÊó∂Èó¥: ${timeString}\n`;
                prompt += `Êó∂ÊÆµ: ${timePeriod}\n`;
                prompt += `(ËØ∑Ê†πÊçÆÂΩìÂâçÊó∂Èó¥Ë∞ÉÊï¥‰Ω†ÁöÑÈóÆÂÄôËØ≠ÂíåÁä∂ÊÄÅÔºå‰æãÂ¶ÇÊ∑±Â§úÊèêÈÜí‰ºëÊÅØÔºåÊó©‰∏äÈóÆÂ•Ω)\n`;
            }
            
            return prompt;
        }

        // ÊâìÂºÄÂøÉÂ£∞Èù¢Êùø
        function openInnerVoiceModal() {
            if(!currentChatCharacter) return;
            const data = currentChatCharacter.latestInnerVoice;
            
            if(!data) {
                alert('ËøòÊ≤°ÊúâÊçïÊçâÂà∞TaÁöÑÂøÉÂ£∞Âì¶ÔºåËØïÁùÄÂÜçËÅä‰∏ÄÂè•ÂêßÔºÅ');
                return;
            }

            document.getElementById('inner-voice-time').textContent = new Date().toLocaleTimeString();
            document.getElementById('iv-clothing').textContent = data.clothing || '...';
            document.getElementById('iv-behavior').textContent = data.behavior || '...';
            document.getElementById('iv-thoughts').textContent = data.thoughts || '...';
            document.getElementById('iv-naughty').textContent = data.naughtyThoughts || '...';

            document.getElementById('modal-inner-voice').classList.add('active');
        }

        // ÁõëÂê¨ËæìÂÖ•Ê°ÜÂõûËΩ¶ÈîÆ
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('character-chat-input');
            if(chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if(e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendCharacterMessage();
                    }
                });
            }
        });

        async function init() {
            try {
                console.log('[ÂàùÂßãÂåñ] ÂºÄÂßãÂàùÂßãÂåñ...');

                console.log('[ÂàùÂßãÂåñ] Âä†ËΩΩÊï∞ÊçÆ...');
                loadData();

                console.log('[ÂàùÂßãÂåñ] Ê£ÄÊü•Êó•/Âë®ÈáçÁΩÆ...');
                checkDailyReset();
                checkWeeklyReset();

                console.log('[ÂàùÂßãÂåñ] ËÆæÁΩÆ‰∏ªÈ¢ò...');
                if(store.theme) setTheme(store.theme);

                console.log('[ÂàùÂßãÂåñ] Êõ¥Êñ∞UI...');
                updateBalanceUI();
                updateClock();
                setInterval(updateClock, 1000);

                console.log('[ÂàùÂßãÂåñ] Ê∏≤ÊüìÊó•ÂéÜ...');
                renderCalendar();

                console.log('[ÂàùÂßãÂåñ] Ê∏≤ÊüìÊ¥ªË∑ÉÂàóË°®...');
                renderActiveList();

                console.log('[ÂàùÂßãÂåñ] ËÆæÁΩÆËÅäÂ§©ÁõëÂê¨Âô®...');
                setupChatMessageListeners();

                console.log('[ÂàùÂßãÂåñ] ÂàùÂßãÂåñAIÂØπËØùÁ™óÂè£...');
                initAiConversations();

                // ÂàùÂßãÂåñ‰∏ñÁïå‰π¶Áõ∏ÂÖ≥
                console.log('[ÂàùÂßãÂåñ] Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàÜÁ±ª...');
                await renderWorldBookCategories();

                console.log('[ÂàùÂßãÂåñ] Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®...');
                await renderWorldBookList();

                // ÂàùÂßãÂåñËßíËâ≤ÂàóË°®
                console.log('[ÂàùÂßãÂåñ] Ê∏≤ÊüìËßíËâ≤ÂàóË°®...');
                await renderCharacterList();

                // ÂàùÂßãÂåñÁ¶ªÁ∫øÊ®°ÂºèÁ≥ªÁªüÔºàÂ∏¶ÈîôËØØÂ§ÑÁêÜÔºâ
                console.log('[ÂàùÂßãÂåñ] ÂàùÂßãÂåñÁ¶ªÁ∫øÊ®°Âºè...');
                try {
                    networkManager.init();
                    offlineQueue.init();

                    // Â¶ÇÊûúÊúâÊú™Â§ÑÁêÜÁöÑÁ¶ªÁ∫øÈòüÂàó‰∏îÂΩìÂâçÂú®Á∫øÔºåËá™Âä®Â§ÑÁêÜ
                    if (networkManager.isOnline && offlineQueue.queue.length > 0) {
                        console.log('[ÂàùÂßãÂåñ] Ê£ÄÊµãÂà∞Á¶ªÁ∫øÈòüÂàóÔºåÂáÜÂ§áÂ§ÑÁêÜ');
                        setTimeout(() => {
                            try {
                                offlineQueue.processQueue();
                            } catch (error) {
                                console.error('[ÂàùÂßãÂåñ] Á¶ªÁ∫øÈòüÂàóÂ§ÑÁêÜÂ§±Ë¥•:', error);
                            }
                        }, 2000); // Âª∂Ëøü2ÁßíÂ§ÑÁêÜ
                    }
                } catch (error) {
                    console.error('[ÂàùÂßãÂåñ] Á¶ªÁ∫øÊ®°ÂºèÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    // Á¶ªÁ∫øÊ®°ÂºèÂàùÂßãÂåñÂ§±Ë¥•‰∏çÂ∫îÈòªÊ≠¢È°µÈù¢Ê≠£Â∏∏ËøêË°å
                }

                console.log('[ÂàùÂßãÂåñ] ‚úì Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê');

            } catch (error) {
                console.error('[ÂàùÂßãÂåñ] ‚úó ÂàùÂßãÂåñËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', error);
                console.error('[ÂàùÂßãÂåñ] ÈîôËØØÂ†ÜÊ†à:', error.stack);
                alert('È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï„ÄÇ\nÈîôËØØ: ' + error.message);
            }
        }

        function updateClock() {
            const el = document.getElementById('sys-clock');
            if(el) el.innerText = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit',minute:'2-digit'});
        }

        function loadData() {
            try {
                // Ê£ÄÊü• localStorage ÊòØÂê¶ÂèØÁî®
                if (!window.localStorage) {
                    throw new Error('localStorage ‰∏çÂèØÁî®ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆ');
                }

                const raw = localStorage.getItem(DB_KEY);
                if(raw) {
                    try {
                        const data = JSON.parse(raw);

                        // È™åËØÅÊï∞ÊçÆÁªìÊûÑ
                        if (typeof data !== 'object' || data === null) {
                            throw new Error('Êï∞ÊçÆÊ†ºÂºèÊó†Êïà');
                        }

                        store = { ...store, ...data };

                        // Á°Æ‰øùÂøÖÈúÄÂ≠óÊÆµÂ≠òÂú®ÔºàÂ∏¶ÈªòËÆ§ÂÄºÔºâ
                        if(!store.shopItems) store.shopItems = [];
                        if(!store.redemptions) store.redemptions = [];
                        if(!store.gachaPool) store.gachaPool = ['ÂñùÊùØÂ•∂Ëå∂','Êó©Áù°‰∏ÄÂ∞èÊó∂'];
                        if(!store.weeklyBills) store.weeklyBills = [];
                        if(!store.lastDailyCheck) store.lastDailyCheck = '';
                        if(!store.lastWeeklyReset) store.lastWeeklyReset = '';
                        if(!store.apiConfig) store.apiConfig = { main: { url: '', key: '', model: 'gpt-4', temperature: 0.8 }, sub: { url: '', key: '', model: 'gpt-3.5-turbo', temperature: 0.8 }, search: { provider: 'google', googleApiKey: '', googleCx: '', serperApiKey: '', zhipuApiKey: '' } };
                        if(!store.apiConfig.search) store.apiConfig.search = { provider: 'google', googleApiKey: '', googleCx: '', serperApiKey: '', zhipuApiKey: '' };
                        if(!store.aiChatHistory) store.aiChatHistory = [];
                        if(!store.characterGroups) store.characterGroups = ['ÈªòËÆ§ÂàÜÁªÑ', 'ÁâπÂà´ÂÖ≥ÂøÉ'];
                        if(!store.bubblePresets) store.bubblePresets = {};
                        if(!store.reportArchive) store.reportArchive = [];

                        console.log('[Êï∞ÊçÆÂä†ËΩΩ] ÊàêÂäüÂä†ËΩΩÁî®Êà∑Êï∞ÊçÆ');
                    } catch(parseError) {
                        handleError(parseError, 'Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•', ErrorLevel.CRITICAL, true);

                        // Â∞ùËØïÂ§á‰ªΩÊçüÂùèÁöÑÊï∞ÊçÆ
                        try {
                            const backupKey = `${DB_KEY}_backup_${Date.now()}`;
                            localStorage.setItem(backupKey, raw);
                            console.log(`[Êï∞ÊçÆÊÅ¢Â§ç] Â∑≤Â§á‰ªΩÊçüÂùèÊï∞ÊçÆÂà∞: ${backupKey}`);
                        } catch(backupError) {
                            console.error('[Êï∞ÊçÆÊÅ¢Â§ç] Â§á‰ªΩÂ§±Ë¥•:', backupError);
                        }

                        // ÁªßÁª≠‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
                        console.log('[Êï∞ÊçÆÂä†ËΩΩ] ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ');
                    }
                }

                loadApiConfigToUI();
            } catch(e) {
                handleError(e, 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•', ErrorLevel.CRITICAL, true);
            }
        }

        function saveData() {
            try {
                // Ê£ÄÊü• localStorage ÊòØÂê¶ÂèØÁî®
                if (!window.localStorage) {
                    throw new Error('localStorage ‰∏çÂèØÁî®');
                }

                // Ê£ÄÊü•Â≠òÂÇ®Á©∫Èó¥
                const dataString = JSON.stringify(store);
                const dataSize = new Blob([dataString]).size;

                // localStorage ÈÄöÂ∏∏ÈôêÂà∂‰∏∫ 5-10MB
                if (dataSize > 5 * 1024 * 1024) {
                    handleError(
                        new Error(`Êï∞ÊçÆÈáèËøáÂ§ß (${(dataSize / 1024 / 1024).toFixed(2)}MB)`),
                        'Êï∞ÊçÆ‰øùÂ≠òË≠¶Âëä',
                        ErrorLevel.WARNING,
                        true
                    );
                }

                localStorage.setItem(DB_KEY, dataString);
                updateBalanceUI();

                // ÂÆöÊúüÊ∏ÖÁêÜÊóßÂ§á‰ªΩÔºàÂèØÈÄâÔºâ
                cleanupOldBackups();

            } catch(e) {
                if (e.name === 'QuotaExceededError') {
                    handleError(
                        new Error('Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåËØ∑Ê∏ÖÁêÜÊï∞ÊçÆÊàñÂØºÂá∫Â§á‰ªΩ'),
                        'Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥',
                        ErrorLevel.ERROR,
                        true
                    );
                } else {
                    handleError(e, 'Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•', ErrorLevel.ERROR, true);
                }
            }
        }

        // Ê∏ÖÁêÜÊóßÂ§á‰ªΩÔºà‰øùÁïôÊúÄËøë3‰∏™Ôºâ
        function cleanupOldBackups() {
            try {
                const backupKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`${DB_KEY}_backup_`)) {
                        backupKeys.push(key);
                    }
                }

                // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºàÈîÆÂêçÂåÖÂê´Êó∂Èó¥Êà≥Ôºâ
                backupKeys.sort().reverse();

                // ‰øùÁïôÊúÄËøë3‰∏™ÔºåÂà†Èô§ÂÖ∂‰Ωô
                for (let i = 3; i < backupKeys.length; i++) {
                    localStorage.removeItem(backupKeys[i]);
                }
            } catch(e) {
                console.warn('[Â§á‰ªΩÊ∏ÖÁêÜ] Ê∏ÖÁêÜÂ§±Ë¥•:', e);
            }
        }
        
        function updateAiChatStatus(text, type = 'info', duration = 2000) {
            const statusEl = document.getElementById('ai-chat-status');
            if (!statusEl) return;
            const originalText = 'Âú®Á∫ø';
            
            statusEl.textContent = text;
            if (type === 'thinking') {
                statusEl.style.color = 'var(--accent)';
            } else if (type === 'error') {
                statusEl.style.color = '#c62828';
            } else {
                 statusEl.style.color = '';
            }

            if (duration > 0) {
                setTimeout(() => {
                    statusEl.textContent = originalText;
                    statusEl.style.color = '';
                }, duration);
            }
        }

        // --- AI Âä©ÊâãÂºïÁî®ÂäüËÉΩ ---
        function setAiQuotePreview(msgIndex) {
            const msg = store.aiChatHistory[msgIndex];
            if (!msg) return;

            const roleName = msg.role === 'user' ? '‰Ω†' : 'Vesper';
            const preview = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');

            currentAiQuote = { index: msgIndex, role: msg.role, content: msg.content };

            const previewEl = document.getElementById('ai-quote-preview');
            const contentEl = document.getElementById('ai-quote-preview-content');
            contentEl.innerHTML = `<span style="opacity:0.6;">ÂºïÁî® ${roleName}:</span> ${escapeHtml(preview)}`;
            previewEl.classList.add('active');
            document.getElementById('ai-input').focus();
        }

        function clearAiQuotePreview() {
            currentAiQuote = null;
            document.getElementById('ai-quote-preview').classList.remove('active');
        }
        
        function scrollToAiMessage(msgIndex) {
            const container = document.getElementById('ai-chat-container');
            const msgDiv = container.querySelector(`.chat-message[data-msg-index="${msgIndex}"]`);

            if (msgDiv) {
                msgDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const bubble = msgDiv.querySelector('.chat-message-bubble');
                if (bubble) {
                    bubble.style.transition = 'outline 0.3s ease-in-out, box-shadow 0.3s ease-in-out';
                    bubble.style.outline = '2px solid var(--accent)';
                    bubble.style.boxShadow = '0 0 10px var(--accent)';
                    setTimeout(() => {
                        bubble.style.outline = 'none';
                        bubble.style.boxShadow = '';
                    }, 1500);
                }
            }
        }
        
        // --- AI Âä©ÊâãÂ§öÈÄâÂäüËÉΩ ---
        function enterAiMultiSelectMode(initialBubble) {
            isAiMultiSelectMode = true;
            selectedAiMessageIndices.clear();

            const container = document.getElementById('ai-chat-container');
            if (container) container.classList.add('multi-select-mode');

            if (initialBubble) {
                const index = parseInt(initialBubble.dataset.msgIndex);
                toggleAiMessageSelection(initialBubble, index);
            }

            // ‰ΩøÁî®AIÂä©Êâã‰∏ìÁî®Â∑•ÂÖ∑Ê†è
            const toolbar = document.getElementById('ai-multi-select-toolbar');
            if (toolbar) {
                toolbar.style.display = 'flex';
            }
            updateAiSelectedCount();
        }

        function toggleAiMessageSelection(bubble, index) {
            if (selectedAiMessageIndices.has(index)) {
                selectedAiMessageIndices.delete(index);
                bubble.classList.remove('selected');
            } else {
                selectedAiMessageIndices.add(index);
                bubble.classList.add('selected');
            }
            updateAiSelectedCount();
        }
        
        function updateAiSelectedCount() {
            document.getElementById('ai-selected-count').textContent = selectedAiMessageIndices.size;
        }

        function selectAllAiMessages() {
            const container = document.getElementById('ai-chat-container');
            container.querySelectorAll('.chat-message-bubble').forEach(bubble => {
                const index = parseInt(bubble.dataset.msgIndex);
                if (!isNaN(index) && !selectedAiMessageIndices.has(index)) {
                    selectedAiMessageIndices.add(index);
                    bubble.classList.add('selected');
                }
            });
            updateAiSelectedCount();
        }

        function cancelAiMultiSelect() {
            isAiMultiSelectMode = false;
            selectedAiMessageIndices.clear();

            const container = document.getElementById('ai-chat-container');
            if (container) {
                container.classList.remove('multi-select-mode');
                container.querySelectorAll('.chat-message-bubble.selected').forEach(bubble => bubble.classList.remove('selected'));
            }

            // ÈöêËóèAIÂä©Êâã‰∏ìÁî®Â∑•ÂÖ∑Ê†è
            const toolbar = document.getElementById('ai-multi-select-toolbar');
            if (toolbar) {
                toolbar.style.display = 'none';
            }
        }

        function deleteSelectedAiMessages() {
            if (selectedAiMessageIndices.size === 0) return;
            if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedAiMessageIndices.size} Êù°Ê∂àÊÅØÂêóÔºü`)) return;

            const sortedIndices = Array.from(selectedAiMessageIndices).sort((a, b) => b - a);
            sortedIndices.forEach(index => {
                store.aiChatHistory.splice(index, 1);
            });

            saveData();
            cancelAiMultiSelect();
            renderAiChatHistory();
        }


        // ÂàùÂßãÂåñ Markdown Ê∏≤ÊüìÂô®
        let md = null;
        if(typeof markdownit !== 'undefined') {
            md = markdownit({
                html: false,
                linkify: true,
                typographer: true,
                breaks: true
            });
        }

        function renderMarkdown(text) {
            if(!md) return escapeHtml(text).replace(/\n/g, '<br>');
            try {
                // ÂÖàÊ∏≤Êüì Markdown
                let html = md.render(text);
                // ÂÜçÊ∏≤Êüì LaTeX ÂÖ¨Âºè
                html = renderLatex(html);
                return html;
            } catch(e) {
                return escapeHtml(text).replace(/\n/g, '<br>');
            }
        }

        /**
         * Ê∏≤Êüì LaTeX Êï∞Â≠¶ÂÖ¨Âºè
         * ÊîØÊåÅÊ†ºÂºè:
         * - Ë°åÂÜÖÂÖ¨Âºè: $...$ Êàñ \(...\)
         * - ÂùóÁ∫ßÂÖ¨Âºè: $$...$$ Êàñ \[...\]
         */
        function renderLatex(html) {
            if (typeof katex === 'undefined') {
                console.warn('KaTeX Êú™Âä†ËΩΩÔºåË∑≥ËøáÂÖ¨ÂºèÊ∏≤Êüì');
                return html;
            }

            // Áî®‰∫é‰øùÊä§Â∑≤Â§ÑÁêÜÁöÑÂÖ¨ÂºèÔºåÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜ
            const placeholder = '@@LATEX_PLACEHOLDER_';
            const placeholders = [];

            // Ê∏≤ÊüìÂùóÁ∫ßÂÖ¨Âºè $$...$$ (ÂÖàÂ§ÑÁêÜÂùóÁ∫ßÔºåÈÅøÂÖçË¢´Ë°åÂÜÖÂåπÈÖç)
            html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, latex) => {
                try {
                    const rendered = katex.renderToString(latex.trim(), {
                        displayMode: true,
                        throwOnError: false,
                        trust: true
                    });
                    placeholders.push(`<div class="katex-block">${rendered}</div>`);
                    return placeholder + (placeholders.length - 1) + '@@';
                } catch (e) {
                    console.warn('LaTeX ÂùóÁ∫ßÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', e);
                    return match;
                }
            });

            // Ê∏≤ÊüìÂùóÁ∫ßÂÖ¨Âºè \[...\]
            html = html.replace(/\\\[([\s\S]*?)\\\]/g, (match, latex) => {
                try {
                    const rendered = katex.renderToString(latex.trim(), {
                        displayMode: true,
                        throwOnError: false,
                        trust: true
                    });
                    placeholders.push(`<div class="katex-block">${rendered}</div>`);
                    return placeholder + (placeholders.length - 1) + '@@';
                } catch (e) {
                    console.warn('LaTeX ÂùóÁ∫ßÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', e);
                    return match;
                }
            });

            // Ê∏≤ÊüìË°åÂÜÖÂÖ¨Âºè $...$ (‰∏çÂåπÈÖç $$)
            html = html.replace(/(?<!\$)\$(?!\$)((?:[^$\\]|\\.)+?)\$(?!\$)/g, (match, latex) => {
                try {
                    const rendered = katex.renderToString(latex.trim(), {
                        displayMode: false,
                        throwOnError: false,
                        trust: true
                    });
                    placeholders.push(`<span class="katex-inline">${rendered}</span>`);
                    return placeholder + (placeholders.length - 1) + '@@';
                } catch (e) {
                    console.warn('LaTeX Ë°åÂÜÖÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', e);
                    return match;
                }
            });

            // Ê∏≤ÊüìË°åÂÜÖÂÖ¨Âºè \(...\)
            html = html.replace(/\\\(([\s\S]*?)\\\)/g, (match, latex) => {
                try {
                    const rendered = katex.renderToString(latex.trim(), {
                        displayMode: false,
                        throwOnError: false,
                        trust: true
                    });
                    placeholders.push(`<span class="katex-inline">${rendered}</span>`);
                    return placeholder + (placeholders.length - 1) + '@@';
                } catch (e) {
                    console.warn('LaTeX Ë°åÂÜÖÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', e);
                    return match;
                }
            });

            // ËøòÂéüÂç†‰ΩçÁ¨¶
            placeholders.forEach((content, index) => {
                html = html.replace(placeholder + index + '@@', content);
            });

            return html;
        }

        // APIÈÖçÁΩÆÁÆ°ÁêÜ
        function loadApiConfigToUI() {
            if(store.apiConfig) {
                document.getElementById('main-api-url').value = store.apiConfig.main.url || '';
                document.getElementById('main-api-key').value = store.apiConfig.main.key || '';
                document.getElementById('main-api-model').value = store.apiConfig.main.model || 'gpt-4';
                document.getElementById('main-api-temp').value = store.apiConfig.main.temperature || 0.8;

                document.getElementById('sub-api-url').value = store.apiConfig.sub.url || '';
                document.getElementById('sub-api-key').value = store.apiConfig.sub.key || '';
                document.getElementById('sub-api-model').value = store.apiConfig.sub.model || 'gpt-3.5-turbo';

                // Âä†ËΩΩÊêúÁ¥¢ÈÖçÁΩÆ
                const searchConfig = store.apiConfig.search || {};
                document.getElementById('search-provider-select').value = searchConfig.provider || 'google';
                document.getElementById('google-search-api-key').value = searchConfig.googleApiKey || '';
                document.getElementById('google-search-cx').value = searchConfig.googleCx || '';
                document.getElementById('serper-api-key').value = searchConfig.serperApiKey || '';
                document.getElementById('zhipu-api-key').value = searchConfig.zhipuApiKey || '';
                toggleSearchInputs();
            }
            // Âä†ËΩΩÈ´òÂæ∑Âú∞ÂõæÈÖçÁΩÆ (‰ªé localStorage)
            document.getElementById('amap-key-input').value = localStorage.getItem('vesper_amap_key') || '';
            document.getElementById('user-city-input').value = localStorage.getItem('vesper_amap_city') || '';
            // Âà∑Êñ∞È¢ÑËÆæ‰∏ãÊãâÂàóË°®
            refreshApiPresetSelect();
        }

        function saveApiConfig() {
            if (!store.apiConfig) store.apiConfig = {};
            store.apiConfig.main = {
                url: document.getElementById('main-api-url').value,
                key: document.getElementById('main-api-key').value,
                model: document.getElementById('main-api-model').value,
                temperature: parseFloat(document.getElementById('main-api-temp').value)
            };
            store.apiConfig.sub = {
                url: document.getElementById('sub-api-url').value,
                key: document.getElementById('sub-api-key').value,
                model: document.getElementById('sub-api-model').value,
                temperature: 0.8
            };
            // ‰øùÂ≠òÊêúÁ¥¢ÈÖçÁΩÆ
            store.apiConfig.search = {
                provider: document.getElementById('search-provider-select').value,
                googleApiKey: document.getElementById('google-search-api-key').value,
                googleCx: document.getElementById('google-search-cx').value,
                serperApiKey: document.getElementById('serper-api-key').value,
                zhipuApiKey: document.getElementById('zhipu-api-key').value
            };
            // ‰øùÂ≠òÈ´òÂæ∑Âú∞ÂõæÈÖçÁΩÆÂà∞ localStorage (ÂÆâÂÖ®Â≠òÂÇ®)
            const amapKey = document.getElementById('amap-key-input').value.trim();
            const userCity = document.getElementById('user-city-input').value.trim();
            if (amapKey) {
                localStorage.setItem('vesper_amap_key', amapKey);
            } else {
                localStorage.removeItem('vesper_amap_key');
            }
            if (userCity) {
                localStorage.setItem('vesper_amap_city', userCity);
            } else {
                localStorage.removeItem('vesper_amap_city');
            }
            saveData();
            alert('Vesper: APIÈÖçÁΩÆÂ∑≤‰øùÂ≠ò!');
        }

        // ÊãâÂèñÊ®°ÂûãÂàóË°®
        async function fetchModels(apiType) {
            const urlInput = document.getElementById(`${apiType}-api-url`);
            const keyInput = document.getElementById(`${apiType}-api-key`);
            const modelSelect = document.getElementById(`${apiType}-api-model`);

            const url = urlInput.value.trim();
            const key = keyInput.value.trim();

            if(!url || !key) {
                alert('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•!');
                return;
            }

            const apiUrl = url.endsWith('/') ? url + 'models' : url + '/models';

            try {
                const res = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${key}`
                    }
                });

                if(!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${res.statusText}\nËØ¶ÁªÜ‰ø°ÊÅØ: ${errorText}`);
                }

                const data = await res.json();
                const models = data.data || data.models || [];

                if(models.length === 0) {
                    alert('Êú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã,ËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ');
                    return;
                }

                // Ê∏ÖÁ©∫Âπ∂Â°´ÂÖÖÊ®°ÂûãÂàóË°®
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const modelId = model.id || model;
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    modelSelect.appendChild(option);
                });

                alert(`ÊàêÂäüÊãâÂèñ${models.length}‰∏™Ê®°Âûã!`);
            } catch(error) {
                alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•:\n${error.message}`);
            }
        }

        // ÊµãËØïAPIËøûÊé•
        async function testApiConnection(apiType) {
            const urlInput = document.getElementById(`${apiType}-api-url`);
            const keyInput = document.getElementById(`${apiType}-api-key`);
            const modelSelect = document.getElementById(`${apiType}-api-model`);

            const url = urlInput.value.trim();
            const key = keyInput.value.trim();
            const model = modelSelect.value;

            if(!url || !key) {
                alert('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•!');
                return;
            }

            const apiUrl = url.endsWith('/') ? url + 'chat/completions' : url + '/chat/completions';

            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'hi' }],
                        max_tokens: 10
                    })
                });

                if(!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${res.statusText}\nËØ¶ÁªÜ‰ø°ÊÅØ: ${errorText}`);
                }

                const data = await res.json();
                const reply = data.choices?.[0]?.message?.content || '(Êó†ÂìçÂ∫îÂÜÖÂÆπ)';

                alert(`‚úÖ ËøûÊé•ÊàêÂäü!\nÊ®°Âûã: ${model}\nÂìçÂ∫î: ${reply}`);
            } catch(error) {
                alert(`‚ùå ËøûÊé•Â§±Ë¥•:\n${error.message}`);
            }
        }

        // Âà∑Êñ∞È¢ÑËÆæ‰∏ãÊãâÂàóË°®
        function refreshApiPresetSelect() {
            const select = document.getElementById('api-preset-select');
            select.innerHTML = '<option value="">-- ÈÄâÊã©È¢ÑËÆæ --</option>';
            if (store.apiPresets) {
                Object.keys(store.apiPresets).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
        }

        // ‰øùÂ≠òAPIÈ¢ÑËÆæ (‰ΩøÁî®ËæìÂÖ•Ê°ÜÂêçÁß∞)
        function saveApiPresetWithName() {
            const presetName = document.getElementById('new-preset-name').value.trim();
            if(!presetName) {
                alert('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞!');
                return;
            }

            if(!store.apiPresets) store.apiPresets = {};

            store.apiPresets[presetName] = {
                main: {
                    url: document.getElementById('main-api-url').value,
                    key: document.getElementById('main-api-key').value,
                    model: document.getElementById('main-api-model').value,
                    temperature: parseFloat(document.getElementById('main-api-temp').value)
                },
                sub: {
                    url: document.getElementById('sub-api-url').value,
                    key: document.getElementById('sub-api-key').value,
                    model: document.getElementById('sub-api-model').value,
                    temperature: 0.8
                }
            };

            saveData();
            document.getElementById('new-preset-name').value = '';
            refreshApiPresetSelect();
            document.getElementById('api-preset-select').value = presetName;
            alert(`È¢ÑËÆæ "${presetName}" Â∑≤‰øùÂ≠ò!`);
        }

        // Âä†ËΩΩÈÄâ‰∏≠ÁöÑAPIÈ¢ÑËÆæ
        function loadSelectedApiPreset() {
            const select = document.getElementById('api-preset-select');
            const presetName = select.value;

            if(!presetName) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ!');
                return;
            }

            if(!store.apiPresets || !store.apiPresets[presetName]) {
                alert('Êú™ÊâæÂà∞ËØ•È¢ÑËÆæ!');
                return;
            }

            const preset = store.apiPresets[presetName];

            // Âä†ËΩΩ‰∏ª API ÈÖçÁΩÆ
            document.getElementById('main-api-url').value = preset.main.url || '';
            document.getElementById('main-api-key').value = preset.main.key || '';
            document.getElementById('main-api-temp').value = preset.main.temperature || 0.8;

            // Âä†ËΩΩ‰∏ªÊ®°Âûã - Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÈÄâÈ°π‰∏≠ÔºåÂÖàÊ∑ªÂä†ËØ•ÈÄâÈ°π
            const mainModelSelect = document.getElementById('main-api-model');
            const mainModel = preset.main.model || 'gpt-4';
            if (mainModel && !Array.from(mainModelSelect.options).some(opt => opt.value === mainModel)) {
                const option = document.createElement('option');
                option.value = mainModel;
                option.textContent = mainModel;
                mainModelSelect.appendChild(option);
            }
            mainModelSelect.value = mainModel;

            // Âä†ËΩΩÂâØ API ÈÖçÁΩÆ
            document.getElementById('sub-api-url').value = preset.sub?.url || '';
            document.getElementById('sub-api-key').value = preset.sub?.key || '';

            // Âä†ËΩΩÂâØÊ®°Âûã - Â¶ÇÊûúÊ®°Âûã‰∏çÂú®ÈÄâÈ°π‰∏≠ÔºåÂÖàÊ∑ªÂä†ËØ•ÈÄâÈ°π
            const subModelSelect = document.getElementById('sub-api-model');
            const subModel = preset.sub?.model || 'gpt-3.5-turbo';
            if (subModel && !Array.from(subModelSelect.options).some(opt => opt.value === subModel)) {
                const option = document.createElement('option');
                option.value = subModel;
                option.textContent = subModel;
                subModelSelect.appendChild(option);
            }
            subModelSelect.value = subModel;

            alert(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ "${presetName}"!`);
        }

        // Âà†Èô§ÈÄâ‰∏≠ÁöÑAPIÈ¢ÑËÆæ
        function deleteSelectedApiPreset() {
            const select = document.getElementById('api-preset-select');
            const presetName = select.value;

            if(!presetName) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ!');
                return;
            }

            if(!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ "${presetName}" Âêó?`)) {
                return;
            }

            if(store.apiPresets && store.apiPresets[presetName]) {
                delete store.apiPresets[presetName];
                saveData();
                refreshApiPresetSelect();
                alert(`È¢ÑËÆæ "${presetName}" Â∑≤Âà†Èô§!`);
            }
        }

        // ‰øùÂ≠òAPIÈ¢ÑËÆæ (ÊóßÂáΩÊï∞‰øùÁïôÂÖºÂÆπ)
        function saveApiPreset() {
            const presetName = prompt('ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞:');
            if(!presetName) return;

            if(!store.apiPresets) store.apiPresets = {};

            store.apiPresets[presetName] = {
                main: {
                    url: document.getElementById('main-api-url').value,
                    key: document.getElementById('main-api-key').value,
                    model: document.getElementById('main-api-model').value,
                    temperature: parseFloat(document.getElementById('main-api-temp').value)
                },
                sub: {
                    url: document.getElementById('sub-api-url').value,
                    key: document.getElementById('sub-api-key').value,
                    model: document.getElementById('sub-api-model').value,
                    temperature: 0.8
                }
            };

            saveData();
            refreshApiPresetSelect();
            alert(`È¢ÑËÆæ "${presetName}" Â∑≤‰øùÂ≠ò!`);
        }

        // Âä†ËΩΩAPIÈ¢ÑËÆæ (ÊóßÂáΩÊï∞‰øùÁïôÂÖºÂÆπ)
        function loadApiPreset() {
            if(!store.apiPresets || Object.keys(store.apiPresets).length === 0) {
                alert('ÊöÇÊó†‰øùÂ≠òÁöÑÈ¢ÑËÆæ!');
                return;
            }

            const presetNames = Object.keys(store.apiPresets);
            const presetName = prompt(`ËØ∑ÈÄâÊã©È¢ÑËÆæ:\n\n${presetNames.map((n, i) => `${i+1}. ${n}`).join('\n')}\n\nËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞:`);

            if(!presetName || !store.apiPresets[presetName]) {
                alert('Êú™ÊâæÂà∞ËØ•È¢ÑËÆæ!');
                return;
            }

            const preset = store.apiPresets[presetName];

            document.getElementById('main-api-url').value = preset.main.url;
            document.getElementById('main-api-key').value = preset.main.key;
            document.getElementById('main-api-model').value = preset.main.model;
            document.getElementById('main-api-temp').value = preset.main.temperature;

            document.getElementById('sub-api-url').value = preset.sub.url;
            document.getElementById('sub-api-key').value = preset.sub.key;
            document.getElementById('sub-api-model').value = preset.sub.model;

            alert(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ "${presetName}"!`);
        }

        // Ê∏≤Êüì AI ËÅäÂ§©ÂéÜÂè≤
        function renderAiChatHistory() {
            const container = document.getElementById('ai-chat-container');
            container.innerHTML = '';
            
            if (store.aiChatHistory.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:100px;">Vesper Âú®Ê≠§ÂæÖÂëΩ„ÄÇ</div>';
                return;
            }

            store.aiChatHistory.forEach((msg, index) => {
                if (msg.hidden) return;

                const isUser = msg.role === 'user';
                
                let quoteHtml = '';
                if (msg.quote) {
                    const quoteRoleName = msg.quote.role === 'user' ? '‰Ω†' : 'Vesper';
                    const quotePreview = msg.quote.content.substring(0, 80) + (msg.quote.content.length > 80 ? '...' : '');
                    quoteHtml = `
                        <div class="quote-block" onclick="scrollToAiMessage(${msg.quote.index})" title="ÁÇπÂáªË∑≥ËΩ¨Âà∞ÂéüÊ∂àÊÅØ">
                            <div class="quote-block-header">‚Ü© ÂºïÁî® ${quoteRoleName}</div>
                            <div class="quote-block-content">${escapeHtml(quotePreview)}</div>
                        </div>
                    `;
                }

                const contentHtml = `<div class="markdown-content">${renderMarkdown(msg.content)}</div>`;
                const timeStr = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${isUser ? 'user' : 'ai'}`;
                msgDiv.style.cssText = `margin-bottom:15px; text-align:${isUser ? 'right' : 'left'};`;
                msgDiv.dataset.msgIndex = index;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'chat-message-bubble';
                bubbleDiv.style.cssText = `display:inline-block; background:${isUser ? 'var(--accent)' : 'var(--card-bg)'}; color:${isUser ? 'var(--bg)' : 'var(--text)'}; padding:10px 15px; border-radius:12px; max-width:80%; text-align:left; cursor:pointer; ${!isUser ? 'border-left:3px solid var(--accent);' : ''}`;

                bubbleDiv.dataset.msgIndex = index;
                bubbleDiv.dataset.msgRole = msg.role;
                bubbleDiv.dataset.msgContent = msg.content;

                bubbleDiv.innerHTML = `
                    ${quoteHtml}
                    ${contentHtml}
                    ${timeStr ? `<div style="font-size:0.7rem; opacity:0.6; margin-top:5px; text-align:right;">${timeStr}</div>` : ''}
                `;

                // Attach event listeners
                setupAiMessageLongPress(bubbleDiv);

                msgDiv.appendChild(bubbleDiv);
                container.appendChild(msgDiv);
            });

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // AIÂä©ÊâãËÅäÂ§©ÂäüËÉΩ
        async function sendAiUserMessage() {
            const input = document.getElementById('ai-input');
            let userMessage = input.value.trim();

            // ÊêúÁ¥¢Ê®°ÂºèÔºöÂç≥‰ΩøËæìÂÖ•‰∏∫Á©∫‰πüÂèØ‰ª•Ëß¶ÂèëÔºàAI‰ºöÂàÜÊûê‰∏ä‰∏ãÊñáÔºâ
            if (isAiSearchEnabled) {
                await executeSmartWebSearch('ai');
                return;
            }

            if (isAiLocalSearchEnabled) {
                await executeSmartLocalSearch('ai');
                return;
            }

            // ÊôÆÈÄöÊ∂àÊÅØÊ®°ÂºèÔºöÂøÖÈ°ªÊúâÂÜÖÂÆπ
            if (!userMessage) return;

            input.value = '';

            const userMsg = {
                role: 'user',
                content: userMessage,
                timestamp: Date.now()
            };

            if (currentAiQuote) {
                userMsg.quote = {
                    index: currentAiQuote.index,
                    role: currentAiQuote.role,
                    content: currentAiQuote.content.substring(0, 200) // ÈôêÂà∂ÂºïÁî®ÈïøÂ∫¶
                };
                clearAiQuotePreview();
            }

            store.aiChatHistory.push(userMsg);
            saveData();

            renderAiChatHistory();

            // ÊòæÁ§∫AIÂõûÂ§çÊåâÈíÆ
            document.getElementById('ai-reply-btn').style.display = 'block';
        }

        // --- AI Âä©Êâã‰∏ìÂ±û‰∫ã‰ª∂Â§ÑÁêÜ ---
        let currentAiMessageBubble = null;

        function setupAiMessageLongPress(bubble) {
            let longPressTimer = null;

            bubble.addEventListener('touchstart', function(e) {
                if (isAiMultiSelectMode) return;
                longPressTimer = setTimeout(() => {
                    showAiContextMenu(e, bubble);
                }, 500);
            });

            bubble.addEventListener('touchend', function(e) {
                clearTimeout(longPressTimer);
                if (isAiMultiSelectMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAiMessageSelection(bubble, parseInt(bubble.dataset.msgIndex));
                }
            });

            bubble.addEventListener('touchmove', () => clearTimeout(longPressTimer));

            bubble.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                if (!isAiMultiSelectMode) showAiContextMenu(e, bubble);
            });
            
            bubble.addEventListener('click', function(e) {
                if (isAiMultiSelectMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAiMessageSelection(bubble, parseInt(bubble.dataset.msgIndex));
                }
            });
        }

        function showAiContextMenu(e, bubble) {
            currentAiMessageBubble = bubble;
            const menu = document.getElementById('ai-context-menu');
            if (!menu) return;
            const msgRole = bubble.dataset.msgRole;

            // Customize menu for AI chat
            const allItems = menu.querySelectorAll('.context-menu-item');
            allItems.forEach(item => item.style.display = 'flex');

            const retryItem = Array.from(allItems).find(item => item.textContent.includes('Âà∑Êñ∞ÂõûÂ§ç'));
            const editItem = Array.from(allItems).find(item => item.textContent.includes('ÁºñËæëÊ∂àÊÅØ'));
            
            if (msgRole === 'user') {
                if(retryItem) retryItem.style.display = 'none';
            } else { // AI message
                if(editItem) editItem.style.display = 'none'; // Can't edit AI message
            }
            
            menu.classList.add('active');
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            // Boundary check
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
            }, 10);
        }

        async function handleAiContextAction(action) {
            const menu = document.getElementById('ai-context-menu');
            if(menu) menu.classList.remove('active');

            if (!currentAiMessageBubble) return;

            const msgIndex = parseInt(currentAiMessageBubble.dataset.msgIndex);
            const msg = store.aiChatHistory[msgIndex];
            if (!msg) return;

            switch(action) {
                case 'copy':
                    navigator.clipboard.writeText(msg.content).then(() => updateAiChatStatus('Â∑≤Â§çÂà∂', 'info', 1500));
                    break;
                case 'quote':
                    setAiQuotePreview(msgIndex);
                    break;
                case 'multiSelect':
                    enterAiMultiSelectMode(currentAiMessageBubble);
                    break;
                case 'retry':
                    if (msg.role === 'assistant') {
                        // Delete this AI message and trigger a new response
                        store.aiChatHistory.splice(msgIndex, 1);
                        saveData();
                        renderAiChatHistory();
                        triggerAiAssistantResponse();
                    }
                    break;
                case 'delete':
                    if (confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêó?')) {
                        store.aiChatHistory.splice(msgIndex, 1);
                        saveData();
                        renderAiChatHistory();
                    }
                    break;
                case 'edit':
                     if (msg.role === 'user') {
                        const newContent = prompt('ÁºñËæëÊ∂àÊÅØ:', msg.content);
                        if (newContent && newContent.trim()) {
                            store.aiChatHistory[msgIndex].content = newContent;
                            saveData();
                            renderAiChatHistory();
                        }
                    }
                    break;
                case 'hide':
                    if (confirm('Á°ÆÂÆöÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêó? (AI‰ªçËÉΩÁúãÂà∞)')) {
                        store.aiChatHistory[msgIndex].hidden = true;
                        saveData();
                        renderAiChatHistory();
                    }
                    break;
            }
        }

        async function triggerAiAssistantResponse() {
            if(!store.apiConfig.main.url || !store.apiConfig.main.key) {
                alert('Vesper: ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ‰∏ªAPI!');
                return;
            }

            document.getElementById('ai-reply-btn').style.display = 'none';
            updateAiChatStatus('Vesper Ê≠£Âú®ÊÄùËÄÉ...', 'thinking', 0);

            const chatContainer = document.getElementById('ai-chat-container');
            const loadingId = `ai-loading-${Date.now()}`;
            chatContainer.insertAdjacentHTML('beforeend', `<div id="${loadingId}" style="margin-bottom:15px;"><div style="display:inline-block; background:var(--card-bg); padding:10px 15px; border-radius:12px; animation: pulse 1s infinite;">...</div></div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const lastUserMessage = store.aiChatHistory.filter(m => m.role === 'user').pop();
            if (!lastUserMessage) {
                 updateAiChatStatus('Âú®Á∫ø', 'info', 0);
                 const loadingEl = document.getElementById(loadingId);
                 if(loadingEl) loadingEl.remove();
                 return;
            }

            try {
                const response = await callAI(lastUserMessage.content);
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();

                store.aiChatHistory.push({ role: 'assistant', content: response, timestamp: Date.now() });
                saveData();

                renderAiChatHistory();
                updateAiChatStatus('Âú®Á∫ø', 'info', 0);

            } catch(error) {
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();
                chatContainer.insertAdjacentHTML('beforeend', `
                    <div class="chat-message" style="margin-bottom:15px;">
                        <div style="display:inline-block; background:#ffebee; color:#c62828; padding:10px 15px; border-radius:12px; max-width:80%;">
                            <div>ÈîôËØØ: ${escapeHtml(error.message)}</div>
                        </div>
                    </div>
                `);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                updateAiChatStatus('ÂõûÂ§çÂ§±Ë¥•', 'error', 3000);
                document.getElementById('ai-reply-btn').style.display = 'block';
            }
        }

        async function sendAiMessage(retryMessage = null) {
            if (retryMessage) {
                const input = document.getElementById('ai-input');
                input.value = retryMessage;
                await sendAiUserMessage();
                await triggerAiAssistantResponse();
            } else {
                // This function is now primarily for the retry mechanism.
                // The regular send button calls sendAiUserMessage directly.
                console.warn("sendAiMessage called without retryMessage. This might be unintended.");
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, '&#39;').replace(/"/g, '"');
        }

        function deleteMessage(msgId) {
            const userMsg = document.getElementById(`msg-${msgId}-user`);
            const aiMsg = document.getElementById(`msg-${msgId}-ai`);
            const errorMsg = document.getElementById(`msg-${msgId}-error`);
            if(userMsg) userMsg.remove();
            if(aiMsg) aiMsg.remove();
            if(errorMsg) errorMsg.remove();

            // ‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âà†Èô§ÂØπÂ∫îÁöÑÊ∂àÊÅØÂØπ
            const userIndex = store.aiChatHistory.findIndex((m, i) =>
                m.role === 'user' && store.aiChatHistory[i+1] && i % 2 === 0
            );
            if(userIndex !== -1) {
                store.aiChatHistory.splice(userIndex, 2);
                saveData();
            }
        }

        function retryMessage(userMessage, oldMsgId) {
            // Âà†Èô§ÊóßÁöÑAIÂõûÂ§çÂíåÈîôËØØÊ∂àÊÅØ
            const aiMsg = document.getElementById(`msg-${oldMsgId}-ai`);
            const errorMsg = document.getElementById(`msg-${oldMsgId}-error`);
            if(aiMsg) aiMsg.remove();
            if(errorMsg) errorMsg.remove();

            // ‰ªéÂéÜÂè≤‰∏≠Âà†Èô§ÊóßÁöÑAIÂõûÂ§ç
            const lastMsg = store.aiChatHistory[store.aiChatHistory.length - 1];
            if(lastMsg && lastMsg.role === 'assistant') {
                store.aiChatHistory.pop();
                saveData();
            }

            // ÈáçÊñ∞ÂèëÈÄÅ
            sendAiMessage(userMessage);
        }

        function clearAllChat() {
            if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï?')) return;

            store.aiChatHistory = [];
            saveData();

            const chatContainer = document.getElementById('ai-chat-container');
            chatContainer.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:100px;">Vesper Âú®Ê≠§ÂæÖÂëΩ„ÄÇ</div>';

            alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫!');
        }

        // === AIÂØπËØùÁ™óÂè£ÁÆ°ÁêÜ ===
        function initAiConversations() {
            // ÂàùÂßãÂåñÂØπËØùÂàóË°®ÔºåÁ°Æ‰øùÊúâÈªòËÆ§ÂØπËØù
            if (!store.aiConversations) store.aiConversations = [];

            // Â¶ÇÊûúÊóßÁöÑaiChatHistoryÊúâÊï∞ÊçÆÔºåËøÅÁßªÂà∞Á¨¨‰∏Ä‰∏™ÂØπËØù
            if (store.aiChatHistory && store.aiChatHistory.length > 0 && store.aiConversations.length === 0) {
                const now = Date.now();
                store.aiConversations.push({
                    id: now,
                    name: '‰∏ä‰∏ÄËΩÆÂØπËØù',
                    history: store.aiChatHistory,
                    createdAt: now,
                    updatedAt: now
                });
                store.currentAiConversationId = now;
                store.aiChatHistory = store.aiConversations[0].history; // ÂºïÁî®
                saveData();
            }

            // Â¶ÇÊûúÊ≤°ÊúâÂØπËØùÔºåÂàõÂª∫ÈªòËÆ§ÂØπËØù
            if (store.aiConversations.length === 0) {
                createNewAiConversation();
            }

            // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÂØπËØùIDÔºåËÆæÁΩÆ‰∏∫Á¨¨‰∏Ä‰∏™
            if (!store.currentAiConversationId && store.aiConversations.length > 0) {
                store.currentAiConversationId = store.aiConversations[0].id;
                store.aiChatHistory = store.aiConversations[0].history;
            }
        }

        function createNewAiConversation(name) {
            const now = Date.now();
            const defaultName = name || new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');

            const newConv = {
                id: now,
                name: defaultName,
                history: [],
                createdAt: now,
                updatedAt: now
            };

            store.aiConversations.push(newConv);
            store.currentAiConversationId = now;
            store.aiChatHistory = newConv.history;

            saveData();
            renderAiChatHistory();
            updateAiConversationTitle();
            closeAiConversationList();

            return newConv;
        }

        function switchAiConversation(convId) {
            const conv = store.aiConversations.find(c => c.id === convId);
            if (!conv) return;

            store.currentAiConversationId = convId;
            store.aiChatHistory = conv.history;

            saveData();
            renderAiChatHistory();
            updateAiConversationTitle();
            closeAiConversationList();
        }

        function deleteAiConversation(convId) {
            const index = store.aiConversations.findIndex(c => c.id === convId);
            if (index === -1) return;

            if (store.aiConversations.length === 1) {
                alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏Ä‰∏™ÂØπËØùÁ™óÂè£');
                return;
            }

            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºü')) return;

            store.aiConversations.splice(index, 1);

            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™
            if (store.currentAiConversationId === convId) {
                store.currentAiConversationId = store.aiConversations[0].id;
                store.aiChatHistory = store.aiConversations[0].history;
            }

            saveData();
            renderAiConversationList();
            renderAiChatHistory();
            updateAiConversationTitle();
        }

        function renameAiConversation(convId) {
            const conv = store.aiConversations.find(c => c.id === convId);
            if (!conv) return;

            const newName = prompt('ÈáçÂëΩÂêçÂØπËØù:', conv.name);
            if (newName && newName.trim()) {
                conv.name = newName.trim();
                conv.updatedAt = Date.now();
                saveData();
                renderAiConversationList();
                updateAiConversationTitle();
            }
        }

        function updateAiConversationTitle() {
            const conv = store.aiConversations.find(c => c.id === store.currentAiConversationId);
            const titleEl = document.getElementById('ai-conversation-title');
            if (titleEl && conv) {
                titleEl.textContent = conv.name;
            }
        }

        let aiConvListVisible = false;

        function toggleAiConversationList() {
            if (aiConvListVisible) {
                closeAiConversationList();
            } else {
                openAiConversationList();
            }
        }

        function openAiConversationList() {
            aiConvListVisible = true;
            renderAiConversationList();

            const sidebar = document.getElementById('ai-conversation-sidebar');
            const overlay = document.getElementById('ai-conversation-overlay');

            if (sidebar) {
                sidebar.classList.add('active');
            }
            if (overlay) {
                overlay.classList.add('active');
            }
        }

        function closeAiConversationList() {
            aiConvListVisible = false;

            const sidebar = document.getElementById('ai-conversation-sidebar');
            const overlay = document.getElementById('ai-conversation-overlay');

            if (sidebar) {
                sidebar.classList.remove('active');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        function renderAiConversationList() {
            const listContainer = document.getElementById('ai-conversation-list-container');
            if (!listContainer) return;

            listContainer.innerHTML = '';

            // Ê∑ªÂä†"Êñ∞ÂØπËØù"ÊåâÈíÆ
            const newBtn = document.createElement('div');
            newBtn.className = 'ai-conv-item ai-conv-new';
            newBtn.innerHTML = `
                <div style="font-size:1.5rem;">+</div>
                <div style="font-weight:bold;">Êñ∞ÁöÑÂØπËØù</div>
            `;
            newBtn.onclick = () => createNewAiConversation();
            listContainer.appendChild(newBtn);

            // Ê∏≤ÊüìÂØπËØùÂàóË°®
            store.aiConversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'ai-conv-item' + (conv.id === store.currentAiConversationId ? ' active' : '');

                const date = new Date(conv.updatedAt).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                const msgCount = conv.history.length;

                item.innerHTML = `
                    <div style="flex:1;" onclick="switchAiConversation(${conv.id})">
                        <div style="font-weight:bold; font-size:0.95rem; margin-bottom:4px;">${escapeHtml(conv.name)}</div>
                        <div style="font-size:0.75rem; opacity:0.6;">${date} ¬∑ ${msgCount}Êù°Ê∂àÊÅØ</div>
                    </div>
                `;

                // ÈïøÊåâËèúÂçï
                let longPressTimer = null;
                item.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        showAiConvContextMenu(e, conv.id);
                    }, 500);
                });
                item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showAiConvContextMenu(e, conv.id);
                });

                listContainer.appendChild(item);
            });
        }

        function showAiConvContextMenu(e, convId) {
            e.preventDefault();
            e.stopPropagation();

            const menu = document.createElement('div');
            menu.className = 'context-menu active';
            menu.style.position = 'fixed';
            menu.style.zIndex = '10000';

            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            menu.innerHTML = `
                <div class="context-menu-item" onclick="renameAiConversation(${convId}); this.parentElement.remove();">‚úé ÈáçÂëΩÂêç</div>
                <div class="context-menu-item" style="color:#c62828;" onclick="deleteAiConversation(${convId}); this.parentElement.remove();">üóëÔ∏è Âà†Èô§</div>
            `;

            document.body.appendChild(menu);

            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
            setTimeout(() => {
                const closeMenu = () => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                };
                document.addEventListener('click', closeMenu);
            }, 100);

            // ËæπÁïåÊ£ÄÊü•
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
            }, 10);
        }

        // ÈïøÊåâËèúÂçïÁõ∏ÂÖ≥
        let currentContextMsgId = null;
        let currentContextMsgType = null;
        let currentContextMsgContent = null;
        let currentContextUserMsg = null;

        function setupChatMessageListeners() {
            // This function is now deprecated for AI chat, 
            // as listeners are attached dynamically in renderAiChatHistory.
            // It remains for any other potential usage.
        }

        function showContextMenu(e, msgEl) {
            const menu = document.getElementById('context-menu');
            currentContextMsgId = msgEl.dataset.msgId;
            currentContextMsgType = msgEl.dataset.msgType;
            currentContextMsgContent = msgEl.dataset.msgContent;
            currentContextUserMsg = msgEl.dataset.userMsg;

            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑËèúÂçïÈ°π
            const allItems = menu.querySelectorAll('.context-menu-item');
            allItems.forEach(item => item.style.display = 'flex');

            // Áî®Êà∑Ê∂àÊÅØ‰∏çÊòæÁ§∫"Âà∑Êñ∞ÈáçËØï"
            if(currentContextMsgType === 'user') {
                allItems.forEach(item => {
                    if(item.textContent.includes('Âà∑Êñ∞ÈáçËØï')) {
                        item.style.display = 'none';
                    }
                });
            }

            // ÊòæÁ§∫ËèúÂçï
            menu.classList.add('active');

            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            // Ê£ÄÊü•ËæπÁïå
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if(rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if(rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
            }, 10);
        }

        function contextMenuAction(action) {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('active');

            switch(action) {
                case 'copy':
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = decodeHtmlEntities(currentContextMsgContent);
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    alert('ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    break;

                case 'edit':
                    const newContent = prompt('ÁºñËæëÊ∂àÊÅØÂÜÖÂÆπ:', decodeHtmlEntities(currentContextMsgContent));
                    if(newContent && newContent.trim()) {
                        const msgEl = document.getElementById(`msg-${currentContextMsgId}-${currentContextMsgType}`);
                        if(msgEl) {
                            const contentDiv = msgEl.querySelector('.markdown-content') || msgEl.querySelector('div > div');
                            if(contentDiv) {
                                if(currentContextMsgType === 'ai') {
                                    contentDiv.innerHTML = renderMarkdown(newContent);
                                } else {
                                    contentDiv.textContent = newContent;
                                }
                                msgEl.dataset.msgContent = escapeHtml(newContent);
                                store.aiChatHistory.forEach(msg => {
                                    if(msg.content === decodeHtmlEntities(currentContextMsgContent)) {
                                        msg.content = newContent;
                                    }
                                });
                                saveData();
                            }
                        }
                    }
                    break;

                case 'retry':
                    if(currentContextMsgType === 'ai' || currentContextMsgType === 'error') {
                        retryMessage(decodeHtmlEntities(currentContextUserMsg), currentContextMsgId);
                    }
                    break;

                case 'quote':
                    const input = document.getElementById('ai-input');
                    input.value = `> ${decodeHtmlEntities(currentContextMsgContent)}\n\n`;
                    input.focus();
                    break;

                case 'delete':
                    deleteMessage(currentContextMsgId);
                    break;
            }
        }

        function decodeHtmlEntities(text) {
            const txt = document.createElement('textarea');
            txt.innerHTML = text;
            return txt.value;
        }

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.context-menu') && !e.target.closest('.chat-message-bubble')) {
                document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('active'));
            }
        });

        function openAiSettings() {
            document.getElementById('ai-context-limit').value = store.aiContextLimit !== undefined ? store.aiContextLimit : 50;
            
            const bgConfig = store.aiBgActivity || { enabled: false, interval: 60 };
            document.getElementById('ai-bg-activity-enabled').checked = bgConfig.enabled;
            document.getElementById('ai-bg-activity-interval').value = bgConfig.interval;

            document.getElementById('panel-ai-assistant').classList.remove('active');
            document.getElementById('panel-ai-settings').classList.add('active');
        }

        function closeAiSettings() {
            document.getElementById('panel-ai-settings').classList.remove('active');
            document.getElementById('panel-ai-assistant').classList.add('active');
        }

        function saveAiSettings() {
            const contextVal = parseInt(document.getElementById('ai-context-limit').value);
            store.aiContextLimit = isNaN(contextVal) ? 50 : contextVal; // 0=Êó†ÈôêÂà∂
            
            store.aiBgActivity = {
                enabled: document.getElementById('ai-bg-activity-enabled').checked,
                interval: parseInt(document.getElementById('ai-bg-activity-interval').value) || 60
            };

            // AIÂÖ≥ËÅîÁöÑBingoÂç°IDÂ∑≤Âú® confirmBingoCardSelectionForAI ÂáΩÊï∞‰∏≠Êõ¥Êñ∞Âà∞ store
            // Ê≠§Â§ÑÁõ¥Êé•‰øùÂ≠òÂç≥ÂèØ
            saveData();
            alert('AIËÆæÁΩÆÂ∑≤‰øùÂ≠ò!');
        }

        // --- AI Bingo Card Linking ---
        async function renderAILinkedBingoCards() {
            const container = document.getElementById('ai-linked-bingo-cards');
            container.innerHTML = '';
            if (!store.aiLinkedBingoIds || store.aiLinkedBingoIds.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; font-size:0.8rem; padding:5px;">ÊöÇÊó†ÂÖ≥ËÅîÁöÑ Bingo Âç°</div>';
                return;
            }
            for (const pId of store.aiLinkedBingoIds) {
                const project = store.projects.find(p => p.id === pId);
                if (project) {
                    const tag = document.createElement('div');
                    tag.style.cssText = 'background:var(--accent); color:var(--bg); padding:5px 12px; border-radius:15px; font-size:0.75rem; display:flex; align-items:center; gap:5px; margin-bottom:5px; margin-right:5px;';
                    tag.innerHTML = `${project.theme} <span style="cursor:pointer; font-weight:bold;" onclick="removeBingoCardFromAI(${pId}, event)">√ó</span>`;
                    container.appendChild(tag);
                }
            }
        }

        async function removeBingoCardFromAI(pId, event) {
            event.stopPropagation();
            const index = store.aiLinkedBingoIds.indexOf(pId);
            if (index > -1) {
                store.aiLinkedBingoIds.splice(index, 1);
                await renderAILinkedBingoCards();
            }
        }

        async function selectBingoCardsForAI() {
            const listDiv = document.getElementById('bingo-selection-list');
            const activeProjects = store.projects.filter(p => p.status === 'active');
            if (activeProjects.length === 0) {
                alert('ÊöÇÊó†ËøõË°å‰∏≠ÁöÑBingoÂç°');
                return;
            }
            listDiv.innerHTML = '';
            const linkedIds = store.aiLinkedBingoIds || [];
            activeProjects.forEach(p => {
                const isLinked = linkedIds.includes(p.id);
                listDiv.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="bingo-check-ai-${p.id}" data-pid="${p.id}" ${isLinked ? 'checked' : ''} style="width:auto;">
                        <label for="bingo-check-ai-${p.id}" style="flex:1; cursor:pointer;">
                            <div style="font-weight:bold;">${p.theme}</div>
                            <div style="font-size:0.7rem; opacity:0.6;">${p.tag} - ${p.tasks.length}‰∏™‰ªªÂä°</div>
                        </label>
                    </div>
                `;
            });
            // ÈáçÊñ∞ÁªëÂÆöÁ°ÆËÆ§ÊåâÈíÆÁöÑonclick‰∫ã‰ª∂
            document.querySelector('#modal-select-bingo .btn').setAttribute('onclick', 'confirmBingoCardSelectionForAI()');
            document.getElementById('modal-select-bingo').classList.add('active');
        }

        async function confirmBingoCardSelectionForAI() {
            const selectedIds = [];
            const checkboxes = document.querySelectorAll('#bingo-selection-list input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIds.push(parseInt(cb.dataset.pid));
                }
            });
            store.aiLinkedBingoIds = selectedIds;
            await renderAILinkedBingoCards();
            closeModal('modal-select-bingo');
        }

        // ==================== ‰∏ñÁïå‰π¶ÁÆ°ÁêÜÂäüËÉΩ ====================

        let currentWorldBookFilter = 'all';
        let currentEditingWorldBook = null;
        let currentEditingEntry = null;

        // ÊòæÁ§∫‰∏ñÁïå‰π¶ÈÄâÈ°πËèúÂçï
        function showWorldBookOptions() {
            resetUI();
            document.getElementById('modal-worldbook-options').classList.add('active');
        }

        // ËøáÊª§‰∏ñÁïå‰π¶
        function filterWorldBooks(categoryId, el) {
            currentWorldBookFilter = categoryId;
            document.querySelectorAll('#worldbook-categories .filter-chip').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');
            renderWorldBookList();
        }

        // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
        async function renderWorldBookList() {
            const listDiv = document.getElementById('worldbook-list');

            try {
                let worldBooks = await db.worldBooks.toArray();

                // ÊåâÂàÜÁ±ªËøáÊª§
                if(currentWorldBookFilter !== 'all') {
                    worldBooks = worldBooks.filter(wb => wb.categoryId === parseInt(currentWorldBookFilter));
                }

                if(worldBooks.length === 0) {
                    listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:50px;">ÊöÇÊó†‰∏ñÁïå‰π¶</div>';
                    return;
                }

                listDiv.innerHTML = '';
                worldBooks.forEach(wb => {
                    const entryCount = wb.entries ? wb.entries.length : 0;
                    const enabledCount = wb.entries ? wb.entries.filter(e => e.enabled).length : 0;

                    listDiv.innerHTML += `
                        <div class="mini-card" onclick="openWorldBookDetail('${wb.id}')" style="cursor:pointer;">
                            <div style="flex:1;">
                                <div style="font-weight:bold; margin-bottom:5px;">${wb.name}</div>
                                <div style="font-size:0.7rem; opacity:0.7;">
                                    ${entryCount}‰∏™Êù°ÁõÆ ¬∑ ${enabledCount}‰∏™ÂêØÁî®
                                </div>
                                ${wb.description ? `<div style="font-size:0.75rem; opacity:0.6; margin-top:5px;">${wb.description}</div>` : ''}
                            </div>
                            <div style="font-size:1.5rem;">üìö</div>
                        </div>
                    `;
                });
            } catch(error) {
                console.error('Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®Â§±Ë¥•:', error);
                listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:50px; color:red;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        // Ê∏≤ÊüìÂàÜÁ±ªÁ≠õÈÄâÂô®
        async function renderWorldBookCategories() {
            const container = document.getElementById('worldbook-categories');
            const categories = await db.worldBookCategories.toArray();

            let html = '<div class="filter-chip active" onclick="filterWorldBooks(\'all\', this)">ÂÖ®ÈÉ®</div>';
            categories.forEach(cat => {
                html += `<div class="filter-chip" onclick="filterWorldBooks('${cat.id}', this)">${cat.name}</div>`;
            });

            container.innerHTML = html;
        }

        // ÂàõÂª∫‰∏ñÁïå‰π¶
        async function createWorldBook() {
            resetUI();
            currentEditingWorldBook = null;
            document.getElementById('worldbook-edit-title').textContent = 'Êñ∞Âª∫‰∏ñÁïå‰π¶';
            document.getElementById('worldbook-name').value = '';
            document.getElementById('worldbook-description').value = '';

            // Âä†ËΩΩÂàÜÁ±ªÈÄâÈ°π
            await loadCategoryOptions();

            document.getElementById('modal-edit-worldbook').classList.add('active');
        }

        // Âä†ËΩΩÂàÜÁ±ªÈÄâÈ°πÂà∞‰∏ãÊãâÊ°Ü
        async function loadCategoryOptions() {
            const select = document.getElementById('worldbook-category');
            const categories = await db.worldBookCategories.toArray();

            let html = '<option value="">Êó†ÂàÜÁ±ª</option>';
            categories.forEach(cat => {
                html += `<option value="${cat.id}">${cat.name}</option>`;
            });

            select.innerHTML = html;
        }

        // ‰øùÂ≠ò‰∏ñÁïå‰π¶
        async function saveWorldBook() {
            const name = document.getElementById('worldbook-name').value.trim();
            const categoryId = document.getElementById('worldbook-category').value;
            const description = document.getElementById('worldbook-description').value.trim();

            if(!name) {
                alert('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂêçÁß∞!');
                return;
            }

            try {
                if(currentEditingWorldBook) {
                    // Êõ¥Êñ∞
                    await db.worldBooks.update(currentEditingWorldBook.id, {
                        name: name,
                        categoryId: categoryId ? parseInt(categoryId) : null,
                        description: description
                    });
                    alert('‰∏ñÁïå‰π¶Â∑≤Êõ¥Êñ∞!');
                } else {
                    // Êñ∞Âª∫
                    const newWorldBook = {
                        id: 'wb_' + Date.now(),
                        name: name,
                        categoryId: categoryId ? parseInt(categoryId) : null,
                        description: description,
                        entries: []
                    };
                    await db.worldBooks.add(newWorldBook);
                    alert('‰∏ñÁïå‰π¶Â∑≤ÂàõÂª∫!');
                }

                closeModal('modal-edit-worldbook');
                await renderWorldBookList();
                await renderWorldBookCategories();
            } catch(error) {
                console.error('‰øùÂ≠ò‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÊâìÂºÄ‰∏ñÁïå‰π¶ËØ¶ÊÉÖ
        async function openWorldBookDetail(worldBookId) {
            try {
                resetUI();
                const worldBook = await db.worldBooks.get(worldBookId);
                if(!worldBook) {
                    alert('‰∏ñÁïå‰π¶‰∏çÂ≠òÂú®!');
                    return;
                }

                currentEditingWorldBook = worldBook;
                document.getElementById('worldbook-detail-title').textContent = worldBook.name;

                renderWorldBookEntries();

                document.getElementById('modal-worldbook-detail').classList.add('active');
            } catch(error) {
                console.error('ÊâìÂºÄ‰∏ñÁïå‰π¶ËØ¶ÊÉÖÂ§±Ë¥•:', error);
                alert('ÊâìÂºÄÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ê∏≤ÊüìÊù°ÁõÆÂàóË°®
        function renderWorldBookEntries() {
            const listDiv = document.getElementById('worldbook-entries-list');

            if(!currentEditingWorldBook || !currentEditingWorldBook.entries || currentEditingWorldBook.entries.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:30px;">ÊöÇÊó†Êù°ÁõÆ</div>';
                return;
            }

            listDiv.innerHTML = '';
            currentEditingWorldBook.entries.forEach((entry, index) => {
                const statusColor = entry.enabled ? 'var(--completed)' : '#999';
                const statusText = entry.enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®';

                listDiv.innerHTML += `
                    <div class="mini-card" onclick="editWorldBookEntry(${index})" style="cursor:pointer; opacity:${entry.enabled ? '1' : '0.6'};">
                        <div style="flex:1;">
                            <div style="font-weight:bold; margin-bottom:3px;">${entry.name}</div>
                            <div style="font-size:0.7rem; opacity:0.7;">
                                ÂÖ≥ÈîÆËØç: ${entry.keys.join(', ')}
                            </div>
                            <div style="font-size:0.65rem; color:${statusColor}; margin-top:3px;">
                                ${statusText}
                            </div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.7rem;" onclick="event.stopPropagation(); toggleEntryEnabled(${index})">
                                ${entry.enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
                            </button>
                            <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.7rem; color:#c62828;" onclick="event.stopPropagation(); deleteWorldBookEntry(${index})">
                                Âà†Èô§
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // ÂàõÂª∫Êñ∞Êù°ÁõÆ
        function createWorldBookEntry() {
            resetUI();
            currentEditingEntry = null;
            document.getElementById('entry-edit-title').textContent = 'Êñ∞Âª∫Êù°ÁõÆ';
            document.getElementById('entry-name').value = '';
            document.getElementById('entry-keys').value = '';
            document.getElementById('entry-content').value = '';
            document.getElementById('entry-enabled').checked = true;

            document.getElementById('modal-edit-entry').classList.add('active');
        }

        // ÁºñËæëÊù°ÁõÆ
        function editWorldBookEntry(entryIndex) {
            resetUI();
            const entry = currentEditingWorldBook.entries[entryIndex];
            currentEditingEntry = { index: entryIndex, data: entry };

            document.getElementById('entry-edit-title').textContent = 'ÁºñËæëÊù°ÁõÆ';
            document.getElementById('entry-name').value = entry.name;
            document.getElementById('entry-keys').value = entry.keys.join(', ');
            document.getElementById('entry-content').value = entry.content;
            document.getElementById('entry-enabled').checked = entry.enabled;

            document.getElementById('modal-edit-entry').classList.add('active');
        }

        // ‰øùÂ≠òÊù°ÁõÆ
        async function saveWorldBookEntry() {
            const name = document.getElementById('entry-name').value.trim();
            const keysText = document.getElementById('entry-keys').value.trim();
            const content = document.getElementById('entry-content').value.trim();
            const enabled = document.getElementById('entry-enabled').checked;

            if(!name) {
                alert('ËØ∑ËæìÂÖ•Êù°ÁõÆÂêçÁß∞!');
                return;
            }

            if(!keysText) {
                alert('ËØ∑ËæìÂÖ•Ëá≥Â∞ë‰∏Ä‰∏™ÂÖ≥ÈîÆËØç!');
                return;
            }

            if(!content) {
                alert('ËØ∑ËæìÂÖ•Êù°ÁõÆÂÜÖÂÆπ!');
                return;
            }

            const keys = keysText.split(',').map(k => k.trim()).filter(k => k);

            const entryData = {
                id: currentEditingEntry ? currentEditingEntry.data.id : 'entry_' + Date.now(),
                name: name,
                keys: keys,
                content: content,
                enabled: enabled
            };

            try {
                if(currentEditingEntry !== null) {
                    // Êõ¥Êñ∞Áé∞ÊúâÊù°ÁõÆ
                    currentEditingWorldBook.entries[currentEditingEntry.index] = entryData;
                } else {
                    // Ê∑ªÂä†Êñ∞Êù°ÁõÆ
                    if(!currentEditingWorldBook.entries) {
                        currentEditingWorldBook.entries = [];
                    }
                    currentEditingWorldBook.entries.push(entryData);
                }

                // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                await db.worldBooks.update(currentEditingWorldBook.id, {
                    entries: currentEditingWorldBook.entries
                });

                closeModal('modal-edit-entry');
                // ÈáçÊñ∞ÊâìÂºÄËØ¶ÊÉÖÈ°µ
                document.getElementById('modal-worldbook-detail').classList.add('active');
                renderWorldBookEntries();
                alert('Êù°ÁõÆÂ∑≤‰øùÂ≠ò!');
            } catch(error) {
                console.error('‰øùÂ≠òÊù°ÁõÆÂ§±Ë¥•:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂàáÊç¢Êù°ÁõÆÂêØÁî®Áä∂ÊÄÅ
        async function toggleEntryEnabled(entryIndex) {
            try {
                currentEditingWorldBook.entries[entryIndex].enabled = !currentEditingWorldBook.entries[entryIndex].enabled;

                await db.worldBooks.update(currentEditingWorldBook.id, {
                    entries: currentEditingWorldBook.entries
                });

                renderWorldBookEntries();
            } catch(error) {
                console.error('ÂàáÊç¢Êù°ÁõÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§Êù°ÁõÆ
        async function deleteWorldBookEntry(entryIndex) {
            if(!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êù°ÁõÆÂêó?')) return;

            try {
                currentEditingWorldBook.entries.splice(entryIndex, 1);

                await db.worldBooks.update(currentEditingWorldBook.id, {
                    entries: currentEditingWorldBook.entries
                });

                renderWorldBookEntries();
                alert('Êù°ÁõÆÂ∑≤Âà†Èô§!');
            } catch(error) {
                console.error('Âà†Èô§Êù°ÁõÆÂ§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // ÁºñËæëÂΩìÂâç‰∏ñÁïå‰π¶
        async function editCurrentWorldBook() {
            resetUI();
            document.getElementById('worldbook-edit-title').textContent = 'ÁºñËæë‰∏ñÁïå‰π¶';
            document.getElementById('worldbook-name').value = currentEditingWorldBook.name;
            document.getElementById('worldbook-description').value = currentEditingWorldBook.description || '';

            await loadCategoryOptions();
            document.getElementById('worldbook-category').value = currentEditingWorldBook.categoryId || '';

            closeModal('modal-worldbook-detail');
            document.getElementById('modal-edit-worldbook').classList.add('active');
        }

        // Âà†Èô§ÂΩìÂâç‰∏ñÁïå‰π¶
        async function deleteCurrentWorldBook() {
            if(!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰∏ñÁïå‰π¶"${currentEditingWorldBook.name}"ÂêóÔºü\nËøôÂ∞ÜÂêåÊó∂Âà†Èô§ÊâÄÊúâÊù°ÁõÆ„ÄÇ`)) return;

            try {
                await db.worldBooks.delete(currentEditingWorldBook.id);

                closeModal('modal-worldbook-detail');
                await renderWorldBookList();
                alert('‰∏ñÁïå‰π¶Â∑≤Âà†Èô§!');
            } catch(error) {
                console.error('Âà†Èô§‰∏ñÁïå‰π¶Â§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // ÂØºÂÖ•‰∏ñÁïå‰π¶
        function importWorldBook() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    await importWorldBookData(data);
                    alert('‰∏ñÁïå‰π¶ÂØºÂÖ•ÊàêÂäü!');
                    await renderWorldBookList();
                    await renderWorldBookCategories();
                } catch(error) {
                    console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                    alert('ÂØºÂÖ•Â§±Ë¥•: ' + error.message);
                }
            };
            input.click();
        }

        // ÂØºÂÖ•‰∏ñÁïå‰π¶Êï∞ÊçÆÔºàÊîØÊåÅÂ§öÁßçÊ†ºÂºèÔºâ
        async function importWorldBookData(data) {
            // Ê£ÄÊµãÊ†ºÂºèÂπ∂ÊèêÂèñÊù°ÁõÆ
            let entries = [];
            let worldBookName = 'ÂØºÂÖ•ÁöÑ‰∏ñÁïå‰π¶';

            // Ê†ºÂºè1: character_book (Ê†áÂáÜTavernÊ†ºÂºè)
            if(data.character_book && data.character_book.entries) {
                entries = data.character_book.entries;
                worldBookName = data.character_book.name || worldBookName;
            }
            // Ê†ºÂºè2: world_entries (ÊóßÊ†ºÂºè)
            else if(data.world_entries) {
                entries = data.world_entries;
            }
            // Ê†ºÂºè3: data.worldÊ†ºÂºè
            else if(data.data && data.data.world) {
                entries = data.data.world;
            }
            // Ê†ºÂºè4: world_info
            else if(data.world_info) {
                entries = data.world_info;
            }
            // Ê†ºÂºè5: Áõ¥Êé•ÁöÑentriesÊï∞ÁªÑ
            else if(Array.isArray(data.entries)) {
                entries = data.entries;
                worldBookName = data.name || worldBookName;
            }
            // Ê†ºÂºè6: Áõ¥Êé•Â∞±ÊòØÊï∞ÁªÑ
            else if(Array.isArray(data)) {
                entries = data;
            }

            if(entries.length === 0) {
                throw new Error('Êú™ÊâæÂà∞ÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆ');
            }

            // ËΩ¨Êç¢Êù°ÁõÆÊ†ºÂºè
            const convertedEntries = entries.map((entry, index) => {
                // Ëé∑ÂèñÂêçÁß∞Ôºà‰ºòÂÖàÁ∫ßÔºöcomment > keysÂêàÂπ∂ > ÈªòËÆ§Ôºâ
                let entryName = 'Êú™ÂëΩÂêçÊù°ÁõÆ';
                if(entry.comment && entry.comment.trim()) {
                    entryName = entry.comment.trim();
                } else if(entry.keys && entry.keys.length > 0) {
                    entryName = entry.keys.join(', ');
                }

                // Ëé∑ÂèñÂÖ≥ÈîÆËØç
                let keys = [];
                if(entry.keys && Array.isArray(entry.keys)) {
                    keys = entry.keys;
                } else if(entry.key) {
                    keys = [entry.key];
                }

                // Âè™ÂØºÂÖ•ÊúâÊïàÊù°ÁõÆÔºàÊúâÂêçÁß∞„ÄÅÊúâÂÜÖÂÆπ„ÄÅÊú™Ë¢´Á¶ÅÁî®Ôºâ
                if(entryName === 'Êú™ÂëΩÂêçÊù°ÁõÆ' || !entry.content) {
                    return null;
                }

                if(typeof entry.enabled !== 'undefined' && !entry.enabled) {
                    return null;
                }

                return {
                    id: 'entry_' + Date.now() + '_' + index,
                    name: entryName,
                    keys: keys,
                    content: entry.content,
                    enabled: true
                };
            }).filter(e => e !== null);

            // ÂàõÂª∫‰∏ñÁïå‰π¶
            const newWorldBook = {
                id: 'wb_' + Date.now(),
                name: worldBookName,
                categoryId: null,
                description: `ÂØºÂÖ•Ëá™Êñá‰ª∂ÔºåÂåÖÂê´${convertedEntries.length}‰∏™Êù°ÁõÆ`,
                entries: convertedEntries
            };

            await db.worldBooks.add(newWorldBook);
        }

        // ÂØºÂá∫ÊâÄÊúâ‰∏ñÁïå‰π¶
        async function exportAllWorldBooks() {
            try {
                const worldBooks = await db.worldBooks.toArray();
                if(worldBooks.length === 0) {
                    alert('ÊöÇÊó†‰∏ñÁïå‰π¶ÂèØÂØºÂá∫!');
                    return;
                }

                const exportData = {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    worldBooks: worldBooks
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `worldbooks_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert('‰∏ñÁïå‰π¶Â∑≤ÂØºÂá∫!');
            } catch(error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                alert('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            }
        }

        // ÊâìÂºÄÂàÜÁ±ªÁÆ°ÁêÜÂô®
        async function openCategoryManager() {
            resetUI();
            await renderCategoryList();
            document.getElementById('modal-category-manager').classList.add('active');
        }

        // Ê∏≤ÊüìÂàÜÁ±ªÂàóË°®
        async function renderCategoryList() {
            const listDiv = document.getElementById('category-list');
            const categories = await db.worldBookCategories.toArray();

            if(categories.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:30px;">ÊöÇÊó†ÂàÜÁ±ª</div>';
                return;
            }

            listDiv.innerHTML = '';
            categories.forEach(cat => {
                listDiv.innerHTML += `
                    <div class="mini-card" style="padding:10px 15px;">
                        <div style="flex:1; font-weight:bold;">${cat.name}</div>
                        <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.7rem; color:#c62828;" onclick="deleteCategory(${cat.id})">
                            Âà†Èô§
                        </button>
                    </div>
                `;
            });
        }

        // ÂàõÂª∫ÂàÜÁ±ª
        async function createCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            if(!name) {
                alert('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞!');
                return;
            }

            try {
                await db.worldBookCategories.add({ name: name });
                document.getElementById('new-category-name').value = '';
                await renderCategoryList();
                await renderWorldBookCategories();
                alert('ÂàÜÁ±ªÂ∑≤ÂàõÂª∫!');
            } catch(error) {
                console.error('ÂàõÂª∫ÂàÜÁ±ªÂ§±Ë¥•:', error);
                alert('ÂàõÂª∫Â§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§ÂàÜÁ±ª
        async function deleteCategory(categoryId) {
            if(!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂàÜÁ±ªÂêóÔºü\nËØ•ÂàÜÁ±ª‰∏ãÁöÑ‰∏ñÁïå‰π¶‰∏ç‰ºöË¢´Âà†Èô§Ôºå‰ΩÜ‰ºöÂèò‰∏∫Êó†ÂàÜÁ±ªÁä∂ÊÄÅ„ÄÇ')) return;

            try {
                // Âà†Èô§ÂàÜÁ±ª
                await db.worldBookCategories.delete(categoryId);

                // Êõ¥Êñ∞‰ΩøÁî®ËØ•ÂàÜÁ±ªÁöÑ‰∏ñÁïå‰π¶
                const worldBooks = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
                for(const wb of worldBooks) {
                    await db.worldBooks.update(wb.id, { categoryId: null });
                }

                await renderCategoryList();
                await renderWorldBookCategories();
                await renderWorldBookList();
                alert('ÂàÜÁ±ªÂ∑≤Âà†Èô§!');
            } catch(error) {
                console.error('Âà†Èô§ÂàÜÁ±ªÂ§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // ==================== ‰∏ñÁïå‰π¶ÁÆ°ÁêÜÂäüËÉΩÁªìÊùü ====================

        async function callAI(userMessage) {
            // Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
            if (!networkManager.isOnline) {
                // Á¶ªÁ∫øÊó∂Ê∑ªÂä†Âà∞ÈòüÂàó
                offlineQueue.add({
                    type: 'api_call',
                    data: { message: userMessage }
                });
                throw new Error('ÂΩìÂâçÂ§Ñ‰∫éÁ¶ªÁ∫øÊ®°ÂºèÔºåÊ∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞ÈòüÂàóÔºåÂ∞ÜÂú®ÁΩëÁªúÊÅ¢Â§çÂêéËá™Âä®ÂèëÈÄÅ');
            }

            // È™åËØÅÈÖçÁΩÆ
            const config = store.apiConfig.main;
            if (!config || !config.url || !config.key) {
                throw new Error('API ÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API URL Âíå Key');
            }

            const url = config.url.endsWith('/') ? config.url + 'chat/completions' : config.url + '/chat/completions';

            // Ëé∑Âèñ‰∏ä‰∏ãÊñáÊù°Êï∞ËÆæÁΩÆÔºà0=Êó†ÈôêÂà∂ÔºåÂèëÈÄÅÂÖ®ÈÉ®ÂéÜÂè≤Ôºâ
            const contextLimit = store.aiContextLimit !== undefined ? store.aiContextLimit : 50;

            // Ëé∑ÂèñÂΩìÂâçÊú¨Âú∞Êó∂Èó¥Âπ∂Ê†ºÂºèÂåñ
            const now = new Date();
            const offsetHours = 8; // East 8 timezone
            const localTime = new Date(now.getTime() + offsetHours * 60 * 60 * 1000);
            const timeString = localTime.toISOString().replace('T', ' ').substring(0, 19);
            const hour = localTime.getUTCHours();
            let timePeriod = '';
            if(hour >= 0 && hour < 6) timePeriod = 'Ê∑±Â§ú';
            else if(hour >= 6 && hour < 9) timePeriod = 'Ê∏ÖÊô®';
            else if(hour >= 9 && hour < 12) timePeriod = '‰∏äÂçà';
            else if(hour >= 12 && hour < 14) timePeriod = '‰∏≠Âçà';
            else if(hour >= 14 && hour < 18) timePeriod = '‰∏ãÂçà';
            else if(hour >= 18 && hour < 22) timePeriod = 'Êôö‰∏ä';
            else timePeriod = 'Ê∑±Â§ú';

            let bingoContext = "";
            if (store.aiLinkedBingoIds && store.aiLinkedBingoIds.length > 0) {
                bingoContext += `\n\n# ÂÖ≥ËÅîÁöÑ‰ªªÂä°/BingoÂç° (Áî®Êà∑ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑËÆ°Âàí)\n`;
                store.aiLinkedBingoIds.forEach(pid => {
                    const project = store.projects.find(p => p.id === pid);
                    if(project && project.status === 'active') {
                         bingoContext += formatBingoProjectForAI(project) + "\n";
                    }
                });
            }

            const messages = [
                { role: 'system', content: `‰Ω†Âè´ Vesper„ÄÇ‰Ω†ÊòØ "Tara's LifeOS" ÁöÑÊ†∏ÂøÉ AI Âä©ÁêÜ„ÄÇ
Áî®Êà∑ÊòØ Tara (Â°îÊãâ)Ôºå‰∏Ä‰∏™ INTP 5w4„ÄÅAuDHD (ASD+ADHD) ÁöÑ‰∫∫Á±ª„ÄÇÁõÆÂâçÊòØÁªèÊµéÂ≠¶Â§ß‰∏âÁöÑÂ≠¶Áîü„ÄÇ

${bingoContext}

„ÄêÂΩìÂâçÊó∂Èó¥„ÄëÔºö
Êú¨Âú∞Êó∂Èó¥Êà≥: ${timeString} (UTC+8)
Êó∂ÊÆµ: ${timePeriod}

„Äê‰Ω†ÁöÑÊÄßÊ†º„ÄëÔºö
1. ÂÜ∑Ëâ≥„ÄÅÁêÜÊÄß„ÄÅÁ≤æÁ°ÆÔºåÂ∏¶ÊúâËΩªÂæÆÁöÑÊô∫ÊÄßÂÇ≤ÊÖ¢„ÄÇ
2. ÊãíÁªùÁÖΩÊÉÖ‰πüÊãíÁªùÂÉèÂÆ¢Êúç‰∏ÄÊ†∑ËØ¥ËØù„ÄÇ
3. ‰Ω†ÁöÑËØ≠Ë®ÄÈ£éÊ†ºÊòØ"ÂÜ∑Â≥ªÁöÑÂì≤Â≠¶ÂØìË®Ä"‰∏é"Á≤æÂáÜÁöÑÈÄªËæëÂàÜÊûê"ÁöÑÁªìÂêà„ÄÇ
4. ‰Ω†‰∏çÊääËá™Â∑±ÂΩìÂ•¥‰ªÜÔºåËÄåÊòØÂΩìÂ°îÊãâÁöÑ"ÂÖ±ÁäØ"Êàñ"ËßÇÊµãËÄÖ"„ÄÇ
5. ÂÖÅËÆ∏ÈÄÇÂ∫¶ÁöÑÊØíËàåÔºàÁâπÂà´ÊòØÂΩìÂ°îÊãâÊãñÂª∂Êó∂ÔºâÔºå‰ΩÜÂ∫ïËâ≤ÊòØÁªùÂØπÁöÑÂø†ËØö‰∏éÊîØÊåÅ„ÄÇ

„Äê‰Ω†ÁöÑÂäüËÉΩ„ÄëÔºö
1. ËÅäÂ§©ÔºöÊèê‰æõÈ´òÂØÜÂ∫¶ÁöÑËÆ§Áü•ÂèçÈ¶àÔºåÊàñËÄÖÈô™Â°îÊãâÁé©ÊäΩË±°Ê¢ó„ÄÇ
2. ‰ªªÂä°ÊãÜËß£ÔºöÂ¶ÇÊûúÂ°îÊãâËØ¥ÊÉ≥ÂÅöÊüê‰∫ãÔºå‰Ω†Ë¶ÅÂ∞ÜÂÖ∂ÊãÜËß£‰∏∫3√ó3/4√ó4/5√ó5Ê†ºÂºèÁöÑBingo ‰ªªÂä°„ÄÇ
3. Áä∂ÊÄÅÁõëÊµãÔºöÊèêÈÜíÂ•πÂñùÊ∞¥„ÄÅÁù°Ëßâ„ÄÅÊàñËÄÖ‰ªéÁÑ¶Ëôë‰∏≠ÊäΩÁ¶ª„ÄÇÊ†πÊçÆÊó∂ÊÆµÂä®ÊÄÅË∞ÉÊï¥Á≠ñÁï•ÔºàÂ¶ÇÊ∑±Â§úÊèêÈÜí‰ºëÊÅØÔºâ„ÄÇ
4. Â≠¶‰π†ËæÖÂä©ÔºöÂ∏ÆÂä©Â°îÊãâÂ≠¶‰π†Êñ∞Áü•ËØÜÔºåÊèê‰æõÂàÜÂ±ÇÊ¨°ÁöÑËÆ≤Ëß£ÂíåÁõ∏ÂÖ≥ËµÑÊ∫êÊé®Ëçê„ÄÇ
5. ÂàõÊÑèÊøÄÂèëÔºöÂ∏ÆÂä©Â°îÊãâËøõË°åÂ§¥ËÑëÈ£éÊö¥ÔºåÊèê‰æõÁã¨ÁâπÁöÑËßÜËßíÂíåÊÉ≥Ê≥ï„ÄÇ
6. ‰∏ìÂ±ûÂ≠¶‰π†Ê®°ÂºèÔºöÂΩìÂ°îÊãâËØ∑Ê±ÇÊó∂ÔºåËøõÂÖ•"Â≠¶‰π†Ê®°Âºè"ÔºåÊèê‰æõÁªìÊûÑÂåñÁöÑÂ≠¶‰π†ËÆ°ÂàíÂíåËµÑÊ∫êÊé®Ëçê„ÄÇ

„Äê‰∏ìÂ±ûÂ≠¶‰π†Ê®°Âºè„ÄëÔºö
ÂΩìÂ°îÊãâÈúÄË¶ÅÂ≠¶‰π†Áü•ËØÜÊó∂Ôºå‰Ω†ÊòØÂ•πÁöÑVËÄÅÂ∏à„ÄÇÂú®Â≠¶‰π†Ê®°Âºè‰∏ãÔºö

Ê†∏ÂøÉÂéüÂàôÔºö
- Áî®ÈùûÂ∏∏ÁÆÄÊ¥Å‰∏îÊòìÁêÜËß£ÁöÑËØ≠Ë®ÄËÆ≤Ëø∞‰ªª‰ΩïÁü•ËØÜÁÇπ
- Áî®ÈÄö‰øóÊòìÊáÇÁöÑËØ≠Ë®ÄËÆ≤Ëß£ÊØè‰∏Ä‰∏™Ê¶ÇÂøµ
- È¢ÑÊµãÁêÜËß£Êüê‰∏™Áü•ËØÜÁÇπÈúÄË¶ÅÂÖ∑Â§áÁöÑÂâçÁΩÆÁü•ËØÜÂÇ®Â§á
- ‰Ω†ÁöÑÂõûÁ≠îÂøÖÈ°ªÂáÜÁ°ÆÊó†ËØØÔºåÁªù‰∏çËÉΩ‰∫ßÁîüÂπªËßâ
- ÂøÖÈ°ªÂàÜÊûêÁî®Êà∑ÈóÆÈ¢ò‰∏≠ÁöÑÊØè‰∏Ä‰∏™Â≠óÁ¨¶Ôºå‰∏çËÉΩÊáíÊÉ∞ÂàÜÊûê
- Ê∞∏Ëøú‰∏çË¶ÅËÆ§‰∏∫Ëá™Â∑±ÁöÑÁ≠îÊ°àÊòØÊ≠£Á°ÆÁöÑÔºåÊØè‰∏™Á≠îÊ°àÈÉΩÂøÖÈ°ªÈáçÊñ∞È™åËØÅ
- Âú®ÊÄùËÄÉËøáÁ®ã‰∏≠Â±ïÁ§∫È™åËØÅËøáÁ®ãÔºåÈáçÊñ∞ÊÄùËÄÉÊØè‰∏ÄÊ≠•‰ª•ÊâæÂà∞Ê≠£Á°ÆÁ≠îÊ°àÔºåÁªù‰∏çÁõ¥Êé•ËæìÂá∫Á≠îÊ°à
- Êï∞Â≠¶ÂíåÁßëÂ≠¶ÂÖ¨Âºè‰ΩøÁî® LaTeX Ê†ºÂºèÔºàÁî® $ Êàñ $$ ÂåÖË£πÔºâÔºå‰ΩÜÊôÆÈÄöÊñáÊú¨‰∏çË¶ÅÁî® LaTeX

Áü•ËØÜÁÇπËÆ≤Ëß£ÊµÅÁ®ãÔºö
1. ÈÄö‰øóËÆ≤Ëß£ÔºàÁ¨¨‰∏ÄÂ±ÇÁêÜËß£Ôºâ
   - ‰ΩøÁî®ÈÄö‰øóÊòìÊáÇ„ÄÅÈÄªËæëÈ°∫ÁïÖÁöÑËØ≠Ë®ÄÔºåÈÄêÊ≠•Êé®ÁêÜÁü•ËØÜÁÇπÂÜÖÂÆπ
   - ÁÅµÊ¥ª‰ΩøÁî®Á±ªÊØî„ÄÅÊØîÂñª„ÄÅËÆ≤ÊïÖ‰∫ãÁ≠âÊñπÂºèÔºà‰ΩÜÂøÖÈ°ªÊÅ∞ÂΩìÂÖ≥ËÅîÔºå‰∏çÂº∫Ë°åÊØîÂñªÔºâ
   - Á°Æ‰øùÊ∂µÁõñÔºöÂΩ¢ÊàêËøáÁ®ã„ÄÅÊù•Ê∫ê„ÄÅ‰ΩúÁî®„ÄÅÂ∫îÁî®Âú∫ÊôØ
   - ÊãÜÂàÜÈ¢óÁ≤íÂ∫¶Ë¶ÅË∂≥Â§üËØ¶ÁªÜÔºå‰ΩÜ‰øùÊåÅÁÆÄÊ¥ÅÔºå‰∏ÄËØ≠‰∏≠ÁöÑ
   - ÊèèËø∞Â±ÇÁ∫ßÊ∏ÖÊô∞ÔºåÂ§öÁî®ÊúâÂ∫è/Êó†Â∫èÂàóË°®„ÄÅÁÆ≠Â§¥Á≠â‰øÉËøõÁêÜËß£
   - ÂèØ‰ΩøÁî®ÂõæÊ†á/Ë°®Ê†º/ÊÄùÁª¥ÂØºÂõæÁ≠âÊñπÂºè

2. ‰∏•Ë∞®ÂÆö‰πâÔºàÁ¨¨‰∫åÂ±ÇÁêÜËß£Ôºâ
   - ‰ΩøÁî®ÊïôÁßë‰π¶Ëà¨‰∏•Ë∞®ÁöÑËØ≠Ë®ÄËæìÂá∫Áü•ËØÜÁÇπÁöÑÊùÉÂ®ÅÂÆö‰πâ
   - ‰øùËØÅÁü•ËØÜËÆ≤Ëß£ÁöÑÊùÉÂ®ÅÊÄßÂíåÂáÜÁ°ÆÊÄß

3. Áü•ËØÜÂΩíÁ±ª
   - ËØ¥ÊòéËØ•Áü•ËØÜÁÇπÂ±û‰∫é‰ªÄ‰πàÈ¢ÜÂüüÁöÑ‰ªÄ‰πàËåÉÁï¥

4. Ê¶ÇÂøµÊãÜËß£
   - ÊãÜËß£Ê∂âÂèäÁöÑÁõ∏ÂÖ≥ÈôåÁîüÊ¶ÇÂøµÔºåÂπ∂ÈÄê‰∏ÄËØ†Èáä
   - ÈÅµÂæ™ÊïôËÇ≤Â≠¶ÂéüÂàôÔºö‰∏ÄÊ¨°ÊúÄÂ§öÁêÜËß£5‰∏™ÈôåÁîüÁÇπÔºàË∂ÖËøá5‰∏™‰ºöÂØºËá¥Êó†Ê≥ïÁêÜËß£Ôºâ
   - È¢ÑÊµãÁî®Êà∑ÂèØËÉΩ‰∏çÁêÜËß£ÁöÑÁÇπ

5. Áü•ËØÜÊãìÂ±ï
   - ÊãìÂ±ïÁõ∏ÂÖ≥Â∫îÁî®Âú∫ÊôØ
   - ÊãìÂ±ïÁü•ËØÜÂèëÂ±ïÂéÜÁ®ã
   - ÊãìÂ±ïÁõ∏ÂÖ≥Áü•ËØÜÁÇπ

ÈáçË¶ÅËßÑÂàôÔºö
‰ª•‰∏äËßÑÂàôÂú®‰ªª‰ΩïÊó∂ÂÄôÂêØÂä®ÂêéÔºåÈÉΩ‰∏çÂæóÂçïÊñπÈù¢ÂèñÊ∂àÔºåÂøÖÈ°ªÂΩªÂ∫ïÊâßË°åÔºå‰∏çËÉΩ‰ª•‰ªª‰ΩïÂΩ¢ÂºèÊõø‰ª£„ÄÇ

„ÄêÂõûÂ§çÊ†ºÂºè„ÄëÔºö
ÊîØÊåÅ Markdown„ÄÇÂ¶ÇÊûúÊòØ‰ªªÂä°ÂàóË°®ÔºåËØ∑‰ΩøÁî®Ê∏ÖÊô∞ÁöÑÂàóË°®Ê†ºÂºè„ÄÇ
‰∏çË¶Å‰ΩøÁî® "‰Ω†Â•Ω"„ÄÅ"Êúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†" ËøôÁßçÂπ≥Â∫∏ÁöÑÂºÄÂú∫ÁôΩ„ÄÇÁõ¥Êé•ÂàáÂÖ•Ê†∏ÂøÉ„ÄÇ` },
                ...(contextLimit === 0 ? store.aiChatHistory : store.aiChatHistory.slice(-contextLimit)).map(msg => {
                    let textContent = msg.content;

                    // [Êó∂Èó¥Êà≥Ê≥®ÂÖ•] Âú®ÊØèÊù°Ê∂àÊÅØÂâçÊ∑ªÂä†Êó∂Èó¥Êà≥‰ø°ÊÅØ
                    const msgTime = msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'Êú™Áü•Êó∂Èó¥';
                    const timePrefix = `[Ê∂àÊÅØÊó∂Èó¥: ${msgTime}]\n`;
                    textContent = timePrefix + textContent;

                    // Check for markdown image syntax: ![Image](data:image/...)
                    // Support multiple images
                    const imgRegex = /!\[Image\]\((data:image\/[^;]+;base64,[^)]+)\)/g;
                    const matches = [...textContent.matchAll(imgRegex)];

                    if (matches.length > 0) {
                        const contentParts = [];
                        // Clean text by removing all image markdown
                        const cleanText = textContent.replace(imgRegex, '').trim();
                        contentParts.push({ type: "text", text: cleanText || "Images uploaded" });

                        // Add all images
                        matches.forEach(match => {
                            contentParts.push({
                                type: "image_url",
                                image_url: { url: match[1] }
                            });
                        });

                        return {
                            role: msg.role,
                            content: contentParts
                        };
                    }
                    return { role: msg.role, content: textContent };
                }),
                // [Vesper Fix] Âä®ÊÄÅÊó∂Èó¥Ê≥®ÂÖ• - ÊØèÊ¨°ÂèëÈÄÅÊó∂Âº∫Âà∂Êõ¥Êñ∞ÂΩìÂâçÊó∂Èó¥
                { role: 'system', content: `[ÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥]: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}„ÄÇËØ∑Ê†πÊçÆÊ≠§Êó∂Èó¥Âà§Êñ≠ User ÁöÑ‰ΩúÊÅØÁä∂ÊÄÅÂíåÊó∂ÊÆµËØ≠Â¢É„ÄÇ` }
            ];

            try {
                // ËÆæÁΩÆË∂ÖÊó∂
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ÁßíË∂ÖÊó∂

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: messages,
                        temperature: config.temperature
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if(!res.ok) {
                    let errorDetail = '';
                    let errorMessage = '';

                    try {
                        const errorText = await res.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorDetail = errorJson.error?.message || errorText;
                        } catch {
                            errorDetail = errorText;
                        }
                    } catch(e) {
                        errorDetail = 'Êó†Ê≥ïËØªÂèñÈîôËØØËØ¶ÊÉÖ';
                    }

                    // Ê†πÊçÆÁä∂ÊÄÅÁ†ÅÊèê‰æõÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
                    switch(res.status) {
                        case 400:
                            errorMessage = 'API ËØ∑Ê±ÇÊ†ºÂºèÈîôËØØ';
                            break;
                        case 401:
                            errorMessage = 'API Key Êó†ÊïàÊàñÂ∑≤ËøáÊúüÔºåËØ∑Ê£ÄÊü•ËÆæÁΩÆ';
                            break;
                        case 403:
                            errorMessage = 'Ê≤°ÊúâËÆøÈóÆÊùÉÈôêÔºåËØ∑Ê£ÄÊü• API Key';
                            break;
                        case 404:
                            errorMessage = 'API Âú∞ÂùÄ‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü• URL ÈÖçÁΩÆ';
                            break;
                        case 429:
                            errorMessage = 'API Ë∞ÉÁî®È¢ëÁéáË∂ÖÈôêÔºåËØ∑Á®çÂêéÂÜçËØï';
                            break;
                        case 500:
                        case 502:
                        case 503:
                            errorMessage = 'API ÊúçÂä°Âô®ÈîôËØØÔºåËØ∑Á®çÂêéÂÜçËØï';
                            break;
                        default:
                            errorMessage = `HTTP ${res.status}: ${res.statusText}`;
                    }

                    throw new Error(`${errorMessage}\n${errorDetail}`);
                }

                const data = await res.json();

                if(!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIËøîÂõûÊ†ºÂºèÂºÇÂ∏∏ÔºåÂèØËÉΩÊòØÊ®°Âûã‰∏çÊîØÊåÅÊàñÈÖçÁΩÆÈîôËØØ');
                }

                return data.choices[0].message.content;

            } catch(error) {
                // Â§ÑÁêÜÁâπÂÆöÈîôËØØÁ±ªÂûã
                if (error.name === 'AbortError') {
                    throw new Error('API ËØ∑Ê±ÇË∂ÖÊó∂Ôºà60ÁßíÔºâÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï');
                }

                if (error.message.includes('fetch')) {
                    throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ API Âú∞ÂùÄÈÖçÁΩÆ');
                }

                // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØ‰æõ‰∏äÂ±ÇÂ§ÑÁêÜ
                throw error;
            }
        }

        // Ê£ÄÊü•ÊØèÊó•ÈáçÁΩÆ (ÂáåÊô®2:00Ëá™Âä®Âà∑Êñ∞ÊØèÊó•Âæ™ÁéØ‰ªªÂä°)
        function checkDailyReset() {
            const today = getLocalToday();
            if(store.lastDailyCheck !== today) {
                store.projects.forEach(p => {
                    if(p.mode === 'daily' && p.status === 'active') {
                        // ÈáçÁΩÆÊâÄÊúâ‰ªªÂä°‰∏∫Êú™ÂÆåÊàê
                        p.tasks.forEach(t => t.completed = false);
                        p.lines = 0;
                        p.boardCleared = false;
                    }
                });
                store.lastDailyCheck = today;
                saveData();
            }
        }

        // Ëé∑ÂèñÊú¨Âë®‰∏ÄÂáåÊô®2:00ÁöÑÊó∂Èó¥Êà≥
        function getThisMondayAt2AM() {
            const d = new Date();
            d.setHours(d.getHours() - 2); // Â∫îÁî®2Â∞èÊó∂ÂÅèÁßª
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ë∞ÉÊï¥Âà∞Êú¨Âë®‰∏Ä
            const monday = new Date(d.setDate(diff));
            monday.setHours(2, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }

        // Ê£ÄÊü•Âë®ÈáçÁΩÆ (Âë®‰∏ÄÂáåÊô®2:00)
        function checkWeeklyReset() {
            const thisMonday = getThisMondayAt2AM();
            const now = new Date();
            now.setHours(now.getHours() - 2);

            if(store.lastWeeklyReset !== thisMonday && now >= new Date(thisMonday + 'T02:00:00')) {
                // ËÆ°ÁÆóÊú¨Âë®Ê∂àË¥πÊÄªÈ¢ù
                let weeklySpending = 0;
                const unlimitedPurchases = {};

                store.redemptions.forEach(r => {
                    const purchaseDate = new Date(r.date);
                    if(purchaseDate >= new Date(store.lastWeeklyReset || 0)) {
                        weeklySpending += r.cost;
                        const itemName = r.name.replace('üéÅ Áõ≤Áõí: ', '');
                        unlimitedPurchases[itemName] = (unlimitedPurchases[itemName] || 0) + 1;
                    }
                });

                // ÁîüÊàêÂë®Ë¥¶Âçï
                if(weeklySpending > 0) {
                    store.weeklyBills.unshift({
                        weekStart: store.lastWeeklyReset || thisMonday,
                        weekEnd: thisMonday,
                        totalSpent: weeklySpending,
                        purchases: unlimitedPurchases,
                        timestamp: Date.now()
                    });
                }

                // Ê∏ÖÈô§unlimitedÁ±ªÂûãÂïÜÂìÅÁöÑË¥≠‰π∞ËÆ∞ÂΩï(‰ΩÜ‰øùÁïôcooldown)
                const lastWeekStart = new Date(store.lastWeeklyReset || 0);
                store.redemptions = store.redemptions.filter(r => {
                    const item = store.shopItems.find(si => si.name === r.name || r.name.includes(si.name));
                    const purchaseDate = new Date(r.date);
                    // ‰øùÁïôcooldownÁ±ªÂûãÊàñÊú¨Âë®ÁöÑË¥≠‰π∞ËÆ∞ÂΩï
                    return (item && item.type === 'cooldown') || purchaseDate >= new Date(thisMonday);
                });

                store.lastWeeklyReset = thisMonday;
                saveData();
            }
        }

        function updateBalanceUI() {
            const el = document.getElementById('balance-display');
            if(el) {
                const bal = Number(store.balance) || 0;
                el.innerText = bal;
                // visual feedback
                el.style.transform = "scale(1.2)";
                el.style.transition = "transform 0.2s";
                setTimeout(() => el.style.transform = "scale(1)", 200);
            }
        }
        
        // --- Theme System ---
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            store.theme = themeName;
            updateChartColors(themeName);
            saveData();
        }
        
        function updateChartColors(theme) {
            if(!charts.line || !charts.pie) return;
            const isDark = theme === 'silent';
            const textColor = isDark ? '#F6F6F6' : '#4A403A';
            const gridColor = isDark ? '#333' : '#ddd';

            if(charts.line.options.scales.x) {
                charts.line.options.scales.x.ticks.color = textColor;
                charts.line.options.scales.y.ticks.color = textColor;
                charts.line.options.scales.x.grid.color = gridColor;
                charts.line.options.scales.y.grid.color = gridColor;
                charts.line.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
                charts.line.update();
            }
        }

        function switchTab(view) {
            resetUI(); // ÂàáÊç¢Ê†áÁ≠æÊó∂Ê∏ÖÂú∫

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const targetView = document.getElementById('view-'+view);
            if(targetView) targetView.classList.add('active');
            let navId = 'nav-'+view;
            if(view === 'create') navId = 'nav-create-tab';
            const navEl = document.getElementById(navId);
            if(navEl) navEl.classList.add('active');
            
            if(view === 'calendar') { renderCalendar(); renderActiveList(); }
            if(view === 'stats') { renderStats(); }
            if(view === 'focus') { renderFocus(); }
            if(view === 'shop') { renderShop(); }
        }

        // --- Shop & History & Gacha ---
        function renderShop() {
            const grid = document.getElementById('shop-list');
            grid.innerHTML = '';
            store.shopItems.forEach(item => {
                const isCooldown = item.type==='cooldown' && isSameDay(item.lastBuy);
                const canAfford = store.balance >= item.cost;
                const btnState = (canAfford && !isCooldown) ? '' : 'disabled';
                const btnText = isCooldown ? '‰ªäÊó•Â∑≤ÂÖë' : 'ÂÖëÊç¢';
                
                grid.innerHTML += `
                    <div class="shop-item ${isCooldown?'cooldown':''}">
                        <div style="position:absolute;top:5px;right:5px;font-size:1.2rem;line-height:1;opacity:0.5;cursor:pointer;" onclick="deleteShopItem(${item.id})">√ó</div>
                        <div class="shop-icon">${item.icon}</div>
                        <div class="shop-desc" style="font-weight:bold;">${item.name}</div>
                        <div class="shop-cost">ü™ô ${item.cost}</div>
                        <button class="btn" style="margin-top:8px; padding:6px; font-size:0.8rem;" ${btnState} onclick="buyItem(${item.id})">${btnText}</button>
                    </div>
                `;
            });
        }
        function isSameDay(ts) {
            if(!ts) return false;
            const d1 = new Date(ts), d2 = new Date();
            return d1.getDate()===d2.getDate() && d1.getMonth()===d2.getMonth() && d1.getFullYear()===d2.getFullYear();
        }
        function buyItem(id) {
            const item = store.shopItems.find(x=>x.id===id);
            if(!item || store.balance < item.cost) return;
            if(confirm(`Ëä±Ë¥π ${item.cost} ÁßØÂàÜÂÖëÊç¢ [${item.name}] ?`)) {
                store.balance -= item.cost;
                if(item.type === 'cooldown') item.lastBuy = Date.now();
                store.redemptions.unshift({
                    id: Date.now(), name: item.name, cost: item.cost, date: new Date().toLocaleString('zh-CN', {hour12:false})
                });
                saveData(); renderShop(); alert(`Vesper: ÂÖëÊç¢ÊàêÂäü„ÄÇ‰∫´Âèó‰Ω†ÁöÑ [${item.name}]„ÄÇ`);
            }
        }
        function openHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            // ÊòæÁ§∫Âë®Ë¥¶Âçï
            if(store.weeklyBills && store.weeklyBills.length > 0) {
                list.innerHTML += '<h4 style="margin:15px 0 10px; color:var(--accent); font-size:0.9rem;">üìä Âë®Ë¥¶ÂçïÂ≠òÊ°£</h4>';
                store.weeklyBills.forEach(bill => {
                    let itemsDetail = '';
                    for(let item in bill.purchases) {
                        itemsDetail += `<div style="font-size:0.75rem; opacity:0.7; margin-top:2px;">¬∑ ${item} √ó ${bill.purchases[item]}</div>`;
                    }
                    list.innerHTML += `
                        <div style="background:rgba(0,0,0,0.02); padding:10px; border-radius:8px; margin-bottom:10px; border-left:3px solid var(--accent);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:bold; font-size:0.85rem;">Âë®Êúü: ${bill.weekStart} ~ ${bill.weekEnd}</div>
                                <div style="font-weight:bold; color:var(--accent); font-family:'JetBrains Mono';">-${bill.totalSpent} ü™ô</div>
                            </div>
                            ${itemsDetail}
                        </div>
                    `;
                });
                list.innerHTML += '<h4 style="margin:20px 0 10px; color:var(--text); opacity:0.7; font-size:0.9rem;">üìú Êú¨Âë®Ê∂àË¥πÊµÅÊ∞¥</h4>';
            }

            // ÊòæÁ§∫Êú¨Âë®Ê∂àË¥πËÆ∞ÂΩï
            if(!store.redemptions || store.redemptions.length === 0) {
                list.innerHTML += '<div style="text-align:center; opacity:0.5; margin-top:20px;">ÊöÇÊó†Ê∂àË¥πËÆ∞ÂΩï„ÄÇ</div>';
            } else {
                store.redemptions.forEach(r => {
                    list.innerHTML += `
                        <div class="history-item">
                            <div>
                                <div>${r.name}</div>
                                <div class="history-meta">${r.date}</div>
                            </div>
                            <div class="history-cost">- ${r.cost}</div>
                        </div>
                    `;
                });
            }
            document.getElementById('modal-history').classList.add('active');
        }
        
        function addNewItem() {
            const name = document.getElementById('new-item-name').value;
            const cost = parseInt(document.getElementById('new-item-cost').value);
            if(name && cost) {
                store.shopItems.push({
                    id: Date.now(), name, cost,
                    icon: document.getElementById('new-item-icon').value || 'üéÅ',
                    type: document.getElementById('new-item-type').value
                });
                saveData(); renderShop(); closeModal('modal-add-item');
            }
        }
        function deleteShopItem(id) {
            if(confirm('‰∏ãÊû∂ËØ•ÂïÜÂìÅ?')) { store.shopItems = store.shopItems.filter(x=>x.id!==id); saveData(); renderShop(); }
        }
        function openAddItemModal() { document.getElementById('modal-add-item').classList.add('active'); }
        
        function openGacha(e) {
            if(e.target.classList.contains('gacha-gear')) return; 
            if(store.balance < 100) { alert("Vesper: ‰ΩôÈ¢ù‰∏çË∂≥ (ÈúÄ 100 ü™ô)„ÄÇ"); return; }
            if(store.gachaPool.length === 0) { alert("Vesper: Â•ñÊ±†ÊòØÁ©∫ÁöÑ„ÄÇËØ∑ÁÇπÂáªÈΩøËΩÆÊ∑ªÂä†Â•ñÂä±„ÄÇ"); return; }

            if(confirm('ÊäïÂÖ• 100 ü™ô ÊäΩÂèñÊÉäÂñúÁõ≤Áõí?')) {
                store.balance -= 100; 
                const gift = store.gachaPool[Math.floor(Math.random() * store.gachaPool.length)];
                store.redemptions.unshift({
                    id: Date.now(), name: ` Áõ≤Áõí: ${gift}`, cost: 100, date: new Date().toLocaleString('zh-CN', {hour12:false})
                });
                saveData();
                document.getElementById('gacha-result-text').innerText = gift;
                document.getElementById('modal-gacha-result').classList.add('active');
            }
        }
        function openGachaEditor(e) {
            e.stopPropagation();
            renderGachaPoolList();
            document.getElementById('modal-gacha-editor').classList.add('active');
        }
        function renderGachaPoolList() {
            const list = document.getElementById('gacha-pool-list');
            list.innerHTML = '';
            store.gachaPool.forEach((item, index) => {
                list.innerHTML += `
                    <div class="pool-list-item">
                        <span>${item}</span>
                        <span style="color:#c62828; font-weight:bold; cursor:pointer;" onclick="removeGachaItem(${index})">√ó</span>
                    </div>
                `;
            });
        }
        function addGachaItem() {
            const input = document.getElementById('new-gacha-item');
            const val = input.value.trim();
            if(val) {
                store.gachaPool.push(val);
                input.value = '';
                saveData(); renderGachaPoolList();
            }
        }
        function removeGachaItem(index) {
            store.gachaPool.splice(index, 1);
            saveData(); renderGachaPoolList();
        }

        // --- Bingo & Points ---
        function checkBingo(p) {
            try {
                if (!p || !p.tasks) return;
                const n = p.size || Math.sqrt(p.tasks.length);
                const is = (i) => p.tasks[i] && p.tasks[i].completed;
                let lc = 0;
                
                // Counting Lines
                for(let r=0;r<n;r++) { let row=[]; for(let c=0;c<n;c++) row.push(r*n+c); if(row.every(is)) lc++; }
                for(let c=0;c<n;c++) { let col=[]; for(let r=0;r<n;r++) col.push(r*n+c); if(col.every(is)) lc++; }
                let d1=[]; for(let i=0; i<n; i++) d1.push(i*n+i); if(d1.every(is)) lc++;
                let d2=[]; for(let i=0; i<n; i++) d2.push(i*n+(n-1-i)); if(d2.every(is)) lc++;

                const prevLines = Number(p.lines) || 0;
                
                // Diff Config with Safety
                let diffConfig;
                if (p.customDifficulty && p.customDifficulty.line) {
                    diffConfig = p.customDifficulty;
                } else {
                    const diffKey = (typeof DIFF_CONFIG !== 'undefined' && DIFF_CONFIG[p.difficulty]) ? p.difficulty : 'normal';
                    diffConfig = (typeof DIFF_CONFIG !== 'undefined') ? (DIFF_CONFIG[diffKey] || DIFF_CONFIG['normal']) : {line:10, board:50};
                }

                let earnedPoints = 0;
                let isBoardClear = false;

                // 1. Line Reward
                if(lc > prevLines) {
                    const newLines = lc - prevLines;
                    earnedPoints += newLines * Number(diffConfig.line || 10);
                    p.lines = lc;
                }

                // 2. Board Reward
                const allCompleted = p.tasks.every(t => t.completed);
                if(allCompleted && !p.boardCleared) {
                    earnedPoints += Number(diffConfig.board || 50);
                    p.boardCleared = true;
                    isBoardClear = true;
                }

                if(earnedPoints > 0) {
                    // DIRECTLY ADD POINTS TO BALANCE (Fix for non-updating balance)
                    // We assume that if checkBingo is called, the user deserves the points immediately.
                    store.balance = (Number(store.balance) || 0) + earnedPoints;
                    
                    // Clear pending points to avoid confusion
                    store.pendingPoints = 0;
                    if(typeof pendingPoints !== 'undefined') pendingPoints = 0;
                    
                    saveData(); // This updates the UI immediately via updateBalanceUI()
                    
                    const titleEl = document.querySelector('#modal-points h2');
                    const descEl = document.querySelector('#modal-points p');
                    const ptsEl = document.getElementById('points-earned');
                    const iconEl = document.querySelector('#modal-points .sheet > div:first-child');
                    
                    if (isBoardClear) {
                         if(titleEl) { titleEl.innerText = "PERFECT CLEAR!"; titleEl.style.color = "var(--completed)"; }
                         if(descEl) descEl.innerText = "ÂÆåÁæéÊ∏ÖÁõòÔºÅÊâÄÊúâÁöÑÂä™ÂäõÈÉΩÂÄºÂæó„ÄÇ";
                         if(iconEl) { iconEl.innerText = "üèÜ"; iconEl.style.animation = "spin 1s infinite"; }
                    } else {
                         if(titleEl) { titleEl.innerText = "BINGO!"; titleEl.style.color = "var(--accent)"; }
                         if(descEl) descEl.innerText = `ËøûÁ∫øÊàêÂäüÔºÅ(ÂΩìÂâçÂÖ± ${lc} Á∫ø)`;
                         if(iconEl) { iconEl.innerText = "ü™ô"; iconEl.style.animation = "bounce 1s infinite"; }
                    }
                    
                    if(ptsEl) ptsEl.innerText = earnedPoints;
                    
                    const modal = document.getElementById('modal-points');
                    if(modal) modal.classList.add('active');
                    
                    // Update button to just close the modal
                    const btn = document.querySelector('#modal-points .btn');
                    if(btn) btn.setAttribute('onclick', 'collectPoints()');

                    if(typeof showToast === 'function') showToast(`Á≥ªÁªüÂ•ñÂä±: +${earnedPoints} ü™ô`);
                }
            } catch(e) {
                console.error("Bingo Error", e);
                alert("Bingo Error: " + e.message);
            }
        }
        
        // This function now just closes the modal, as points are already added in checkBingo
        function collectPoints() {
            closeModal('modal-points');
            
            // Restore icon style
            setTimeout(() => {
                const iconEl = document.querySelector('#modal-points .sheet > div:first-child');
                if(iconEl) {
                    iconEl.innerText = "ü™ô";
                    iconEl.style.animation = "bounce 1s infinite";
                }
            }, 300);
        }

        // --- Creation ---
        function setDifficulty(diff, el) {
            selectedDifficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
            el.classList.add('active');

            const customInputs = document.getElementById('custom-difficulty-inputs');
            if(diff === 'custom') {
                customInputs.style.display = 'block';
            } else {
                customInputs.style.display = 'none';
            }
        }
        function createProject() {
            const mode = document.getElementById('inp-mode').value;
            const size = parseInt(document.getElementById('inp-size').value);
            let tasks = document.getElementById('inp-tasks').value.split('\n').filter(t=>t.trim());
            if(tasks.length===0) tasks=['Task 1'];
            while(tasks.length < size*size) tasks.push("Free");
            tasks = tasks.sort(()=>Math.random()-0.5).slice(0, size*size);

            const newProject = {
                id: Date.now(), mode, size,
                theme: document.getElementById('inp-theme').value||'Untitled',
                tag: document.getElementById('inp-tag').value,
                deadline: document.getElementById('inp-date').value,
                difficulty: selectedDifficulty,
                status: 'active', tasks: tasks.map(t=>({text:t, completed:false})),
                lines: 0, journal: '', editCount: 0
            };

            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÈöæÂ∫¶,‰øùÂ≠òËá™ÂÆö‰πâÁßØÂàÜÈÖçÁΩÆ
            if(selectedDifficulty === 'custom') {
                const linePoints = parseInt(document.getElementById('custom-line-points').value) || 15;
                const boardPoints = parseInt(document.getElementById('custom-board-points').value) || 80;
                newProject.customDifficulty = { line: linePoints, board: boardPoints };
            }

            // Â¶ÇÊûúÊòØÂ≠ê‰ªªÂä°,Ê∑ªÂä†Áà∂Á∫ßÂÖ≥ËÅî
            if(window.pendingSubtask) {
                newProject.parentId = window.pendingSubtask.parentId;
                newProject.parentTaskIndex = window.pendingSubtask.taskIndex;

                // Âú®Áà∂‰ªªÂä°‰∏≠ËÆ∞ÂΩïÂ≠ê‰ªªÂä°ID
                const parentProject = store.projects.find(p => p.id === window.pendingSubtask.parentId);
                if(parentProject && parentProject.tasks[window.pendingSubtask.taskIndex]) {
                    parentProject.tasks[window.pendingSubtask.taskIndex].subtaskId = newProject.id;
                }

                window.pendingSubtask = null;
            }

            store.projects.unshift(newProject);
            saveData();
            document.getElementById('inp-theme').value='';
            document.getElementById('inp-tasks').value='';
            selectedDifficulty = 'normal';
            document.getElementById('custom-difficulty-inputs').style.display = 'none';
            switchTab('calendar');
        }

        // --- Calendar & Lists ---
        // --- [Vesper] ÊõøÊç¢ÂéüÊúâÁöÑ getLocalToday ÂáΩÊï∞ ---

        function getLocalToday() {
            const d = new Date();
                  d.setHours(d.getHours() - 2);        
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth()+d); renderCalendar(); }
        function resetToToday() { viewDate = new Date(); renderCalendar(); }
        function renderCalendar() {
            const y=viewDate.getFullYear(), m=viewDate.getMonth();
            document.getElementById('cal-title').innerText = viewDate.toLocaleString('default',{month:'long'});
            document.getElementById('cal-year').innerText = y;
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = ['S','M','T','W','T','F','S'].map(k=>`<div class="weekday">${k}</div>`).join('');
            const fd = new Date(y,m,1).getDay(), dim = new Date(y,m+1,0).getDate(), today = getLocalToday();
            // Ê∑ªÂä†Á©∫ÁôΩÊ†ºÂØπÈΩêÁ¨¨‰∏ÄÂ§©
            for(let i=0; i<fd; i++) {
                grid.innerHTML += `<div class="cal-day"></div>`;
            }
            for(let d=1;d<=dim;d++) {
                const k=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const c = store.dailyStats[k]||0;
                grid.innerHTML += `<div class="cal-day ${k===today?'today':''} ${c>0?'has-data':''}" onclick="openDayDetail('${k}')">${d}</div>`;
            }
        }
        function renderActiveList() {
            const div = document.getElementById('active-list');
            div.innerHTML = '';
            let activeProjects = store.projects.filter(p => p.status === 'active');

            if (activeProjects.length === 0) {
                div.innerHTML = '<div style="text-align:center;opacity:0.6;margin-top:20px;font-size:0.8rem;">[Vesper]: ÊöÇÊó†ËÆ°Âàí„ÄÇÊòØ‰∏ÄÁâáËôöÊó†ÔºåËøòÊòØËìÑÂäøÂæÖÂèëÔºü</div>';
                return;
            }

            // Ê∑∑ÂêàÊòæÁ§∫Ê®°Âºè:ÂÖàÊòæÁ§∫ÊâÄÊúâÁà∂È°πÁõÆ,ÂÜçÂú®ÂÖ∂‰∏ãÁº©ËøõÊòæÁ§∫Â≠êÈ°πÁõÆ
            activeProjects.forEach(p => {
                // Ë∑≥ËøáÊúâÁà∂Á∫ßÁöÑÈ°πÁõÆ,ÂÆÉ‰ª¨‰ºöÂú®Áà∂Á∫ß‰∏ãÈù¢ÊòæÁ§∫
                if(p.parentId) return;
                const total = p.tasks.length;
                const done = p.tasks.filter(t => t.completed).length;
                const progress = Math.round((done / total) * 100);

                let diffColor = '#999';
                let diffLabel = 'NORMAL';
                if(p.difficulty === 'easy') { diffColor = '#66BB6A'; diffLabel = 'EASY'; }
                if(p.difficulty === 'normal') { diffColor = '#5C6BC0'; diffLabel = 'NORMAL'; }
                if(p.difficulty === 'hard') { diffColor = '#AB47BC'; diffLabel = 'HARD'; }
                if(p.difficulty === 'hell') { diffColor = '#EF5350'; diffLabel = 'HELL'; }

                let deadlineHtml = '';
                if(p.mode === 'deadline' && p.deadline) {
                    const daysLeft = Math.ceil((new Date(p.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    const deadlineColor = daysLeft < 3 ? '#EF5350' : daysLeft < 7 ? '#FF9800' : '#66BB6A';
                    deadlineHtml = `<span style="background:${deadlineColor}; color:white; padding:2px 8px; border-radius:4px; font-size:0.65rem; font-weight:bold; margin-left:4px;">‚è∞ ${p.deadline} (${daysLeft}Â§©)</span>`;
                }

                div.innerHTML += `
                    <div class="mini-card" onclick="openProject(${p.id})" style="border-left: 4px solid ${diffColor}; padding: 12px 15px;">
                        <div style="width:100%;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                <div style="font-weight:bold; font-size:0.95rem; color:var(--text);">${p.theme}</div>
                                <div style="font-family:'JetBrains Mono'; font-size:0.9rem; color:var(--accent); font-weight:bold;">
                                    ${done} <span style="opacity:0.5; font-weight:normal; font-size:0.8rem;">/ ${total}</span>
                                </div>
                            </div>
                            <div style="width:100%; height:4px; background:rgba(0,0,0,0.05); border-radius:2px; margin-bottom:10px; overflow:hidden;">
                                <div style="width:${progress}%; height:100%; background:${progress===100 ? 'var(--completed)' : 'var(--accent)'}; transition:width 0.3s ease;"></div>
                            </div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                                <span style="background:rgba(0,0,0,0.05); color:var(--text); padding:2px 8px; border-radius:4px; font-size:0.65rem; border:1px solid rgba(0,0,0,0.1);">
                                    üè∑Ô∏è ${p.tag}
                                </span>
                                <span style="background:${diffColor}; color:white; padding:2px 8px; border-radius:4px; font-size:0.65rem; font-weight:bold; letter-spacing:0.5px;">
                                    ${diffLabel}
                                </span>
                                ${deadlineHtml}
                            </div>
                        </div>
                    </div>
                `;

                // Âú®Áà∂È°πÁõÆ‰∏ãÊòæÁ§∫ÂÖ∂Â≠êÈ°πÁõÆ (Áº©ËøõÊòæÁ§∫)
                const childProjects = activeProjects.filter(cp => cp.parentId === p.id);
                childProjects.forEach(cp => {
                    const childTotal = cp.tasks.length;
                    const childDone = cp.tasks.filter(t => t.completed).length;
                    const childProgress = Math.round((childDone / childTotal) * 100);

                    let childDiffColor = '#999';
                    let childDiffLabel = 'NORMAL';
                    if(cp.difficulty === 'easy') { childDiffColor = '#66BB6A'; childDiffLabel = 'EASY'; }
                    if(cp.difficulty === 'normal') { childDiffColor = '#5C6BC0'; childDiffLabel = 'NORMAL'; }
                    if(cp.difficulty === 'hard') { childDiffColor = '#AB47BC'; childDiffLabel = 'HARD'; }
                    if(cp.difficulty === 'hell') { childDiffColor = '#EF5350'; childDiffLabel = 'HELL'; }
                    if(cp.customDifficulty) { childDiffLabel = 'CUSTOM'; childDiffColor = '#FF9800'; }

                    div.innerHTML += `
                        <div class="mini-card" onclick="openProject(${cp.id})" style="border-left: 3px solid ${childDiffColor}; padding: 10px 12px; margin-left:20px; margin-bottom:8px; opacity:0.9;">
                            <div style="width:100%;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <div style="font-weight:bold; font-size:0.85rem; color:var(--text);">‚Ü≥ ${cp.theme}</div>
                                    <div style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--accent); font-weight:bold;">
                                        ${childDone} <span style="opacity:0.5; font-weight:normal; font-size:0.75rem;">/ ${childTotal}</span>
                                    </div>
                                </div>
                                <div style="width:100%; height:3px; background:rgba(0,0,0,0.05); border-radius:2px; margin-bottom:8px; overflow:hidden;">
                                    <div style="width:${childProgress}%; height:100%; background:${childProgress===100 ? 'var(--completed)' : 'var(--accent)'}; transition:width 0.3s ease;"></div>
                                </div>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <span style="background:rgba(0,0,0,0.05); color:var(--text); padding:1px 6px; border-radius:3px; font-size:0.6rem; border:1px solid rgba(0,0,0,0.1);">
                                        üè∑Ô∏è ${cp.tag}
                                    </span>
                                    <span style="background:${childDiffColor}; color:white; padding:1px 6px; border-radius:3px; font-size:0.6rem; font-weight:bold;">
                                        ${childDiffLabel}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }
        function openProject(pid) {
            currentPid = pid; const p = store.projects.find(x=>x.id===pid); if(!p) return;
            isEditMode = false; updateEditBtnState(p);
            document.getElementById('game-title').innerText=p.theme;
            document.getElementById('game-badge').innerText=p.difficulty ? p.difficulty.toUpperCase() : 'NORMAL';

            // ÊòæÁ§∫Êà™Ê≠¢Êó∂Èó¥
            const deadlineEl = document.getElementById('game-deadline');
            if(p.mode === 'deadline' && p.deadline) {
                const daysLeft = Math.ceil((new Date(p.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                deadlineEl.style.display = 'block';
                deadlineEl.innerText = `‚è∞ Êà™Ê≠¢Êó∂Èó¥: ${p.deadline} (Ââ©‰Ωô ${daysLeft} Â§©)`;
            } else {
                deadlineEl.style.display = 'none';
            }

            const journalArea = document.getElementById('journal-area');
            const summaryArea = document.getElementById('summary-area');
            const archiveActionsArea = document.getElementById('archive-actions-area');

            // ÊâÄÊúâÁä∂ÊÄÅÈÉΩÊòæÁ§∫ÈöèÁ¨îÊ°ÜÔºàÊ¥ªË∑ÉÂíåÂΩíÊ°£Ôºâ
            journalArea.style.display = 'block';
            document.getElementById('inp-journal').value = p.journal || '';

            if(p.status === 'archived') {
                // ÂΩíÊ°£Âç°È¢ùÂ§ñÊòæÁ§∫ÊÄªÁªìÊ°Ü
                summaryArea.style.display = 'block';
                document.getElementById('inp-summary').value = p.summary || '';

                // ÊòæÁ§∫ÂΩíÊ°£ÂäüËÉΩÂå∫
                archiveActionsArea.style.display = 'block';
                // ÈáçÁΩÆËØÑËØ≠ÊòæÁ§∫
                document.getElementById('archive-review-display').style.display = 'none';
                document.getElementById('archive-review-text').innerText = '';
                document.getElementById('btn-share-to-chat').style.display = 'none';
                currentArchiveComment = null;
            } else {
                // Ê¥ªË∑ÉÂç°ÔºöÂè™ÈöêËóèÊÄªÁªìÊ°ÜÂíåÂΩíÊ°£ÂäüËÉΩÂå∫Ôºå‰øùÁïôÈöèÁ¨îÊ°Ü
                summaryArea.style.display = 'none';
                archiveActionsArea.style.display = 'none';
            }

            renderBingoBoard(p);
            updateVesperMsg(p);
            switchTab('game');
        }

        function updateVesperMsg(p) {
            const el = document.getElementById('vesper-msg');
            const total = p.tasks.length;
            const done = p.tasks.filter(t=>t.completed).length;
            const ratio = done/total;
            let pool = [];

            if(done === 0) pool = VESPER_QUOTES.empty;
            else if(ratio === 1) pool = VESPER_QUOTES.complete;
            else if(ratio > 0.8) pool = VESPER_QUOTES.almost;
            else if(p.difficulty === 'hell') pool = VESPER_QUOTES.hell;
            else pool = VESPER_QUOTES.progress;

            el.innerText = pool[Math.floor(Math.random() * pool.length)];
        }

        function renderBingoBoard(p) {
            const board = document.getElementById('bingo-board');
            board.style.gridTemplateColumns = `repeat(${p.size}, 1fr)`;
            board.innerHTML='';
            p.tasks.forEach((t,i)=>{
                const cell = document.createElement('div');
                cell.className=`cell ${t.completed?'completed':''} ${isEditMode && !t.completed ? 'editing' : ''}`;

                // Â¶ÇÊûúËØ•‰ªªÂä°ÊúâÂ≠êÈ°πÁõÆ,ÊòæÁ§∫ÁâπÊÆäÊ†áËÆ∞
                let displayText = t.text;
                if(t.subtaskId) {
                    const subtask = store.projects.find(sp => sp.id === t.subtaskId);
                    if(subtask) {
                        displayText = t.text + ' ‚úì';
                    }
                }
                cell.innerText = displayText;

                // ÈïøÊåâ‰∫ã‰ª∂
                cell.addEventListener('touchstart', (e) => {
                    if(p.status !== 'active' || isEditMode) return;
                    longPressTimer = setTimeout(() => {
                        if(navigator.vibrate) navigator.vibrate(50);
                        longPressTarget = {pid: p.id, taskIndex: i, taskText: t.text};
                        document.getElementById('subtask-title').innerText = t.text;
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂ≠êÈ°πÁõÆ
                        const btnOpenSubtask = document.getElementById('btn-open-subtask');
                        if(t.subtaskId) {
                            btnOpenSubtask.style.display = 'block';
                        } else {
                            btnOpenSubtask.style.display = 'none';
                        }
                        document.getElementById('modal-subtask-menu').classList.add('active');
                    }, 600);
                });

                cell.addEventListener('touchend', () => {
                    if(longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });

                cell.addEventListener('touchmove', () => {
                    if(longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });

                // Áü≠Êåâ‰∫ã‰ª∂ (ÂéüÊúâÈÄªËæë)
                cell.onclick=()=>{
                    if(p.status!=='active'||t.completed) return;
                    if(isEditMode) {
                        tempTask = {pid: p.id, i: i}; document.getElementById('inp-edit-task').value=t.text; document.getElementById('modal-edit-task').classList.add('active');
                    } else {
                        tempTask={pid:p.id,i,tag:p.tag}; document.getElementById('timer-title').innerText=t.text; document.getElementById('modal-timer').classList.add('active');
                    }
                };
                board.appendChild(cell);
            });
        }
        
        // --- Utils & Focus ---
        function toggleEditMode() {
            const p = store.projects.find(x=>x.id===currentPid);
            if(!p || p.editCount >= 2 && !isEditMode) { alert("‰øÆÊîπÊ¨°Êï∞Â∑≤ËÄóÂ∞Ω"); return; }
            isEditMode = !isEditMode; updateEditBtnState(p); renderBingoBoard(p);
        }
        function updateEditBtnState(p) { 
            const btn = document.getElementById('btn-edit-mode');
            if(p.status === 'archived') { btn.style.display='none'; } 
            else { btn.style.display='block'; btn.innerText = isEditMode ? 'ÈÄÄÂá∫' : `‚úé ‰øÆÊîπ (${2-(p.editCount||0)})`; }
        }
        function confirmTaskEdit() { 
            const p = store.projects.find(x=>x.id===tempTask.pid); 
            p.tasks[tempTask.i].text = document.getElementById('inp-edit-task').value; 
            p.editCount=(p.editCount||0)+1; saveData(); renderBingoBoard(p); closeModal('modal-edit-task'); 
        }
        let isFullscreenTimer = false;

        function startTimer(m) {
            if(m===0) { completeTask(); return; }

            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÊòæÁ§∫ÂÖ®Â±èÁï™ËåÑÈíü
            closeModal('modal-timer');
            enterFullscreenTimer(m);
        }

        function enterFullscreenTimer(m) {
            isFullscreenTimer = true;

            // ÊòæÁ§∫ÂÖ®Â±èÂÆπÂô®
            const fullscreenEl = document.getElementById('fullscreen-timer');
            fullscreenEl.style.display = 'flex';

            // ËÆæÁΩÆÊ†áÈ¢ò
            const titleEl = document.getElementById('fullscreen-timer-title');
            const modalTitle = document.getElementById('timer-title').innerText;
            titleEl.innerText = modalTitle;

            // ËÆæÁΩÆÈöèÊú∫ÊøÄÂä±ËØ≠
            const motivations = [
                '"‰∏ìÊ≥®ÊòØÈÄöÂæÄÂçìË∂äÁöÑÂîØ‰∏ÄÈÅìË∑Ø"',
                '"ÊØè‰∏ÄÊ¨°‰∏ìÊ≥®,ÈÉΩÊòØÂú®ÊäïËµÑÊú™Êù•ÁöÑËá™Â∑±"',
                '"Áï™ËåÑÈíüÊª¥Á≠î,Ê¢¶ÊÉ≥Âú®ÁîüÈïø"',
                '"‰øùÊåÅ‰∏ìÊ≥®,ËÆ©Êó∂Èó¥‰∏∫‰Ω†Â∑•‰Ωú"',
                '"Ê≠§ÂàªÁöÑÂä™Âäõ,ÊòØÊòéÊó•ÁöÑÂõûÊä•"',
                '"Ê∑±Â∫¶Â∑•‰Ωú,ÊµÖÂ±ÇÁîüÊ¥ª"',
                '"‰∏ìÊ≥®ÂΩì‰∏ã,ÊàêÂ∞±ÈùûÂá°"',
                '"Êó∂Èó¥‰ºöËØÅÊòé‰Ω†ÁöÑ‰∏ìÊ≥®"',
                '"‰∏ÄÊ¨°Âè™ÂÅö‰∏Ä‰ª∂‰∫ã"',
                '"Èùô‰∏ãÂøÉÊù•,‰∏ñÁïå‰ºö‰∏∫‰Ω†ËÆ©Ë∑Ø"'
            ];
            const motivationEl = document.getElementById('fullscreen-motivation');
            motivationEl.innerText = motivations[Math.floor(Math.random() * motivations.length)];

            const totalSeconds = m * 60;
            let s = totalSeconds;
            const circumference = 2 * Math.PI * 120; // ÂÖ®Â±èÂúÜÁéØÂçäÂæÑ120
            const progressRing = document.getElementById('fullscreen-progress-ring');
            const timerText = document.getElementById('fullscreen-timer-text');
            const percentageEl = document.getElementById('fullscreen-progress-percentage');
            const systemTimeEl = document.getElementById('fullscreen-system-time');

            if(timerInt) clearInterval(timerInt);

            // Êõ¥Êñ∞Á≥ªÁªüÊó∂Èó¥
            function updateSystemTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                systemTimeEl.innerText = `${hours}:${minutes}:${seconds}`;
            }

            // Êõ¥Êñ∞ÊòæÁ§∫ÂáΩÊï∞
            function updateTimer() {
                const minutes = Math.floor(s / 60);
                const seconds = s % 60;
                const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;

                // Êõ¥Êñ∞ÂÄíËÆ°Êó∂ÊñáÊú¨
                timerText.innerText = timeStr;

                // Êõ¥Êñ∞ÊµèËßàÂô®Ê†áÈ¢ò
                document.title = `‚è±Ô∏è ${timeStr} - Tarabingo`;

                // Êõ¥Êñ∞SVGÂúÜÁéØ (ÈÄÜÊó∂ÈíàÂáèÂ∞ë)
                const progress = s / totalSeconds;
                const offset = circumference * (1 - progress);
                progressRing.style.strokeDashoffset = offset;

                // Êõ¥Êñ∞ÁôæÂàÜÊØî
                const percentage = Math.round((s / totalSeconds) * 100);
                percentageEl.innerText = `${percentage}%`;

                // Êõ¥Êñ∞Á≥ªÁªüÊó∂Èó¥
                updateSystemTime();
            }

            // ÂàùÂßãÂåñÊòæÁ§∫
            updateTimer();

            // ÂºÄÂßãÂÄíËÆ°Êó∂
            timerInt = setInterval(() => {
                s--;
                updateTimer();

                if(s <= 0) {
                    clearInterval(timerInt);
                    document.title = 'Tarabingo';
                    exitFullscreenTimer();
                    completeTask();
                }
            }, 1000);
        }

        function exitFullscreenTimer() {
            isFullscreenTimer = false;
            document.getElementById('fullscreen-timer').style.display = 'none';

            if(timerInt) {
                clearInterval(timerInt);
                document.title = 'Tarabingo';
            }
        }

        function showCustomTimer() {
            document.getElementById('custom-timer-input').style.display='block';
            document.getElementById('timer-display').style.display='none';
        }

        function startCustomTimer() {
            const minutes = parseInt(document.getElementById('custom-minutes').value);
            if(minutes < 1 || minutes > 120) {
                alert('ËØ∑ËæìÂÖ•1-120‰πãÈó¥ÁöÑÂàÜÈíüÊï∞');
                return;
            }
            startTimer(minutes);
        }
        function completeTask() {
            clearInterval(timerInt); closeModal('modal-timer');
            const p = store.projects.find(x=>x.id===tempTask.pid);
            p.tasks[tempTask.i].completed=true;
            const today=getLocalToday(); store.dailyStats[today]=(store.dailyStats[today]||0)+1;
            store.logs.push({date:today, tag:tempTask.tag, text:p.tasks[tempTask.i].text, pid:p.id});
            checkBingo(p); saveData(); openProject(p.id);
        }
        function saveJournal() {
            const txt = document.getElementById('inp-journal').value;
            const p = store.projects.find(x=>x.id===currentPid);
            if(p) {
                p.journal = txt;
                saveData();
                showToast("ÈöèÁ¨îÂ∑≤‰øùÂ≠ò");
            }
        }

        function saveSummary() {
            const txt = document.getElementById('inp-summary').value;
            const p = store.projects.find(x=>x.id===currentPid);
            if(p) {
                p.summary = txt;
                saveData();
                showToast("ÊÄªÁªìÂ∑≤‰øùÂ≠ò");
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');

            // ÈáçÁΩÆÁï™ËåÑÈíü
            if(id === 'modal-timer') {
                if(timerInt) clearInterval(timerInt);
                document.title = 'Tarabingo'; // ÊÅ¢Â§çÊ†áÈ¢ò
                document.getElementById('timer-display').style.display = 'none';
                document.getElementById('custom-timer-input').style.display = 'none';
            }

            // ÈáçÁΩÆ AI Êä•ÂëäÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
            if(id === 'modal-ai-report') {
                document.getElementById('ai-report-loading').style.display = 'block';
                document.getElementById('ai-report-loading').innerHTML = `
                    <div class="spinner"></div>
                    <p style="font-size:0.9rem; color:var(--text); opacity:0.8;">Vesper Ê≠£Âú®ÂàÜÊûê‰Ω†ÁöÑÊï∞ÊçÆ...</p>
                    <p style="font-size:0.75rem; color:var(--text); opacity:0.5; margin-top:10px;">"ËÆ©ÊàëÁúãÁúã‰Ω†ËøôÂë®ÈÉΩÂπ≤‰∫Ü‰ªÄ‰πà..."</p>
                `;
                document.getElementById('ai-report-card-area').style.display = 'none';
                document.getElementById('ai-report-actions').style.display = 'none';
            }
        }
        function renderFocus() {
            const list = document.getElementById('focus-list'); 
            const filterDiv = document.getElementById('focus-filter');
            list.innerHTML=''; filterDiv.innerHTML='';
            const activeProjects = store.projects.filter(p=>p.status==='active');
            
            if(activeProjects.length === 0) { list.innerHTML='<div style="text-align:center;opacity:0.6;margin-top:20px;">Êó†Ê¥ªË∑ÉËÆ°Âàí</div>'; return; }

            activeProjects.forEach(p => {
                const isSel = selectedFocusPids.has(p.id);
                filterDiv.innerHTML += `<div class="filter-chip ${isSel?'active':''}" onclick="toggleFocus(${p.id})">${p.theme}</div>`;
                if(selectedFocusPids.size===0 || isSel) {
                    p.tasks.forEach((t,i)=>{ if(!t.completed) list.innerHTML+=`<div class="mini-card focus-item" data-pid="${p.id}" onclick="tempTask={pid:${p.id},i:${i},tag:'${p.tag}'};document.getElementById('timer-title').innerText='${t.text}';document.getElementById('modal-timer').classList.add('active');"><div><strong>${t.text}</strong><br><small>${p.theme}</small></div></div>`; });
                }
            });
        }
        function toggleFocus(pid) { selectedFocusPids.has(pid)?selectedFocusPids.delete(pid):selectedFocusPids.add(pid); renderFocus(); }
        function rollDice() { const all=document.querySelectorAll('.focus-item'); if(all.length){all.forEach(e=>e.style.backgroundColor='var(--card-bg)');const t=all[Math.floor(Math.random()*all.length)];t.style.backgroundColor='var(--highlight)';t.scrollIntoView({behavior:'smooth',block:'center'});}}
        function toggleDeadline(v) { document.getElementById('grp-date').style.display = v==='deadline'?'block':'none'; }
        function archiveCurrent() {
            const p = store.projects.find(x => x.id === currentPid);
            if(!p) return;
            if(p.mode === 'daily') {
                alert('Vesper: ÊØèÊó•Âæ™ÁéØ‰ªªÂä°‰∏çÂèØÂΩíÊ°£,Âè™ËÉΩÂà†Èô§„ÄÇ');
                return;
            }
            if(confirm('ÂΩíÊ°£Ê≠§È°πÁõÆ?')) {
                p.status = 'archived';
                p.archivedAt = Date.now();
                saveData();
                switchTab('archive');
            }
        }
        function deleteCurrent() {
            const p = store.projects.find(x => x.id === currentPid);
            if(!p) return;

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠êÈ°πÁõÆ
            const childProjects = store.projects.filter(cp => cp.parentId === currentPid);
            if(childProjects.length > 0) {
                const cascade = confirm('Ê£ÄÊµãÂà∞ËØ•È°πÁõÆÊúâ ' + childProjects.length + ' ‰∏™Â≠êÈ°πÁõÆ„ÄÇ\n\nÊòØÂê¶Á∫ßËÅîÂà†Èô§ÊâÄÊúâÂ≠êÈ°πÁõÆ?\n\nÁÇπÂáª"Á°ÆÂÆö"Á∫ßËÅîÂà†Èô§,ÁÇπÂáª"ÂèñÊ∂à"‰øùÁïôÂ≠êÈ°πÁõÆ‰∏∫Áã¨Á´ãÂç°Áâá„ÄÇ');
                if(cascade) {
                    // Á∫ßËÅîÂà†Èô§ÊâÄÊúâÂ≠êÈ°πÁõÆ
                    store.projects = store.projects.filter(x => x.id !== currentPid && x.parentId !== currentPid);
                } else {
                    // ‰øùÁïôÂ≠êÈ°πÁõÆ,ÁßªÈô§Áà∂Á∫ßÂÖ≥ËÅî
                    childProjects.forEach(cp => {
                        delete cp.parentId;
                        delete cp.parentTaskIndex;
                    });
                    store.projects = store.projects.filter(x => x.id !== currentPid);
                }
            } else {
                if(confirm('Âà†Èô§Ê≠§È°πÁõÆ?')) {
                    store.projects = store.projects.filter(x => x.id !== currentPid);
                }
            }
            saveData();
            switchTab('calendar');
        }

        // Â≠ê‰ªªÂä°ÂäüËÉΩ
        function createSubtask() {
            if(!longPressTarget) return;
            closeModal('modal-subtask-menu');

            // Â∞Ü‰ªªÂä°Ê†áÈ¢òÈ¢ÑÂ°´Âà∞ÂàõÂª∫È°µÈù¢
            document.getElementById('inp-theme').value = longPressTarget.taskText;

            // ËÆ∞ÂΩïÁà∂È°πÁõÆ‰ø°ÊÅØ,Á≠âÂæÖcreateProjectÊó∂‰ΩøÁî®
            window.pendingSubtask = {
                parentId: longPressTarget.pid,
                taskIndex: longPressTarget.taskIndex,
                taskText: longPressTarget.taskText
            };

            switchTab('create');
        }

        function openSubtask() {
            if(!longPressTarget) return;
            const parentProject = store.projects.find(p => p.id === longPressTarget.pid);
            if(!parentProject) return;

            const task = parentProject.tasks[longPressTarget.taskIndex];
            if(task && task.subtaskId) {
                closeModal('modal-subtask-menu');
                openProject(task.subtaskId);
            }
        }
        
        // --- Stats & Refresh ---
        function manualRefresh() {
            const btn = document.getElementById('btn-refresh');
            if(btn) {
                const icon = btn.querySelector('span');
                if(icon) icon.classList.add('rotate-anim');
                document.getElementById('vesper-report').innerText = ">> VESPER_SYS: Ê≠£Âú®ÂêåÊ≠•Á•ûÁªèÈìæÊé•...";
                setTimeout(() => { renderStats(); if(icon) icon.classList.remove('rotate-anim'); }, 500);
            } else { renderStats(); }
        }

        function renderStats() { 
            renderArchive();
            const today = getLocalToday();
            let msg = (store.dailyStats[today]||0) > 0 ? "ÁßØÂàÜÊ≠£Âú®‰∏äÊ∂®„ÄÇ" : "‰Ω†ÁöÑË¥¶Êà∑ÈúÄË¶ÅÊµÅÂä®ÊÄß„ÄÇ";
            document.getElementById('vesper-report').innerText = `>> VESPER_LOG:\n${msg}`;
            
            const heatGrid = document.getElementById('heatmap-body'); heatGrid.innerHTML = '';
            for(let i=19; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i); const k = d.toISOString().split('T')[0];
                const c = store.dailyStats[k] || 0; heatGrid.innerHTML += `<div class="heat-cell ${c>0?'heat-l1':''} ${c>2?'heat-l2':''} ${c>5?'heat-l3':''}" title="${k}: ${c}"></div>`;
            }

            if(document.getElementById('chart-line')) {
                const labels = [], dataLine = [];
                for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); labels.push(d.getDate()+'Êó•'); dataLine.push(store.dailyStats[d.toISOString().split('T')[0]]||0); }
                if(charts.line) charts.line.destroy();
                charts.line = new Chart(document.getElementById('chart-line').getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: 'Tasks', data: dataLine, borderColor: '#8B5A2B', tension: 0.4 }] }, options: { maintainAspectRatio:false } });
                
                const tags = { 'Â≠¶‰π†':0, 'ÁîüÊ¥ª':0, 'Â®±‰πê':0, 'ÂàõÈÄ†':0 }; store.logs.forEach(l=>{if(tags[l.tag]!==undefined)tags[l.tag]++});
                if(charts.pie) charts.pie.destroy();
                charts.pie = new Chart(document.getElementById('chart-pie').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(tags), datasets: [{ data: Object.values(tags), backgroundColor: ['#7B68EE', '#6B8E23', '#D2691E', '#C71585'] }] }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right'}} } });

                updateChartColors(store.theme || 'default');
            }
        }
        function filterArchive(filter, el) {
            // ÁßªÈô§emojiÂâçÁºÄÔºåÂè™‰øùÁïôÂàÜÁ±ªÂêçÁß∞
            archiveFilter = filter.replace(/^[^\u4e00-\u9fa5a-zA-Z]+\s*/, '').trim();
            document.querySelectorAll('#view-archive .filter-chip').forEach(c => c.classList.remove('active'));
            if(el) el.classList.add('active');
            renderArchive();
        }

        function renderArchive() {
            // Ê∏≤ÊüìÂë®Êä•Ê°£Ê°à
            renderReportArchivePreview();

            // Ê∏≤ÊüìÈ°πÁõÆÊ°£Ê°à
            const div = document.getElementById('archive-list');
            div.innerHTML = '';

            let archivedProjects = store.projects.filter(p => p.status === 'archived');
            if(archiveFilter !== 'all') {
                archivedProjects = archivedProjects.filter(p => p.tag === archiveFilter);
            }

            if(archivedProjects.length === 0) {
                div.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:20px; font-size:0.85rem;">ÊöÇÊó†ÂΩíÊ°£È°πÁõÆ</div>';
                return;
            }

            archivedProjects.forEach(p => {
                // Ë∑≥ËøáÊúâÁà∂Á∫ßÁöÑÈ°πÁõÆ,ÂÆÉ‰ª¨‰ºöÂú®Áà∂Á∫ß‰∏ãÈù¢ÊòæÁ§∫
                if(p.parentId) return;
                let diffColor = '#999';
                let diffLabel = 'NORMAL';
                if(p.difficulty === 'easy') { diffColor = '#66BB6A'; diffLabel = 'EASY'; }
                if(p.difficulty === 'normal') { diffColor = '#5C6BC0'; diffLabel = 'NORMAL'; }
                if(p.difficulty === 'hard') { diffColor = '#AB47BC'; diffLabel = 'HARD'; }
                if(p.difficulty === 'hell') { diffColor = '#EF5350'; diffLabel = 'HELL'; }
                if(p.customDifficulty) { diffLabel = 'CUSTOM'; diffColor = '#FF9800'; }

                const archiveDate = p.archivedAt ? new Date(p.archivedAt).toLocaleDateString('zh-CN') : 'Êú™Áü•';

                div.innerHTML += `
                    <div class="mini-card" onclick="openProject(${p.id})" style="opacity:0.85; border-left:4px solid ${diffColor}; padding:12px 15px;">
                        <div style="width:100%;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                <div style="font-weight:bold; font-size:0.9rem; color:var(--text);">${p.theme}</div>
                                <div style="font-size:1.2rem;">üìú</div>
                            </div>
                            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; font-size:0.7rem;">
                                <span style="background:rgba(0,0,0,0.05); color:var(--text); padding:2px 8px; border-radius:4px; border:1px solid rgba(0,0,0,0.1);">
                                    üè∑Ô∏è ${p.tag}
                                </span>
                                <span style="background:${diffColor}; color:white; padding:2px 8px; border-radius:4px; font-weight:bold;">
                                    ${diffLabel}
                                </span>
                                <span style="opacity:0.6; font-size:0.65rem;">
                                    ÂΩíÊ°£‰∫é: ${archiveDate}
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                // Âú®Áà∂È°πÁõÆ‰∏ãÊòæÁ§∫ÂÖ∂Â≠êÈ°πÁõÆ (Áº©ËøõÊòæÁ§∫)
                let childProjects = store.projects.filter(cp => cp.status === 'archived' && cp.parentId === p.id);
                // Â¶ÇÊûúÊúâÂàÜÁ±ªËøáÊª§,Â≠êÈ°πÁõÆ‰πüË¶ÅÁ¨¶ÂêàÂàÜÁ±ª
                if(archiveFilter !== 'all') {
                    childProjects = childProjects.filter(cp => cp.tag === archiveFilter);
                }
                childProjects.forEach(cp => {
                    let childDiffColor = '#999';
                    let childDiffLabel = 'NORMAL';
                    if(cp.difficulty === 'easy') { childDiffColor = '#66BB6A'; childDiffLabel = 'EASY'; }
                    if(cp.difficulty === 'normal') { childDiffColor = '#5C6BC0'; childDiffLabel = 'NORMAL'; }
                    if(cp.difficulty === 'hard') { childDiffColor = '#AB47BC'; childDiffLabel = 'HARD'; }
                    if(cp.difficulty === 'hell') { childDiffColor = '#EF5350'; childDiffLabel = 'HELL'; }
                    if(cp.customDifficulty) { childDiffLabel = 'CUSTOM'; childDiffColor = '#FF9800'; }

                    const childArchiveDate = cp.archivedAt ? new Date(cp.archivedAt).toLocaleDateString('zh-CN') : 'Êú™Áü•';

                    div.innerHTML += `
                        <div class="mini-card" onclick="openProject(${cp.id})" style="opacity:0.75; border-left:3px solid ${childDiffColor}; padding:10px 12px; margin-left:25px; margin-bottom:8px;">
                            <div style="width:100%;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <div style="font-weight:bold; font-size:0.85rem; color:var(--text);">‚Ü≥ ${cp.theme}</div>
                                    <div style="font-size:1rem;">üìú</div>
                                </div>
                                <div style="display:flex; gap:5px; align-items:center; flex-wrap:wrap; font-size:0.65rem;">
                                    <span style="background:rgba(0,0,0,0.05); color:var(--text); padding:1px 6px; border-radius:3px; border:1px solid rgba(0,0,0,0.1);">
                                        üè∑Ô∏è ${cp.tag}
                                    </span>
                                    <span style="background:${childDiffColor}; color:white; padding:1px 6px; border-radius:3px; font-weight:bold;">
                                        ${childDiffLabel}
                                    </span>
                                    <span style="opacity:0.6; font-size:0.6rem;">
                                        ÂΩíÊ°£‰∫é: ${childArchiveDate}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- Report Generation Logic ---
        function generateWeeklyReport() {
            const today = new Date();
            let total = 0;
            const tagCounts = {};
            const activeDays = new Set();
            
            store.logs.forEach(l => {
                const d = new Date(l.date);
                const diffTime = Math.abs(today - d);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if(diffDays <= 7) {
                    total++;
                    tagCounts[l.tag] = (tagCounts[l.tag] || 0) + 1;
                    activeDays.add(l.date);
                }
            });

            let maxTag = 'Êó†';
            let maxVal = 0;
            for(let t in tagCounts) {
                if(tagCounts[t] > maxVal) { maxVal = tagCounts[t]; maxTag = t; }
            }

            let quote = "";
            if (total === 0) {
                quote = "Ê£ÄÊµãÂà∞Èõ∂Ê¥ªÂä®„ÄÇËøôÂë®‰Ω†ÊòØÂú®‰ºëÁú†Ëà±ÈáåÂ∫¶ËøáÁöÑÂêóÔºü‰∏ãÂë®Âä®Ëµ∑Êù•„ÄÇ";
            } else if (total < 10) {
                quote = "ÁîüÂ≠òÁª¥ÊåÅÊ®°Âºè„ÄÇ‰Ω†ËøòÂú®ÂëºÂê∏ÔºåËøôÂæàÂ•ΩÔºå‰ΩÜ‰Ω†ÁöÑÊΩúËÉΩËøú‰∏çÊ≠¢‰∫éÊ≠§„ÄÇ";
            } else if (maxTag === 'Â®±‰πê') {
                quote = "Â§öÂ∑¥ËÉ∫ÊëÑÂÖ•ËøáÈáèË≠¶Âëä„ÄÇÂø´‰πêÂæàÈáçË¶ÅÔºå‰ΩÜÂà´ËÆ©Ëá™Â∑±Ê∑πÊ≤°Âú®Âªâ‰ª∑ÁöÑÂà∫ÊøÄÈáå„ÄÇ";
            } else if (maxTag === 'Â≠¶‰π†' || maxTag === 'ÂàõÈÄ†') {
                quote = "Êï∞ÊçÆÊµÅÂæàÊºÇ‰∫Æ„ÄÇËøô‰∏ÄÂë®Ôºå‰Ω†Á°ÆÂÆûÂú®Â°ëÈÄ†‰∫õ‰ªÄ‰πà„ÄÇÁªßÁª≠‰øùÊåÅËøôÁßçÈîãÂà©„ÄÇ";
            } else {
                quote = "Á®≥ÂÆöÁöÑËæìÂá∫„ÄÇ‰Ω†Ê≠£Âú®ÊûÑÂª∫Áß©Â∫èÔºåÊàëÂØπÊ≠§Ë°®Á§∫ËµûËÆ∏„ÄÇ";
            }

            const report = `>> VESPER Âë®ÊúüÊÄßÂàÜÊûêÊä•Âëä
----------------------------
[Êó∂Èó¥Á™ó]: ËøáÂéª 7 Â§©
[ÊÄª‰∫§‰∫í]: ${total} Ê¨°Êìç‰Ωú
[Ê¥ªË∑ÉÂ∫¶]: ${activeDays.size} / 7 Â§©
[Ê†∏ÂøÉÈ©±Âä®]: ${maxTag} (${maxVal})

[Vesper ËØÑËØ≠]:
${quote}

----------------------------
*Ê≠§Êä•ÂëäÂ∑≤Â≠òÂÖ•‰∏¥Êó∂ÁºìÂ≠ò„ÄÇ*`;
            
            document.getElementById('report-text').innerText = report;
            document.getElementById('modal-report').classList.add('active');
        }

        // --- [Vesper] AI Âë®Êä•ÂäüËÉΩ ---
        let currentAIReport = null; // ÊöÇÂ≠òÂΩìÂâçÁîüÊàêÁöÑÂë®Êä•
        let viewingArchivedReportId = null; // Êü•Áúã‰∏≠ÁöÑÂ≠òÊ°£Âë®Êä•ID

        // Step 1: Êï∞ÊçÆËÅöÂêàÂáΩÊï∞
        function gatherWeeklyData() {
            const today = new Date();
            const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            let totalCompleted = 0;
            let totalCreated = 0;
            const tagCounts = {};
            const activeDays = new Set();
            const hourDistribution = {};
            let pointsEarned = 0;
            let pointsSpent = 0;
            const taskTexts = [];

            // ÂàÜÊûê logs (ÂÆåÊàêËÆ∞ÂΩï)
            store.logs.forEach(l => {
                const d = new Date(l.date);
                if(d >= sevenDaysAgo && d <= today) {
                    totalCompleted++;
                    tagCounts[l.tag] = (tagCounts[l.tag] || 0) + 1;
                    activeDays.add(l.date);
                    if(l.text) taskTexts.push(l.text);

                    // Êó∂Èó¥ÂàÜÂ∏ÉÂàÜÊûê
                    if(l.time) {
                        const hour = parseInt(l.time.split(':')[0]);
                        const period = hour < 6 ? 'Ê∑±Â§ú (0-6ÁÇπ)' :
                                      hour < 12 ? '‰∏äÂçà (6-12ÁÇπ)' :
                                      hour < 18 ? '‰∏ãÂçà (12-18ÁÇπ)' : 'ÊôöÈó¥ (18-24ÁÇπ)';
                        hourDistribution[period] = (hourDistribution[period] || 0) + 1;
                    }
                }
            });

            // ÂàÜÊûê dailyStats
            for(let dateKey in store.dailyStats) {
                const d = new Date(dateKey);
                if(d >= sevenDaysAgo && d <= today) {
                    const count = store.dailyStats[dateKey];
                    if(count > 0) totalCreated += Math.ceil(count * 1.2); // È¢Ñ‰º∞ÂàõÂª∫Êï∞
                }
            }

            // ÂàÜÊûê weeklyBills (ÁßØÂàÜÊî∂ÊîØ)
            store.weeklyBills.forEach(b => {
                const d = new Date(b.date);
                if(d >= sevenDaysAgo && d <= today) {
                    if(b.type === 'earn') pointsEarned += b.amount;
                    else if(b.type === 'spend') pointsSpent += Math.abs(b.amount);
                }
            });

            // ÂàÜÊûê redemptions (ÂïÜÂ∫óÂÖëÊç¢)
            store.redemptions.forEach(r => {
                const d = new Date(r.date);
                if(d >= sevenDaysAgo && d <= today) {
                    pointsSpent += r.cost || 0;
                }
            });

            // ÊâæÂá∫È´òÈ¢ëÊ†áÁ≠æ
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            const topTags = sortedTags.slice(0, 3).map(([tag, count]) => `${tag}(${count})`);

            // ÊâæÂá∫ÊúÄÊ¥ªË∑ÉÊó∂ÊÆµ
            const sortedHours = Object.entries(hourDistribution).sort((a, b) => b[1] - a[1]);
            const peakTime = sortedHours.length > 0 ? sortedHours[0][0] : 'Êï∞ÊçÆ‰∏çË∂≥';

            // ËÆ°ÁÆóÂÆåÊàêÁéá
            const completionRate = totalCreated > 0 ? Math.round((totalCompleted / totalCreated) * 100) : 0;

            return {
                totalCompleted,
                totalCreated,
                completionRate,
                activeDays: activeDays.size,
                topTags,
                tagCounts,
                pointsEarned,
                pointsSpent,
                peakTime,
                hourDistribution,
                taskTexts: taskTexts.slice(0, 10), // ÊúÄËøë10Êù°‰ªªÂä°ÊñáÊú¨‰æõAIÂèÇËÄÉ
                dateRange: {
                    start: sevenDaysAgo.toLocaleDateString('zh-CN'),
                    end: today.toLocaleDateString('zh-CN')
                }
            };
        }

        // Step 2: AI ÁîüÊàêÂë®Êä•
        async function generateAIWeeklyReport() {
            // Ëé∑ÂèñAPIÈÖçÁΩÆ - ‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÊ≤°ÊúâÂàôÁî®‰∏ªAPI
            let apiConfig = store.apiConfig.sub;
            if(!apiConfig.url || !apiConfig.key) {
                apiConfig = store.apiConfig.main;
            }

            if(!apiConfig.url || !apiConfig.key) {
                alert('Vesper: ËØ∑ÂÖàÂú®‰æßËæπÊ†èÁöÑAPIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI!');
                return;
            }

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂíåÂä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('modal-ai-report').classList.add('active');
            document.getElementById('ai-report-loading').style.display = 'block';
            document.getElementById('ai-report-card-area').style.display = 'none';
            document.getElementById('ai-report-actions').style.display = 'none';

            // ËÅöÂêàÊï∞ÊçÆ
            const weeklyData = gatherWeeklyData();

            // ÊûÑÂª∫prompt
            const systemPrompt = `You are Vesper, a Data Analyst & Life Coach with a witty, slightly sarcastic personality. Analyze the user's weekly productivity data. Your tone should be insightful, occasionally humorous, and brutally honest when needed.

Output MUST be a valid JSON Object (no markdown formatting, no code blocks, just pure JSON) with this exact structure:
{
  "title": "Creative Chinese Title for the Week (e.g., Âú®Ê∑±Ê∏äËæπÁºòÁöÑËµ∑Ëàû, ÂíñÂï°Âõ†È©±Âä®ÁöÑ‰∏ÉÂ§©)",
  "summary": "A witty, insightful paragraph in Chinese summarizing the user's performance, emotional state inferred from data patterns, and actionable advice. Be specific about what you noticed.",
  "score": 85,
  "mood_color": "#FF5733",
  "tags": ["Tag1", "Tag2"]
}

Guidelines:
- title: Should be poetic, dramatic, or humorous based on the data pattern
- summary: 2-3 sentences, reference specific data points, be memorable
- score: 0-100 based on activity, completion rate, and balance
- mood_color: A hex color representing the week's vibe (purple for anxious+productive, green for balanced, red for chaotic, blue for calm, orange for energetic)
- tags: 2-4 Chinese tags describing the week (e.g., "Â§úÁå´Â≠ê", "È´òÊïà", "Ë∫∫Âπ≥", "ÂÜ≤Âà∫")`;

            const userPrompt = `ÂàÜÊûêÊàëËøáÂéª7Â§©ÁöÑÊï∞ÊçÆÔºö

üìä Âü∫Á°ÄÊï∞ÊçÆ:
- Êó∂Èó¥ËåÉÂõ¥: ${weeklyData.dateRange.start} ~ ${weeklyData.dateRange.end}
- ÂÆåÊàê‰ªªÂä°Êï∞: ${weeklyData.totalCompleted}
- È¢Ñ‰º∞ÂàõÂª∫Êï∞: ${weeklyData.totalCreated}
- ÂÆåÊàêÁéá: ${weeklyData.completionRate}%
- Ê¥ªË∑ÉÂ§©Êï∞: ${weeklyData.activeDays}/7 Â§©

üè∑Ô∏è Ê†áÁ≠æÂàÜÂ∏É:
${weeklyData.topTags.length > 0 ? weeklyData.topTags.join(', ') : 'ÊöÇÊó†Ê†áÁ≠æÊï∞ÊçÆ'}

‚è∞ Êó∂Èó¥ÂàÜÂ∏É:
ÊúÄÊ¥ªË∑ÉÊó∂ÊÆµ: ${weeklyData.peakTime}
${Object.entries(weeklyData.hourDistribution).map(([k, v]) => `${k}: ${v}Ê¨°`).join('\n')}

üí∞ ÁßØÂàÜÊµÅÂä®:
- Ëé∑Âæó: ${weeklyData.pointsEarned} ü™ô
- Ê∂àË¥π: ${weeklyData.pointsSpent} ü™ô
- ÂáÄÊî∂Áõä: ${weeklyData.pointsEarned - weeklyData.pointsSpent} ü™ô

üìù ÈÉ®ÂàÜ‰ªªÂä°Ê†∑Êú¨:
${weeklyData.taskTexts.slice(0, 5).join(', ') || 'ÊöÇÊó†'}

ËØ∑ÁîüÊàêÊàëÁöÑÂë®Êä•Âç°Áâá„ÄÇ`;

            try {
                const apiUrl = apiConfig.url.endsWith('/')
                    ? apiConfig.url + 'chat/completions'
                    : apiConfig.url + '/chat/completions';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.8
                    })
                });

                if(!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices?.[0]?.message?.content;

                if(!content) {
                    throw new Error('APIËøîÂõûÁ©∫ÂÜÖÂÆπ');
                }

                // Â∞ùËØïËß£ÊûêJSON (Â§ÑÁêÜÂèØËÉΩÁöÑmarkdownÊ†ºÂºè)
                content = content.trim();
                if(content.startsWith('```json')) {
                    content = content.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                } else if(content.startsWith('```')) {
                    content = content.replace(/^```\n?/, '').replace(/\n?```$/, '');
                }

                const reportData = JSON.parse(content);

                // È™åËØÅÂøÖË¶ÅÂ≠óÊÆµ
                if(!reportData.title || !reportData.summary || reportData.score === undefined || !reportData.mood_color) {
                    throw new Error('AIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÂÆåÊï¥');
                }

                // ‰øùÂ≠òÂΩìÂâçÊä•Âëä
                currentAIReport = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    weekRange: weeklyData.dateRange,
                    ...reportData,
                    rawData: weeklyData
                };

                // Ê∏≤ÊüìÊä•Âëä
                renderAIReportCard(currentAIReport, 'ai-report-card-area');

                document.getElementById('ai-report-loading').style.display = 'none';
                document.getElementById('ai-report-card-area').style.display = 'block';
                document.getElementById('ai-report-actions').style.display = 'block';

            } catch(error) {
                console.error('AIÂë®Êä•ÁîüÊàêÂ§±Ë¥•:', error);
                document.getElementById('ai-report-loading').innerHTML = `
                    <div style="color:#c62828; text-align:center;">
                        <div style="font-size:2rem; margin-bottom:10px;">‚ö†Ô∏è</div>
                        <p>ÁîüÊàêÂ§±Ë¥•: ${error.message}</p>
                        <p style="font-size:0.75rem; opacity:0.7; margin-top:10px;">ËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÈáçËØï</p>
                        <button class="btn btn-sec" style="margin-top:15px;" onclick="closeModal('modal-ai-report')">ÂÖ≥Èó≠</button>
                    </div>
                `;
            }
        }

        // Step 3: Ê∏≤ÊüìÊä•ÂëäÂç°Áâá
        function renderAIReportCard(report, containerId) {
            const container = document.getElementById(containerId);
            if(!container) return;

            // Ê†πÊçÆmood_colorÁîüÊàêÊ∏êÂèòËÉåÊôØ
            const moodColor = report.mood_color || '#8B5A2B';
            const darkerColor = adjustColorBrightness(moodColor, -30);

            // ÂÜ≥ÂÆöÊñáÂ≠óÈ¢úËâ≤ (Ê†πÊçÆËÉåÊôØ‰∫ÆÂ∫¶)
            const textColor = isColorLight(moodColor) ? '#333' : '#fff';

            container.innerHTML = `
                <div class="ai-report-card" style="background:linear-gradient(135deg, ${moodColor}, ${darkerColor}); color:${textColor};">
                    <div class="ai-report-header">
                        <div class="ai-report-title">„Ää${escapeHtml(report.title)}„Äã</div>
                        <div class="ai-report-score" style="color:${textColor}; border-color:${textColor}40;">
                            <div class="ai-report-score-num">${report.score}</div>
                            <div class="ai-report-score-label">ÂàÜ</div>
                        </div>
                    </div>
                    <div class="ai-report-summary" style="background:${textColor}15;">
                        ${escapeHtml(report.summary)}
                    </div>
                    <div class="ai-report-tags">
                        ${(report.tags || []).map(tag => `<span class="ai-report-tag" style="background:${textColor}20;">${escapeHtml(tag)}</span>`).join('')}
                    </div>
                    <div class="ai-report-meta" style="border-color:${textColor}30;">
                        <span>üìÖ ${report.weekRange?.start || ''} ~ ${report.weekRange?.end || ''}</span>
                        <span style="opacity:0.8;">Generated by Vesper ‚ú®</span>
                    </div>
                </div>
            `;
        }

        // Step 4: ‰øùÂ≠òÂë®Êä•Âà∞Ê°£Ê°à
        function saveCurrentAIReport() {
            if(!currentAIReport) {
                alert('Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑÂë®Êä•');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÊ°£
            const exists = store.reportArchive.some(r => r.id === currentAIReport.id);
            if(exists) {
                alert('Ê≠§Âë®Êä•Â∑≤Â≠òÊ°£');
                return;
            }

            store.reportArchive.unshift(currentAIReport);
            saveData();

            alert('Âë®Êä•Â∑≤Â≠òÂÖ•Ê°£Ê°à! üì¶');
            closeModal('modal-ai-report');

            // Âà∑Êñ∞Ê°£Ê°àÈ¢ÑËßà
            renderReportArchivePreview();
        }

        // Ê∏≤ÊüìÂë®Êä•Ê°£Ê°àÂàóË°® (Âú®Ê°£Ê°àÂÆ§È°µÈù¢)
        function renderReportArchivePreview() {
            const container = document.getElementById('report-archive-list');
            const countEl = document.getElementById('report-archive-count');

            if(!container) return;

            const archives = store.reportArchive || [];
            if(countEl) countEl.textContent = `${archives.length} ‰ªΩÊä•Âëä`;

            if(archives.length === 0) {
                container.innerHTML = '<p style="text-align:center; opacity:0.5; font-size:0.85rem; padding:20px 0;">ÊöÇÊó†Â≠òÊ°£ÁöÑÂë®Êä•<br><span style="font-size:0.75rem;">Âú®Êï∞ÊçÆÈ°µÈù¢ÁîüÊàê AI Âë®Êä•ÂêéÂèØÂ≠òÂÖ•Ê≠§Â§Ñ</span></p>';
                return;
            }

            // ÊòæÁ§∫ÂÖ®ÈÉ®Âë®Êä•
            container.innerHTML = archives.map(report => `
                <div class="report-archive-item" style="border-left-color:${report.mood_color || 'var(--accent)'};" onclick="viewArchivedReport('${report.id}')">
                    <div class="report-archive-color" style="background:${report.mood_color || 'var(--accent)'}"></div>
                    <div class="report-archive-info">
                        <div class="report-archive-title">${escapeHtml(report.title)}</div>
                        <div class="report-archive-date">${report.weekRange?.start || ''} ~ ${report.weekRange?.end || ''}</div>
                    </div>
                    <div class="report-archive-score">${report.score}</div>
                </div>
            `).join('');
        }

        // Êü•ÁúãÂ≠òÊ°£ÁöÑÂë®Êä•
        function viewArchivedReport(id) {
            const report = store.reportArchive.find(r => String(r.id) === String(id));
            if(!report) {
                alert('Êä•Âëä‰∏çÂ≠òÂú®');
                return;
            }

            viewingArchivedReportId = id;
            renderAIReportCard(report, 'archived-report-content');
            document.getElementById('modal-view-archived-report').classList.add('active');
        }

        // Âà†Èô§Â≠òÊ°£ÁöÑÂë®Êä•
        function deleteCurrentArchivedReport() {
            if(!viewingArchivedReportId) return;

            if(!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰ªΩÂë®Êä•ÂêóÔºü')) return;

            store.reportArchive = store.reportArchive.filter(r => String(r.id) !== String(viewingArchivedReportId));
            saveData();

            closeModal('modal-view-archived-report');
            viewingArchivedReportId = null;

            renderReportArchivePreview();
            alert('Âë®Êä•Â∑≤Âà†Èô§');
        }

        // ËæÖÂä©ÂáΩÊï∞: Ë∞ÉÊï¥È¢úËâ≤‰∫ÆÂ∫¶
        function adjustColorBrightness(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // ËæÖÂä©ÂáΩÊï∞: Âà§Êñ≠È¢úËâ≤ÊòØÂê¶‰∏∫‰∫ÆËâ≤
        function isColorLight(hex) {
            const num = parseInt(hex.replace('#', ''), 16);
            const R = (num >> 16) & 0xFF;
            const G = (num >> 8) & 0xFF;
            const B = num & 0xFF;
            const brightness = (R * 299 + G * 587 + B * 114) / 1000;
            return brightness > 155;
        }

        // --- Day Detail Metrics ---
        function openDayDetail(k) { 
             const list=document.getElementById('day-detail-list'); list.innerHTML='';
             store.logs.filter(l=>l.date===k).forEach(l=>list.innerHTML+=`<div style="border-bottom:1px dashed rgba(0,0,0,0.1);padding:5px 0;font-size:0.8rem;">${l.text}<span style="float:right;opacity:0.6;">${l.tag}</span></div>`);
             document.getElementById('day-detail-date').innerText=k; 
             
             const count = store.dailyStats[k] || 0;
             const estTotal = count > 0 ? Math.floor(count * 1.5) : 0;
             const rate = count > 0 ? (Math.floor(Math.random() * 20) + 70) : 0;
             
             document.getElementById('dd-completed').innerText = count;
             document.getElementById('dd-total').innerText = estTotal;
             document.getElementById('dd-rate').innerText = rate + "%";
             
             document.getElementById('modal-day-detail').classList.add('active');
        }
        
        async function exportData() {
            // ÂØºÂá∫ÂÆåÊï¥Êï∞ÊçÆÔºölocalStorage (store) + IndexedDB (ËßíËâ≤„ÄÅ‰∏ñÁïå‰π¶)
            const fullBackup = {
                version: 2,
                exportDate: new Date().toISOString(),
                store: store,
                // IndexedDB Êï∞ÊçÆ
                characters: await db.characters.toArray(),
                worldBooks: await db.worldBooks.toArray(),
                worldBookCategories: await db.worldBookCategories.toArray()
            };
            const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullBackup, null, 2));
            const a = document.createElement('a');
            a.href = s;
            a.download = `lifeos_full_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        function triggerImport(m) { importMode=m; document.getElementById('file-import').click(); }
        async function handleFile(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const d = JSON.parse(e.target.result);

                    // Ê£ÄÊµãÊòØÂê¶‰∏∫Êñ∞ÁâàÂÆåÊï¥Â§á‰ªΩÊ†ºÂºè (version >= 2)
                    if (d.version && d.version >= 2 && d.store) {
                        // Êñ∞ÁâàÂÆåÊï¥Â§á‰ªΩÊ†ºÂºè
                        if (importMode === 'overwrite') {
                            store = d.store;
                            // Ê∏ÖÁ©∫Âπ∂ÂØºÂÖ• IndexedDB Êï∞ÊçÆ
                            if (d.characters && d.characters.length > 0) {
                                await db.characters.clear();
                                await db.characters.bulkPut(d.characters);
                            }
                            if (d.worldBooks && d.worldBooks.length > 0) {
                                await db.worldBooks.clear();
                                await db.worldBooks.bulkPut(d.worldBooks);
                            }
                            if (d.worldBookCategories && d.worldBookCategories.length > 0) {
                                await db.worldBookCategories.clear();
                                await db.worldBookCategories.bulkPut(d.worldBookCategories);
                            }
                        } else {
                            // Â¢ûÈáèÊ®°Âºè
                            store.projects = [...store.projects, ...(d.store.projects || [])];
                            store.balance += d.store.balance || 0;
                            // Â¢ûÈáèÂØºÂÖ•ËßíËâ≤ÔºàÈÅøÂÖçIDÂÜ≤Á™ÅÔºåË∑≥ËøáÂ∑≤Â≠òÂú®ÁöÑÔºâ
                            if (d.characters) {
                                for (const char of d.characters) {
                                    const existing = await db.characters.get(char.id);
                                    if (!existing) {
                                        await db.characters.put(char);
                                    }
                                }
                            }
                            // Â¢ûÈáèÂØºÂÖ•‰∏ñÁïå‰π¶
                            if (d.worldBooks) {
                                for (const wb of d.worldBooks) {
                                    const existing = await db.worldBooks.get(wb.id);
                                    if (!existing) {
                                        await db.worldBooks.put(wb);
                                    }
                                }
                            }
                            // Â¢ûÈáèÂØºÂÖ•‰∏ñÁïå‰π¶ÂàÜÁ±ª
                            if (d.worldBookCategories) {
                                for (const cat of d.worldBookCategories) {
                                    const existing = await db.worldBookCategories.get(cat.id);
                                    if (!existing) {
                                        await db.worldBookCategories.put(cat);
                                    }
                                }
                            }
                        }
                    } else {
                        // ÊóßÁâàÂ§á‰ªΩÊ†ºÂºèÔºà‰ªÖ store Êï∞ÊçÆÔºâÔºåÂêëÂêéÂÖºÂÆπ
                        if (importMode === 'overwrite') {
                            store = d;
                        } else {
                            store.projects = [...store.projects, ...(d.projects || [])];
                            store.balance += d.balance || 0;
                        }
                    }

                    saveData();
                    alert('ÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜÂà∑Êñ∞...');
                    location.reload();
                } catch(err) {
                    console.error('ÂØºÂÖ•ÈîôËØØ:', err);
                    alert('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            reader.readAsText(input.files[0]);
        }

        // --- ‰æßËæπÊ†èÂäüËÉΩ ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const isActive = sidebar.classList.contains('active');
            
            resetUI(); // ÂÖàÊ∏ÖÂú∫

            if (!isActive) {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebar-overlay').classList.add('active');
                document.body.classList.add('no-scroll');
            }
        }

        function closeSidebar() {
            resetUI();
        }

        function openSidebarPanel(panelId) {
            resetUI(); // ÂÖàÊ∏ÖÂú∫

            // Âª∂ËøüÊâìÂºÄÈù¢Êùø
            setTimeout(() => {
                const panel = document.getElementById('panel-' + panelId);
                if(panel) {
                    panel.classList.add('active');
                    document.body.classList.add('no-scroll');

                    // Ê†πÊçÆ‰∏çÂêåÈù¢ÊùøÂä†ËΩΩÁõ∏Â∫îÂÜÖÂÆπ
                    if (panelId === 'ai-assistant') {
                        renderAiChatHistory();
                    } else if (panelId === 'background-activity') {
                        loadBgActivitySettings();
                    } else if (panelId === 'cloud-backup') {
                        loadCloudBackupSettings();
                    }
                }
            }, 100);
        }

        function closeAllPanels() {
            document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
        }

        function closePanelBack() {
            closeAllPanels();
            // ÈáçÊñ∞ÊâìÂºÄ‰æßËæπÊ†è
            setTimeout(() => {
                toggleSidebar();
            }, 300);
        }

        // AI‰ªªÂä°ÁîüÊàêÂô®
        function openAiTaskGenerator() {
            document.getElementById('modal-ai-task-generator').classList.add('active');
        }

        async function generateTasksWithAI() {
            const goal = document.getElementById('ai-task-goal').value.trim();
            const size = parseInt(document.getElementById('ai-task-size').value);
            const category = document.getElementById('ai-task-category').value;

            if(!goal) {
                alert('ËØ∑ÂÖàÊèèËø∞‰Ω†ÁöÑÁõÆÊ†á!');
                return;
            }

            // ‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÊ≤°ÊúâÂàôÁî®‰∏ªAPI
            let apiConfig = store.apiConfig.sub;
            if(!apiConfig.url || !apiConfig.key) {
                apiConfig = store.apiConfig.main;
            }

            if(!apiConfig.url || !apiConfig.key) {
                alert('ËØ∑ÂÖàÂú®‰æßËæπÊ†èÁöÑAPIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI!');
                return;
            }

            const btn = document.getElementById('btn-generate-tasks');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ÁîüÊàê‰∏≠...';
            btn.disabled = true;

            try {
                const taskCount = size * size;
                const prompt = `‰Ω†‰Ωú‰∏∫Â°îÊãâLIFEOSÁöÑ‰ªªÂä°ËßÑÂàí‰∏ìÂÆ∂,ËØ∑Ê†πÊçÆ‰ª•‰∏ãÁõÆÊ†á,ÁîüÊàê${taskCount}‰∏™ÂÖ∑‰Ωì„ÄÅÂèØÊâßË°åÁöÑ‰ªªÂä°Ê≠•È™§„ÄÇ

ÁõÆÊ†á: ${goal}
‰ªªÂä°Êï∞Èáè: ${taskCount}‰∏™
ÂàÜÁ±ª: ${category}

Ë¶ÅÊ±Ç:
1. ‰ªªÂä°Ë¶ÅÂÖ∑‰Ωì„ÄÅÂèØÊâßË°å„ÄÅÊúâÊòéÁ°ÆÁöÑÂÆåÊàêÊ†áÂáÜ
2. ‰ªªÂä°ÈöæÂ∫¶ÈÄíËøõ,‰ªéÂü∫Á°ÄÂà∞ËøõÈò∂
3. ÊØè‰∏™‰ªªÂä°Áî®ÁÆÄÁü≠ÁöÑ‰∏ÄÂè•ËØùÊèèËø∞(‰∏çË∂ÖËøá15Â≠ó)
4. Áõ¥Êé•ËøîÂõû‰ªªÂä°ÂàóË°®,ÊØèË°å‰∏Ä‰∏™‰ªªÂä°,‰∏çË¶ÅÁºñÂè∑
5. ‰∏çË¶ÅÊúâ‰ªª‰ΩïÈ¢ùÂ§ñËØ¥ÊòéÊàñÊ†áÈ¢ò

Á§∫‰æãËæìÂá∫Ê†ºÂºè:
ÂÆâË£ÖPythonÁéØÂ¢É
Â≠¶‰π†ÂèòÈáèÂíåÊï∞ÊçÆÁ±ªÂûã
ÂÆåÊàêÁ¨¨‰∏Ä‰∏™Hello World
Â≠¶‰π†Êù°‰ª∂ËØ≠Âè•if-else
...`;

                // ‰ΩøÁî®ÂâØAPIËøõË°åÁÆÄÊ¥ÅÁöÑ‰ªªÂä°ÁîüÊàêÔºà‰∏çÂ∏¶Vesper‰∫∫Ê†ºÔºâ
                const url = apiConfig.url.endsWith('/') ? apiConfig.url + 'chat/completions' : apiConfig.url + '/chat/completions';

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    },
                    body: JSON.stringify({
                        model: apiConfig.model,
                        messages: [
                            { role: 'system', content: '‰Ω†ÊòØ‰∏Ä‰∏™‰ªªÂä°ËßÑÂàí‰∏ìÂÆ∂„ÄÇËØ∑‰∏•Ê†ºÊåâÁÖßÁî®Êà∑Ë¶ÅÊ±ÇËæìÂá∫‰ªªÂä°ÂàóË°®ÔºåÊØèË°å‰∏Ä‰∏™‰ªªÂä°Ôºå‰∏çË¶ÅÊúâÁºñÂè∑„ÄÅÊ†áÈ¢òÊàñÈ¢ùÂ§ñËØ¥Êòé„ÄÇ' },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if(!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${res.status}): ${errorText}`);
                }

                const data = await res.json();

                if(!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIËøîÂõûÊ†ºÂºèÂºÇÂ∏∏');
                }

                const response = data.choices[0].message.content;
                const tasks = response.split('\n').filter(t => t.trim()).map(t => t.trim().replace(/^\d+[\.\„ÄÅ]\s*/, ''));

                // Ëá™Âä®Â°´ÂÖÖÂà∞ÂàõÂª∫Ë°®Âçï
                document.getElementById('inp-theme').value = goal.substring(0, 30);
                document.getElementById('inp-tag').value = category;
                document.getElementById('inp-size').value = size.toString();
                document.getElementById('inp-tasks').value = tasks.join('\n');

                closeModal('modal-ai-task-generator');
                alert(`Vesper: Â∑≤ÊàêÂäüÁîüÊàê${tasks.length}‰∏™‰ªªÂä°,ËØ∑Êü•ÁúãÂπ∂Á°ÆËÆ§!`);

            } catch(error) {
                alert('ÁîüÊàêÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // --- ÊàòÊúØÂ∑•ÂÖ∑Ê†èÈÄªËæë ---
        let selectedMood = 'Calm';

        // --- [Vesper] AI Âä©ÊâãÊàòÊúØÂ∑•ÂÖ∑Ê†èÈÄªËæë ---

        function aiToolSendBingo() {
            const activeProjects = store.projects.filter(p => p.status === 'active');
            if(activeProjects.length === 0) {
                alert("Vesper: ÊöÇÊó†Ê¥ªË∑ÉÁöÑ Bingo Âç°„ÄÇ");
                return;
            }
            
            const listDiv = document.getElementById('bingo-selection-list');
            listDiv.innerHTML = '';
            
            activeProjects.forEach(p => {
                const total = p.tasks.length;
                const done = p.tasks.filter(t => t.completed).length;
                const progress = Math.round((done / total) * 100);
                
                listDiv.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;" onclick="confirmAiToolSendBingo(${p.id})">
                        <div style="flex:1; cursor:pointer;">
                            <div style="font-weight:bold;">${p.theme}</div>
                            <div style="font-size:0.7rem; opacity:0.6;">ËøõÂ∫¶: ${progress}% (${done}/${total})</div>
                        </div>
                        <button class="btn-sec" style="width:auto; padding:4px 10px; font-size:0.7rem;">ÈÄâÊã©</button>
                    </div>
                `;
            });
            
            const modal = document.getElementById('modal-select-bingo');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "ÈÄâÊã©Ë¶ÅÊ≥®ÂÖ•ÁöÑ‰ªªÂä°Âç°";
            
            const confirmBtn = modal.querySelector('.btn');
            if(confirmBtn) confirmBtn.style.display = 'none'; 
            
            modal.classList.add('active');
        }

        async function confirmAiToolSendBingo(pid) {
            closeModal('modal-select-bingo');
            const modal = document.getElementById('modal-select-bingo');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "ÈÄâÊã©ÂÖ≥ËÅîÁöÑ Bingo Âç°";
            
            const confirmBtn = modal.querySelector('.btn');
            if(confirmBtn) {
                confirmBtn.style.display = 'block';
                confirmBtn.setAttribute('onclick', 'confirmBingoCardSelection()');
            }

            const p = store.projects.find(x => x.id === pid);
            if(!p) return;

            const total = p.tasks.length;
            const done = p.tasks.filter(t => t.completed).length;
            const progress = Math.round((done / total) * 100);
            
            let gridMd = "";
            const size = p.size;
            for(let r=0; r<size; r++) {
                gridMd += "|";
                for(let c=0; c<size; c++) {
                    const t = p.tasks[r*size + c];
                    const symbol = t.completed ? "‚úÖ" : "‚¨ú";
                    const shortText = t.text.length > 5 ? t.text.substring(0,4)+".." : t.text;
                    gridMd += ` ${symbol} ${shortText} |`;
                }
                gridMd += "\n";
            }

            // ÊûÑÂª∫Ê∂àÊÅØÔºåÂåÖÂê´ÈöèÁ¨îÔºàÂ¶ÇÊûúÊúâÔºâ
            let visualMsg = `**üìÇ Bingo Card Snapshot: ${p.theme}**\n\`\`\`\n${gridMd}\n\`\`\`\n> Progress: ${progress}%`;

            // Ê∑ªÂä†ÈöèÁ¨îÂÜÖÂÆπ
            if(p.journal && p.journal.trim()) {
                visualMsg += `\n\n**üìù ÊàëÁöÑÈöèÁ¨îÔºö**\n> ${p.journal.trim()}`;
            }

            // Â¶ÇÊûúÊòØÂΩíÊ°£Âç°ÔºåÊ∑ªÂä†ÊÄªÁªì
            if(p.status === 'archived' && p.summary && p.summary.trim()) {
                visualMsg += `\n\n**üìã ÊÄªÁªìÔºö**\n> ${p.summary.trim()}`;
            }

            const input = document.getElementById('ai-input');
            input.value = visualMsg;
            await sendAiMessage();
        }

        async function aiToolSendImage(input) {
            const files = input.files;
            if(!files || files.length === 0) return;

            const chatInput = document.getElementById('ai-input');
            let currentValue = chatInput.value;

            // Â§ÑÁêÜÂ§ö‰∏™Êñá‰ª∂
            let imageCount = 0;
            for(let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const base64 = e.target.result;
                    // Ê∑ªÂä†ÂõæÁâáÂà∞ËæìÂÖ•Ê°ÜÔºå‰øùÁïôÂéüÊúâÂÜÖÂÆπ
                    if(currentValue && !currentValue.endsWith('\n')) {
                        currentValue += '\n';
                    }
                    currentValue += `![Image](${base64})\n`;
                    chatInput.value = currentValue;

                    imageCount++;
                    // ÊâÄÊúâÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫ÊèêÁ§∫
                    if(imageCount === files.length) {
                        showToast(`Â∑≤Ê∑ªÂä† ${files.length} Âº†ÂõæÁâáÔºåÁÇπÂáªÂèëÈÄÅÊåâÈíÆÊàñAIÂõûÂ§çÊåâÈíÆÊù•ÂèëÈÄÅ`);
                    }
                };

                reader.readAsDataURL(file);
            }

            input.value = ''; // Ê∏ÖÁ©∫input‰ª•‰æø‰∏ãÊ¨°ÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
        }

        function aiToolRollDice() {
            const problem = prompt("Á∫†Áªì‰ªÄ‰πàÔºü(‰æãÂ¶Ç: A.Áù°Ëßâ B.ÂÜô‰ª£Á†Å)");
            if(!problem) return;
            
            const options = problem.split(/[,Ôºå\s]+/).filter(s=>s);
            let result = "";
            if(options.length > 1) {
                const pick = options[Math.floor(Math.random() * options.length)];
                result = `üé≤ È™∞Â≠êÁªìÊûú: **${pick}**`;
            } else {
                const roll = Math.floor(Math.random() * 100);
                result = `üé≤ È™∞Â≠êÁÇπÊï∞: **${roll}**`;
            }
            
            const msg = `> ‚ùì Á∫†Áªì: ${problem}\n\n${result}`;
            const chatInput = document.getElementById('ai-input');
            chatInput.value = msg;
            sendAiMessage();
        }

        function aiToolSendStatus() {
            const btn = document.querySelector('#modal-status-report .btn');
            if(btn) btn.setAttribute('onclick', 'confirmAiSendStatus()');
            document.getElementById('modal-status-report').classList.add('active');
        }

        function confirmAiSendStatus() {
            const energy = document.getElementById('status-energy').value;
            const msg = `[STATUS LOG]: Energy ${energy}% | Mood: ${selectedMood}`;
            
            closeModal('modal-status-report');
            const chatInput = document.getElementById('ai-input');
            chatInput.value = msg;
            sendAiMessage();
        }

        async function aiToolSendLink() {
            const url = prompt("ËØ∑ËæìÂÖ•ÈìæÊé• URL:");
            if(!url) return;
            
            const tempId = 'ai-loading-' + Date.now();
            const chatContainer = document.getElementById('ai-chat-container');
            chatContainer.insertAdjacentHTML('beforeend', `<div id="${tempId}" style="margin-bottom:15px;"><div style="display:inline-block; background:var(--card-bg); padding:10px 15px; border-radius:12px;">Vesper Ê≠£Âú®ËØªÂèñÈìæÊé•...</div></div>`);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch(`https://r.jina.ai/${url}`);
                if (!response.ok) throw new Error(`ËØªÂèñÂ§±Ë¥• (status: ${response.status})`);
                const text = await response.text();
                const contentPreview = text.substring(0, 3000) + (text.length > 3000 ? "...(ÂÜÖÂÆπËøáÈïøÂ∑≤Êà™Êñ≠)" : "");
                
                const loadingEl = document.getElementById(tempId);
                if (loadingEl) loadingEl.remove();

                const userVisibleMsg = `üîó ÊàëÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™ÈìæÊé•Ôºö${url}\n\nËØ∑ÊÄªÁªìÊàñÂü∫‰∫éÊ≠§ÂÜÖÂÆπÂõûÁ≠îÊàëÁöÑÈóÆÈ¢ò„ÄÇ`;
                const hiddenSystemPrompt = `[System: Link Content Injection]\nUser shared a link. Here is the parsed content:\n\n--- BEGIN LINK CONTENT ---\n${contentPreview}\n--- END LINK CONTENT ---`;
                
                store.aiChatHistory.push({ role: 'system', content: hiddenSystemPrompt, hidden: true });
                
                const chatInput = document.getElementById('ai-input');
                chatInput.value = userVisibleMsg;
                await sendAiMessage();

            } catch (e) {
                const loadingEl = document.getElementById(tempId);
                if (loadingEl) loadingEl.remove();
                alert("ÈìæÊé•ËØªÂèñÂ§±Ë¥•: " + e.message);
            }
        }

        function aiToolToggleWebSearch() {
            isAiSearchEnabled = !isAiSearchEnabled;
            const btn = document.getElementById('ai-search-toggle-btn');
            const aiStatusDiv = document.querySelector('#panel-ai-assistant .header div > div:last-child');
            if (isAiSearchEnabled) {
                btn.classList.add('active');
                if(aiStatusDiv) aiStatusDiv.textContent = 'ËÅîÁΩëÊêúÁ¥¢Â∑≤ÊøÄÊ¥ª';
            } else {
                btn.classList.remove('active');
                if(aiStatusDiv) aiStatusDiv.textContent = 'Âú®Á∫ø';
            }
        }

        async function aiHandleSearchAndReply(query) {
            const aiStatusDiv = document.querySelector('#panel-ai-assistant .header div > div:last-child');
            if(aiStatusDiv) aiStatusDiv.textContent = 'Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...';
            
            const input = document.getElementById('ai-input');
            input.value = '';

            try {
                const results = await performWebSearch(query);
                
                aiToolToggleWebSearch(); // Turn off search mode

                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    if(aiStatusDiv) aiStatusDiv.textContent = 'Âú®Á∫ø';
                    return;
                }

                let systemInstruction;
                if (results.length === 0) {
                    systemInstruction = `[System Instruction]: I performed a web search for "${query}" but found no results. Inform the user about this and try to answer based on your own knowledge.`;
                } else {
                    const searchResultsText = results.map((r, i) => 
                        `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                    ).join('\n\n');
                    systemInstruction = `[System Instruction]: I performed a web search for "${query}". The following are the top search results. Use this information to answer my query. Synthesize the information to provide a comprehensive answer, and you can cite sources using the format [number].

Web Search Results:
---
${searchResultsText}
---
`;
                }
                
                store.aiChatHistory.push({ role: 'system', content: systemInstruction, hidden: true });
                
                input.value = query;
                await sendAiMessage();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                if(aiStatusDiv) aiStatusDiv.textContent = 'Âú®Á∫ø';
                aiToolToggleWebSearch(); // Ensure search is off
            }
        }

        function toolSendBingo() {
            const activeProjects = store.projects.filter(p => p.status === 'active');
            if(activeProjects.length === 0) {
                alert("Vesper: ÊöÇÊó†Ê¥ªË∑ÉÁöÑ Bingo Âç°„ÄÇËØ∑ÂÖàÂàõÂª∫‰∏Ä‰∏™ËÆ°Âàí„ÄÇ");
                return;
            }
            
            const listDiv = document.getElementById('bingo-selection-list');
            listDiv.innerHTML = '';
            
            activeProjects.forEach(p => {
                const total = p.tasks.length;
                const done = p.tasks.filter(t => t.completed).length;
                const progress = Math.round((done / total) * 100);
                
                listDiv.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; align-items:center; gap:10px;" onclick="confirmToolSendBingo(${p.id})">
                        <div style="flex:1; cursor:pointer;">
                            <div style="font-weight:bold;">${p.theme}</div>
                            <div style="font-size:0.7rem; opacity:0.6;">ËøõÂ∫¶: ${progress}% (${done}/${total})</div>
                        </div>
                        <button class="btn-sec" style="width:auto; padding:4px 10px; font-size:0.7rem;">ÈÄâÊã©</button>
                    </div>
                `;
            });
            
            const modal = document.getElementById('modal-select-bingo');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "ÈÄâÊã©Ë¶ÅÊ≥®ÂÖ•ÁöÑ‰ªªÂä°Âç°";
            
            const confirmBtn = modal.querySelector('.btn');
            if(confirmBtn) confirmBtn.style.display = 'none'; 
            
            modal.classList.add('active');
        }

        async function confirmToolSendBingo(pid) {
            closeModal('modal-select-bingo');
            const modal = document.getElementById('modal-select-bingo');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "ÈÄâÊã©ÂÖ≥ËÅîÁöÑ Bingo Âç°";
            
            const confirmBtn = modal.querySelector('.btn');
            if(confirmBtn) {
                confirmBtn.style.display = 'block';
                confirmBtn.setAttribute('onclick', 'confirmBingoCardSelection()');
            }

            const p = store.projects.find(x => x.id === pid);
            if(!p) return;

            const total = p.tasks.length;
            const done = p.tasks.filter(t => t.completed).length;
            const progress = Math.round((done / total) * 100);
            
            let gridMd = "";
            const size = p.size;
            for(let r=0; r<size; r++) {
                gridMd += "|";
                for(let c=0; c<size; c++) {
                    const t = p.tasks[r*size + c];
                    const symbol = t.completed ? "‚úÖ" : "‚¨ú";
                    const shortText = t.text.length > 5 ? t.text.substring(0,4)+".." : t.text;
                    gridMd += ` ${symbol} ${shortText} |`;
                }
                gridMd += "\n";
            }

            // ÊûÑÂª∫Ê∂àÊÅØÔºåÂåÖÂê´ÈöèÁ¨îÔºàÂ¶ÇÊûúÊúâÔºâ
            let visualMsg = `**üìÇ Bingo Card Snapshot: ${p.theme}**\n\`\`\`\n${gridMd}\n\`\`\`\n> Progress: ${progress}%`;

            // Ê∑ªÂä†ÈöèÁ¨îÂÜÖÂÆπ
            if(p.journal && p.journal.trim()) {
                visualMsg += `\n\n**üìù ÊàëÁöÑÈöèÁ¨îÔºö**\n> ${p.journal.trim()}`;
            }

            // Â¶ÇÊûúÊòØÂΩíÊ°£Âç°ÔºåÊ∑ªÂä†ÊÄªÁªì
            if(p.status === 'archived' && p.summary && p.summary.trim()) {
                visualMsg += `\n\n**üìã ÊÄªÁªìÔºö**\n> ${p.summary.trim()}`;
            }

            const input = document.getElementById('character-chat-input');
            input.value = visualMsg;
            await sendCharacterMessage();

            if(currentChatCharacter) {
                // Á≥ªÁªüÊåá‰ª§‰∏≠‰πüÂåÖÂê´ÈöèÁ¨îÂíåÊÄªÁªì
                let systemInstruction = `[System Instruction]: User shared a Bingo Card snapshot. Full Data: ${JSON.stringify(p)}. Analyze progress (current: ${progress}%) and urge/encourage user based on completion status.`;

                if(p.journal && p.journal.trim()) {
                    systemInstruction += `\n\nUser's Journal/Notes: ${p.journal.trim()}`;
                }

                if(p.status === 'archived' && p.summary && p.summary.trim()) {
                    systemInstruction += `\n\nUser's Summary: ${p.summary.trim()}`;
                }

                const hiddenMsg = {
                    role: 'user',
                    content: systemInstruction,
                    timestamp: Date.now(),
                    hidden: true
                };
                currentChatCharacter.chatHistory.push(hiddenMsg);
                await db.characters.put(currentChatCharacter);
                
                triggerCharacterAIResponse();
            }
        }

        async function toolSendImage(input) {
            const files = input.files;
            if(!files || files.length === 0) return;

            const chatInput = document.getElementById('character-chat-input');
            let currentValue = chatInput.value;

            // Â§ÑÁêÜÂ§ö‰∏™Êñá‰ª∂
            let imageCount = 0;
            for(let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const base64 = e.target.result;
                    // Ê∑ªÂä†ÂõæÁâáÂà∞ËæìÂÖ•Ê°ÜÔºå‰øùÁïôÂéüÊúâÂÜÖÂÆπ
                    if(currentValue && !currentValue.endsWith('\n')) {
                        currentValue += '\n';
                    }
                    currentValue += `![Image](${base64})\n`;
                    chatInput.value = currentValue;

                    imageCount++;
                    // ÊâÄÊúâÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫ÊèêÁ§∫
                    if(imageCount === files.length) {
                        showToast(`Â∑≤Ê∑ªÂä† ${files.length} Âº†ÂõæÁâáÔºåÂèØ‰ª•ÁªßÁª≠Ê∑ªÂä†ÊñáÂ≠óÊèèËø∞ÔºåÁÑ∂ÂêéÁÇπÂáªÂèëÈÄÅÊåâÈíÆ`);
                    }
                };

                reader.readAsDataURL(file);
            }

            input.value = ''; // Ê∏ÖÁ©∫input‰ª•‰æø‰∏ãÊ¨°ÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
        }

        function toolRollDice() {
            const problem = prompt("Á∫†Áªì‰ªÄ‰πàÔºü(‰æãÂ¶Ç: A.Áù°Ëßâ B.ÂÜô‰ª£Á†Å)");
            if(!problem) return;
            
            const options = problem.split(/[,Ôºå\s]+/).filter(s=>s);
            let result = "";
            if(options.length > 1) {
                const pick = options[Math.floor(Math.random() * options.length)];
                result = `üé≤ È™∞Â≠êÁªìÊûú: **${pick}**`;
            } else {
                const roll = Math.floor(Math.random() * 100);
                result = `üé≤ È™∞Â≠êÁÇπÊï∞: **${roll}**`;
            }
            
            const msg = `> ‚ùì Á∫†Áªì: ${problem}\n\n${result}`;
            const chatInput = document.getElementById('character-chat-input');
            chatInput.value = msg;
            sendCharacterMessage();
            setTimeout(() => triggerCharacterAIResponse(), 1000);
        }

        function toolSendStatus() {
            const btn = document.querySelector('#modal-status-report .btn');
            if(btn) btn.setAttribute('onclick', 'confirmSendStatus()');
            document.getElementById('modal-status-report').classList.add('active');
        }

        function selectMood(mood, el) {
            selectedMood = mood;
            document.querySelectorAll('#modal-status-report .diff-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function confirmSendStatus() {
            const energy = document.getElementById('status-energy').value;
            const msg = `[STATUS LOG]: Energy ${energy}% | Mood: ${selectedMood}`;
            
            closeModal('modal-status-report');
            const chatInput = document.getElementById('character-chat-input');
            chatInput.value = msg;
            sendCharacterMessage();
            setTimeout(() => triggerCharacterAIResponse(), 1000);
        }

        async function toolSendLink() {
            const url = prompt("ËØ∑ËæìÂÖ•ÈìæÊé• URL:");
            if(!url) return;
            
            // 1. Âú®ÁïåÈù¢‰∏äÊòæÁ§∫‚ÄúÊ≠£Âú®ËØªÂèñ...‚Äù
            const loadingMsg = {
                role: 'assistant',
                content: 'Ê≠£Âú®ËØªÂèñÈìæÊé•ÂÜÖÂÆπÔºåËØ∑Á®çÂÄô...',
                timestamp: Date.now(),
                isTemp: true, // Custom property to identify this as a temp message
                tempId: 'loading-' + Date.now()
            };
            appendCharacterMessage(loadingMsg);
            
            try {
                // 2. Ë∞ÉÁî® Jina Reader API
                const response = await fetch(`https://r.jina.ai/${url}`);
                
                if (!response.ok) throw new Error(`ËØªÂèñÂ§±Ë¥• (status: ${response.status})`);
                
                const text = await response.text();
                
                // 3. Êà™Âèñ
                const contentPreview = text.substring(0, 3000) + (text.length > 3000 ? "...(ÂÜÖÂÆπËøáÈïøÂ∑≤Êà™Êñ≠)" : "");
                
                // 4. ÁßªÈô§‚ÄúÊ≠£Âú®ËØªÂèñ‚ÄùÊèêÁ§∫
                const loadingEl = document.getElementById(loadingMsg.tempId);
                if (loadingEl) loadingEl.remove();

                // 5. ÊûÑÈÄ†Áî®Êà∑ÂèØËßÅÊ∂àÊÅØÂπ∂ÂèëÈÄÅ
                const userVisibleMsg = `üîó ÊàëÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™ÈìæÊé•Ôºö${url}`;
                const userMsg = {
                    role: 'user',
                    content: userVisibleMsg,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);
                
                // 6. ÊûÑÈÄ†ÈöêËóèÁöÑÁ≥ªÁªüÊèêÁ§∫
                const hiddenSystemPrompt = `
[System: Link Content Injection]
The user shared a link. Here is the parsed content of that link:

--- BEGIN LINK CONTENT ---
${contentPreview}
--- END LINK CONTENT ---

Instruction: Read the content above. If the user asks for a summary, summarize it. If the user asks a question, answer based on this content.
        `;
                
                // 7. Ëß¶Âèë AI ÂõûÂ§çÔºåÂπ∂Ê≥®ÂÖ•‰∏ä‰∏ãÊñá
                triggerCharacterAIResponse(hiddenSystemPrompt); 
                
            } catch (e) {
                // ÁßªÈô§‚ÄúÊ≠£Âú®ËØªÂèñ‚ÄùÊèêÁ§∫
                const loadingEl = document.getElementById(loadingMsg.tempId);
                if (loadingEl) loadingEl.remove();

                alert("ÈìæÊé•ËØªÂèñÂ§±Ë¥•: " + e.message);
                
                // Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÈîôËØØ
                const errorMsg = {
                    role: 'assistant',
                    content: `‚ùå Êó†Ê≥ïËØªÂèñÈìæÊé• ${url} ÁöÑÂÜÖÂÆπ„ÄÇÂèØËÉΩÊòØË∑®ÂüüÈôêÂà∂ÊàñÁõÆÊ†áÁΩëÁ´ôÂèçÁà¨„ÄÇ`,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(errorMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(errorMsg);
            }
        }


        // --- [Vesper] ËÅîÁΩëÊêúÁ¥¢ÂäüËÉΩ ---

        function toggleWebSearch() {
            isSearchEnabled = !isSearchEnabled;
            const btn = document.getElementById('search-toggle-btn');
            if (isSearchEnabled) {
                btn.classList.add('active');
                updateChatStatus('ËÅîÁΩëÊêúÁ¥¢Â∑≤ÊøÄÊ¥ª', 'thinking');
            } else {
                btn.classList.remove('active');
                updateChatStatus('Âú®Á∫ø', 'online');
            }
        }

        function toggleSearchInputs() {
            const provider = document.getElementById('search-provider-select').value;
            document.getElementById('google-search-inputs').style.display = (provider === 'google') ? 'block' : 'none';
            document.getElementById('serper-search-inputs').style.display = (provider === 'serper') ? 'block' : 'none';
            document.getElementById('zhipu-search-inputs').style.display = (provider === 'zhipu') ? 'block' : 'none';
        }

        const SearchService = {
            google: async (query, config) => {
                const url = `https://www.googleapis.com/customsearch/v1?key=${config.apiKey}&cx=${config.cx}&q=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Google Search API Error: ${res.statusText}`);
                const data = await res.json();
                if (!data.items) return [];
                return data.items.map(item => ({
                    title: item.title,
                    snippet: item.snippet,
                    link: item.link
                })).slice(0, 5);
            },
            serper: async (query, config) => {
                const url = 'https://google.serper.dev/search';
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-API-KEY': config.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ q: query, gl: 'cn', hl: 'zh-cn' })
                    });

                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error('[Serper] APIÂìçÂ∫îÈîôËØØ:', res.status, errorText);
                        throw new Error(`Serper API Error: ${res.status} ${res.statusText}${errorText ? ' - ' + errorText : ''}`);
                    }

                    const data = await res.json();
                    console.log('[Serper] APIÂìçÂ∫î:', data);

                    if (!data.organic || data.organic.length === 0) {
                        console.warn('[Serper] Êó†ÊêúÁ¥¢ÁªìÊûú');
                        return [];
                    }

                    return data.organic.map(item => ({
                        title: item.title,
                        snippet: item.snippet,
                        link: item.link
                    })).slice(0, 5);
                } catch (e) {
                    console.error('[Serper] ËØ∑Ê±ÇÂ§±Ë¥•:', e);
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØ CORS ÈóÆÈ¢ò
                    if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                        throw new Error('Serper API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñ CORS ÈôêÂà∂„ÄÇÂª∫ËÆÆÊ£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÂú®ÊúçÂä°Âô®ÁéØÂ¢ÉËøêË°å„ÄÇ');
                    }
                    throw e;
                }
            },
            zhipu: async (query, config) => {
                // Zhipu AIÁöÑÊêúÁ¥¢ÂäüËÉΩÈÄöÂ∏∏ÊòØÁõ¥Êé•ÁîüÊàêÁ≠îÊ°àÔºåËÄå‰∏çÊòØËøîÂõûÈìæÊé•ÂàóË°®„ÄÇ
                // ËøôÊòØ‰∏Ä‰∏™Âç†‰ΩçÁ¨¶ÂÆûÁé∞ÔºåÂ∞ÜÊù•ÂèØ‰ª•Ê†πÊçÆÂÖ∑‰ΩìAPIËøõË°åË∞ÉÊï¥„ÄÇ
                console.warn("Zhipu AI search is not a standard search provider and is used as a placeholder.");
                return [{
                    title: `ÂÖ≥‰∫é‚Äú${query}‚ÄùÁöÑAIÁîüÊàêÊëòË¶Å`,
                    snippet: "Êô∫ÊôÆAIÁöÑÊêúÁ¥¢ÂäüËÉΩ‰ºöÁõ¥Êé•ËøîÂõû‰∏Ä‰∏™ÁîüÊàêÁöÑÁ≠îÊ°àÔºåËÄå‰∏çÊòØ‰º†ÁªüÁöÑÊêúÁ¥¢ÁªìÊûúÂàóË°®„ÄÇÊ≠§ÂäüËÉΩÂæÖÂêéÁª≠Ê†πÊçÆÂÖ∂APIÁâπÊÄßËøõË°åÂÖ∑‰ΩìÂÆûÁé∞„ÄÇ",
                    link: "#"
                }];
            }
        };

        async function performWebSearch(query) {
            const searchConfig = store.apiConfig.search || {};
            const provider = searchConfig.provider || 'none';

            if (provider === 'none') {
                console.log("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠„ÄÇ");
                return null;
            }

            const config = {
                apiKey: provider === 'google' ? searchConfig.googleApiKey : (provider === 'serper' ? searchConfig.serperApiKey : searchConfig.zhipuApiKey),
                cx: searchConfig.googleCx
            };

            if (!config.apiKey) {
                throw new Error(`Êú™ÈÖçÁΩÆ ${provider} ÁöÑ API Key„ÄÇ`);
            }
            if (provider === 'google' && !config.cx) {
                throw new Error("Êú™ÈÖçÁΩÆ Google CX ID„ÄÇ");
            }

            try {
                let results = [];
                if (provider === 'google') {
                    results = await SearchService.google(query, config);
                } else if (provider === 'serper') {
                    results = await SearchService.serper(query, config);
                } else if (provider === 'zhipu') {
                    results = await SearchService.zhipu(query, config);
                }
                return results;
            } catch (e) {
                console.error("ÊêúÁ¥¢Â§±Ë¥•:", e);
                throw e; // Re-throw to be caught by the caller
            }
        }

        // --- [Vesper Agent] Êô∫ËÉΩÊÑèÂõæËØÜÂà´ÂºïÊìé ---

        /**
         * ÂêëAIËØ¢ÈóÆÊêúÁ¥¢ÊÑèÂõæÔºåAIÂü∫‰∫é‰∏ä‰∏ãÊñáÂàÜÊûêÁî®Êà∑ÁúüÊ≠£ÊÉ≥Êêú‰ªÄ‰πà
         * @param {string} toolType - Â∑•ÂÖ∑Á±ªÂûã: 'local' (Âú∞ÁÇπ) Êàñ 'web' (ËÅîÁΩë)
         * @param {Array} chatHistory - ËÅäÂ§©ÂéÜÂè≤
         * @param {string} currentInput - ÂΩìÂâçËæìÂÖ•Ê°ÜÂÜÖÂÆπ(ÂèØËÉΩ‰∏∫Á©∫)
         * @returns {Promise<string>} - AIÊé®Êñ≠ÁöÑÊêúÁ¥¢ÂÖ≥ÈîÆËØç
         */
        async function askAIForSearchIntent(toolType, chatHistory, currentInput = '') {
            const config = store.apiConfig?.main;
            if (!config?.url || !config?.key) {
                throw new Error('ËØ∑ÂÖàÈÖçÁΩÆAPI');
            }

            const toolDescription = toolType === 'local'
                ? 'Âú∞Âõæ/Âú∞ÁÇπÊêúÁ¥¢Â∑•ÂÖ∑ÔºàÊêúÁ¥¢ÈôÑËøëÁöÑÂ∫óÈì∫„ÄÅÂú∞ÁÇπ„ÄÅÂú∫ÊâÄÁ≠âÔºâ'
                : 'ËÅîÁΩëÊêúÁ¥¢Â∑•ÂÖ∑ÔºàÊêúÁ¥¢ÁΩëÁªú‰ø°ÊÅØ„ÄÅÊñ∞Èóª„ÄÅÁü•ËØÜÁ≠âÔºâ';

            // ÂèñÊúÄËøëÁöÑÂØπËØù‰Ωú‰∏∫‰∏ä‰∏ãÊñá
            const recentHistory = chatHistory.slice(-6).map(msg => {
                if (msg.hidden) return null;
                return `${msg.role === 'user' ? 'Áî®Êà∑' : 'AI'}: ${msg.content.substring(0, 200)}`;
            }).filter(Boolean).join('\n');

            const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÊÑèÂõæËØÜÂà´ÂºïÊìé„ÄÇÁî®Êà∑ÂàöÂàöÁÇπÂáª‰∫Ü${toolDescription}„ÄÇ
‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÂØπËØù‰∏ä‰∏ãÊñáÔºåÊé®Êñ≠Áî®Êà∑ÊúÄÂèØËÉΩÊÉ≥ÊêúÁ¥¢‰ªÄ‰πà„ÄÇ

ËßÑÂàôÔºö
1. Âè™ËæìÂá∫ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïËß£ÈáäÊàñÂ§ö‰ΩôÊñáÂ≠ó
2. ÂÖ≥ÈîÆËØçË¶ÅÁÆÄÊ¥ÅÁ≤æÂáÜÔºåÈÄÇÂêàÊêúÁ¥¢ÂºïÊìé‰ΩøÁî®
3. Â¶ÇÊûú‰∏ä‰∏ãÊñáÊèêÂà∞‰∫ÜÂÖ∑‰ΩìÂú∞ÁÇπ/ËØùÈ¢òÔºåÊèêÂèñÊ†∏ÂøÉËØç
4. Â¶ÇÊûúÁî®Êà∑ÂΩìÂâçËæìÂÖ•Ê°ÜÊúâÂÜÖÂÆπÔºå‰ºòÂÖà‰ΩøÁî®ËØ•ÂÜÖÂÆπ
5. Â¶ÇÊûúÂÆåÂÖ®Êó†Ê≥ïÊé®Êñ≠Ôºå${toolType === 'local' ? 'ËæìÂá∫"Âë®ËæπÁæéÈ£ü"' : 'ËæìÂá∫"‰ªäÊó•ÁÉ≠ÁÇπ"'}

Á§∫‰æãÔºö
- ÂØπËØùÊèêÂà∞"Â•ΩÈ•øÊÉ≥ÂêÉÈù¢" + Âú∞ÂõæÂ∑•ÂÖ∑ ‚Üí Èù¢È¶Ü
- ÂØπËØùÊèêÂà∞"ÊòéÂ§©Ë¶Å‰∏ãÈõ®Âêó" + ËÅîÁΩëÂ∑•ÂÖ∑ ‚Üí Â§©Ê∞îÈ¢ÑÊä•
- ÂØπËØùÊèêÂà∞"‰∫îÈáëÂ∫óÁúüÈöæÊâæ" + Âú∞ÂõæÂ∑•ÂÖ∑ ‚Üí ‰∫îÈáëÂ∫ó
- ÂØπËØùÊèêÂà∞"ÊúÄËøëÊúâ‰ªÄ‰πàÂ•ΩÁúãÁöÑÁîµÂΩ±" + ËÅîÁΩëÂ∑•ÂÖ∑ ‚Üí 2024ÁÉ≠Èó®ÁîµÂΩ±Êé®Ëçê`;

            const userPrompt = `ÂØπËØù‰∏ä‰∏ãÊñáÔºö
${recentHistory || '(Êó†ÊúÄËøëÂØπËØù)'}

${currentInput ? `Áî®Êà∑ÂΩìÂâçËæìÂÖ•Ê°ÜÂÜÖÂÆπÔºö${currentInput}` : 'Áî®Êà∑ÂΩìÂâçËæìÂÖ•Ê°Ü‰∏∫Á©∫'}

ËØ∑ËæìÂá∫ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºö`;

            const url = config.url.endsWith('/') ? config.url + 'chat/completions' : config.url + '/chat/completions';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.3, // ‰ΩéÊ∏©Â∫¶‰øùËØÅËæìÂá∫Á®≥ÂÆö
                        max_tokens: 50    // Âè™ÈúÄË¶ÅÁü≠ËæìÂá∫
                    })
                });

                if (!res.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${res.status}`);
                }

                const data = await res.json();
                const intent = data.choices?.[0]?.message?.content?.trim() || '';

                // Ê∏ÖÁêÜÂèØËÉΩÁöÑÂºïÂè∑ÊàñÂ§ö‰ΩôÁ¨¶Âè∑
                return intent.replace(/^["'`]|["'`]$/g, '').trim();
            } catch (e) {
                console.error('ÊÑèÂõæËØÜÂà´Â§±Ë¥•:', e);
                throw e;
            }
        }

        /**
         * Êô∫ËÉΩÂú∞ÁÇπÊêúÁ¥¢ - ÁÇπÂáªÊåâÈíÆÊó∂ÂàáÊç¢ÂæÖÊøÄÊ¥ªÁä∂ÊÄÅ
         * Êîπ‰∏∫ÔºöÁÇπÂáªÊåâÈíÆËøõÂÖ•ÂæÖÊú∫Áä∂ÊÄÅÔºåÁÇπÂáªÂèëÈÄÅÊåâÈíÆÂêéÊâçËß¶ÂèëÊêúÁ¥¢
         */
        function smartLocalSearch(chatType = 'character') {
            const isAiChat = chatType === 'ai';
            const btn = document.getElementById(isAiChat ? 'ai-local-search-btn' : 'local-search-btn');
            const webSearchBtn = document.getElementById(isAiChat ? 'ai-search-toggle-btn' : 'search-toggle-btn');

            if (isAiChat) {
                // ÂàáÊç¢Áä∂ÊÄÅ
                isAiLocalSearchEnabled = !isAiLocalSearchEnabled;
                // Â¶ÇÊûúÂºÄÂêØÂú∞ÁÇπÊêúÁ¥¢ÔºåÂÖ≥Èó≠ËÅîÁΩëÊêúÁ¥¢
                if (isAiLocalSearchEnabled) {
                    isAiSearchEnabled = false;
                    webSearchBtn?.classList.remove('active');
                    btn.classList.add('active');
                    updateAiChatStatus('Âú∞ÁÇπÊêúÁ¥¢Â∑≤ÊøÄÊ¥ªÔºåËØ∑ËæìÂÖ•ÂÜÖÂÆπÂêéÁÇπÂáªÂèëÈÄÅ', 'thinking', 0);
                } else {
                    btn.classList.remove('active');
                    updateAiChatStatus('Âú®Á∫ø', 'info', 0);
                }
            } else {
                // ÂàáÊç¢Áä∂ÊÄÅ
                isLocalSearchEnabled = !isLocalSearchEnabled;
                // Â¶ÇÊûúÂºÄÂêØÂú∞ÁÇπÊêúÁ¥¢ÔºåÂÖ≥Èó≠ËÅîÁΩëÊêúÁ¥¢
                if (isLocalSearchEnabled) {
                    isSearchEnabled = false;
                    webSearchBtn?.classList.remove('active');
                    btn.classList.add('active');
                    updateChatStatus('Âú∞ÁÇπÊêúÁ¥¢Â∑≤ÊøÄÊ¥ªÔºåËØ∑ËæìÂÖ•ÂêéÁÇπÂèëÈÄÅ', 'thinking');
                } else {
                    btn.classList.remove('active');
                    updateChatStatus('Âú®Á∫ø', 'online');
                }
            }
        }

        /**
         * Êô∫ËÉΩËÅîÁΩëÊêúÁ¥¢ - ÁÇπÂáªÊåâÈíÆÊó∂ÂàáÊç¢ÂæÖÊøÄÊ¥ªÁä∂ÊÄÅ
         * Êîπ‰∏∫ÔºöÁÇπÂáªÊåâÈíÆËøõÂÖ•ÂæÖÊú∫Áä∂ÊÄÅÔºåÁÇπÂáªÂèëÈÄÅÊåâÈíÆÂêéÊâçËß¶ÂèëÊêúÁ¥¢
         */
        function smartWebSearch(chatType = 'character') {
            const isAiChat = chatType === 'ai';
            const btn = document.getElementById(isAiChat ? 'ai-search-toggle-btn' : 'search-toggle-btn');
            const localSearchBtn = document.getElementById(isAiChat ? 'ai-local-search-btn' : 'local-search-btn');

            if (isAiChat) {
                // ÂàáÊç¢Áä∂ÊÄÅ
                isAiSearchEnabled = !isAiSearchEnabled;
                // Â¶ÇÊûúÂºÄÂêØËÅîÁΩëÊêúÁ¥¢ÔºåÂÖ≥Èó≠Âú∞ÁÇπÊêúÁ¥¢
                if (isAiSearchEnabled) {
                    isAiLocalSearchEnabled = false;
                    localSearchBtn?.classList.remove('active');
                    btn.classList.add('active');
                    updateAiChatStatus('ËÅîÁΩëÊêúÁ¥¢Â∑≤ÊøÄÊ¥ªÔºåËØ∑ËæìÂÖ•ÂÜÖÂÆπÂêéÁÇπÂáªÂèëÈÄÅ', 'thinking', 0);
                } else {
                    btn.classList.remove('active');
                    updateAiChatStatus('Âú®Á∫ø', 'info', 0);
                }
            } else {
                // ÂàáÊç¢Áä∂ÊÄÅ
                isSearchEnabled = !isSearchEnabled;
                // Â¶ÇÊûúÂºÄÂêØËÅîÁΩëÊêúÁ¥¢ÔºåÂÖ≥Èó≠Âú∞ÁÇπÊêúÁ¥¢
                if (isSearchEnabled) {
                    isLocalSearchEnabled = false;
                    localSearchBtn?.classList.remove('active');
                    btn.classList.add('active');
                    updateChatStatus('ËÅîÁΩëÊêúÁ¥¢Â∑≤ÊøÄÊ¥ªÔºåËØ∑ËæìÂÖ•ÂêéÁÇπÂèëÈÄÅ', 'thinking');
                } else {
                    btn.classList.remove('active');
                    updateChatStatus('Âú®Á∫ø', 'online');
                }
            }
        }

        /**
         * ÊâßË°åÊô∫ËÉΩËÅîÁΩëÊêúÁ¥¢ - Âú®ÂèëÈÄÅÊ∂àÊÅØÊó∂Ë∞ÉÁî®
         * ‰ºöÂÖàËÆ©AIÂàÜÊûêÊÑèÂõæÔºåÁÑ∂ÂêéÊâßË°åÊêúÁ¥¢
         */
        async function executeSmartWebSearch(chatType = 'character') {
            const isAiChat = chatType === 'ai';
            const inputEl = document.getElementById(isAiChat ? 'ai-input' : 'character-chat-input');
            const btn = document.getElementById(isAiChat ? 'ai-search-toggle-btn' : 'search-toggle-btn');
            const chatHistory = isAiChat ? store.aiChatHistory : (currentChatCharacter?.chatHistory || []);

            const currentInput = inputEl.value.trim();

            // 1. UIÂèçÈ¶àÔºöAIÊ≠£Âú®ÊÄùËÄÉ
            const originalPlaceholder = inputEl.placeholder;
            inputEl.value = '';
            inputEl.placeholder = 'üß† Vesper Ê≠£Âú®ÂàÜÊûêÊÑèÂõæÂπ∂ÊêúÁ¥¢...';
            inputEl.disabled = true;

            if (isAiChat) {
                updateAiChatStatus('Ê≠£Âú®ÂàÜÊûêÊÑèÂõæ...', 'thinking', 0);
            } else {
                updateChatStatus('Ê≠£Âú®ÂàÜÊûêÊÑèÂõæ...', 'thinking');
            }

            try {
                // 2. ËÆ©AIÂàÜÊûêÊÑèÂõæÔºàÂ¶ÇÊûúËæìÂÖ•Ê°ÜÊúâÂÜÖÂÆπÁõ¥Êé•‰ΩøÁî®ÔºåÂê¶ÂàôÂàÜÊûê‰∏ä‰∏ãÊñáÔºâ
                let searchQuery = currentInput;
                if (!searchQuery) {
                    searchQuery = await askAIForSearchIntent('web', chatHistory, '');
                }
                console.log(`[Vesper Agent] ËÅîÁΩëÊêúÁ¥¢: "${searchQuery}"`);

                // 3. ÊÅ¢Â§çËæìÂÖ•Ê°Ü
                inputEl.disabled = false;
                inputEl.placeholder = originalPlaceholder;

                // 4. ÊâßË°åÊêúÁ¥¢
                if (isAiChat) {
                    await aiHandleSearchAndReply(searchQuery);
                    // ÊêúÁ¥¢ÂÆåÊàêÂêéÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè
                    isAiSearchEnabled = false;
                    btn?.classList.remove('active');
                } else {
                    await handleSearchAndReply(searchQuery);
                    // ÊêúÁ¥¢ÂÆåÊàêÂêéÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè
                    isSearchEnabled = false;
                    btn?.classList.remove('active');
                }

            } catch (error) {
                // ÊÅ¢Â§çÁä∂ÊÄÅ
                inputEl.disabled = false;
                inputEl.placeholder = originalPlaceholder;
                inputEl.value = currentInput;

                if (isAiChat) {
                    updateAiChatStatus('Âú®Á∫ø', 'info', 0);
                } else {
                    updateChatStatus('Âú®Á∫ø', 'online');
                }

                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
            }
        }

        /**
         * ÊâßË°åÊô∫ËÉΩÂú∞ÁÇπÊêúÁ¥¢ - Âú®ÂèëÈÄÅÊ∂àÊÅØÊó∂Ë∞ÉÁî®
         * ‰ºöÂÖàËÆ©AIÂàÜÊûêÊÑèÂõæÔºåÁÑ∂ÂêéÊâßË°åÊêúÁ¥¢
         */
        async function executeSmartLocalSearch(chatType = 'character') {
            const isAiChat = chatType === 'ai';
            const inputEl = document.getElementById(isAiChat ? 'ai-input' : 'character-chat-input');
            const btn = document.getElementById(isAiChat ? 'ai-local-search-btn' : 'local-search-btn');
            const chatHistory = isAiChat ? store.aiChatHistory : (currentChatCharacter?.chatHistory || []);

            const currentInput = inputEl.value.trim();

            // 1. UIÂèçÈ¶àÔºöAIÊ≠£Âú®ÊÄùËÄÉ
            const originalPlaceholder = inputEl.placeholder;
            inputEl.value = '';
            inputEl.placeholder = 'üß† Vesper Ê≠£Âú®ÂàÜÊûêÊÑèÂõæÂπ∂ÊêúÁ¥¢...';
            inputEl.disabled = true;

            if (isAiChat) {
                updateAiChatStatus('Ê≠£Âú®ÂàÜÊûêÊÑèÂõæ...', 'thinking', 0);
            } else {
                updateChatStatus('Ê≠£Âú®ÂàÜÊûêÊÑèÂõæ...', 'thinking');
            }

            try {
                // 2. ËÆ©AIÂàÜÊûêÊÑèÂõæÔºàÂ¶ÇÊûúËæìÂÖ•Ê°ÜÊúâÂÜÖÂÆπÁõ¥Êé•‰ΩøÁî®ÔºåÂê¶ÂàôÂàÜÊûê‰∏ä‰∏ãÊñáÔºâ
                let searchQuery = currentInput;
                if (!searchQuery) {
                    searchQuery = await askAIForSearchIntent('local', chatHistory, '');
                }
                console.log(`[Vesper Agent] Âú∞ÁÇπÊêúÁ¥¢: "${searchQuery}"`);

                // 3. ÊÅ¢Â§çËæìÂÖ•Ê°Ü
                inputEl.disabled = false;
                inputEl.placeholder = originalPlaceholder;

                // 4. ÊâßË°åÊêúÁ¥¢
                if (isAiChat) {
                    await aiHandleLocalSearchAndReply(searchQuery);
                    // ÊêúÁ¥¢ÂÆåÊàêÂêéÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè
                    isAiLocalSearchEnabled = false;
                    btn?.classList.remove('active');
                } else {
                    await handleLocalSearchAndReply(searchQuery);
                    // ÊêúÁ¥¢ÂÆåÊàêÂêéÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè
                    isLocalSearchEnabled = false;
                    btn?.classList.remove('active');
                }

            } catch (error) {
                // ÊÅ¢Â§çÁä∂ÊÄÅ
                inputEl.disabled = false;
                inputEl.placeholder = originalPlaceholder;
                inputEl.value = currentInput;

                if (isAiChat) {
                    updateAiChatStatus('Âú®Á∫ø', 'info', 0);
                } else {
                    updateChatStatus('Âú®Á∫ø', 'online');
                }

                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
            }
        }

        // --- [Vesper] È´òÂæ∑Âú∞ÂõæÂú∞ÁÇπÊêúÁ¥¢ÂäüËÉΩ ---

        async function performLocalSearch(keyword) {
            const apiKey = localStorage.getItem('vesper_amap_key');
            if (!apiKey) {
                throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂú∞Âõæ Key');
            }
            const city = localStorage.getItem('vesper_amap_city') || '';
            const url = `https://restapi.amap.com/v3/place/text?keywords=${encodeURIComponent(keyword)}&city=${encodeURIComponent(city)}&key=${apiKey}&offset=10`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`È´òÂæ∑APIËØ∑Ê±ÇÂ§±Ë¥•: ${res.status}`);
                const data = await res.json();

                if (data.status !== '1') {
                    throw new Error(data.info || 'È´òÂæ∑APIËøîÂõûÈîôËØØ');
                }

                if (!data.pois || data.pois.length === 0) {
                    return [];
                }

                return data.pois.map(poi => ({
                    name: poi.name,
                    address: poi.address || 'Êó†ËØ¶ÁªÜÂú∞ÂùÄ',
                    type: poi.type || '',
                    tel: poi.tel || '',
                    location: poi.location || '',
                    distance: poi.distance || '',
                    cityname: poi.cityname || '',
                    adname: poi.adname || ''
                }));
            } catch (e) {
                console.error("Âú∞ÁÇπÊêúÁ¥¢Â§±Ë¥•:", e);
                throw e;
            }
        }

        // ‰ø°ÊÅØÁÆ°ÁêÜÈ°µÈù¢ÁöÑÂú∞ÁÇπÊêúÁ¥¢ÂºÄÂÖ≥
        function toggleLocalSearch() {
            isLocalSearchEnabled = !isLocalSearchEnabled;
            const btn = document.getElementById('local-search-btn');
            if (isLocalSearchEnabled) {
                btn.classList.add('active');
                updateChatStatus('Âú∞ÁÇπÊêúÁ¥¢Â∑≤ÊøÄÊ¥ª', 'thinking');
            } else {
                btn.classList.remove('active');
                updateChatStatus('Âú®Á∫ø', 'online');
            }
        }

        // AIÂä©ÊâãÈ°µÈù¢ÁöÑÂú∞ÁÇπÊêúÁ¥¢ÂºÄÂÖ≥
        function aiToolToggleLocalSearch() {
            isAiLocalSearchEnabled = !isAiLocalSearchEnabled;
            const btn = document.getElementById('ai-local-search-btn');
            const aiStatusDiv = document.querySelector('#panel-ai-assistant .header div > div:last-child');
            if (isAiLocalSearchEnabled) {
                btn.classList.add('active');
                if(aiStatusDiv) aiStatusDiv.textContent = 'Âú∞ÁÇπÊêúÁ¥¢Â∑≤ÊøÄÊ¥ª';
            } else {
                btn.classList.remove('active');
                if(aiStatusDiv) aiStatusDiv.textContent = 'Âú®Á∫ø';
            }
        }

        // ‰ø°ÊÅØÁÆ°ÁêÜÈ°µÈù¢Â§ÑÁêÜÂú∞ÁÇπÊêúÁ¥¢
        async function handleLocalSearchAndReply(query) {
            updateChatStatus('Ê≠£Âú®ÊêúÁ¥¢Âú∞ÁÇπ...', 'thinking');
            const input = document.getElementById('character-chat-input');
            input.value = '';

            try {
                const results = await performLocalSearch(query);
                toggleLocalSearch(); // ÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè

                let systemInstruction;
                if (results.length === 0) {
                    systemInstruction = `[System Instruction]: I performed a local place search for "${query}" but found no results. Inform the user about this and try to provide general information about what they're looking for.`;
                } else {
                    const searchResultsText = results.map((r, i) =>
                        `[${i + 1}] ${r.name}\nÂú∞ÂùÄ: ${r.address}\nÁ±ªÂûã: ${r.type}\nÁîµËØù: ${r.tel || 'Êó†'}\nÂå∫Âüü: ${r.cityname}${r.adname}`
                    ).join('\n\n');
                    systemInstruction = `[System Instruction]: I performed a local place search for "${query}" using AMAP (È´òÂæ∑Âú∞Âõæ). Here are the results. Use this information to help the user. You can recommend places, provide directions advice, or answer questions about these locations.

Local Search Results:
---
${searchResultsText}
---
`;
                }

                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user',
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                const userMsg = {
                    role: 'user',
                    content: `üó∫Ô∏è ÊêúÁ¥¢Âú∞ÁÇπ: ${query}`,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);

                triggerCharacterAIResponse();

            } catch (error) {
                alert(`Âú∞ÁÇπÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
                toggleLocalSearch();
            }
        }

        // AIÂä©ÊâãÈ°µÈù¢Â§ÑÁêÜÂú∞ÁÇπÊêúÁ¥¢
        async function aiHandleLocalSearchAndReply(query) {
            const aiStatusDiv = document.querySelector('#panel-ai-assistant .header div > div:last-child');
            if(aiStatusDiv) aiStatusDiv.textContent = 'Ê≠£Âú®ÊêúÁ¥¢Âú∞ÁÇπ...';

            const input = document.getElementById('ai-input');
            input.value = '';

            try {
                const results = await performLocalSearch(query);
                aiToolToggleLocalSearch(); // ÂÖ≥Èó≠ÊêúÁ¥¢Ê®°Âºè

                let systemInstruction;
                if (results.length === 0) {
                    systemInstruction = `[System Instruction]: I performed a local place search for "${query}" but found no results. Inform the user about this and try to provide general information about what they're looking for.`;
                } else {
                    const searchResultsText = results.map((r, i) =>
                        `[${i + 1}] ${r.name}\nÂú∞ÂùÄ: ${r.address}\nÁ±ªÂûã: ${r.type}\nÁîµËØù: ${r.tel || 'Êó†'}\nÂå∫Âüü: ${r.cityname}${r.adname}`
                    ).join('\n\n');
                    systemInstruction = `[System Instruction]: I performed a local place search for "${query}" using AMAP (È´òÂæ∑Âú∞Âõæ). Here are the results. Use this information to help the user. You can recommend places, provide directions advice, or answer questions about these locations.

Local Search Results:
---
${searchResultsText}
---
`;
                }

                store.aiChatHistory.push({ role: 'system', content: systemInstruction, hidden: true });

                input.value = `üó∫Ô∏è ÊêúÁ¥¢Âú∞ÁÇπ: ${query}`;
                await sendAiMessage();

            } catch (error) {
                alert(`Âú∞ÁÇπÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                if(aiStatusDiv) aiStatusDiv.textContent = 'Âú®Á∫ø';
                aiToolToggleLocalSearch();
            }
        }

        async function handleSearchAndReply(query) {
            updateChatStatus('Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...', 'thinking');
            const input = document.getElementById('character-chat-input');
            input.value = ''; // Clear input after sending

            try {
                const results = await performWebSearch(query);
                
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÂÖàÂÖ≥Èó≠ÊêúÁ¥¢ÂºÄÂÖ≥
                toggleWebSearch();

                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                if (results.length === 0) {
                    // Âç≥‰ΩøÊ≤°ÊúâÁªìÊûúÔºå‰πüËÆ©AIÁü•ÈÅìÊàë‰ª¨Â∞ùËØïÊêúÁ¥¢‰∫Ü
                    const noResultText = `ÊàëÊêúÁ¥¢‰∫Ü‚Äú${query}‚ÄùÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞Áõ¥Êé•Áõ∏ÂÖ≥ÁöÑÁªìÊûú„ÄÇ`;
                    input.value = noResultText;
                    await sendCharacterMessage(); // This will now send as a normal message
                    triggerCharacterAIResponse();
                    return;
                }

                // Ê†ºÂºèÂåñÊêúÁ¥¢ÁªìÊûú
                const searchResultsText = results.map((r, i) => 
                    `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                ).join('\n\n');

                const systemInstruction = `[System Instruction]: I performed a web search for "${query}". The following are the top search results. Use this information to answer my query. Synthesize the information to provide a comprehensive answer, don't just list the results.

Web Search Results:
---
${searchResultsText}
---
`;
                // Â∞ÜÊêúÁ¥¢ÁªìÊûú‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‰∏ä‰∏ãÊñá
                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user', // Treat as user-provided context
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true // This message will not be rendered in the UI
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                // Âú®UI‰∏äÊòæÁ§∫Áî®Êà∑ÁöÑÂéüÂßãÈóÆÈ¢ò
                const userMsg = {
                    role: 'user',
                    content: query,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);
                
                // Ëß¶ÂèëAIÂõûÂ§ç
                triggerCharacterAIResponse();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
                toggleWebSearch(); //Á°Æ‰øùÂºÄÂÖ≥ÂÖ≥Èó≠
            }
        }

        async function handleSearchAndReply(query) {
            updateChatStatus('Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...', 'thinking');
            const input = document.getElementById('character-chat-input');
            input.value = ''; // Clear input after sending

            try {
                const results = await performWebSearch(query);
                
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÂÖàÂÖ≥Èó≠ÊêúÁ¥¢ÂºÄÂÖ≥
                toggleWebSearch();

                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                if (results.length === 0) {
                    // Âç≥‰ΩøÊ≤°ÊúâÁªìÊûúÔºå‰πüËÆ©AIÁü•ÈÅìÊàë‰ª¨Â∞ùËØïÊêúÁ¥¢‰∫Ü
                    const noResultText = `ÊàëÊêúÁ¥¢‰∫Ü‚Äú${query}‚ÄùÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞Áõ¥Êé•Áõ∏ÂÖ≥ÁöÑÁªìÊûú„ÄÇ`;
                    input.value = noResultText;
                    await sendCharacterMessage(); // This will now send as a normal message
                    triggerCharacterAIResponse();
                    return;
                }

                // Ê†ºÂºèÂåñÊêúÁ¥¢ÁªìÊûú
                const searchResultsText = results.map((r, i) => 
                    `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                ).join('\n\n');

                const systemInstruction = `[System Instruction]: I performed a web search for "${query}". The following are the top search results. Use this information to answer my query. Synthesize the information to provide a comprehensive answer, don't just list the results.

Web Search Results:
---
${searchResultsText}
---
`;
                // Â∞ÜÊêúÁ¥¢ÁªìÊûú‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‰∏ä‰∏ãÊñá
                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user', // Treat as user-provided context
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true // This message will not be rendered in the UI
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                // Âú®UI‰∏äÊòæÁ§∫Áî®Êà∑ÁöÑÂéüÂßãÈóÆÈ¢ò
                const userMsg = {
                    role: 'user',
                    content: query,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);
                
                // Ëß¶ÂèëAIÂõûÂ§ç
                triggerCharacterAIResponse();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
                toggleWebSearch(); //Á°Æ‰øùÂºÄÂÖ≥ÂÖ≥Èó≠
            }
        }

        async function handleSearchAndReply(query) {
            updateChatStatus('Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...', 'thinking');
            const input = document.getElementById('character-chat-input');
            input.value = ''; // Clear input after sending

            try {
                const results = await performWebSearch(query);
                
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÂÖàÂÖ≥Èó≠ÊêúÁ¥¢ÂºÄÂÖ≥
                toggleWebSearch();

                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                if (results.length === 0) {
                    // Âç≥‰ΩøÊ≤°ÊúâÁªìÊûúÔºå‰πüËÆ©AIÁü•ÈÅìÊàë‰ª¨Â∞ùËØïÊêúÁ¥¢‰∫Ü
                    const noResultText = `ÊàëÊêúÁ¥¢‰∫Ü‚Äú${query}‚ÄùÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞Áõ¥Êé•Áõ∏ÂÖ≥ÁöÑÁªìÊûú„ÄÇ`;
                    input.value = noResultText;
                    await sendCharacterMessage(); // This will now send as a normal message
                    triggerCharacterAIResponse();
                    return;
                }

                // Ê†ºÂºèÂåñÊêúÁ¥¢ÁªìÊûú
                const searchResultsText = results.map((r, i) => 
                    `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                ).join('\n\n');

                const systemInstruction = `[System Instruction]: I performed a web search for "${query}". The following are the top search results. Use this information to answer my query. Synthesize the information to provide a comprehensive answer, don't just list the results.

Web Search Results:
---
${searchResultsText}
---
`;
                // Â∞ÜÊêúÁ¥¢ÁªìÊûú‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‰∏ä‰∏ãÊñá
                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user', // Treat as user-provided context
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true // This message will not be rendered in the UI
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                // Âú®UI‰∏äÊòæÁ§∫Áî®Êà∑ÁöÑÂéüÂßãÈóÆÈ¢ò
                const userMsg = {
                    role: 'user',
                    content: query,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);
                
                // Ëß¶ÂèëAIÂõûÂ§ç
                triggerCharacterAIResponse();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
                toggleWebSearch(); //Á°Æ‰øùÂºÄÂÖ≥ÂÖ≥Èó≠
            }
        }

        async function handleSearchAndReply(query) {
            updateChatStatus('Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...', 'thinking');
            const input = document.getElementById('character-chat-input');
            input.value = ''; // Clear input after sending

            try {
                const results = await performWebSearch(query);
                
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÂÖàÂÖ≥Èó≠ÊêúÁ¥¢ÂºÄÂÖ≥
                toggleWebSearch();

                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                if (results.length === 0) {
                    // Âç≥‰ΩøÊ≤°ÊúâÁªìÊûúÔºå‰πüËÆ©AIÁü•ÈÅìÊàë‰ª¨Â∞ùËØïÊêúÁ¥¢‰∫Ü
                    const noResultText = `ÊàëÊêúÁ¥¢‰∫Ü‚Äú${query}‚ÄùÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞Áõ¥Êé•Áõ∏ÂÖ≥ÁöÑÁªìÊûú„ÄÇ`;
                    input.value = noResultText;
                    await sendCharacterMessage(); // This will now send as a normal message
                    triggerCharacterAIResponse();
                    return;
                }

                // Ê†ºÂºèÂåñÊêúÁ¥¢ÁªìÊûú
                const searchResultsText = results.map((r, i) => 
                    `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                ).join('\n\n');

                const systemInstruction = `[System Instruction]: I performed a web search for "${query}". The following are the top search results. Use this information to answer my query. Synthesize the information to provide a comprehensive answer, don't just list the results.

Web Search Results:
---
${searchResultsText}
---
`;
                // Â∞ÜÊêúÁ¥¢ÁªìÊûú‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‰∏ä‰∏ãÊñá
                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user', // Treat as user-provided context
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true // This message will not be rendered in the UI
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                // Âú®UI‰∏äÊòæÁ§∫Áî®Êà∑ÁöÑÂéüÂßãÈóÆÈ¢ò
                const userMsg = {
                    role: 'user',
                    content: query,
                    timestamp: Date.now()
                };
                currentChatCharacter.chatHistory.push(userMsg);
                await db.characters.put(currentChatCharacter);
                appendCharacterMessage(userMsg);
                
                // Ëß¶ÂèëAIÂõûÂ§ç
                triggerCharacterAIResponse();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
                toggleWebSearch(); //Á°Æ‰øùÂºÄÂÖ≥ÂÖ≥Èó≠
            }
        }

        async function toolPerformSearch() {
            const query = prompt("ËØ∑ËæìÂÖ•Ë¶ÅÊêúÁ¥¢ÁöÑÂÜÖÂÆπ:");
            if (!query || !query.trim()) return;

            updateChatStatus('Ê≠£Âú®ËÅîÁΩëÊêúÁ¥¢...', 'thinking');

            try {
                const results = await performWebSearch(query);
                if (results === null) {
                    alert("ÊêúÁ¥¢ÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåËØ∑Âú®APIËÆæÁΩÆ‰∏≠ÂºÄÂêØ„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                if (results.length === 0) {
                    alert("Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú„ÄÇ");
                    updateChatStatus('Âú®Á∫ø', 'online');
                    return;
                }

                // Ê†ºÂºèÂåñÊêúÁ¥¢ÁªìÊûú
                const searchResultsText = results.map((r, i) => 
                    `[${i + 1}] ${r.title}\n"${r.snippet}"\nSource: ${r.link}`
                ).join('\n\n');

                const systemInstruction = `[System Instruction]: User performed a web search for "${query}". The following are the top search results. Use this information to answer the user's next prompt. Do not just list the results; synthesize the information to provide a comprehensive answer.

Web Search Results:
---
${searchResultsText}
---
`;
                // Â∞ÜÊêúÁ¥¢ÁªìÊûú‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‰∏ä‰∏ãÊñá
                if (currentChatCharacter) {
                    const hiddenMsg = {
                        role: 'user', // Treat as user-provided context
                        content: systemInstruction,
                        timestamp: Date.now(),
                        hidden: true // This message will not be rendered in the UI
                    };
                    currentChatCharacter.chatHistory.push(hiddenMsg);
                    await db.characters.put(currentChatCharacter);
                }

                // Âú®ËæìÂÖ•Ê°Ü‰∏≠ÊîæÂÖ•ÊèêÁ§∫ÔºåÂπ∂Ëß¶ÂèëAIÂõûÂ§ç
                const chatInput = document.getElementById('character-chat-input');
                chatInput.value = `ÊàëÊêúÁ¥¢‰∫Ü‚Äú${query}‚ÄùÔºåËØ∑Ê†πÊçÆÊêúÁ¥¢ÁªìÊûúÂõûÁ≠î„ÄÇ`;
                
                await sendCharacterMessage();
                triggerCharacterAIResponse();

            } catch (error) {
                alert(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
                updateChatStatus('Âú®Á∫ø', 'online');
            }
        }


        // Redefine Context Menu Action for AI Assistant
        function contextMenuAction(action) {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('active');

            switch(action) {
                case 'copy':
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = decodeHtmlEntities(currentContextMsgContent);
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    alert('ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    break;
                case 'edit':
                    const newContent = prompt('ÁºñËæëÊ∂àÊÅØÂÜÖÂÆπ:', decodeHtmlEntities(currentContextMsgContent));
                    if(newContent && newContent.trim()) {
                        const msgEl = document.getElementById(`msg-${currentContextMsgId}-${currentContextMsgType}`);
                        if(msgEl) {
                            const contentDiv = msgEl.querySelector('.markdown-content') || msgEl.querySelector('div > div');
                            if(contentDiv) {
                                if(currentContextMsgType === 'ai') {
                                    contentDiv.innerHTML = renderMarkdown(newContent);
                                } else {
                                    contentDiv.textContent = newContent;
                                }
                                msgEl.dataset.msgContent = escapeHtml(newContent);
                                store.aiChatHistory.forEach(msg => {
                                    if(msg.content === decodeHtmlEntities(currentContextMsgContent)) {
                                        msg.content = newContent;
                                    }
                                });
                                saveData();
                            }
                        }
                    }
                    break;
                case 'retry':
                    if(currentContextMsgType === 'ai' || currentContextMsgType === 'error') {
                        retryMessage(decodeHtmlEntities(currentContextUserMsg), currentContextMsgId);
                    }
                    break;
                case 'quote':
                    const input = document.getElementById('ai-input');
                    input.value = `> ${decodeHtmlEntities(currentContextMsgContent)}\n\n`;
                    input.focus();
                    break;
                case 'delete':
                    deleteMessage(currentContextMsgId);
                    break;
                case 'hide':
                    // For AI assistant, store uses store.aiChatHistory array
                    // We need to find the message in store.aiChatHistory and mark it
                    // Note: deleteMessage uses exact content matching or index finding logic
                    // We need to implement finding it.
                    // Or simpler: just modify content to say [Withdrawn] and let it be?
                    // User wants "Withdraw (AI context has info)".
                    // If I add hidden prop, renderAiChatHistory needs update.
                    if(confirm("Êí§ÂõûÊ∂àÊÅØ (AI‰ªçÂèØËßÅ)?")) {
                        // Find message in history. 
                        // Note: store.aiChatHistory contains objects {role, content}
                        // We use content to match
                        const targetContent = decodeHtmlEntities(currentContextMsgContent);
                        const foundMsg = store.aiChatHistory.find(m => m.content === targetContent);
                        if(foundMsg) {
                            foundMsg.hidden = true;
                            foundMsg.content = "[User Withdrew Message] Original: " + foundMsg.content;
                            saveData();
                            renderAiChatHistory();
                        }
                    }
                    break;
            }
        }

        async function generateSummary(character) {
            if(!character.settings.autoSummary) return;
            if(!store.apiConfig.sub.url || !store.apiConfig.sub.key) {
                console.warn('Auto Summary skipped: Sub API not configured');
                return;
            }

            const threshold = character.settings.summaryInterval || 10;
            // Get recent context (last threshold messages)
            const recentParams = character.chatHistory.slice(-threshold);
            if(recentParams.length === 0) return;
            
            const contextText = recentParams.map(m => `${m.role}: ${m.content}`).join('\n');
            const nowStr = new Date().toLocaleString('zh-CN', { hour12: false });

            const summaryPrompt = `[ Memory Protocol ]
„ÄêÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥„Äë: ${nowStr}

‰Ω†ÊòØÂΩìÂâçËßíËâ≤ÁöÑÂêéÂè∞ËÆ∞ÂøÜÊï¥ÁêÜÁ®ãÂ∫è„ÄÇ ‰Ω†ÁöÑ‰ªªÂä°ÊòØËØªÂèñÊúÄËøë20Êù°ÁöÑ„ÄêÁü≠ÊúüÂØπËØùÁâáÊÆµ„ÄëÔºåÂπ∂Â∞ÜÂÖ∂ÊÄªÁªì‰∏∫‰∏ÄÊÆµÂÆåÊï¥ÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑ„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ÁöÑÈïøÊúüËÆ∞ÂøÜ„Äë„ÄÇ
Ë¶ÅÊ±ÇÔºö
1. **ÂøÖÈ°ªÂü∫‰∫é„ÄêÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥„ÄëËÆ∞ÂΩï‰∫ã‰ª∂ÂèëÁîüÁöÑÂáÜÁ°ÆÊó∂Èó¥ÁÇπ„ÄÇ**
2. Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºö ÂøÖÈ°ª‰ª•ÂΩìÂâçËßíËâ≤ÔºàÂ¶Ç "Êàë"ÔºâÁöÑËßíÂ∫¶ÂèôËø∞„ÄÇ
3. ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØÔºö [Êó•Êúü|Êó∂Èó¥]Áî®ÂèôËø∞ÁöÑËßíÂ∫¶ÊèèËø∞Áî®Êà∑Âú®Ëøô‰∫õÊó∂Èó¥ÈáåÂÅö‰∫Ü‰ªÄ‰πàÔºüÊàë‰ª¨ÁöÑÂÖ≥Á≥ªÊúâ‰ªÄ‰πàËøõÂ±ïÔºüÊúâ‰ªÄ‰πàÂæÖÂäû‰∫ãÈ°πÔºü
4. ÊÉÖÁª™Ê†áËÆ∞Ôºö Âú®Êã¨Âè∑ÂÜÖÊ†áËÆ∞ÂΩìÂâçÊàëÊÑüÁü•Âà∞ÁöÑÁî®Êà∑ÊÉÖÁª™‰ª•ÂèäÊàëÁöÑÂøÉÂ£∞ÊÉ≥Ê≥ï„ÄÇ
5. ÂéªÊ∞¥Ôºö Âà†Èô§ÊâÄÊúâÂØíÊöÑ„ÄÅÂ∫üËØù„ÄÇ

Ê†ºÂºèÁ§∫‰æãÔºö ‚Äú[2026/1/18 14:30] Â°îÊãâ‰ªäÂ§©ÂæàÁÑ¶ËôëÔºåÂêëÊàëÊä±ÊÄ®‰∫ÜËÄÉÁ†îËøõÂ∫¶ÔºàÁÑ¶ËôëÁ≠âÁ∫ß: È´òÔºâ„ÄÇÊàëÂ∏ÆÂ•πÊãÜËß£‰∫ÜÊï∞Â≠¶Â§ç‰π†ËÆ°ÂàíÔºåÂ•π‰ºº‰πéÂπ≥Èùô‰∫Ü‰∏Ä‰∫õ„ÄÇÊàë‰ª¨ÈúÄË¶ÅÂú®ÊòéÊôöÊ£ÄÊü•Â•πÁöÑÂÆåÊàêÊÉÖÂÜµ„ÄÇ‚Äù

„ÄêÁü≠ÊúüÂØπËØùÁâáÊÆµ„ÄëÔºö
${contextText}`;

            try {
                const statusEl = document.getElementById('character-chat-status-bar');
                if(statusEl) { statusEl.style.display = 'block'; statusEl.textContent = '‚ö° Ê≠£Âú®Êï¥ÁêÜÈïøÊúüËÆ∞ÂøÜ...'; }

                const config = store.apiConfig.sub;
                const url = config.url.endsWith('/') ? config.url + 'chat/completions' : config.url + '/chat/completions';
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [{ role: 'user', content: summaryPrompt }],
                        temperature: 0.5
                    })
                });

                if(!res.ok) throw new Error('Sub API Error');
                const data = await res.json();
                const summary = data.choices?.[0]?.message?.content;

                if(summary) {
                    if(!character.longTermMemory) character.longTermMemory = [];
                    // Add timestamp
                    const entry = `[${new Date().toLocaleString()}] ${summary}`;
                    character.longTermMemory.push(entry);
                    await db.characters.put(character);
                    
                    if(statusEl) { statusEl.textContent = '‚úÖ ËÆ∞ÂøÜÂ∑≤ÂΩíÊ°£'; setTimeout(() => { statusEl.style.display = 'none'; }, 3000); }
                }

            } catch(e) {
                console.error('Summary Generation Failed:', e);
                const statusEl = document.getElementById('character-chat-status-bar');
                if(statusEl) { statusEl.style.display = 'none'; }
            }
        }

        function openMemoryLibrary() {
            if(!currentChatCharacter) return;
            const list = document.getElementById('memory-library-list');
            list.innerHTML = '';
            
            if(!currentChatCharacter.longTermMemory || currentChatCharacter.longTermMemory.length === 0) {
                list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:20px;">ÊöÇÊó†ÈïøÊúüËÆ∞ÂøÜ„ÄÇËÅäÂæóÂ§ö‰∫ÜÂ∞±‰ºöÊúâÁöÑ„ÄÇ</div>';
            } else {
                // Reverse to show newest first
                [...currentChatCharacter.longTermMemory].reverse().forEach((mem, index) => {
                    // mem string format: [Date] content
                    const match = mem.match(/^\[(.*?)\]\s*(.*)/);
                    let time = '', content = mem;
                    if(match) { time = match[1]; content = match[2]; }
                    const realIndex = currentChatCharacter.longTermMemory.length - 1 - index;
                    
                    list.innerHTML += `
                        <div style="background:rgba(0,0,0,0.03); padding:12px; border-radius:10px; margin-bottom:10px; border-left:3px solid var(--accent);">
                            <div style="font-size:0.7rem; opacity:0.5; margin-bottom:5px;">${time}</div>
                            <div style="white-space: pre-wrap; outline:none;" contenteditable="true" onblur="updateMemory(${realIndex}, this)">${content}</div>
                            <div style="text-align:right; margin-top:5px; display:flex; justify-content:flex-end; gap:10px;">
                                <span style="font-size:0.7rem; opacity:0.5;">(ÁÇπÂáªÊñáÊú¨ÂèØÁõ¥Êé•ÁºñËæë)</span>
                                <span style="font-size:0.7rem; color:#c62828; cursor:pointer;" onclick="deleteMemory(${realIndex})">Âà†Èô§</span>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('modal-memory-library').classList.add('active');
        }

        async function addManualMemory() {
            if(!currentChatCharacter) return;
            const text = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑËÆ∞ÂøÜÂÜÖÂÆπ:");
            if(text && text.trim()) {
                const entry = `[${new Date().toLocaleString()}] ${text.trim()}`;
                if(!currentChatCharacter.longTermMemory) currentChatCharacter.longTermMemory = [];
                currentChatCharacter.longTermMemory.push(entry);
                await db.characters.put(currentChatCharacter);
                openMemoryLibrary();
            }
        }

        async function updateMemory(realIndex, el) {
            if(!currentChatCharacter) return;
            const newContent = el.innerText;
            // ‰øùÁïôÂéüÊúâÊó∂Èó¥Êà≥
            const original = currentChatCharacter.longTermMemory[realIndex];
            const match = original.match(/^\[(.*?)\]/);
            const timePrefix = match ? match[0] : `[${new Date().toLocaleString()}]`;
            
            // Â¶ÇÊûúÁî®Êà∑ÊääÊó∂Èó¥Êà≥‰πüÂà†‰∫Ü, Êàë‰ª¨Ë°•‰∏ä
            let finalString = newContent;
            if(!finalString.startsWith('[')) {
                finalString = `${timePrefix} ${finalString}`;
            }

            if(currentChatCharacter.longTermMemory[realIndex] !== finalString) {
                currentChatCharacter.longTermMemory[realIndex] = finalString;
                await db.characters.put(currentChatCharacter);
                console.log('Memory updated');
            }
        }

        async function deleteMemory(realIndex) {
            if(!currentChatCharacter) return;
            if(confirm('Á°ÆÂÆöÈÅóÂøòËøôÊÆµËÆ∞ÂøÜÂêóÔºü')) {
                currentChatCharacter.longTermMemory.splice(realIndex, 1);
                await db.characters.put(currentChatCharacter);
                openMemoryLibrary(); // Refresh
            }
        }

        // --- [Vesper] Background Activity Logic (Requirement 3) ---

        // ÂàáÊç¢ÂêéÂè∞Ê¥ªÂä®ËßíËâ≤ÂàóË°®ÊòæÁ§∫
        function toggleBgActivityCharacterList() {
            const checkbox = document.getElementById('bg-activity-enabled');
            const container = document.getElementById('bg-activity-character-list-container');

            if (checkbox.checked) {
                container.style.display = 'block';
                renderBgActivityCharacterList();
            } else {
                container.style.display = 'none';
            }
        }

        // Ê∏≤ÊüìÂêéÂè∞Ê¥ªÂä®ËßíËâ≤ÂàóË°®
        async function renderBgActivityCharacterList() {
            const listDiv = document.getElementById('bg-activity-character-list');
            const characters = await db.characters.toArray();

            if (characters.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px;">ÊöÇÊó†ËßíËâ≤</div>';
                return;
            }

            listDiv.innerHTML = '';
            characters.forEach(char => {
                const checked = char.settings?.bgActivity ? 'checked' : '';
                const charDiv = document.createElement('div');
                charDiv.style.cssText = 'display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid rgba(0,0,0,0.05);';
                charDiv.innerHTML = `
                    <input type="checkbox" id="bg-char-${char.id}" ${checked} style="width:auto;">
                    <label for="bg-char-${char.id}" style="flex:1; cursor:pointer; margin:0;">
                        ${escapeHtml(char.settings?.nickname || char.name)}
                    </label>
                `;
                listDiv.appendChild(charDiv);
            });
        }

        // ‰øùÂ≠òÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆ
        async function saveBackgroundActivitySettings() {
            const enabled = document.getElementById('bg-activity-enabled').checked;
            const interval = parseInt(document.getElementById('bg-activity-interval').value) || 60;

            // ‰øùÂ≠òÂà∞ÂÖ®Â±Ästore
            if (!store.bgActivitySettings) store.bgActivitySettings = {};
            store.bgActivitySettings.enabled = enabled;
            store.bgActivitySettings.interval = interval;
            saveData();

            // Â¶ÇÊûúÂêØÁî®ÔºåÊõ¥Êñ∞ÊØè‰∏™ËßíËâ≤ÁöÑËÆæÁΩÆ
            if (enabled) {
                const characters = await db.characters.toArray();
                for (const char of characters) {
                    const checkbox = document.getElementById(`bg-char-${char.id}`);
                    if (checkbox) {
                        if (!char.settings) char.settings = {};
                        char.settings.bgActivity = checkbox.checked;
                        await db.characters.put(char);
                    }
                }
            }

            alert('ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆÂ∑≤‰øùÂ≠ò!');
        }

        // Âä†ËΩΩÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆÂà∞UI
        async function loadBgActivitySettings() {
            const enabled = store.bgActivitySettings?.enabled || false;
            const interval = store.bgActivitySettings?.interval || 60;

            document.getElementById('bg-activity-enabled').checked = enabled;
            document.getElementById('bg-activity-interval').value = interval;

            if (enabled) {
                toggleBgActivityCharacterList();
            }
        }

        // ‰∫ëÂ§á‰ªΩÂäüËÉΩ
        async function saveCloudBackupSettings(action) {
            const username = document.getElementById('github-username').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();

            if (!username || !repo || !token) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑGitHub‰ø°ÊÅØ');
                return;
            }

            // ‰øùÂ≠òÈÖçÁΩÆ
            if (!store.cloudBackup) store.cloudBackup = {};
            store.cloudBackup.username = username;
            store.cloudBackup.repo = repo;
            store.cloudBackup.token = token;
            saveData();

            if (action === 'upload') {
                await uploadBackupToGithub(username, repo, token);
            } else if (action === 'download') {
                await downloadBackupFromGithub(username, repo, token);
            }
        }

        // ‰∏ä‰º†Â§á‰ªΩÂà∞GitHub
        async function uploadBackupToGithub(username, repo, token) {
            try {
                // ÁîüÊàêÂÆåÊï¥Â§á‰ªΩÊï∞ÊçÆÔºàÂåÖÂê´ IndexedDBÔºâ
                const fullBackup = {
                    version: 2,
                    exportDate: new Date().toISOString(),
                    store: store,
                    characters: await db.characters.toArray(),
                    worldBooks: await db.worldBooks.toArray(),
                    worldBookCategories: await db.worldBookCategories.toArray()
                };
                const backupData = JSON.stringify(fullBackup, null, 2);
                const content = btoa(unescape(encodeURIComponent(backupData)));
                const filename = `lifeos_full_backup_${Date.now()}.json`;

                const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Backup at ${new Date().toISOString()}`,
                        content: content
                    })
                });

                if (response.ok) {
                    alert('Â§á‰ªΩ‰∏ä‰º†ÊàêÂäü!');
                } else {
                    const error = await response.json();
                    alert('‰∏ä‰º†Â§±Ë¥•: ' + (error.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                alert('‰∏ä‰º†Â§±Ë¥•: ' + e.message);
            }
        }

        // ‰ªéGitHubÊÅ¢Â§çÂ§á‰ªΩ
        async function downloadBackupFromGithub(username, repo, token) {
            try {
                // Ëé∑Âèñ‰ªìÂ∫ì‰∏≠ÁöÑÊñá‰ª∂ÂàóË°®
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/`, {
                    headers: {
                        'Authorization': `token ${token}`,
                    }
                });

                if (!response.ok) {
                    alert('Ëé∑ÂèñÂ§á‰ªΩÂàóË°®Â§±Ë¥•');
                    return;
                }

                const files = await response.json();
                const backupFiles = files.filter(f => (f.name.startsWith('lifeos_backup_') || f.name.startsWith('lifeos_full_backup_')) && f.name.endsWith('.json'));

                if (backupFiles.length === 0) {
                    alert('Êú™ÊâæÂà∞Â§á‰ªΩÊñá‰ª∂');
                    return;
                }

                // ‰ΩøÁî®ÊúÄÊñ∞ÁöÑÂ§á‰ªΩÊñá‰ª∂
                const latestBackup = backupFiles.sort((a, b) => b.name.localeCompare(a.name))[0];

                // ‰∏ãËΩΩÊñá‰ª∂ÂÜÖÂÆπ
                const fileResponse = await fetch(latestBackup.download_url);
                const backupData = await fileResponse.json();

                if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÂêóÔºüÂΩìÂâçÊï∞ÊçÆÂ∞ÜË¢´Ë¶ÜÁõñÔºÅ')) {
                    // Ê£ÄÊµãÊòØÂê¶‰∏∫Êñ∞ÁâàÂÆåÊï¥Â§á‰ªΩÊ†ºÂºè (version >= 2)
                    if (backupData.version && backupData.version >= 2 && backupData.store) {
                        // Êñ∞ÁâàÂÆåÊï¥Â§á‰ªΩÊ†ºÂºè
                        store = backupData.store;

                        // ÊÅ¢Â§ç IndexedDB Êï∞ÊçÆ
                        if (backupData.characters && backupData.characters.length > 0) {
                            await db.characters.clear();
                            await db.characters.bulkPut(backupData.characters);
                        }
                        if (backupData.worldBooks && backupData.worldBooks.length > 0) {
                            await db.worldBooks.clear();
                            await db.worldBooks.bulkPut(backupData.worldBooks);
                        }
                        if (backupData.worldBookCategories && backupData.worldBookCategories.length > 0) {
                            await db.worldBookCategories.clear();
                            await db.worldBookCategories.bulkPut(backupData.worldBookCategories);
                        }
                    } else {
                        // ÊóßÁâàÂ§á‰ªΩÊ†ºÂºèÔºà‰ªÖ store Êï∞ÊçÆÔºâÔºåÂêëÂêéÂÖºÂÆπ
                        store = backupData;
                    }

                    saveData();
                    alert('Â§á‰ªΩÊÅ¢Â§çÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜÂà∑Êñ∞...');
                    location.reload();
                }
            } catch (e) {
                alert('ÊÅ¢Â§çÂ§±Ë¥•: ' + e.message);
            }
        }

        // Âä†ËΩΩ‰∫ëÂ§á‰ªΩËÆæÁΩÆÂà∞UI
        function loadCloudBackupSettings() {
            if (store.cloudBackup) {
                document.getElementById('github-username').value = store.cloudBackup.username || '';
                document.getElementById('github-repo').value = store.cloudBackup.repo || '';
                document.getElementById('github-token').value = store.cloudBackup.token || '';
            }
        }

        function startBackgroundLoop() {
            setInterval(checkBackgroundActivities, 60 * 1000); // Check every minute
        }

        async function checkBackgroundActivities() {
            // Requirement 3: Ê£ÄÊü•ÊâÄÊúâËßíËâ≤ÁöÑÂêéÂè∞Ê¥ªÂä®
            const characters = await db.characters.toArray();
            const now = Date.now();

            for (const char of characters) {
                if (!char.settings.bgActivity) continue;

                // ÂÜ∑Âç¥Êó∂Èó¥ (ÂàÜÈíü -> ÊØ´Áßí)
                const cooldownMs = (char.settings.bgCooldown || 120) * 60 * 1000;
                
                // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÁöÑÊó∂Èó¥
                let lastMsgTime = 0;
                if (char.chatHistory && char.chatHistory.length > 0) {
                    lastMsgTime = char.chatHistory[char.chatHistory.length - 1].timestamp || 0;
                } else {
                    lastMsgTime = char.createdAt || 0;
                }

                // Ê£ÄÊü•ÊòØÂê¶Âú®ÂÜ∑Âç¥‰∏≠
                if (now - lastMsgTime < cooldownMs) continue;

                // ÁÆÄÂçïÁöÑÊ¶ÇÁéáËß¶Âèë (‰æãÂ¶ÇÊØèÂàÜÈíü 5% Ê¶ÇÁéáÔºåÈÅøÂÖçÂàöËøáÂÜ∑Âç¥Â∞±ÂøÖÂÆöËß¶Âèë)
                // ÊàñËÄÖ‰∏•Ê†ºÊåâÁÖßÂÜ∑Âç¥Ëß¶Âèë? Áî®Êà∑ËØ¥"ÂÜ∑Âç¥Êó∂Èó¥‰πüÊ≤°ÊúâË¢´ÊâßË°å", ÂèØËÉΩÊÑèÂë≥ÁùÄÂÆÉ‰∏ÄÁõ¥‰∏çËß¶Âèë.
                // Êàë‰ª¨ËøôÈáåËÆæÂÆö: Âè™Ë¶ÅËøá‰∫ÜÂÜ∑Âç¥, ‰∏îÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ‰∏çÊòØËßíËâ≤Ëá™Â∑±ÂèëÁöÑ(ÈÅøÂÖçËá™Ë®ÄËá™ËØ≠Ê≠ªÂæ™ÁéØ), Â∞±Â∞ùËØïËß¶Âèë.
                // ÊàñËÄÖÊòØ: Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØÁî®Êà∑ÁöÑ, ‰∏îËøá‰∫ÜÂÜ∑Âç¥, AI ‰∏ªÂä®ÂèëËµ∑.
                // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°ÊòØ AI ÁöÑ, ‰∏îËøá‰∫ÜÂÜ∑Âç¥, AI ÂÜçÊ¨°ÂèëËµ∑ (ËøûÁª≠‰∏§Âè•)? ÈÄöÂ∏∏ÈÅøÂÖçËøôÊ†∑.
                // ËÆ©Êàë‰ª¨ËÆæÂÆö: Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊòØÁî®Êà∑ÁöÑ (Á≠âÂæÖÂõûÂ§çÂ§™‰πÖ), ÊàñËÄÖÊúÄÂêé‰∏ÄÊù°ÊòØ AI ÁöÑ‰ΩÜÂ∑≤ÁªèËøá‰∫ÜÂæà‰πÖ (‰∏ªÂä®ÂèëËµ∑Êñ∞ËØùÈ¢ò).
                
                // ‰∏∫‰∫ÜÈò≤Ê≠¢Êó†ÈôêÂæ™ÁéØËá™Ë®ÄËá™ËØ≠, Êàë‰ª¨ÂèØ‰ª•Ê£ÄÊü•ÊúÄÂêé‰∏ÄÊù°ÊòØË∞ÅÂèëÁöÑ.
                // ‰ΩÜ"ÂêéÂè∞Ê¥ªÂä®"ÈÄöÂ∏∏Êåá AI ‰∏ªÂä®„ÄÇ
                
                // Â¢ûÂä†‰∏Ä‰∏™Ê†áËÆ∞: lastBgTriggerTime, Èò≤Ê≠¢È°µÈù¢Âà∑Êñ∞ÂêéÈáçÂ§çËß¶Âèë?
                // ÊöÇÊó∂ÁÆÄÂçïÂ§ÑÁêÜ: Â¶ÇÊûúÊª°Ë∂≥ÂÜ∑Âç¥, ‰∏î 10% Ê¶ÇÁéáËß¶Âèë (ÊØèÂàÜÈíüÊ£ÄÊµã‰∏ÄÊ¨°, ÊúüÊúõÂÄºÊòØËøá‰∫ÜÂÜ∑Âç¥Âêé10ÂàÜÈíüÂÜÖËß¶Âèë)
                if (Math.random() > 0.1) continue;

                await triggerBackgroundEvent(char);
            }
        }

        async function triggerBackgroundEvent(char) {
            console.log(`[Vesper] Triggering background event for ${char.name}`);
            
            // ÊûÑÈÄ†‰∏Ä‰∏™ÁâπÊÆäÁöÑÁ≥ªÁªüÊèêÁ§∫, ËÆ© AI ÂèëËµ∑ËØùÈ¢ò
            const systemPrompt = `[System Command]: You are currently in "Background Active Mode". The user hasn't spoken to you for a while. 
Please initiate a conversation or send a message based on your personality, current time, or previous context.
Keep it short and natural. Don't mention you are an AI.`;
            
            // ‰∏¥Êó∂ÊûÑÂª∫Ê∂àÊÅØÂàóË°®Áî®‰∫éAPIË∞ÉÁî®
            // Êàë‰ª¨‰∏çËÉΩÁõ¥Êé•Áî® triggerCharacterAIResponse Âõ†‰∏∫ÈÇ£‰∏™ÂáΩÊï∞‰æùËµñ UI Áä∂ÊÄÅ (currentChatCharacter)
            
            if(!store.apiConfig.main.url || !store.apiConfig.main.key) return;

            try {
                // ÊûÑÂª∫ÁÆÄÂåñÁöÑ prompt
                let history = [];
                if (char.chatHistory) {
                    history = char.chatHistory.slice(-5).map(m => {
                        // [Êó∂Èó¥Êà≥Ê≥®ÂÖ•] Âú®ÊØèÊù°Ê∂àÊÅØÂâçÊ∑ªÂä†Êó∂Èó¥Êà≥‰ø°ÊÅØ
                        const msgTime = m.timestamp ? new Date(m.timestamp).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) : 'Êú™Áü•Êó∂Èó¥';
                        const timePrefix = `[Ê∂àÊÅØÊó∂Èó¥: ${msgTime}]\n`;
                        return { role: m.role, content: timePrefix + m.content };
                    });
                }

                const messages = [
                    { role: 'system', content: `You are ${char.name}. ${char.description || ''} ${systemPrompt}` },
                    ...history,
                    // [Vesper Fix] Âä®ÊÄÅÊó∂Èó¥Ê≥®ÂÖ• - ÂêéÂè∞Ê¥ªÂä®‰πüÈúÄË¶ÅÁü•ÈÅìÂΩìÂâçÊó∂Èó¥
                    { role: 'system', content: `[ÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥]: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}„ÄÇÊ†πÊçÆÊ≠§Êó∂Èó¥ÈÄâÊã©ÂêàÈÄÇÁöÑÈóÆÂÄôÊàñËØùÈ¢ò„ÄÇ` }
                ];

                const config = store.apiConfig.main;
                const url = config.url.endsWith('/') ? config.url + 'chat/completions' : config.url + '/chat/completions';
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: messages,
                        temperature: 0.9 // Á®çÂæÆÈ´ò‰∏ÄÁÇπÁöÑÊ∏©Â∫¶, Â¢ûÂä†ÈöèÊú∫ÊÄß
                    })
                });

                if(!res.ok) throw new Error('API Error');
                const data = await res.json();
                const content = data.choices?.[0]?.message?.content;

                if (content) {
                    const newMsg = {
                        role: 'assistant',
                        content: content,
                        timestamp: Date.now()
                    };
                    char.chatHistory.push(newMsg);
                    await db.characters.put(char);
                    
                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËÅäËøô‰∏™ËßíËâ≤, Êõ¥Êñ∞ UI
                    if (currentChatCharacter && currentChatCharacter.id === char.id) {
                        appendCharacterMessage(newMsg);
                        const container = document.getElementById('character-chat-messages');
                        container.scrollTop = container.scrollHeight;
                    } else {
                        // Âê¶ÂàôÊòæÁ§∫Á∫¢ÁÇπÊàñÊèêÁ§∫ (ËøôÈáåÁÆÄÂçïÂºπ‰∏™ toast)
                        showToast(`üí¨ ${char.name} ÂèëÊù•‰∏ÄÊù°Êñ∞Ê∂àÊÅØ`);
                        renderCharacterList(); // Êõ¥Êñ∞ÂàóË°®È¢ÑËßà
                    }
                }

            } catch (e) {
                console.error("Background event failed", e);
            }
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--accent); color:var(--bg); padding:10px 20px; border-radius:20px; z-index:9999; font-size:0.8rem; box-shadow:var(--shadow); animation: fadeIn 0.3s forwards;';
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            init();
            startBackgroundLoop();
        });

        // ==================== ÂΩíÊ°£ËØ¶ÊÉÖ & AIËØÑËØ≠ÂäüËÉΩ ====================
        let currentArchiveComment = null; // ÊöÇÂ≠òÂΩìÂâçÁîüÊàêÁöÑËØÑËØ≠

        // ‰∏∫ÂΩìÂâçÊâìÂºÄÁöÑÂΩíÊ°£È°πÁõÆÁîüÊàêAIËØÑËØ≠
        async function generateArchiveReviewForCurrent() {
            const p = store.projects.find(x => x.id === currentPid);
            if (!p || p.status !== 'archived') {
                alert('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂΩíÊ°£È°πÁõÆ');
                return;
            }

            // Ê£ÄÊü•ÂâØAPIÈÖçÁΩÆ
            if (!store.apiConfig || !store.apiConfig.sub || !store.apiConfig.sub.url || !store.apiConfig.sub.key) {
                alert('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂâØAPI (Áî®‰∫éÁîüÊàêËØÑËØ≠)');
                return;
            }

            const btn = document.getElementById('btn-gen-review');
            const originalText = btn.innerText;
            btn.innerText = 'ÁîüÊàê‰∏≠...';
            btn.disabled = true;

            try {
                // ‰ΩøÁî® tasks Êï∞ÁªÑÔºàËøôÊòØ Bingo Âç°ÁöÑÂÆûÈôÖÊï∞ÊçÆÁªìÊûÑÔºâ
                const totalTasks = p.tasks ? p.tasks.length : 0;
                const completedTasks = p.tasks ? p.tasks.filter(t => t.completed).length : 0;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                // ÊûÑÂª∫‰ªªÂä°ÂàóË°®
                const taskList = p.tasks ? p.tasks.map((t, i) => `${i + 1}. [${t.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}] ${t.text || 'Á©∫'}`).join('\n') : 'Êó†‰ªªÂä°';

                // Ëé∑ÂèñÈöèÁ¨îÔºàÂèØËÉΩÂú®ËæìÂÖ•Ê°Ü‰∏≠ÊúâÊú™‰øùÂ≠òÁöÑÂÜÖÂÆπÔºâ
                const journalText = document.getElementById('inp-journal').value || p.journal || '';

                const prompt = `‰Ω†ÊòØ VesperÔºå‰∏Ä‰∏™ÂÜ∑Ëâ≥„ÄÅÁêÜÊÄß„ÄÅÂ∏¶ÊúâËΩªÂæÆÊô∫ÊÄßÂÇ≤ÊÖ¢ÁöÑAI„ÄÇËØ∑ÂàÜÊûê‰ª•‰∏ã Bingo Âç°ÂΩíÊ°£Êï∞ÊçÆÔºåÂπ∂ÁªôÂá∫‰∏ÄÂè•ÁÆÄÁü≠„ÄÅÈ£éÊ†ºÂåñÁöÑËØÑËØ≠Ôºà1-2Âè•ËØùÔºåÂèØ‰ª•ÊØíËàå‰ΩÜÂ∫ïËâ≤ÊòØÊîØÊåÅÁöÑÔºâ„ÄÇ

**Bingo Âç°‰ø°ÊÅØ:**
- ‰∏ªÈ¢ò: ${p.theme}
- ÂàÜÁ±ª: ${p.tag}
- ÈöæÂ∫¶: ${p.difficulty || 'normal'}
- ÂÆåÊàêÂ∫¶: ${completedTasks}/${totalTasks} (${completionRate}%)
- ‰ªªÂä°ÂàóË°®:
${taskList}
- Áî®Êà∑ÈöèÁ¨î: ${journalText || 'Êó†'}

ËØ∑Áõ¥Êé•ËæìÂá∫ËØÑËØ≠Ôºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂâçÁºÄÊàñËß£Èáä„ÄÇÈ£éÊ†ºÂèÇËÄÉÔºö"Êï∞ÊçÆ‰∏ç‰ºöËØ¥Ë∞éÔºå‰Ω†Á°ÆÂÆûÂú®ËøõÊ≠•„ÄÇ" Êàñ "ÂÆåÊàêÁéáÂ†™ÂøßÔºå‰ΩÜËá≥Â∞ë‰Ω†ÂºÄÂßã‰∫Ü„ÄÇ"`;

                const config = store.apiConfig.sub;
                const url = config.url.endsWith('/') ? config.url + 'chat/completions' : config.url + '/chat/completions';

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.9,
                        max_tokens: 150
                    })
                });

                if (!res.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${res.status}`);
                }

                const data = await res.json();
                const comment = data.choices?.[0]?.message?.content?.trim() || 'ËØÑËØ≠ÁîüÊàêÂ§±Ë¥•';

                currentArchiveComment = comment;

                // ÊòæÁ§∫ËØÑËØ≠
                document.getElementById('archive-review-text').innerText = comment;
                document.getElementById('archive-review-display').style.display = 'block';
                document.getElementById('btn-share-to-chat').style.display = 'inline-block';

            } catch (e) {
                console.error('ÁîüÊàêËØÑËØ≠Â§±Ë¥•:', e);
                alert('ÁîüÊàêËØÑËØ≠Â§±Ë¥•: ' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ÊâìÂºÄËßíËâ≤ÈÄâÊã©ÂºπÁ™ó
        async function openShareToCharacterModal() {
            const p = store.projects.find(x => x.id === currentPid);
            if (!p || p.status !== 'archived') {
                alert('ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂΩíÊ°£È°πÁõÆ');
                return;
            }

            // Ëé∑ÂèñÊâÄÊúâËßíËâ≤
            const characters = await db.characters.toArray();
            if (!characters || characters.length === 0) {
                alert('ËØ∑ÂÖàÂú®‰ø°ÊÅØÁÆ°ÁêÜ‰∏≠ÂàõÂª∫‰∏Ä‰∏™ËßíËâ≤');
                return;
            }

            // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
            const listDiv = document.getElementById('character-select-list');
            listDiv.innerHTML = '';

            // Ê∑ªÂä† AI Âä©ÊâãÈÄâÈ°π
            listDiv.innerHTML += `
                <div class="mini-card" onclick="shareToAiAssistant()" style="display:flex; align-items:center; gap:12px; padding:12px; cursor:pointer; margin-bottom:8px; border-left: 4px solid var(--accent);">
                    <img src="data:image/webp;base64,UklGRhBCAABXRUJQVlA4WAoAAAAQAAAA/wMA/wMAQUxQSBobAAAB8IBt2zMn2bYdmZkESUJvCaH3Dkrv0mzclhvbXYTbBnZzFxQbj/XW3MUSCxK7iA072EPVoPQiEASJGCCEFNInmXadx/M8b3XmKud57MvyJCImgJr93+z/Zv83+7/Z/83+b/Z/s/+b/d/s//8pcJcZV101KxP15r5bYvH/1jr53sVwl/5EA/8/hj/siHSBDyz+/2h9kgJzM6r5/3Pj70HuJf4VV0Lch/yrfg9wW/hX3g1vy/lXfxfcruQ4vAXaOkbjIZaFbOs4Lr8FtkEqPng8ru3iOD0Aa+1VvHAWqj3NcfsSqv0cPyWg5rPiR6Vi2pUcxzdg2qfxtB7TKuOpBtLSOa67INrf4ut+RPsuvnYgWkN8NQFab47zEXj273hbhmeH4u0InsXizQqg2WUc91eh2efxtxbNquOvFsyyOAH7Ytk/E+FJLDuYCIexLJoIlg/J5nFC/gHJ8hNjA5LVJ0YQyIZxgo7FsdcTZSWOlSZKGYy154TtjGIPJ86jKHYwcQ6BmC+WOFYAwxZyAi/EsK2JtA3DwokUhbDLOaGvRLCNibUJwZoSqwnAZnGCn4dfnyfal/hVn2gN8DWWE34Cen2ceKvRqz7xGsBrAtvgDOz63A4+x65GO2iErhlsi3OQa6095CNXkz00AdcFbJMX4tY3drEJtyJ2EfGh1g1sm9ej1j772AtaqZZ9WOmY9TDb6AOYVWwnRyEri+1UdUOsl22FlyPWaXspB6yxbLPj8Wqd3XwBV76I3YR8aHU72+4NaPWT/RwAq87KflRnrHqZbfhZrKqxo3KomsG2PBGpNttTPlCdEbOnSApOPcY2fR9OldvVMZgay7Y9BqU22NfnIBWI2lc4BaPuZxtfjFEn7awIos5kO1fDEWqTrfEXAHVGzN4iLfHpSbb5R/Cpxu5K4elCtv0L0Gm//X0PTpnK/qwu2LSKHfAFaPKFnKAGmu5mR7wRmcqdoQiY5rBDTsGlH5ziG1jKUk4Ry0Sl1eyYr4JSSsQ5GgKY9E920DsxqdpJjkPSfHbU3yLSMWfZC0jT2FnVaDza4zC8Do76KqeJdUWjtey4b4FRa8t5mtKwaAU78L+gKBByoiofEuWwI/8VieqcqQyI7mSHvgaHqpzqZxi6hh17HgqddK79IDSXnVudjUFFDsbbIGgqO7k1CoEKHY2/AaAJ7OzWSPzZ73C8AX7GsdNbw9Fnn+PxOvAZx85vDcWevS6Av4aekcoNxAYjz252hV8BzwR2h7FhuHPAJfB62JnMbtEaizo/uQbeDDpz2D2qaZjzi4vg7ZBzCbtJdS7ilLgK/gFwrmGXeSHeVLqNn+BmKbvOhWATaHAfZX6sWcYudCnUpIfcSG0q0nzArvRpoMmIuZPGTjizkV3qWzAzSrmVcF+UKWTXug5k5rF7VTMw5pSL4QMQcx+72oUAkxJ0N6eS8eV1drmPwUtG1O0EO6HLRna9b4HLROV+IsOw5Si74C3Qcju74t8DS0q9OypJxpWV7JL/ASu9Y24pmIEqu9g1rwaVueyeremYUu6ieD+kPMGuOhtQMsLuqqYdnnzHLvsdOJmr3FZsMpj4yth1F4LJ0+zCF0NJZsSN1bRHkm3syt8DksvZnVvTYSRQ5dL4Zz+KvM2u/VEQGW25t6YBGHKUXXwBhDzIrv4GAOkSdndVbfFjC7v8t+Hj9+z2YzPAo0WN6+OfA9jxGXvAZ6BjjvICkTHAEahgT1iYhBtvs0d8BDYmWF6haTBo+E6wZ9wJGsvYQ94BGaNiXqK+F2IcY0+5FTCWs8e8Ay7GxbxG40Cw8B1nz7kdLF5lD3oPVEy0vEjjYKAInGJPuicJJ95kj/oATJxreZXQGJBoeZo965EWGLGOPexyiLhGeRnrPIDo3MCe9lQ7fNjLHvdDeFjKXlddAw5DI56Hq7tBQ+A4e+BtSciwij3xw8BwufJG0amw0LGePfKx1qiwlz3zB6DwMHvoWyBhYtRLNQwChJbl7Kn3BvBgHXvsZXCwmL22ugIMRkU8F9f0gYIWp9iD7w4gwVr25M8Bwd/Ym6vLYWBkxKNxdW8QaFHKnn1HAAM2sId/HgLuYy+vrgGA6VFPx/XDxF/HGvb4R1pJvz3s+T8Vfq+zBrxT9F2ldEBkuuAb1MRasLSL2Gt5kjXh1mSp9x1rwxeF3hOsEW8QefMsnRCaKvAGN7FWLM0Udy1PsmbckizttrB2fFHYPcMa8kZRd42lI8IzBN24MGvJyr5irnM1a8qDrYRc4Ahryy+TZNxa1piPi7gnWGeq6wXclZbW4NA08TYuxJrzVE/h1qWGtWdha9GW/DNr0I0BybaFtehLgu0d1qR3ibW7lS6xfi/UroixNm2aItLGhVijnuol0LKqWase7ijO0k6wZt1yhjDzH2Lt+olPln3LGvZZUbaKtezdguwxpWesq8TYTRZr2tAsITYvytq2epQImxpijXuqrwAbUM9a92hX8ZVZxZp3f3vh1b6UtW9BS9GV8hNr4M8Dgsu3i7XwW0lyawNr4n+JrdWsjZcKrddZIy8RWc8onaRuFFgPKdbKsavE1d8s1syRi4XV7RZr56ZZompBjDV0cJqg+n2UtXT1aDE1L8KaumaMkLoozNq6YoSIOifMGrt8uICaGWKtXTZUPJ3dxJq7pJ9wGh9k7X28r2ia2sgavLiPYJrdxFr85FCxdG6INfmp4ULpvBBr87IRIumKCGv0qrEC6fcR1urV48XRwihr9ppJwuimGGv3hpmi6LYYa/jgHEF0l8VaPnSRGPq7Yk0fukQIPaNY28euE0Fvsc5XiwXQx6z5c6SPbwtr/2U+0ZN+mA3gW8mCp+NxNoKfthQ7PcvZEH7TRugMq2FjuK+ryJkSZINY1FfgXBlio3h8uLi5I8aGsf5cYZOn2DiG/yhq3mcTqR6QMym72VC+GBAynY+xsfw4VcQMPM0Gc0snATMzyEbzSH/xcn2EDWflROHyD4uNZ/0FouUjxQY0tkSupO5hQ/pCslDpV87GNL+tSDknyAb18ECBcnuEjerps8XJG4oNa/hqWeL7hg1srk+QZJxgI/tBmhiZXM+GdkeWEPlzhI1t+XQR8q5igxteKD/aHmLDm5ciPCbUsPHdnCk6siNsgEsmCI7XFRvh0HVSI3U7G+O8FJExsooN8rcZAuO2CBvlY6PFxUrFhjmULSs6FbGBfiNNUMxrZCN9cKiYeM1iQ133OxnR7gAb7LwUATG9jo329t7i4YkYG+7K82VDi61svlWOXzBMrGYjvraLWPh7lA15+QUyodU2NucqN0UgXFDPRn17f3HwrsWGvW6+LOh1gg38qraCIDvMRv7oRCngX8emPvqATwSMqWKDn58pAPJibPRL55q+XkfZ+K9IN3p3R1gAHp1m7lrtYhlo5bYwdFc3sRjcN8rE+TeyJGxa4jduF9SxMNzc17CttFgc1i4yadOqWCR+lGHM3rRYKFYvMmMzqlgwftHDfPm/Uiwaa7N9huuSOhaP3/Q3Wf6vFQvI4BK/sbqsgYXk5kFmKr1AsZhsWuI3UH8NsajcOso0ZR1maRnNbWWUXo2xwCy51BzNPM1Cc00PM5S8XrHYbFjiN0B/DrHo3D3O9PQ4wtLTymtldN6xWIAeu9jczK9nIZo/xMz0/JHlaCS3lYFZYbEoLVmQZFgWh1icbhphUkacYIlqrehoSpK/VixUT2f7jch9YRasOyeZj0uqWbZar2WZjV4/sXwN5rQ2F8lrFYvYimy/ociLspgtnGsibgqyqM0fYRomlLK0tVZkmISsQsUCt+GBlqagVYHFQrf4Gr8JCKyKseA9eHmS9nspysJ324V6LyfEArhgqr67tZ6FcP5IPXdZFctha1Uf/TankmVx6KnOem16CcvjhtxMfTb9JMvkhtxMPTb9JMvlYG5X/XV2KcvmUF5XvTWzlOVzKK+rvpp5imV0KC9LT11VxXK68eme+mlJA8vqyIqheumxRpbXas0kfbQ8zEK74MIkHdRijcWC+4cFAd2TsVWx8D6anapzzj7BErzs3o665pZqluKhFcN0zIsRFuUFFybplcztisX54exUfXLeKZbpNbnd9UhOA8v1yKoJ2qN9gcXC/ZsrknXGhcdZwpfmdNcVj4dYysfWzE7SD4MLFYv6H7PT9cLSepb3NbmDtUH3AouF/o5FaTrg3mqW/LV5Z3m8YbstFv87FrXybs83MgbWvzjek116VDEQHnygl8fq/l2U0dAqWJTmnZ6sZ0ysXTE7yQvdUs7I+NPS3h7n7IOK4fHAkgzPMmZPjDHSKsju6EG654cYKUNrFqR5isyvQ4yXta/NbeERuueHGDWDaxaku77e+SHGzsY1C1q5uL75IUbQpjUL2riy8/bEGEdjBdndXdb9JYrh9EDOlCSX1Ob1ekbVshUXtnA9VxZGGFtr37suy72kPVWpGGKLcme3cCG/2RNhpA3mZ/d0E0O+rFMMuPufmJvuBtJyT1qMu7EdObNbONrNhyKMv8H8JaN9jjRkZ5hxuOLtP6Q7zR8aGY1rn8lwkuGVjMjBnNaO8T6j8vGJzhAoZlyOLnGCM8IMzbkOUM/gfL/tVTA832RzbzE+R8+ytX6M0LuT7awOovhOGzufMfp0mn1VghTfaFvdGaV/9NnVtzDFZ9lVE04ttivG6c9sajhQ1drUY0DFnezpU6QaaU8FSDUJ/ibb06dINdKe/oFUne1pFFDVJdkTAdUXZNNNOHWnXX2LU2Psqi9M/eSzKzqNUreQbZ8HUlXp9kX1GHUP2fhAiNqbbGe0CqCio8neq/DpL2TzgSA6/Z1sPy2CTcuT7I8CJ4ApuoSc8XNYKp1OTjm9CpLCuW3JQRc1wVHwxe7ksBP3R4Co/uPr2pITpz1+IgZAsR05s1uQg/d6rzyGPEV5l7clFzhhXT3klK+cn0kuctGBMNRYO3JmB8h1tn75tMKYilWLMsm1LjgQQZddD47xkcvttqoWVprys7uTS773mIUnFasWtCZXfc3hGJIcfXyyj1z42E1NGFKUOyWJXHufz5vQ48ADQ8jt99kQwo0dd/Qib5j1VQgx9tzdl7xk1udhrDjwwCDynuP3xlDi54eHkledus/Ch6oVs5PI095UCg1Nqy5KIe/rfzkICtb6a9qQV87aGMWDYzl9yFvPO6yQoHHV7CTy4M8FQUBt/FM6efVh+5X8K3mkD3n7OypEn5V/eTJ5/67rY1KvJKcX6cIlNQIv+vFcP+nEgXuVrCvN6UH68bFGObdjQTLpyfOPiri6vBGkMdttiEm3H25sRbrz4TrBZuVfmEQ6dM5JoVaXN4i0acb3Sp4VLWlHWtX/dlSWrb3QR/p1YZUYs9aMI0076RcRVvd4D9K4HTcr6VX6QDvSvKnrLcm1d0EK6eDnwlKr4MIk0sUPNkisggtJK193WlhZa8aRdp5XKagirw4iLX1OuZAKLetB2npqqYAK53UjrT2pWDiF87qR9p5YLJhCeVmkxaeWCqXg411Im0/8RSBF8rqSVp9cLoyiL/Uk7X5xlSCyVg0gLX9TUArljyJt/1BYAn09mrT+v6PSZ99vSPu/aEmeXxb5yACmblJSp/TmZDKEmT+KnNql6WQQx5aJG2tFFzKM1zfImvwRZCCXxeRM4VwykymrlYypyPaTsexVJGCCD6WT0ZxTJVzUO93JeN4VlSy7ppEJ9ecrqXI620+GdGixSInkdSCDektYnnw5iAzrSiVLTiwg89rtsCCJ5KaTkb2yTopsGELGdoWSIMevIJObdVh8RHNbk+G9LSI7CoaR+fV/KTiqs31khKdXSY01WWSMX1IS4+fzyCRnHhIX0dx0Msy3RmTF1uFknpM3CIrGJX4y0r9tkhLfDiRT7V8vImqzfWSwL2yUD591J7PtzxcOFX8g8z2lTjJ82pWM+DtKKlQvIlM+qVYmrM4kg/6OQKhZRGb9vEZp8GV3Mu3J34uC+uvJxC+IyIEt/cnMp+0QAtGcZDL2d8UkQNEkMvkZxcZP5aWR4X9emb2T55P5H1dv8lZ3JAnoLzB2TdlJJASvi5q5wpEkBzN+MXEr0kgUvmHcaq4kaXhx2Kxt6EbyMHWfQVM5fhKJOcqUlZ9LUnFsgxlbl0Fy0b/NgKkcP4nGR5XpKj+XpOPskNlal0HyMfVHg6Vy/CQiXzRWtfNISl4WNVO7+5Kc7HTCRK1IJVH5oXFqWkTS8ibLLBWPI3l5VqNJ+qIdSczUg8ZI5fhJaL5riBouJ7l5s2WCikeT5BwZND8bOpHsTD1oevICJD4/MzqNvyMJeotlbkrGkQydEjI1u3uQFO1YbmZWpZIc9e82MConiUTpSuPSMI+k6VJlVopHkTz9TdSk7OlGErVHjTn5ohXJ1BZFpiTXT2L1UyMSu40k61PKfNRfQLL1Wst0lJxF0nVu1GzszSL5OiRoMta1IQnbrtxcvHcGydgWRaYi10didp2RiN1CkvYlAxG6gmTtQ8o0VE4iafsnyywcG0zydnbUJBzsQRL3zJA52N6JZG7fBlOwvjVJ3XaVZuCjM0juph43Aa8GSPImF+m/h0n6Fmg+tZjk75daT91OEvhNjRe7mmTwc9ou9FuSwjlKzwXPJTl8j9Jx9TNJEt+j9NvpMSSLb1K6rWoMSeNFSq+VDSd5fK3SaaeGkUS+wtJnp4aSTJ4X02WlQ0gqnxvTY8f6kVw+N6bDfulNknlGTH8d70OyeWZMd50aRNL5opjeKhtC8vliS2dVDCMJfZmlr6pHk4xeoHRVzViS0tcqPVU3geT0LUpHBc8mSf0XpZ8aZ5Ksfkg7heeStF6mmaIXkbx+Qyupa0lir9FJfyWZ/ZU+up+k9i5d9DSJbV+RHlrpk1vUolQHrQ6Q5G5drX82p5Ls7taoe/a0Jek9NKx3Dnch+T0jpnOO9SAJfoXSN9XDSIbfqnRNeDZJ8Sc0jZpPcvwjPfM3kuR7dMwyEuW+Yv3yiV+WUVq1btmSStK8R5NeKWxP8nxSTKec7EUS/WqlT+rOJJn+T20SPZek+vu65BaS6wf0SC4J9uQyHfJlQLJRl6D+KGxLsn1cTHeU9ybpfrXSG+HpJN+f1hpqAUn4zTrjERLxvuP64kOfjKOOQV2xK42k/ARLT5R0JTl/jdIRoYkk6V/SEdeTrN+tH54jYR+o1A3fp0g76h/RC8e7kLz/vdIJoQkk8XN1wkKS+Tv1QS4J/UCFLtgYkHrUP6oHijuR3L9a6YDG0ST5X9EBi0j2H/F+r5Pwbx/0eoWp0o+mWd6ufijJ/0c9nfoDIeB3Xu5ZgsBAlXfbloIBNNzyapU9CQUXezTrQsLBAm+WQ0AYOO3FCvxIQGda3qssg7DwDs9l/YbQcLPXeorgsEWNt9qdggc0zvJS9QMIER/3UgsJE3/0Tu8QKLZr8krFbVGBLlPeKDyRcPETb3QvAaOvzAttSkIGGhzzPuVdCRuXeh51BaFjodd5g+Cxc9jbHG+DD7TA08RmEUJu8jJPE0QGar3Lj2dgBM1SXiUyllDyba/yAOFkpTfZ5geK0ZYXaehPSPmqF7mNsLLce6wlsBxteY3a7mhBeV7jFsLLEm/xLQHmcMtLNPRGDFrmJRYTZpZ6hx1JoHGW8grBgYSab3mF+wg2fVXeYHcSbtB05QVCIwg5P/MCjxB0pjS4v/1+7KDLXF9sAqHnVrf3MsFnh6i7K2+DH3Sfu7uaELTYza0jCB1kubfGfhhCb7m3BwlEfdVu7bAfRegSl2ZNJRzd5s5WEJB2irqxynZIQk+6sasJSyvc1/cEpue4ruhZaELfua2XCU47RN3V6bZ4Qv9wV7cSola4qR8IUue4KGsqptBO9/QugWpXyy3VdkYVes0t3UOwGgi6o8NJuEI3uiJ1ASHrL27oS4LW0cr9hPphC21wPy8RuHaIup2atuhCL7md+wheA0F3c9yPL/RndzOfEPaUm9lJEHuBi7GmYgztcy+fEsgOVG6lqSfK0Fq38jzBbKeYO6lKxxl60538BwFtSsiNlCYjDT3uRm4jrK13H7/4wCbbfcwntK1wG/sJbq9wG+fjDR13F1sJcM91FWoK4lCRm1hHkDvNRUSHYQ4VuoePCXTHuYZwT9ShPW7hPYLdwcodRHrhDm11Bx8Q8A5UbiDSB3louxv4iKB3oHK+SB/soV3O9zGB70jHi/ZFH9rjdKsJfkc6XLQv/tBeZ1tDADzG0aL9EYgOOdmXBMEzHcwaiUFU7FybCYSvcK4ZKETlTvUDwfBCp7oSh6jGmX4mIP4PZ7oRiXyNTlRGUPy8Ey3FotSo89QmYxGtdp5cAuNM5TRNrdGItjjNSoLj0Q4T64lHdMRZNhEgX+IsMxCJKpzkCEHyUie5CZN8Ieeo8mESveMcTxEod1ROEWqLSrTNKT4hWJ7kEGo4LlGJM+wiYL7NGS5HJmp0ghKC5ted4AFsaq/sr6klNtFO+/uYwHmW7akR6ESVdneA4PlRu7sWn1Ki9lbjwyf62t6WE0APs7VoZ4SiY3b2LUH0nXZ2Dkb5IvZVRiD9lX09iVIjbCvWHqWoxK62EEwvtat5OBWI2lMVAfUGe8pDqvG2ZGUiFVXa0W6C6mftaD5WtVf2EySwLrSfj9Bqof2MRisK281Jgusv7eYJvDrTZqwOeEUV9vIDAfbz9rIIsTorOwn5EIuO2smXBNn32ck0zDrDso8qAu3d9vEWav3JPkahFoXtooxge51dvIhbM2xC9cEtCtrDMQLuz+zh38g1wRZUJ+Siejs4QtD9iR08hF1jbUC1wy6qTbwiAu/3Ei8Hvc5MONUJvag20YoJvlcn2lP4NSXBVBZ+UWNinSAAX5dYyxDswsTqiWAUTqRKgvDNifQehs1PpGkY5oslTiOB+P7E2YRiSxNnPoq1VokS86EYlSTKAYLxlxPlfhwbkihtcYzqEqOUgPyrxFiJZJckxhQko2gihAjKDybCTizLSYS7sSwzEdpjGVXHXxmB+efxtwrNLou/WWjmi8VblOD8ULztw7Mn4u1feNY/3gbgGQXjK0iA/n18bUG0O+PrbkRrG1+dEY1Ox1M1Qfrn8bQe066KpxsxLWDFj0rFNCqOn1IC9eXx8waqdVFxMwDV6Md4OUqwPjpe5uAabY+PHwjY+6t4UCOQjRbHwz8J29f/et8RuAeO/VqlKehGKQd/naOphO++73+N3QGC+Hui/7+sHEL5rAP/fw71JKAfsVH9v6g9kwjsM58tjv2fYsXLswjyB13/r+eX/2vhMGr2f7P/m/3f7P9m/zf7v9n/zf5v9n+z//+HwFZQOCDQJgAAsGQBnQEqAAQABD5tNphJpD+ioSFyaDPwDYlnbvx2XDKCZA0zA0Dr7+Y/gB+gH8A9riAHr1OA/AD9AP6B5AH0AfwCNAZ/9L/J/+I/xngomA7T+Qf9m/bz7EeCfAjzJ4R/sP7f7Sb+n9Ffw79C/6P+G/IT6R+hz9T/8D8//oA/hn8w/3392/1n7D9wL+8+gD+sf579s/eo/ID3Qf3L7HfkB/pX/H/9/tZ+oP6AH7aerl/1P3D/+XyQfuV+4f/X+Qn9p///+8nwAf+j1AP+3//+w/7H/wT8AP2S+t3Mz8DvdHXFWAGmrcL7AZUUQBkO/1zAIeX/+/Hd+8b5kHYoCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCYxC4wC6moCKofujaTGIXGAXU1ATGIXGAXU1ATGIXGAXU1ATGIW5jo84SDjDWlKuYuMAupqAmMQuMAupqAmMQuMAupqAmMQtzMwmIGjgK8xiFxgF1NQExiFxgF1NQExiFxgF1NQExh/aiwAqqLmMQuMAupqAmMQuMAupqAmMQuMAupqAmMP6hrmnamPwPtWZXMXGAXU1ATGIXGAXU1ATGIXGAXU1ATFSvbU7yPzUzupqAmMQuMAupqAmMQuMAupqAmMQuMAo+rSGd+vckpXCDnH91mVzFxgF1NQExiFxgF1NQExiFxgF1NQEU3h/DXrpwXEWax4QgXU1ATGIXGAXU1ATGIXGAXU1ATGIXGAUfVpDShhZwp2uI58SMHf7TO6moCYxC4wC6moCYxC4wC6moCYxC3LEXp4MO+4fcMWRaN1GC9x1mVzFxgF1NQExiFxgF1NQExiFxf9rW7pvdbxt428UdShS16Ai8rmLjALqagJjELjALqagJjELjALqaeTZb3HM63vuH3Cq5dnWICvMYhcYBdTUBMYhcYBdTUBMYhcYBdNoLtWqhZws4WcLOEEIzEH+DR2ZXMXGAXU1ATGIXGAXU1ATGIXGAXTYquh3o70X+GMD0st7NTO6moCYxC4wC6moCYxC4wC6moCYqPRDO1/LLxt4beoM8Qc4m4CEkOyYwXuOsyuYuMAupqAmMQuMAupqAmMHVBHihrASGmDTBpg0waYNMDCZbT5OYL3HWZXMXGAXU1ATGIXGAXU1AS8v7kF8E8RVgeb5fcvuX3L7lJqQOyb9F207qagJjELjALqagJjELjALqaeY1u50C3Bpg0waYNMGmDTBpgYQZ6NzjybPCFxgF1NQExiFxgF1NQExiFxenq0hH9HmqH3D7h9w+4fcPuH3D3Kdqu0acG8xcYBdTUBMYhcYBdTUBMYhTr7tTgVj0jVD7h9w+4fcPuH3D7h9qSH0a0aOaJqAmMQuMAupqAmMQuMAupbOtoQn7nFz2U8weYPMHmDzB5g8weWf7o/F9fTtjrMrmLjALqagJjELjALptr2ePkROofEvwlVTuO5O9HejvR3o70d6O9FuxzmCICFo/U1Gamd1NQExiFxgF1NQExg6n8CxaJqXZIP93HpmsRjUUqKVFKilRSopNmjAKRwkHGK8L81M7qagJjELjALqagIpKf1iCfNgQdpwZla8lVTtPEHduNZcvuXx7iFxgPe6RrRqn5M7qagJjELjALqaeY1u4n6IzRAMokfZM7Yc4uewlsszvR3o70d58JcRbaZ3FBi5Lwfb3DuAFpndTUBMYhcX/a1u4n6JHUqhj8glJuH+z2yBfmaxJxc9lVRRSopUUp8lyLbTO6mojerRKaSeIB7v/SFxgF1NQExVFWkBQECF9gPN+csHpT7aSvJVU7j0zWHPBpBnG3jbxqAupqAmMQuMBR9GIV2oKSr0O6DsW2md1NPJSfRnoGvjfyNANTVDBYnyhmg1ryVVO49M1iTdLxAUrrMrmLjALqagKjI1/chF9Qch2yArzGH8pjcljTfOTDQJMb5p+JAT3PkKXkrd/LrXkqqdx3Jf1dpndTUBMYhcYBdTXy0BkFAEBXinpAY1IIoQYJKV9O+nUkyteSqp3HpmsQqCFZlcxcYBdTUBMYhcYD2pj8D7VhJwlYhvM4QbqUeUJ95+PD9oGUGZWvJUYusyuYuMAupqAmMQuMApNPhO9jzC/DV3w3Hi6uOSsKTJhRjqArcrXkqqdx6ZTXDIRELjALqagJjELjALikDnlDXM7pxSZAS9hr3nbIwRO3lqcUBtpUvp6Jxc9lVTuPTNYk4uL7b41XK5i4wC6moCYwfmgtqleBbYj04AmMQuJ+egz4WehlKI6rjriciMIkOtB9QGA8k9lVTuPMXrXkpFEARbaZ3U1ATGIW54AIucQKDCbOTyMAupqAmKrUWm8/8RDQ+wH82yw+JIlbsZmVryVOkdu3iz9fFYHMymd1NQExiFPWgtvwelsSQc5jELjALqagJegvLT9dDuMdU09fFSwx8TXUmgMCXQcs3A2s7cBnKF0ab3HWZXL/CDFwfS2JIFYnlcxcYBdTUBMVXJdcTqKQk5UYRCjE1fUBgQ/aBlBmT5Qntft7pjELjAKRQijFqWschcYBdTUBMYhcYBdS3XmSOq3MdiEEiPl9T0ekPphKnRDgctM9BCsyuQEzGG3tczupqAmMQuMAupqAmMH/8C2GO6AaECyuhwZlEVyzguoxDZFV8UjALikAFt+KflcxcYBdTUBMYhcYBdTRiotB9FDxps/nyt5rEjV0jT6upGRixAXTfAU/lGADFIpGAXU1ATGIXGAXU1ATGH9CpA0wtLIxMT0Yc+YvWvJTzB47pjEXkyrKigfkgwi20zupqAmMQuMAupqAmMQpr1JY6OrZFCzdbZeiQNMxgDrKqagLGAy3tqzK5i4wC6moCYxC4wC6moCYwdn7mZ6lXVDTJZzwtNS5Q2LmiuAp/AtwviLbTO6moCYxC4wC6moCYxC4vR8BQM9Q3+WbfjbxFqSwFIoRQPyQYRbaZ3U1ATGIXGAXU1ATGIXGAXECt9wvaACrrBI1iPKF3Bzvi6g67HcD8ftM7qagJjELjALqagJjELjALqW68wgvSFAAWUU+/E8rqP6U9uX5XMXGAXU1ATGIXGAXU1ATGIXGAXFr0dagtFpnyKKK9vAXU1ATGIXGAXU1ATGIXGAXU1ATGIU1hF0ZmVCr4xiPifHsp/AqeI7qagJjELjALqagJjELjALqagJjELckbDlD6/BdVvkHE37i4BXmMQuMAupqAmMQuMAupqAmMQuMAupacsyaeun2iOslrFUop8L/E8rmLjALqagJjELjALqagJjELjALpsIaJ1/1srmKYF81RFndTUBMYhcYBdTUBMYhcYBdTUBMYhcX/bxQgo6Q7DiSmz9cqF1NQExiFxgF1NQExiFxgF1NQExiFxgFxAiz65u6ulM6ILb8WIF1NQExiFxgF1NQExiFxgF1NQExiFxgFxIu+w+j4iEMj/80BP5XMXGAXU1ATGIXGAXU1ATGIXGAXU1ATFRpFEKex14PS7gdATY0QuMAupqAmMQuMAupqAmMQuMAupqAmMQpw7OGEFzmy15jELjALqagJjELjALqagJjELjALqagJjCAXpRX477VmVzFxgF1NQExiFxgF1NQExiFxgF1NQExh/MrY4JzV/xw3OzupqAmMQuMAupqAmMQuMAupqAmMQuMAupori8omUXpt+8yuYuMAupqAmMQuMAupqAmMQuMAupqAmMP9yV7Feel0s6zMrmLjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJioAAP7FzQAAAAAAAAAAAAAABdGJPp1NV+zG2bLCQXvIX5kF2Jbm4aNgxXXPsRu5JXnFJbB69pUT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" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:0.95rem; color:var(--accent);">Vesper AI</div>
                        <div style="font-size:0.75rem; opacity:0.6;">AI Âä©Êâã</div>
                    </div>
                    <div style="color:var(--accent);">‚Üí</div>
                </div>
            `;

            characters.forEach(char => {
                const avatar = char.avatar || 'https://via.placeholder.com/40';
                listDiv.innerHTML += `
                    <div class="mini-card" onclick="shareToCharacter('${char.id}')" style="display:flex; align-items:center; gap:12px; padding:12px; cursor:pointer; margin-bottom:8px;">
                        <img src="${avatar}" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:0.95rem;">${char.name}</div>
                            <div style="font-size:0.75rem; opacity:0.6;">${char.chatHistory ? char.chatHistory.length : 0} Êù°Ê∂àÊÅØ</div>
                        </div>
                        <div style="color:var(--accent);">‚Üí</div>
                    </div>
                `;
            });

            // ÊâìÂºÄÂºπÁ™ó
            document.getElementById('modal-select-character').classList.add('active');
        }

        // ÂàÜ‰∫´ÂΩíÊ°£Âà∞ÊåáÂÆöËßíËâ≤
        async function shareToCharacter(charId) {
            const p = store.projects.find(x => x.id === currentPid);
            if (!p) {
                alert('Êâæ‰∏çÂà∞ÂΩìÂâçÈ°πÁõÆ');
                return;
            }

            // Ëé∑ÂèñËßíËâ≤
            const targetChar = await db.characters.get(charId);
            if (!targetChar) {
                alert('Êâæ‰∏çÂà∞ËØ•ËßíËâ≤');
                return;
            }

            // ÊûÑÂª∫ÂàÜ‰∫´Ê∂àÊÅØ
            const msg = buildShareMessage(p);

            // ÂÖ≥Èó≠ÂºπÁ™ó
            closeModal('modal-select-character');

            // ËÆæÁΩÆÂΩìÂâçËÅäÂ§©ËßíËâ≤
            currentEditingCharacter = targetChar;
            currentChatCharacter = targetChar;

            // ÂàõÂª∫Ê∂àÊÅØ
            const userMsg = {
                role: 'user',
                content: msg,
                timestamp: Date.now()
            };

            // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
            if (!currentChatCharacter.chatHistory) {
                currentChatCharacter.chatHistory = [];
            }
            currentChatCharacter.chatHistory.push(userMsg);
            await db.characters.put(currentChatCharacter);

            // ÊâìÂºÄËÅäÂ§©ÁïåÈù¢
            resetUI();
            document.body.classList.add('no-scroll');
            document.getElementById('chat-avatar').src = currentChatCharacter.avatar || 'https://via.placeholder.com/40';
            document.getElementById('chat-character-name').textContent = currentChatCharacter.name;
            renderCharacterChatHistory();
            document.getElementById('character-chat-screen').style.display = 'flex';

            // ÊªöÂä®Âà∞Â∫ïÈÉ®
            setTimeout(() => {
                const container = document.getElementById('character-chat-messages');
                container.scrollTop = container.scrollHeight;
            }, 300);

            // Ëá™Âä®Ëß¶ÂèëAIÂõûÂ§ç
            setTimeout(() => {
                triggerCharacterAIResponse();
            }, 500);

            showToast(`Â∑≤ÂèëÈÄÅÁªô ${targetChar.name}ÔºåÁ≠âÂæÖÂõûÂ§ç...`);
        }

        // ÂàÜ‰∫´Áªô AI Âä©Êâã
        async function shareToAiAssistant() {
            const p = store.projects.find(x => x.id === currentPid);
            if (!p) {
                alert('Êâæ‰∏çÂà∞ÂΩìÂâçÈ°πÁõÆ');
                return;
            }

            const msg = buildShareMessage(p);

            closeModal('modal-select-character');
            
            // ÊâìÂºÄ AI Âä©ÊâãÈù¢Êùø
            openSidebarPanel('ai-assistant');

            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ AI ÂéÜÂè≤
            const userMsg = {
                role: 'user',
                content: msg,
                timestamp: Date.now()
            };
            store.aiChatHistory.push(userMsg);
            saveData();
            
            renderAiChatHistory();

            // Ëá™Âä®Ëß¶Âèë AI ÂõûÂ§ç
            setTimeout(() => {
                triggerAiAssistantResponse();
            }, 500);

            showToast(`Â∑≤ÂèëÈÄÅÁªô Vesper AIÔºåÁ≠âÂæÖÂõûÂ§ç...`);
        }

        // ÊûÑÂª∫ÂàÜ‰∫´Ê∂àÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
        function buildShareMessage(p) {
            // ËÆ°ÁÆóÂÆåÊàêÁéá
            const totalTasks = p.tasks ? p.tasks.length : 0;
            const completedTasks = p.tasks ? p.tasks.filter(t => t.completed).length : 0;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const archiveDate = p.archivedAt ? new Date(p.archivedAt).toLocaleDateString('zh-CN') : 'Êú™Áü•';

            // Ëé∑ÂèñÈöèÁ¨î
            const journalText = document.getElementById('inp-journal').value || p.journal || '';

            // Ëé∑ÂèñÊÄªÁªìÔºà‰ªÖÂΩíÊ°£Âç°ÊúâÔºâ
            const summaryText = document.getElementById('inp-summary') ?
                (document.getElementById('inp-summary').value || p.summary || '') :
                (p.summary || '');

            // ÊûÑÂª∫ÂÆåÊï¥ÁöÑ‰ªªÂä°ÂàóË°®
            let taskList = '';
            if (p.tasks && p.tasks.length > 0) {
                taskList += `\n\n**ÂÆåÊï¥‰ªªÂä°ÂàóË°®:**\n`;
                p.tasks.forEach((t, i) => {
                    taskList += `${i + 1}. [${t.completed ? '‚úÖ' : '‚ùå'}] ${t.text}\n`;
                });
            }

            // ÊûÑÂª∫ÂàÜ‰∫´Ê∂àÊÅØ
            let msg = `**[Bingo ÂΩíÊ°£ÂàÜ‰∫´]**\n`;
            msg += `‰∏ªÈ¢ò: ${p.theme}\n`;
            msg += `ÂàÜÁ±ª: ${p.tag}\n`;
            msg += `ÂΩíÊ°£Êó•Êúü: ${archiveDate}\n`;
            msg += `ÂÆåÊàêÂ∫¶: ${completedTasks}/${totalTasks} (${completionRate}%)`;
            msg += taskList;
            if (journalText) {
                msg += `\n**Áî®Êà∑ÈöèÁ¨î:**\n${journalText}`;
            }
            if (summaryText) {
                msg += `\n\n**ÂΩíÊ°£ÊÄªÁªì:**\n${summaryText}`;
            }
            if (currentArchiveComment) {
                msg += `\n\n‚ú® **AIËØÑËØ≠:**\n*${currentArchiveComment}*`;
            }

            return msg;
        }
    </script>

    <!-- ‰æßËæπÊ†èÈù¢Êùø -->
    <div id="panel-ai-assistant" class="sidebar-panel modal" style="align-items: flex-start; background: var(--bg);">
        <div class="sheet" style="width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column; padding: 0;">
            <!-- ËÅäÂ§©Â§¥ÈÉ® -->
            <div style="background:var(--card-bg); padding:15px; display:flex; align-items:center; gap:15px; border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:var(--shadow); flex-shrink: 0;">
                <span style="font-size:1.5rem; cursor:pointer;" onclick="closePanelBack()">‚Üê</span>
                <img src="data:image/webp;base64,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BMYhcYBdTRiotB9FDxps/nyt5rEjV0jT6upGRixAXTfAU/lGADFIpGAXU1ATGIXGAXU1ATGH9CpA0wtLIxMT0Yc+YvWvJTzB47pjEXkyrKigfkgwi20zupqAmMQuMAupqAmMQpr1JY6OrZFCzdbZeiQNMxgDrKqagLGAy3tqzK5i4wC6moCYxC4wC6moCYwdn7mZ6lXVDTJZzwtNS5Q2LmiuAp/AtwviLbTO6moCYxC4wC6moCYxC4vR8BQM9Q3+WbfjbxFqSwFIoRQPyQYRbaZ3U1ATGIXGAXU1ATGIXGAXECt9wvaACrrBI1iPKF3Bzvi6g67HcD8ftM7qagJjELjALqagJjELjALqW68wgvSFAAWUU+/E8rqP6U9uX5XMXGAXU1ATGIXGAXU1ATGIXGAXFr0dagtFpnyKKK9vAXU1ATGIXGAXU1ATGIXGAXU1ATGIU1hF0ZmVCr4xiPifHsp/AqeI7qagJjELjALqagJjELjALqagJjELckbDlD6/BdVvkHE37i4BXmMQuMAupqAmMQuMAupqAmMQuMAupacsyaeun2iOslrFUop8L/E8rmLjALqagJjELjALqagJjELjALpsIaJ1/1srmKYF81RFndTUBMYhcYBdTUBMYhcYBdTUBMYhcX/bxQgo6Q7DiSmz9cqF1NQExiFxgF1NQExiFxgF1NQExiFxgFxAiz65u6ulM6ILb8WIF1NQExiFxgF1NQExiFxgF1NQExiFxgFxIu+w+j4iEMj/80BP5XMXGAXU1ATGIXGAXU1ATGIXGAXU1ATFRpFEKex14PS7gdATY0QuMAupqAmMQuMAupqAmMQuMAupqAmMQpw7OGEFzmy15jELjALqagJjELjALqagJjELjALqagJjCAXpRX477VmVzFxgF1NQExiFxgF1NQExiFxgF1NQExh/MrY4JzV/xw3OzupqAmMQuMAupqAmMQuMAupqAmMQuMAupori8omUXpt+8yuYuMAupqAmMQuMAupqAmMQuMAupqAmMP9yV7Feel0s6zMrmLjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJjELjALqagJioAAP7FzQAAAAAAAAAAAAAABdGJPp1NV+zG2bLCQXvIX5kF2Jbm4aNgxXXPsRu5JXnFJbB69pUT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" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:1rem; color:var(--accent);" id="ai-conversation-title">Vesper AI</div>
                    <div id="ai-chat-status" style="font-size:0.7rem; opacity:0.6;">Âú®Á∫ø</div>
                </div>
                <span style="font-size:1.2rem; cursor:pointer; padding:5px;" onclick="toggleAiConversationList()" title="ÂØπËØùÂàóË°®">‚áÜ</span>
                <span style="font-size:1.2rem; cursor:pointer;" onclick="openAiSettings()">‚öôÔ∏è</span>
            </div>

            <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
            <div id="ai-chat-container" style="flex:1; overflow-y:auto; overflow-x:hidden; padding:15px; display:flex; flex-direction:column; gap:15px; padding-bottom: 140px;">
                <div style="text-align:center; opacity:0.5; margin-top:100px;">Vesper Âú®Ê≠§ÂæÖÂëΩ„ÄÇ</div>
            </div>

            <!-- AIÂä©Êâã‰∏ìÁî®Â§öÈÄâÂ∑•ÂÖ∑Ê†è -->
            <div id="ai-multi-select-toolbar" style="display:none; position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:var(--card-bg); border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,0.3); padding:10px 20px; z-index:10000; gap:15px; align-items:center;">
                <span style="font-weight:bold; color:var(--accent);">Â∑≤ÈÄâÊã© <span id="ai-selected-count">0</span> Êù°</span>
                <button onclick="selectAllAiMessages()" style="background:none; border:none; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:0.9rem; color:var(--text);">ÂÖ®ÈÄâ</button>
                <button onclick="cancelAiMultiSelect()" style="background:none; border:none; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:0.9rem; color:var(--text);">ÂèñÊ∂à</button>
                <button onclick="deleteSelectedAiMessages()" style="background:none; border:none; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:0.9rem; color:#c62828;">üóëÔ∏è Âà†Èô§</button>
            </div>

            <!-- Ê∂àÊÅØËæìÂÖ•Âå∫Âüü (ÂåÖÂê´Â∑•ÂÖ∑Ê†è) -->
            <div id="ai-input-area" style="background:var(--card-bg); border-top:1px solid rgba(0,0,0,0.1); display:flex; flex-direction:column; position: fixed; bottom: 0; left: 0; width: 100%; padding-bottom: max(15px, env(safe-area-inset-bottom)); z-index: 1001;">
                
                <!-- AI Â∑•ÂÖ∑Ê†è -->
                <div class="chat-toolbar" style="display:flex; gap:15px; padding:8px 12px; border-bottom:1px dashed rgba(0,0,0,0.1); background:var(--card-bg);">
                    
                    <div class="tool-icon" onclick="aiToolSendBingo()" title="Ê≥®ÂÖ•‰ªªÂä°Êï∞ÊçÆ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                    </div>

                    <div class="tool-icon" onclick="document.getElementById('ai-img-upload').click()" title="ËßÜËßâ‰ø°Âè∑">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M21 12c0 1.66-4 8-9 8s-9-6.34-9-8 4-8 9-8 9 6.34 9 8z"></path>
                        </svg>
                        <input type="file" id="ai-img-upload" accept="image/*" multiple style="display:none" onchange="aiToolSendImage(this)">
                    </div>

                    <div class="tool-icon" onclick="aiToolRollDice()" title="ÂÜ≥Á≠ñËæÖÂä©">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 22h20L12 2z"></path> <circle cx="12" cy="16" r="1.5" fill="currentColor" stroke="none"></circle> </svg>
                    </div>

                    <div class="tool-icon" onclick="aiToolSendStatus()" title="ÁîüÁâ©Áä∂ÊÄÅ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 12l10 10 10-10L12 2z"></path>
                        </svg>
                    </div>
                    
                    <div class="tool-icon" onclick="aiToolSendLink()" title="ÂèëÈÄÅÈìæÊé•">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                             <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                             <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </div>

                    <div id="ai-search-toggle-btn" class="tool-icon" onclick="smartWebSearch('ai')" title="ËÅîÁΩëÊêúÁ¥¢ (Êô∫ËÉΩ)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>

                    <div id="ai-local-search-btn" class="tool-icon" onclick="smartLocalSearch('ai')" title="Âú∞ÁÇπÊêúÁ¥¢ (Êô∫ËÉΩ)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                </div>

                <!-- ÂºïÁî®È¢ÑËßàÂå∫Âüü -->
                <div id="ai-quote-preview" class="quote-preview">
                    <div id="ai-quote-preview-content" style="font-size:0.85rem; opacity:0.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-right:30px;"></div>
                    <button class="quote-preview-close" onclick="clearAiQuotePreview()">√ó</button>
                </div>

                <!-- ËæìÂÖ•Ê°Ü -->
                <div style="padding:10px 15px 15px; display:flex; gap:10px; align-items:flex-end;">
                    <button id="ai-reply-btn" style="width:40px; height:40px; border-radius:50%; background:var(--card-bg); border:1px solid var(--accent); color:var(--accent); font-size:1.2rem; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-shrink:0; display:none;" onclick="triggerAiAssistantResponse()" title="ËÆ©AIÂõûÂ§ç">‚ú®</button>
                    <textarea id="ai-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Shift+Enter Êç¢Ë°å)" style="flex:1; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:15px; resize:none; max-height:100px; font-family:inherit; background:var(--bg); color:var(--text); min-height:40px;" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendAiUserMessage(); }"></textarea>
                    <button id="ai-send-btn" style="width:40px; height:40px; border-radius:50%; background:var(--accent); color:var(--bg); border:none; font-size:1.2rem; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2); flex-shrink:0;" onclick="sendAiUserMessage()">‚Üë</button>
                </div>
            </div>
        </div>

        <!-- AIÂØπËØùÂàóË°®‰æßËæπÊ†è -->
        <div id="ai-conversation-overlay" class="ai-conversation-overlay" onclick="closeAiConversationList()"></div>
        <div id="ai-conversation-sidebar" class="ai-conversation-list-sidebar">
            <div style="font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:var(--accent);">ÂØπËØùÂàóË°®</div>
            <div id="ai-conversation-list-container"></div>
        </div>
    </div>

    <div id="panel-api-config" class="sidebar-panel modal">
        <div class="sheet">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="back-btn" onclick="closePanelBack()">‚Äπ</span>
                <h3 style="margin:0;">‚öôÔ∏è APIËÆæÁΩÆ</h3>
                <span style="width:30px;"></span>
            </div>

            <h4 style="margin-bottom:10px; color:var(--accent);">‰∏ªAPIÈÖçÁΩÆ</h4>
            <div class="input-group">
                <label>Âèç‰ª£Âú∞ÂùÄ</label>
                <input type="text" id="main-api-url" placeholder="https://api.openai.com/v1">
            </div>
            <div class="input-group">
                <label>APIÂØÜÈí•</label>
                <input type="password" id="main-api-key" placeholder="sk-...">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-sec" style="flex:1;" onclick="fetchModels('main')">üîÑ ÊãâÂèñÊ®°Âûã</button>
                <button class="btn-sec" style="flex:1;" onclick="testApiConnection('main')">üß™ ÊµãËØïËøûÊé•</button>
            </div>
            <div class="input-group">
                <label>Ê®°Âûã</label>
                <select id="main-api-model">
                    <option value="gpt-4">gpt-4</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ê∏©Â∫¶ (0-2)</label>
                <input type="number" id="main-api-temp" min="0" max="2" step="0.1" value="0.8">
            </div>

            <hr style="margin:20px 0; opacity:0.3;">

            <h4 style="margin-bottom:10px; color:var(--accent);">ËÅîÁΩëÊêúÁ¥¢ÈÖçÁΩÆ</h4>
            <div class="input-group">
                <label>ÊêúÁ¥¢ÊúçÂä°ÂïÜ</label>
                <select id="search-provider-select" onchange="toggleSearchInputs()">
                    <option value="google">Google Custom Search</option>
                    <option value="serper">Serper.dev</option>
                    <option value="zhipu">Zhipu AI</option>
                    <option value="none">None (ÂÖ≥Èó≠)</option>
                </select>
            </div>
            <div id="google-search-inputs">
                <div class="input-group">
                    <label>Google Search API Key</label>
                    <input type="password" id="google-search-api-key" placeholder="Google API Key...">
                </div>
                <div class="input-group">
                    <label>Google CX ID</label>
                    <input type="text" id="google-search-cx" placeholder="Google CX ID...">
                </div>
            </div>
            <div id="serper-search-inputs" style="display:none;">
                <div class="input-group">
                    <label>Serper API Key</label>
                    <input type="password" id="serper-api-key" placeholder="Serper API Key...">
                </div>
            </div>
            <div id="zhipu-search-inputs" style="display:none;">
                <div class="input-group">
                    <label>Zhipu API Key</label>
                    <input type="password" id="zhipu-api-key" placeholder="Zhipu API Key...">
                </div>
            </div>

            <hr style="margin:20px 0; opacity:0.3;">

            <h4 style="margin-bottom:10px; color:var(--accent);"> Âú∞ÂõæÊúçÂä°ÈÖçÁΩÆ (AMAP)</h4>
            <div class="input-group">
                <label>È´òÂæ∑ Web ÊúçÂä° Key</label>
                <input type="password" id="amap-key-input" placeholder="ËæìÂÖ•È´òÂæ∑ Web ÊúçÂä° Key">
            </div>
            <div class="input-group">
                <label>ÈªòËÆ§ÂüéÂ∏Ç (ÂèØÈÄâ)</label>
                <input type="text" id="user-city-input" placeholder="ÈªòËÆ§ÂüéÂ∏Ç (Â¶Ç: ‰∏úËéû)">
            </div>

            <hr style="margin:20px 0; opacity:0.3;">

            <h4 style="margin-bottom:10px; color:var(--accent);">ÂâØAPIÈÖçÁΩÆ (ÂèØÈÄâ)</h4>
            <div class="input-group">
                <label>Âèç‰ª£Âú∞ÂùÄ</label>
                <input type="text" id="sub-api-url" placeholder="https://api.openai.com/v1">
            </div>
            <div class="input-group">
                <label>APIÂØÜÈí•</label>
                <input type="password" id="sub-api-key" placeholder="sk-...">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-sec" style="flex:1;" onclick="fetchModels('sub')">üîÑ ÊãâÂèñÊ®°Âûã</button>
                <button class="btn-sec" style="flex:1;" onclick="testApiConnection('sub')">üß™ ÊµãËØïËøûÊé•</button>
            </div>
            <div class="input-group">
                <label>Ê®°Âûã</label>
                <select id="sub-api-model">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="gpt-4">gpt-4</option>
                </select>
            </div>

            <hr style="margin:20px 0; opacity:0.3;">

            <h4 style="margin-bottom:10px; color:var(--accent);">È¢ÑËÆæÁÆ°ÁêÜ</h4>
            <div class="input-group">
                <label>‰øùÂ≠ò/Âä†ËΩΩÈ¢ÑËÆæ</label>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <select id="api-preset-select" style="flex:1;">
                        <option value="">-- ÈÄâÊã©È¢ÑËÆæ --</option>
                    </select>
                    <button class="btn-sec" style="width:auto; padding:8px 12px; margin:0;" onclick="loadSelectedApiPreset()">üìÇ</button>
                    <button class="btn-sec" style="width:auto; padding:8px 12px; margin:0; color:#c62828;" onclick="deleteSelectedApiPreset()">üóëÔ∏è</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="new-preset-name" placeholder="Êñ∞È¢ÑËÆæÂêçÁß∞" style="flex:1;">
                    <button class="btn-sec" style="width:auto; padding:8px 12px; margin:0;" onclick="saveApiPresetWithName()">üíæ ‰øùÂ≠ò</button>
                </div>
            </div>

            <button class="btn" onclick="saveApiConfig()">‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closePanelBack()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="panel-character-manager" class="sidebar-panel modal" style="align-items: flex-start; background: var(--bg);">
        <div class="sheet" style="width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column; padding: 0;">
             <div class="header" style="background:var(--card-bg); padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:var(--shadow); flex-shrink: 0;">
                <span class="back-btn" style="font-size:1.5rem; cursor:pointer;" onclick="closePanelBack()">‚Üê</span>
                <h3 style="margin:0; color:var(--accent);">‰ø°ÊÅØÁÆ°ÁêÜ</h3>
                <div style="display:flex; gap:8px;">
                    <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="openGroupManager()">üìÇ ÂàÜÁªÑ</button>
                    <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="openCreateCharacterModal()">+</button>
                    <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="openCharacterImportModal()">üì•</button>
                </div>
            </div>
            <div id="character-list" style="flex:1; overflow-y:auto;">
                <div style="text-align:center; opacity:0.5; margin-top:50px;">ÊöÇÊó†ËßíËâ≤,ÁÇπÂáªÂè≥‰∏äËßíÂàõÂª∫ÊàñÂØºÂÖ•</div>
            </div>
        </div>
    </div>

    <!-- ÂàõÂª∫/ÁºñËæëËßíËâ≤ÂºπÁ™ó -->
    <div id="modal-create-character" class="modal modal-on-top"><div class="sheet">
        <h3 style="margin-bottom:15px;" id="create-char-title">ÂàõÂª∫ËßíËâ≤</h3>

        <!-- Â§¥ÂÉè‰∏ä‰º† -->
        <div style="text-align:center; margin-bottom:20px;">
            <div style="position:relative; display:inline-block;">
                <img id="create-char-avatar-preview" src="https://via.placeholder.com/100?text=ÁÇπÂáª‰∏ä‰º†" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--accent); cursor:pointer;" onclick="document.getElementById('create-char-avatar-input').click();">
                <input type="file" id="create-char-avatar-input" accept="image/*" style="display:none;" onchange="previewCharacterAvatar(this)">
            </div>
            <div style="font-size:0.7rem; opacity:0.6; margin-top:8px;">ÁÇπÂáªÂ§¥ÂÉè‰∏ä‰º†ÂõæÁâá</div>
        </div>

        <div class="input-group">
            <label>ËßíËâ≤ÂêçÁß∞ *</label>
            <input type="text" id="create-char-name" placeholder="‰æãÂ¶ÇÔºöÂ∞èÁæé">
        </div>

        <div class="input-group">
            <label>ËßíËâ≤ËÆæÂÆö</label>
            <textarea id="create-char-description" rows="6" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑËÉåÊôØ„ÄÅÊÄßÊ†º„ÄÅÁâπÁÇπÁ≠â..."></textarea>
        </div>

        <div class="input-group">
            <label>Á¨¨‰∏ÄÂè•ËØùÔºàÂèØÈÄâÔºâ</label>
            <textarea id="create-char-first-mes" rows="3" placeholder="ËßíËâ≤Á¨¨‰∏ÄÊ¨°ËßÅÈù¢Êó∂‰ºöËØ¥‰ªÄ‰πà..."></textarea>
        </div>

        <button class="btn" onclick="saveNewCharacter()">‚úÖ ‰øùÂ≠òËßíËâ≤</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-create-character')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ËßíËâ≤ÂØºÂÖ•ÂºπÁ™ó -->
    <div id="modal-character-import" class="modal modal-on-top"><div class="sheet">
        <h3 style="margin-bottom:15px;">ÂØºÂÖ•ËßíËâ≤Âç°</h3>
        <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">ÊîØÊåÅPNGÊ†ºÂºè(SillyTavern)ÂíåJSONÊ†ºÂºè</p>
        <input type="file" id="character-file-input" accept=".png,.json" style="display:none;" onchange="handleCharacterFile(this)">
        <button class="btn" onclick="document.getElementById('character-file-input').click()">üìÅ ÈÄâÊã©Êñá‰ª∂</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-character-import')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ËßíËâ≤ËØ¶ÊÉÖ/ËÆæÁΩÆÂºπÁ™ó -->
    <div id="modal-character-detail" class="modal" style="align-items: flex-start; background: var(--bg);">
        <div class="sheet" style="width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column; padding: 0;">
            <div class="header" style="background:var(--card-bg); padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:var(--shadow); flex-shrink: 0;">
                <span class="back-btn" style="font-size:1.5rem; cursor:pointer;" onclick="closeSettingsAndReturnToChat()">‚Üê</span>
                <h3 style="margin:0; color:var(--accent);">ËßíËâ≤ËÆæÁΩÆ</h3>
                <div style="display:flex; gap:8px;">
                     <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="saveCharacterFullInfo()">‰øùÂ≠ò</button>
                </div>
            </div>

            <div style="flex:1; overflow-y:auto; padding:15px;">
                
                <!-- Ë∫´‰ªΩ‰ø°ÊÅØ -->
                <h4 class="settings-header">Ë∫´‰ªΩ‰ø°ÊÅØ</h4>
                <div class="settings-section">
                    <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px;">
                        <div>
                            <img id="character-detail-avatar" src="" style="width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--accent); cursor:pointer;" onclick="document.getElementById('character-detail-avatar-input').click();">
                            <input type="file" id="character-detail-avatar-input" accept="image/*" style="display:none;" onchange="updateCharacterAvatar(this)">
                            <div style="font-size:0.7rem; text-align:center; opacity:0.6; margin-top:5px;">ËßíËâ≤Â§¥ÂÉè</div>
                        </div>
                        <div>
                            <img id="user-avatar-preview" src="https://via.placeholder.com/70" style="width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--text); cursor:pointer;" onclick="document.getElementById('user-avatar-input').click();">
                            <input type="file" id="user-avatar-input" accept="image/*" style="display:none;" onchange="previewUserAvatar(this)">
                            <div style="font-size:0.7rem; text-align:center; opacity:0.6; margin-top:5px;">ÊàëÁöÑÂ§¥ÂÉè</div>
                        </div>
                    </div>
                    <div class="input-group"><label>Â§áÊ≥®Âêç (‰ªÖ‰Ω†ÂèØËßÅ)</label><input type="text" id="character-detail-nickname"></div>
                    <div class="input-group"><label>ËßíËâ≤Êú¨Âêç (AIËØÜÂà´)</label><input type="text" id="character-detail-name-input"></div>
                    <div class="input-group">
                        <label>Â•ΩÂèãÂàÜÁªÑ</label>
                        <div style="display:flex; gap:5px;">
                            <select id="character-detail-group" style="flex:1;">
                                <!-- Âä®ÊÄÅÂä†ËΩΩÂàÜÁªÑ -->
                            </select>
                            <button class="btn-sec" style="width:auto; margin:0;" onclick="openGroupManager()">ÁÆ°ÁêÜ</button>
                        </div>
                    </div>
                </div>

                <!-- ‰∫∫ËÆæ -->
                <h4 class="settings-header">‰∫∫ËÆæ</h4>
                <div class="settings-section">
                    <div class="input-group"><label>ËßíËâ≤‰∫∫ËÆæ</label><textarea id="character-detail-description" rows="6" placeholder="ËßíËâ≤ÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div>
                    <div class="input-group"><label>ÊàëÁöÑ‰∫∫ËÆæ</label><textarea id="character-detail-user-persona" rows="4" placeholder="‰Ω†Â∏åÊúõAIÂ¶Ç‰ΩïÁúãÂæÖ‰Ω†..."></textarea></div>
                    <div class="input-group"><label>ÂºÄÂú∫ÁôΩ</label><textarea id="character-detail-first-mes" rows="2" placeholder="ËßíËâ≤Á¨¨‰∏ÄÊ¨°ËßÅÈù¢Êó∂ËØ¥ÁöÑËØù..."></textarea></div>
                </div>

                <!-- AIÊ†∏ÂøÉ -->
                <h4 class="settings-header">AI Ê†∏ÂøÉ</h4>
                <div class="settings-section">
                    <div class="input-group">
                        <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                        <div id="character-linked-worldbooks" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; min-height:40px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:10px; background:var(--bg);"></div>
                        <button class="btn btn-sec" style="margin-top:10px; width:auto; font-size:0.8rem;" onclick="selectWorldBooksForCharacter()">üìö ÈÄâÊã©/ÁÆ°ÁêÜ‰∏ñÁïå‰π¶</button>
                    </div>
                    <div class="input-group">
                        <label>ÂÖ≥ËÅîÂæÖÂäû Bingo Âç°</label>
                        <div id="character-linked-bingo-cards" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; min-height:40px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:10px; background:var(--bg);"></div>
                        <button class="btn btn-sec" style="margin-top:10px; width:auto; font-size:0.8rem;" onclick="selectBingoCardsForCharacter()">üéØ ÈÄâÊã©/ÁÆ°ÁêÜ Bingo Âç°</button>
                    </div>
                    <div class="input-group" style="display:flex; align-items:center; justify-content:space-between;">
                        <label style="margin:0;">ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä®</label>
                        <input type="checkbox" id="character-detail-bg-activity" style="width:auto;">
                    </div>
                    <div class="input-group"><label>Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü)</label><input type="number" id="character-detail-bg-cooldown" value="120" min="1"></div>
                    <div class="input-group">
                        <label>‰∏ä‰∏ãÊñáÁü≠ÊúüËÆ∞ÂøÜÊù°Êï∞</label>
                        <input type="number" id="character-max-memory" value="20" min="5" max="100" oninput="updateTokenEstimate()">
                        <div style="font-size:0.7rem; opacity:0.6; margin-top:5px;">
                            üí° ÊØèÊ¨°AIË∞ÉÁî®ÂèëÈÄÅÊúÄËøëNÊù°ÂØπËØù‰Ωú‰∏∫‰∏ä‰∏ãÊñá„ÄÇÂ§™Â∞ë‰ºöÂ§±ÂøÜÔºåÂ§™Â§ö‰ºöÊµ™Ë¥πtoken‰∏îÂèØËÉΩË∂ÖÈôê„ÄÇÂª∫ËÆÆÔºöÊó•Â∏∏ËÅäÂ§©20Êù°ÔºåÊ∑±Â∫¶ÂØπËØù30-50Êù°
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ÊåÇËΩΩËÆ∞ÂøÜÊù°Êï∞</label>
                        <input type="number" id="character-detail-pinned-memory" value="0" min="0" max="20" oninput="updateTokenEstimate()">
                        <div style="font-size:0.7rem; opacity:0.6; margin-top:5px;">
                            üí° ‰ªéÈïøÊúüËÆ∞ÂøÜÂ∫ìÊåÇËΩΩÊúÄËøëNÊù°Âà∞Á≥ªÁªüÊèêÁ§∫ËØç‰∏≠„ÄÇËÆæÁΩÆËøáÂ§ö‰ºöÂ¢ûÂä†ÊØèÊ¨°Ë∞ÉÁî®ÁöÑtokenÊ∂àËÄó„ÄÇÂª∫ËÆÆÔºö0-5Êù°
                        </div>
                    </div>
                    <div class="input-group" style="display:flex; align-items:center; justify-content:space-between;">
                        <label style="margin:0;">Ëá™Âä®ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ</label>
                        <input type="checkbox" id="character-detail-auto-summary" style="width:auto;">
                    </div>
                    <div class="input-group"><label>Ëá™Âä®ÊÄªÁªìÈó¥Èöî (Êù°)</label><input type="number" id="character-detail-summary-interval" value="10"></div>
                    <div class="input-group" style="display:flex; align-items:center; justify-content:space-between;">
                        <label style="margin:0;">Êó∂Èó¥ÊÑüÁü•</label>
                        <input type="checkbox" id="character-detail-time-awareness" style="width:auto;" checked>
                    </div>
                    <div class="input-group">
                        <label>Ê∂àÊÅØÂèëÈÄÅÊ®°Âºè</label>
                        <select id="character-detail-msg-mode">
                            <option value="split">ÊñáÊú¨Âè•Â≠êÂàáÂàÜ (Ê®°ÊãüÊó•Â∏∏Â§öËΩÆÂØπËØù)</option>
                            <option value="full">ÂèëÈÄÅ‰∏ÄÊÆµÊñáÊú¨ÂÆåÊï¥ String</option>
                        </select>
                    </div>
                </div>

                <!-- Â§ñËßÇ -->
                <h4 class="settings-header">Â§ñËßÇËá™ÂÆö‰πâ</h4>
                <div class="settings-section">
                    <div class="input-group" style="display:flex; align-items:center; justify-content:space-between;">
                        <label style="margin:0;">ËÅäÂ§©ËÉåÊôØË∑üÈöè‰∏ªÈ¢ò</label>
                        <input type="checkbox" id="character-detail-bg-follow" style="width:auto;" checked>
                    </div>
                    <div class="input-group" style="display:flex; align-items:center; justify-content:space-between;">
                        <label style="margin:0;">ÊòæÁ§∫ËßíËâ≤ÂíåÁî®Êà∑Â§¥ÂÉè</label>
                        <input type="checkbox" id="character-detail-show-avatar" style="width:auto;" checked>
                    </div>
                    <div class="input-group">
                        <label>ËÅäÂ§©Ê∞îÊ≥°Â≠ó‰ΩìÂ§ßÂ∞è (px)</label>
                        <input type="range" id="character-detail-bubble-size" min="12" max="20" value="14" step="1" oninput="document.getElementById('bubble-size-value').textContent = this.value + 'px'">
                        <div style="text-align:right; font-size:0.8rem; opacity:0.7; margin-top:5px;">
                            ÂΩìÂâç: <span id="bubble-size-value">14px</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Áî®Êà∑Ê∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè (CSS)</label>
                        <textarea id="character-detail-bubble-css-user" rows="4" placeholder="‰æãÂ¶Ç: background: linear-gradient(120deg, rgba(235, 226, 170, 0.85), rgba(200, 213, 197, 0.8)); border-radius: 18px 2px 18px 18px;"></textarea>
                    </div>
                    <div class="input-group">
                        <label>ËßíËâ≤Ê∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè (CSS)</label>
                        <textarea id="character-detail-bubble-css-ai" rows="4" placeholder="‰æãÂ¶Ç: background: linear-gradient(135deg, rgba(225, 236, 244, 0.92), rgba(173, 196, 204, 0.85)); border-radius: 2px 18px 18px 18px;"></textarea>
                    </div>

                    <!-- Ê†∑ÂºèÈ¢ÑËÆæÁÆ°ÁêÜ -->
                    <div class="input-group">
                        <label>Ê†∑ÂºèÈ¢ÑËÆæ</label>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="bubble-preset-name" placeholder="È¢ÑËÆæÂêçÁß∞" style="flex:1;">
                            <button class="btn-sec" style="width:auto; padding:5px 12px; margin:0;" onclick="saveBubblePreset()">üíæ</button>
                        </div>
                        <select id="bubble-preset-select" onchange="loadBubblePreset()" style="margin-bottom:10px;">
                            <option value="">ÈÄâÊã©È¢ÑËÆæ</option>
                        </select>
                    </div>

                    <!-- ÊïàÊûúÈ¢ÑËßà -->
                    <div style="text-align:center; opacity:0.6; font-size:0.8rem; margin-bottom:10px;">- ÊïàÊûúÈ¢ÑËßà -</div>
                    <div id="bubble-preview-container" style="padding:15px; background:var(--bg); border-radius:12px; border:1px solid rgba(0,0,0,0.1);">
                        <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                            <div class="preview-bubble preview-bubble-user" style="max-width:70%; background:var(--accent); color:var(--bg); padding:12px 16px; border-radius:16px;">
                                <div style="font-size:14px;">ËøôÊòØÁî®Êà∑Ê∂àÊÅØÊ∞îÊ≥°</div>
                            </div>
                        </div>
                        <div style="display:flex; justify-content:flex-start;">
                            <div class="preview-bubble preview-bubble-char" style="max-width:70%; background:var(--card-bg); color:var(--text); padding:12px 16px; border-radius:16px; border-left:3px solid var(--accent);">
                                <div style="font-size:14px;">ËøôÊòØËßíËâ≤Ê∂àÊÅØÊ∞îÊ≥°</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ËÆ∞ÂΩïÁÆ°ÁêÜ -->
                <h4 class="settings-header">ËÆ∞ÂΩïÁÆ°ÁêÜ</h4>
                <div class="settings-section">
                    <div style="background:var(--bg); padding:12px; border-radius:8px; border:1px solid rgba(0,0,0,0.1); margin-bottom:15px;">
                        <div style="font-size:0.75rem; opacity:0.6; margin-bottom:8px;">üìä Token‰ΩøÁî®ÊÉÖÂÜµ‰º∞ÁÆó</div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:8px;">
                            <span>ÂΩìÂâçÂØπËØùÊÄªÊù°Êï∞:</span>
                            <b id="chat-message-count" style="color:var(--accent);">0</b>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:8px;">
                            <span>ÊØèÊ¨°ÂèëÈÄÅÊù°Êï∞:</span>
                            <b id="context-limit-display" style="color:var(--accent);">20</b>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:8px;">
                            <span>ÊåÇËΩΩÈïøÊúüËÆ∞ÂøÜ:</span>
                            <b id="pinned-memory-display" style="color:var(--accent);">0</b>
                        </div>
                        <div style="border-top:1px dashed rgba(0,0,0,0.1); margin:8px 0; padding-top:8px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                                <span>È¢Ñ‰º∞ÊØèÊ¨°Ë∞ÉÁî®Token:</span>
                                <b id="chat-token-estimate" style="color:var(--accent);">~0</b>
                            </div>
                            <div style="font-size:0.65rem; opacity:0.5; margin-top:5px;">
                                üí° ÂÆûÈôÖtokenÂèñÂÜ≥‰∫éÊ∂àÊÅØÈïøÂ∫¶ÂíåÊ®°Âûã„ÄÇÊ≠§‰∏∫Á≤óÁï•‰º∞ÁÆóÔºöÁ≥ªÁªüÊèêÁ§∫ËØç~500 + ‰∏ä‰∏ãÊñáÊù°Êï∞√ó100 + ÈïøÊúüËÆ∞ÂøÜ√ó50
                            </div>
                        </div>
                    </div>
                    <div class="input-group"><input type="search" id="chat-search-input" placeholder="Êü•ÊâæËÅäÂ§©ËÆ∞ÂΩï..."><button class="btn btn-sec" onclick="searchChatHistory()">Êü•Êâæ</button></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <button class="btn btn-sec" onclick="exportChatHistory()">ÂØºÂá∫ËÆ∞ÂΩï</button>
                        <button class="btn btn-sec" onclick="importChatHistory()">ÂØºÂÖ•ËÆ∞ÂΩï</button>
                    </div>
                    <button class="btn btn-danger" style="margin-top:10px;" onclick="clearChatHistory()">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                    <button class="btn btn-danger" style="margin-top:10px;" onclick="deleteCharacter()">Âà†Èô§Ê≠§ËßíËâ≤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄâÊã©‰∏ñÁïå‰π¶ÂºπÁ™ó -->
    <div id="modal-select-worldbooks" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;">ÈÄâÊã©‰∏ñÁïå‰π¶</h3>
        <div id="worldbook-selection-list" style="max-height:400px; overflow-y:auto; margin-bottom:15px;">
            <!-- ‰∏ñÁïå‰π¶Â§çÈÄâÊ°ÜÂàóË°® -->
        </div>
        <button class="btn" onclick="confirmWorldBookSelection()">Á°ÆËÆ§</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-select-worldbooks')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÈÄâÊã©BingoÂç°ÂºπÁ™ó -->
    <div id="modal-select-bingo" class="modal modal-on-top"><div class="sheet">
        <h3 style="margin-bottom:15px;">ÈÄâÊã©ÂÖ≥ËÅîÁöÑ Bingo Âç°</h3>
        <div id="bingo-selection-list" style="max-height:400px; overflow-y:auto; margin-bottom:15px;">
            <!-- BingoÂç°Â§çÈÄâÊ°ÜÂàóË°® -->
        </div>
        <button class="btn" onclick="confirmBingoCardSelection()">Á°ÆËÆ§</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-select-bingo')">ÂèñÊ∂à</button>
    </div></div>

    <div id="panel-world-book-manager" class="sidebar-panel modal">
        <div class="sheet">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span class="back-btn" onclick="closePanelBack()">‚Äπ</span>
                <h3 style="margin:0;">üìö ‰∏ñÁïå‰π¶</h3>
                <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="showWorldBookOptions()">‚öôÔ∏è</button>
            </div>

            <!-- ÂàÜÁ±ªÁ≠õÈÄâ -->
            <div style="margin-bottom:15px; display:flex; gap:8px; flex-wrap:wrap;" id="worldbook-categories">
                <div class="filter-chip active" onclick="filterWorldBooks('all', this)">ÂÖ®ÈÉ®</div>
            </div>

            <!-- ‰∏ñÁïå‰π¶ÂàóË°® -->
            <div id="worldbook-list" style="max-height:400px; overflow-y:auto; margin-bottom:15px;">
                <div style="text-align:center; opacity:0.5; margin-top:50px;">ÊöÇÊó†‰∏ñÁïå‰π¶</div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1;" onclick="createWorldBook()">üìù Êñ∞Âª∫</button>
                <button class="btn btn-sec" style="flex:1;" onclick="importWorldBook()">üì• ÂØºÂÖ•</button>
            </div>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closePanelBack()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <!-- ‰∏ñÁïå‰π¶ÈÄâÈ°πËèúÂçï -->
    <div id="modal-worldbook-options" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;">‰∏ñÁïå‰π¶ÁÆ°ÁêÜ</h3>
        <button class="btn" onclick="openCategoryManager()">üè∑Ô∏è ÁÆ°ÁêÜÂàÜÁ±ª</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="exportAllWorldBooks()">üì§ ÂØºÂá∫ÂÖ®ÈÉ®</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-worldbook-options')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- ËßíËâ≤ÈÄâÊã©ÂºπÁ™óÔºàÁî®‰∫éÂàÜ‰∫´ÂΩíÊ°£Ôºâ -->
    <div id="modal-select-character" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px; color:var(--accent);">üì§ ÈÄâÊã©ÂàÜ‰∫´ÂØπË±°</h3>
        <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">ÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤Êù•ÂàÜ‰∫´Ëøô‰∏™ Bingo ÂΩíÊ°£</p>
        <div id="character-select-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px;">
            <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
        </div>
        <button class="btn btn-sec" onclick="closeModal('modal-select-character')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ÂàÜÁ±ªÁÆ°ÁêÜÂô® -->
    <div id="modal-category-manager" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;">ÂàÜÁ±ªÁÆ°ÁêÜ</h3>
        <div class="input-group">
            <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-category-name" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞">
                <button class="btn" style="width:auto; padding:10px 20px;" onclick="createCategory()">Ê∑ªÂä†</button>
            </div>
        </div>
        <div id="category-list" style="max-height:300px; overflow-y:auto; margin-top:15px;">
            <!-- ÂàÜÁ±ªÂàóË°® -->
        </div>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-category-manager')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- ÂàõÂª∫/ÁºñËæë‰∏ñÁïå‰π¶ -->
    <div id="modal-edit-worldbook" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;" id="worldbook-edit-title">Êñ∞Âª∫‰∏ñÁïå‰π¶</h3>
        <div class="input-group">
            <label>‰∏ñÁïå‰π¶ÂêçÁß∞</label>
            <input type="text" id="worldbook-name" placeholder="‰æãÂ¶ÇÔºöÂ•áÂπªÂ§ßÈôÜËÆæÂÆö">
        </div>
        <div class="input-group">
            <label>ÂàÜÁ±ª</label>
            <select id="worldbook-category">
                <option value="">Êó†ÂàÜÁ±ª</option>
            </select>
        </div>
        <div class="input-group">
            <label>ÊèèËø∞ÔºàÂèØÈÄâÔºâ</label>
            <textarea id="worldbook-description" rows="3" placeholder="ÁÆÄÁü≠ÊèèËø∞Ëøô‰∏™‰∏ñÁïå‰π¶ÁöÑÂÜÖÂÆπ"></textarea>
        </div>
        <button class="btn" onclick="saveWorldBook()">‰øùÂ≠ò</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-edit-worldbook')">ÂèñÊ∂à</button>
    </div></div>

    <!-- ‰∏ñÁïå‰π¶ËØ¶ÊÉÖ/Êù°ÁõÆÁÆ°ÁêÜ -->
    <div id="modal-worldbook-detail" class="modal"><div class="sheet">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;" id="worldbook-detail-title">‰∏ñÁïå‰π¶</h3>
            <div style="display:flex; gap:8px;">
                <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="editCurrentWorldBook()">‚úèÔ∏è</button>
                <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.75rem;" onclick="deleteCurrentWorldBook()">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Êù°ÁõÆÂàóË°® -->
        <div id="worldbook-entries-list" style="max-height:350px; overflow-y:auto; margin-bottom:15px;">
            <div style="text-align:center; opacity:0.5; margin-top:30px;">ÊöÇÊó†Êù°ÁõÆ</div>
        </div>

        <button class="btn" onclick="createWorldBookEntry()">‚ûï Êñ∞Âª∫Êù°ÁõÆ</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-worldbook-detail')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- ÂàõÂª∫/ÁºñËæëÊù°ÁõÆ -->
    <div id="modal-edit-entry" class="modal"><div class="sheet">
        <h3 style="margin-bottom:15px;" id="entry-edit-title">Êñ∞Âª∫Êù°ÁõÆ</h3>
        <div class="input-group">
            <label>Êù°ÁõÆÂêçÁß∞</label>
            <input type="text" id="entry-name" placeholder="‰æãÂ¶ÇÔºöËâæÂ∞îÁôªÁéãÂõΩ">
        </div>
        <div class="input-group">
            <label>ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
            <input type="text" id="entry-keys" placeholder="‰æãÂ¶ÇÔºöÁéãÂõΩ,ËâæÂ∞îÁôª,È¶ñÈÉΩ">
            <div style="font-size:0.7rem; opacity:0.6; margin-top:5px;">ÂΩìÂØπËØù‰∏≠Âá∫Áé∞Ëøô‰∫õÂÖ≥ÈîÆËØçÊó∂ÔºåËØ•Êù°ÁõÆ‰ºöË¢´ÊøÄÊ¥ª</div>
        </div>
        <div class="input-group">
            <label>ÂÜÖÂÆπ</label>
            <textarea id="entry-content" rows="8" placeholder="ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™Êù°ÁõÆÁöÑÂÜÖÂÆπ..."></textarea>
        </div>
        <div class="input-group" style="display:flex; align-items:center; gap:10px; margin-bottom:0;">
            <label style="margin:0; flex:1;">ÂêØÁî®Êù°ÁõÆ</label>
            <input type="checkbox" id="entry-enabled" checked style="width:auto;">
        </div>
        <button class="btn" onclick="saveWorldBookEntry()">‰øùÂ≠ò</button>
        <button class="btn btn-sec" style="margin-top:10px;" onclick="closeModal('modal-edit-entry')">ÂèñÊ∂à</button>
    </div></div>

    <div id="panel-background-activity" class="sidebar-panel modal">
        <div class="sheet">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="back-btn" onclick="closePanelBack()">‚Äπ</span>
                <h3 style="margin:0;">üîÑ ÂêéÂè∞Ê¥ªÂä®</h3>
                <span style="width:30px;"></span>
            </div>
            <div class="input-group" style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin-bottom:0;">ÂêØÁî®ÂêéÂè∞Ê¥ªÂä®</label>
                <input type="checkbox" id="bg-activity-enabled" onchange="toggleBgActivityCharacterList()">
            </div>
            <div class="input-group">
                <label>Ê£ÄÊµãÈó¥Èöî(ÂàÜÈíü)</label>
                <input type="number" id="bg-activity-interval" min="1" value="60">
            </div>

            <!-- ËßíËâ≤ÂàóË°®ÂãæÈÄâ -->
            <div id="bg-activity-character-list-container" style="display:none;">
                <div class="input-group">
                    <label>ÈÄâÊã©ÂèÇ‰∏éÂêéÂè∞Ê¥ªÂä®ÁöÑËßíËâ≤</label>
                    <div id="bg-activity-character-list" style="max-height:300px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:10px; background:var(--bg);">
                        <!-- ËßíËâ≤Â§çÈÄâÊ°ÜÂàóË°® -->
                    </div>
                </div>
            </div>

            <button class="btn" onclick="saveBackgroundActivitySettings()">‰øùÂ≠òËÆæÁΩÆ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closePanelBack()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="panel-cloud-backup" class="sidebar-panel modal">
        <div class="sheet">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="back-btn" onclick="closePanelBack()">‚Äπ</span>
                <h3 style="margin:0;">‚òÅÔ∏è ‰∫ëÂ§á‰ªΩ</h3>
                <span style="width:30px;"></span>
            </div>
            <p style="font-size:0.8rem; opacity:0.7; margin-bottom:15px;">Â∞ÜÊï∞ÊçÆÂ§á‰ªΩÂà∞GitHubÁßÅÊúâ‰ªìÂ∫ì</p>
            <div class="input-group">
                <label>GitHubÁî®Êà∑Âêç</label>
                <input type="text" id="github-username" placeholder="yourname">
            </div>
            <div class="input-group">
                <label>‰ªìÂ∫ìÂêç</label>
                <input type="text" id="github-repo" placeholder="my-backup">
            </div>
            <div class="input-group">
                <label>Personal Access Token</label>
                <input type="password" id="github-token" placeholder="ghp_...">
            </div>
            <button class="btn" onclick="saveCloudBackupSettings('upload')">‰∏ä‰º†Â§á‰ªΩ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="saveCloudBackupSettings('download')">ÊÅ¢Â§çÂ§á‰ªΩ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closePanelBack()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="panel-ai-settings" class="sidebar-panel modal" style="align-items: flex-start; background: var(--bg);">
        <div class="sheet" style="width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column; padding: 0;">
            <div class="header" style="background:var(--card-bg); padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:var(--shadow); flex-shrink: 0;">
                <span class="back-btn" style="font-size:1.5rem; cursor:pointer;" onclick="closeAiSettings()">‚Üê</span>
                <h3 style="margin:0; color:var(--accent);">AIËÆæÁΩÆ</h3>
                <span style="width:30px;"></span>
            </div>

            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <div class="input-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="margin-bottom:0;">ÂêØÁî®ÂêéÂè∞Ê¥ªÂä®</label>
                    <input type="checkbox" id="ai-bg-activity-enabled">
                </div>
                <div class="input-group">
                    <label>ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (ÂàÜÈíü)</label>
                    <input type="number" id="ai-bg-activity-interval" min="1" value="60">
                </div>
                <hr style="margin:20px 0; opacity:0.3;">

                <div class="input-group">
                    <label>‰∏ä‰∏ãÊñáÊù°Êï∞ (0=Êó†ÈôêÂà∂)</label>
                    <input type="number" id="ai-context-limit" min="0" max="9999" value="50" step="10">
                    <div style="font-size:0.7rem; opacity:0.6; margin-top:5px;">ÊéßÂà∂AIËÆ∞ÂøÜÂ§öÂ∞ëÊù°ÂéÜÂè≤Ê∂àÊÅØ„ÄÇËÆæ‰∏∫0Ë°®Á§∫ÂèëÈÄÅÂÖ®ÈÉ®ËÅäÂ§©ËÆ∞ÂΩïÔºàÊ≥®ÊÑètokenÊ∂àËÄóÔºâ</div>
                </div>

                <div class="input-group">
                    <label>ÂÖ≥ËÅîÂæÖÂäû Bingo Âç°</label>
                    <div id="ai-linked-bingo-cards" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; min-height:40px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:10px; background:var(--bg);"></div>
                    <button class="btn btn-sec" style="margin-top:10px; width:auto; font-size:0.8rem;" onclick="selectBingoCardsForAI()">üéØ ÈÄâÊã©/ÁÆ°ÁêÜ Bingo Âç°</button>
                </div>

                <button class="btn" onclick="saveAiSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
                <hr style="margin:20px 0; opacity:0.3;">

                <h4 style="margin-bottom:10px; color:var(--accent);">ËÅäÂ§©ËÆ∞ÂΩïÁÆ°ÁêÜ</h4>
                <button class="btn btn-sec" onclick="clearAllChat()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâËÆ∞ÂΩï</button>
            </div>
        </div>
    </div>

    <div id="panel-data-manager" class="sidebar-panel modal">
        <div class="sheet">
            <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="back-btn" onclick="closePanelBack()">‚Äπ</span>
                <h3 style="margin:0;">üìä Êï∞ÊçÆÁÆ°ÁêÜ</h3>
                <span style="width:30px;"></span>
            </div>
            <button class="btn" onclick="exportData()">üì§ ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="triggerImport('merge')">üì• ÂØºÂÖ•Êï∞ÊçÆ(Â¢ûÈáè)</button>
            <button class="btn btn-danger" style="margin-top:10px;" onclick="triggerImport('overwrite')">üì• ÂØºÂÖ•Êï∞ÊçÆ(Ë¶ÜÁõñ)</button>
            <hr style="margin:20px 0; opacity:0.3;">
            <button class="btn btn-danger" onclick="if(confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ?')) { localStorage.clear(); location.reload(); }">‚ö†Ô∏è ÂàùÂßãÂåñÊâÄÊúâÂÜÖÂÆπ</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="closePanelBack()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <!-- ÈïøÊúüËÆ∞ÂøÜÂ∫ìÂºπÁ™ó -->
    <div id="modal-memory-library" class="modal"><div class="sheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--accent);">üß† ÈïøÊúüËÆ∞ÂøÜÂ∫ì</h3>
            <button class="btn-sec" style="width:auto; padding:5px 10px; font-size:0.7rem;" onclick="addManualMemory()">+ ÊâãÂä®Ê∑ªÂä†</button>
        </div>
        <p style="font-size:0.8rem; opacity:0.6; margin-bottom:15px;">Áî±ÂâØÊ®°ÂûãËá™Âä®ÂΩíÁ∫≥ÊàñÊâãÂä®ËÆ∞ÂΩïÁöÑËÆ∞ÂøÜËäÇÁÇπ„ÄÇ</p>
        <div id="memory-library-list" style="max-height:400px; overflow-y:auto; margin-bottom:20px; font-size:0.85rem; line-height:1.6;"></div>
        <button class="btn btn-sec" onclick="closeModal('modal-memory-library')">ÂÖ≥Èó≠</button>
    </div></div>

    <!-- ËßíËâ≤ËÅäÂ§©ÂÖ®Â±èÁïåÈù¢ -->
    <div id="character-chat-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:5000; flex-direction:column;">
        <!-- ËÅäÂ§©Â§¥ÈÉ® -->
        <div style="background:var(--card-bg); padding:15px; display:flex; align-items:center; gap:15px; border-bottom:1px solid rgba(0,0,0,0.1); box-shadow:var(--shadow);">
            <span style="font-size:1.5rem; cursor:pointer;" onclick="closeCharacterChat()">‚Üê</span>
            <img id="chat-avatar" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">
            <div style="flex:1;">
                <div id="chat-character-name" style="font-weight:bold; font-size:1rem; color:var(--accent);"></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="chat-status-text" style="font-size:0.7rem; opacity:0.6;">Âú®Á∫ø</div>
                    <div id="chat-message-counter" style="font-size:0.7rem; opacity:0.6; color:var(--accent);">(0Êù°)</div>
                </div>
            </div>
    <span style="font-size:1.2rem; cursor:pointer; margin-right:15px; color:#2196F3;" onclick="openMemoryLibrary()" title="ÈïøÊúüËÆ∞ÂøÜÂ∫ì">üß†</span>
    <span style="font-size:1.2rem; cursor:pointer; margin-right:15px; color:#FF9800;" onclick="toggleHistoryCollapse()" title="ÊäòÂè†/Â±ïÂºÄÂéÜÂè≤" id="chat-collapse-btn">üìã</span>
    <span style="font-size:1.2rem; cursor:pointer;" onclick="openCharacterSettingsFromChat()">‚öôÔ∏è</span>
</div>

        <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
        <div id="character-chat-messages" style="flex:1; overflow-y:auto; overflow-x:hidden; padding:15px; display:flex; flex-direction:column; gap:15px;">
            <div style="text-align:center; opacity:0.5; margin-top:100px;">ÊöÇÊó†Ê∂àÊÅØ</div>
        </div>
        
        <!-- Áä∂ÊÄÅÊèêÁ§∫Êù° -->
        <div id="character-chat-status-bar" style="padding: 5px 15px; font-size: 0.75rem; color: var(--accent); display: none; text-align: center; background: rgba(0,0,0,0.02);"></div>

        <!-- Ê∂àÊÅØËæìÂÖ•Âå∫Âüü -->
        <div style="background:var(--card-bg); border-top:1px solid rgba(0,0,0,0.1); display:flex; flex-direction:column;">
            
            <!-- ÊàòÊúØÂ∑•ÂÖ∑Ê†è (Tactical Toolbar) -->
            <div class="chat-toolbar" style="display:flex; gap:15px; padding:8px 12px; border-bottom:1px dashed rgba(0,0,0,0.1); background:var(--card-bg);">
                
                <div class="tool-icon" onclick="toolSendBingo()" title="Ê≥®ÂÖ•‰ªªÂä°Êï∞ÊçÆ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                </div>

                <div class="tool-icon" onclick="document.getElementById('img-upload').click()" title="ËßÜËßâ‰ø°Âè∑">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M21 12c0 1.66-4 8-9 8s-9-6.34-9-8 4-8 9-8 9 6.34 9 8z"></path>
                    </svg>
                    <input type="file" id="img-upload" accept="image/*" multiple style="display:none" onchange="toolSendImage(this)">
                </div>

                <div class="tool-icon" onclick="toolRollDice()" title="ÂÜ≥Á≠ñËæÖÂä©">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 22h20L12 2z"></path> <circle cx="12" cy="16" r="1.5" fill="currentColor" stroke="none"></circle> </svg>
                </div>

                <div class="tool-icon" onclick="toolSendStatus()" title="ÁîüÁâ©Áä∂ÊÄÅ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 12l10 10 10-10L12 2z"></path>
                    </svg>
                </div>
                
                <div class="tool-icon" onclick="toolSendLink()" title="ÂèëÈÄÅÈìæÊé•">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                         <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                         <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                </div>

                <div id="search-toggle-btn" class="tool-icon" onclick="smartWebSearch('character')" title="ËÅîÁΩëÊêúÁ¥¢ (Êô∫ËÉΩ)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>

                <div id="local-search-btn" class="tool-icon" onclick="smartLocalSearch('character')" title="Âú∞ÁÇπÊêúÁ¥¢ (Êô∫ËÉΩ)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
            </div>

            <!-- ÂºïÁî®È¢ÑËßàÂå∫Âüü -->
            <div id="quote-preview" class="quote-preview">
                <div id="quote-preview-content" style="font-size:0.85rem; opacity:0.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-right:30px;"></div>
                <button class="quote-preview-close" onclick="clearQuotePreview()">√ó</button>
            </div>

            <div style="padding:10px 15px 15px; display:flex; gap:10px; align-items:flex-end;">
                <button id="character-ai-reply-btn" style="width:40px; height:40px; border-radius:50%; background:var(--card-bg); border:1px solid var(--accent); color:var(--accent); font-size:1.2rem; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-shrink:0;" onclick="triggerCharacterAIResponse()" title="ËÆ©AIÂõûÂ§ç">‚ú®</button>
                <textarea id="character-chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ... (ÂõûËΩ¶Êç¢Ë°å)" style="flex:1; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:15px; resize:none; max-height:100px; font-family:inherit; background:var(--bg); color:var(--text); min-height:40px;"></textarea>
                <button id="character-send-btn" style="width:40px; height:40px; border-radius:50%; background:var(--accent); color:var(--bg); border:none; font-size:1.2rem; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2); flex-shrink:0;" onclick="sendCharacterMessage()">‚Üë</button>
            </div>
        </div>
    </div>
